<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thera Social - Anonymous Wellness Community</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #EC4899;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        /* RTL Support */
        [dir="rtl"] {
            direction: rtl;
        }

        [dir="rtl"] .nav-menu {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .avatar,
        [dir="rtl"] .member-avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        [dir="rtl"] .post-header .avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .language-selector {
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: var(--white);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Auth Forms */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 70px);
        }

        .auth-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            margin-top: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar-item:hover {
            background: var(--light);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
        }

        /* Feed - Enhanced with Calendar */
        .feed-calendar-section {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feed-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .feed-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .feed-calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--white);
        }

        .feed-calendar-day:hover {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.has-posts::after {
            content: '•';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        .post-form {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            align-items: center;
        }

        .visibility-select {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            background: var(--white);
        }

        .post-card {
            background: var(--white);
            border: 1px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .post-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 12px;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--dark);
        }

        .post-time {
            font-size: 12px;
            color: var(--gray);
        }

        .post-content {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Enhanced Profile Section */
        .profile-section {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 15px;
        }

        .profile-fields {
            display: grid;
            gap: 20px;
        }

        .profile-field {
            position: relative;
        }

        .profile-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Parameters with Calendar */
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
        }

        .parameter-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .parameter-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .parameter-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
        }

        .calendar-section {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--light);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-day.has-data::after {
            content: '•';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        /* Enhanced Circles */
        .circles-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .circle-card {
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .circle-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .circle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .circle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .circle-count {
            background: var(--primary);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .circle-members {
            max-height: 200px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .member-item:hover {
            background: var(--light);
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 12px;
        }

        .member-name {
            flex: 1;
        }

        .remove-btn {
            background: var(--danger);
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .member-item:hover .remove-btn {
            opacity: 1;
        }

        .user-search {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        /* Messages - Enhanced */
        .messages-container {
            display: flex;
            height: 600px;
        }

        .conversations-list {
            width: 300px;
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
        }

        [dir="rtl"] .conversations-list {
            border-right: none;
            border-left: 1px solid #E5E7EB;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--light);
        }

        .conversation-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .conversation-username {
            font-weight: 600;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--gray);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .unread-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        [dir="rtl"] .unread-badge {
            right: auto;
            left: 15px;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            font-weight: 600;
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            background: var(--light);
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: var(--white);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
        }

        /* Right Sidebar */
        .right-sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
        }

        [dir="rtl"] .alert-item {
            border-left: none;
            border-right: 4px solid var(--warning);
        }

        .alert-item.high {
            border-left-color: var(--danger);
        }

        [dir="rtl"] .alert-item.high {
            border-left-color: transparent;
            border-right-color: var(--danger);
        }

        .alert-item.low {
            border-left-color: var(--success);
        }

        [dir="rtl"] .alert-item.low {
            border-left-color: transparent;
            border-right-color: var(--success);
        }

        /* About and Support Pages */
        .page-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.2);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Responsive */
  /* Mobile Navigation Bar */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 8px 0;
            border-top: 1px solid #E5E7EB;
        }

        .mobile-nav-menu {
            display: flex;
            justify-content: space-around;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mobile-nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            color: var(--gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        .mobile-nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* RTL Support for Mobile Navigation */
        [dir="rtl"] .mobile-nav-menu {
            direction: rtl;
        }

        [dir="rtl"] .mobile-nav-item {
            direction: rtl;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding-bottom: 70px; /* Space for bottom nav */
            }

            .sidebar {
                display: none;
            }

            .right-sidebar {
                display: none;
            }

            .mobile-nav {
                display: block;
            }

            .main-content {
                margin-bottom: 60px; /* Prevent content being hidden behind nav */
                border-radius: 15px 15px 0 0;
            }

            .messages-container {
                flex-direction: column;
                margin-bottom: 60px;
            }

            .conversations-list {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }

            /* Adjust navbar on mobile */
            .navbar {
                padding: 10px 15px;
            }

            .nav-content {
                padding: 10px 15px;
            }

            .logo {
                font-size: 20px;
            }

            .nav-menu {
                gap: 10px;
            }

            /* Hide desktop navigation links on mobile */
            .nav-link {
                display: none;
            }

            /* Keep language selector visible */
            .language-selector {
                padding: 6px 10px;
                font-size: 14px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo" data-i18n="nav.logo">🧠 Thera Social</div>
            <div class="nav-menu">
                <select id="languageSelector" class="language-selector">
                    <option value="en">English</option>
                    <option value="he">עברית</option>
                    <option value="ar">العربية</option>
                    <option value="ru">Русский</option>
                </select>
                <a href="#" class="nav-link" id="navHome" data-i18n="nav.home">Home</a>
                <a href="#" class="nav-link" id="navAbout" data-i18n="nav.about">About</a>
                <a href="#" class="nav-link" id="navSupport" data-i18n="nav.support">Support</a>
                <button class="btn btn-primary" id="logoutBtn" style="display: none; width: auto;" data-i18n="nav.logout">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card fade-in">
            <h2 class="auth-title" id="authTitle" data-i18n="auth.welcome">Welcome Back</h2>
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email">Email</label>
                    <input type="email" class="form-input" id="emailInput" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.password">Password</label>
                    <input type="password" class="form-input" id="passwordInput" autocomplete="current-password" required>
                </div>
                <div class="form-group" id="usernameGroup" style="display: none;">
                    <label class="form-label" data-i18n="auth.username">Username</label>
                    <input type="text" class="form-input" id="usernameInput" autocomplete="username" data-i18n="auth.username_placeholder" placeholder="Choose a username">
                </div>
                <button type="submit" class="btn btn-primary" id="authSubmit" data-i18n="btn.signin">Sign In</button>
            </form>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" id="toggleAuth" style="color: var(--primary);" data-i18n="auth.toggle_signup">New here? Create an account</a>
            </p>
        </div>
    </div>

    <!-- About Page -->
    <div id="aboutPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="about.title">About Thera Social</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="about.subtitle">
                Your safe space for wellness, connection, and personal growth
            </p>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🛡️</div>
                    <h3 data-i18n="about.privacy_title">Privacy First</h3>
                    <p data-i18n="about.privacy_desc">Your wellness journey is private and secure. Share only what you're comfortable with.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3 data-i18n="about.track_title">Track Progress</h3>
                    <p data-i18n="about.track_desc">Monitor your wellness parameters and see your growth over time with insights.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">💥</div>
                    <h3 data-i18n="about.community_title">Supportive Community</h3>
                    <p data-i18n="about.community_desc">Connect with others on similar journeys in a judgment-free environment.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">💬</div>
                    <h3 data-i18n="about.communication_title">Safe Communication</h3>
                    <p data-i18n="about.communication_desc">Private messaging and circles let you control who sees your content.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🎯</div>
                    <h3 data-i18n="about.goals_title">Goal Setting</h3>
                    <p data-i18n="about.goals_desc">Set and track personal goals with community support and accountability.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🌟</div>
                    <h3 data-i18n="about.checkin_title">Daily Check-ins</h3>
                    <p data-i18n="about.checkin_desc">Regular parameter tracking helps you understand patterns and triggers.</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" style="width: 200px;" onclick="goHome()" data-i18n="btn.getstarted">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Support Page -->
    <div id="supportPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="support.title">Support Center</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="support.subtitle">
                We're here to help you on your wellness journey
            </p>

            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.faq_title">Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq1_q">How do I track my wellness parameters?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq1_a">Navigate to the Parameters tab in your dashboard. You can input daily values for mood, sleep, exercise, anxiety, and energy levels. Use the calendar to save and load parameters for different dates.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq2_q">What are Circles?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq2_a">Circles allow you to organize your connections into groups: General, Close Friends, and Family. You can control who sees your posts based on these circles.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq3_q">How do I update my profile?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq3_a">Go to the Profile tab to update your bio, interests, occupation, goals, and favorite hobbies. These help others understand you better.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq4_q">Is my data private?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq4_a">Yes! We take privacy seriously. Your wellness data is encrypted and only visible to you unless you choose to share it.</p>
                </div>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.contact_title">Contact Support</h3>
                <form id="supportForm">
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.subject">Subject</label>
                        <input type="text" class="form-input" id="supportSubject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.message">Message</label>
                        <textarea class="form-input" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" data-i18n="support.send">Send Message</button>
                </form>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" style="width: 200px;" onclick="goHome()" data-i18n="btn.back">Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
 <div id="dashboard" class="dashboard container">
    <!-- Mobile Navigation Bar -->
    <nav class="mobile-nav">
        <ul class="mobile-nav-menu">
            <li class="mobile-nav-item active" data-view="feed" onclick="showView('feed')">
                <span class="mobile-nav-icon">🏠</span>
                <span class="mobile-nav-label" data-i18n="menu.feed">Feed</span>
            </li>
            <li class="mobile-nav-item" data-view="profile" onclick="showView('profile')">
                <span class="mobile-nav-icon">👤</span>
                <span class="mobile-nav-label" data-i18n="menu.profile">Profile</span>
            </li>
            <li class="mobile-nav-item" data-view="circles" onclick="showView('circles')">
                <span class="mobile-nav-icon">⭕</span>
                <span class="mobile-nav-label" data-i18n="menu.circles">Circles</span>
            </li>
            <li class="mobile-nav-item" data-view="messages" onclick="showView('messages')">
                <span class="mobile-nav-icon">💬</span>
                <span class="mobile-nav-label" data-i18n="menu.messages">Messages</span>
            </li>
            <li class="mobile-nav-item" data-view="tracking" onclick="showView('tracking')">
    <span class="mobile-nav-icon">📊</span>
    <span class="mobile-nav-label" data-i18n="menu.parameters">Parameters</span>
</li>
        </ul>
    </nav>

    <div class="dashboard-grid">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" data-view="feed" data-i18n="menu.feed">
                        📱 Feed
                    </li>
                    <li class="sidebar-item" data-view="profile" data-i18n="menu.profile">
                        👤 Profile
                    </li>
                    <li class="sidebar-item" data-view="circles" data-i18n="menu.circles">
                        👥 Circles
                    </li>
                    <li class="sidebar-item" data-view="messages" data-i18n="menu.messages">
                        💬 Messages
                    </li>
                   <li class="sidebar-item" data-view="tracking">
    📊 <span data-i18n="menu.parameters">Parameters</span>
</li>
                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
              <!-- Feed View - Date-Based Journal -->
<div id="feedView" class="view">
    <h2 style="margin-bottom: 20px;" data-i18n="feed.title">Your Feed Journal</h2>
    <p style="color: var(--gray); margin-bottom: 20px;" data-i18n="feed.subtitle">Save your thoughts for each day. Select a date from the calendar, write your update, and save it. Green dots show dates with saved entries.</p>

    <!-- Feed Calendar -->
    <div class="feed-calendar-section">
        <div class="feed-calendar-header">
            <button class="btn btn-secondary" onclick="feedPreviousMonth()" data-i18n="calendar.prev">←</button>
            <span id="feedCurrentMonth" style="font-weight: 600;">January 2025</span>
            <button class="btn btn-secondary" onclick="feedNextMonth()" data-i18n="calendar.next">→</button>
        </div>
        <div class="feed-calendar-grid" id="feedCalendarGrid"></div>
        <div style="text-align: center; margin-top: 15px;">
            <p><span data-i18n="feed.selected_date">Selected Date:</span> <strong id="feedSelectedDateDisplay" data-i18n="feed.today">Today</strong></p>
        </div>
    </div>

    <!-- Post Form -->
    <div class="post-form">
        <textarea class="post-input" data-i18n="feed.placeholder" placeholder="How are you feeling today?" id="postInput"></textarea>
        <div class="post-actions">
            <select class="visibility-select" id="visibilitySelect">
                <option value="general" data-i18n="visibility.general">General</option>
                <option value="close_friends" data-i18n="visibility.close_friends">Close Friends</option>
                <option value="family" data-i18n="visibility.family">Family</option>
                <option value="private" data-i18n="visibility.private">Private</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: auto;" onclick="loadFeedForDate()" data-i18n="feed.load_update">Load Update</button>
                <button class="btn btn-primary" style="width: auto;" id="postBtn" data-i18n="feed.save_update">Save Update</button>
            </div>
        </div>
    </div>
</div>

                <!-- Profile View (Enhanced with 5 fields) -->
                <div id="profileView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="profile.title">Your Profile</h2>
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <h3 id="profileUsername">Username</h3>
                        </div>

                        <div class="profile-fields">
                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.bio">Bio</label>
                                <textarea class="profile-textarea" id="profileBio" data-i18n="profile.bio_placeholder" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.interests">Interests</label>
                                <textarea class="profile-textarea" id="profileInterests" data-i18n="profile.interests_placeholder" placeholder="What are you interested in?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.occupation">Occupation</label>
                                <input type="text" class="form-input" id="profileOccupation" data-i18n="profile.occupation_placeholder" placeholder="What do you do?">
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.goals">Goals</label>
                                <textarea class="profile-textarea" id="profileGoals" data-i18n="profile.goals_placeholder" placeholder="What are your personal or professional goals?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.hobbies">Favorite Hobbies</label>
                                <textarea class="profile-textarea" id="profileFavoriteHobbies" data-i18n="profile.hobbies_placeholder" placeholder="What do you love to do in your free time?" maxlength="300"></textarea>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" style="width: 200px;" id="updateProfileBtn" data-i18n="profile.save">Save Profile</button>
                        </div>
                    </div>
                </div>

                <!-- Circles View (Enhanced) -->
                <div id="circlesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="circles.title">Your Circles</h2>

                    <div class="user-search">
                        <input type="text" class="search-input" id="userSearchInput" data-i18n="circles.search_placeholder" placeholder="Search users to add to circles..." onkeyup="searchUsers()">
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <div class="circles-container">
                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.general">💥 General</span>
                                <span class="circle-count" id="generalCount">0</span>
                            </div>
                            <div class="circle-members" id="generalMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No members yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.close_friends">❤️ Close Friends</span>
                                <span class="circle-count" id="closeFriendsCount">0</span>
                            </div>
                            <div class="circle-members" id="closeFriendsMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No close friends yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.family">👨‍👩‍👧‍👦 Family</span>
                                <span class="circle-count" id="familyCount">0</span>
                            </div>
                            <div class="circle-members" id="familyMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No family members yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages View - Enhanced -->
                <div id="messagesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="messages.title">Messages</h2>
                    <div class="user-search" style="margin-bottom: 20px;">
                        <input type="text" class="search-input" id="messageUserSearch" data-i18n="messages.search_placeholder" placeholder="Search users to message..." onkeyup="searchUsersForMessage()">
                        <div class="search-results" id="messageSearchResults"></div>
                    </div>

                    <div class="messages-container">
                        <div class="conversations-list" id="conversationsList">
                            <div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">
                                No conversations yet
                            </div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader" data-i18n="messages.select_conversation">Select a conversation</div>
                            <div class="messages-list" id="messagesList">
                                <div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">
                                    Select a conversation to start messaging
                                </div>
                            </div>
                            <div class="message-input-area">
                                <input type="text" class="message-input" id="messageInput" data-i18n="messages.type_message" placeholder="Type a message..." disabled>
                                <button class="btn btn-primary" style="width: auto;" id="sendMessageBtn" disabled data-i18n="btn.send">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking/Parameters View (Enhanced with save/load) -->
                <div id="trackingView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="parameters.title">Wellness Parameters</h2>

                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="previousMonth()" data-i18n="calendar.prev">←</button>
                            <span id="currentMonth" style="font-weight: 600;">January 2025</span>
                            <button class="btn btn-secondary" onclick="nextMonth()" data-i18n="calendar.next">→</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                        <div style="text-align: center; margin-top: 15px;">
                            <p><span data-i18n="parameters.selected_date">Selected Date:</span> <strong id="selectedDateDisplay" data-i18n="feed.today">Today</strong></p>
                        </div>
                    </div>

                    <div id="parametersContainer" class="parameter-grid">
                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.mood">Mood</div>
                            <div id="moodInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.sleep">Sleep</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" class="parameter-input" id="sleepInput" data-i18n="parameters.sleep_placeholder" placeholder="Hours" min="0" max="24" step="0.5" style="width: 100px;">
                                <span style="color: white; font-weight: 600;" id="sleepDisplay"><span>0</span> <span data-i18n="parameters.sleep_hours">Hours</span></span>
                            </div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.exercise">Exercise</div>
                            <div id="exerciseInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.anxiety">Anxiety</div>
                            <input type="text" class="parameter-input" id="anxietyInput" data-i18n="parameters.anxiety_placeholder" placeholder="e.g., None, Mild, Moderate">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.energy">Energy</div>
                            <input type="text" class="parameter-input" id="energyInput" data-i18n="parameters.energy_placeholder" placeholder="e.g., Low, Normal, High">
                        </div>

                        <div class="parameter-card" style="grid-column: span 2;">
                            <div class="parameter-name" data-i18n="parameters.notes">Notes</div>
                            <textarea class="parameter-input" id="notesInput" data-i18n="parameters.notes_placeholder" placeholder="Additional notes..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveParameters()" data-i18n="parameters.save">Save Parameters</button>
                        <button class="btn btn-secondary" style="width: 200px;" onclick="loadParameters()" data-i18n="parameters.load">Load Parameters</button>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;" data-i18n="parameters.insights">Insights</h3>
                    <div id="insights"></div>
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <h3 style="margin-bottom: 15px;" data-i18n="alerts.title">Alerts</h3>
                <div class="alerts-list" id="alertsList"></div>
            </aside>
        </div>
    </div>

    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/parameters-social.js"></script>
    <script>
        // API Configuration
        const API_URL = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let isLoginMode = true;
        let selectedDate = new Date();
        let currentMonth = new Date();
        let savedDates = [];
        let currentRecipient = null;

        // Helper function to format message time with translation
      function formatMessageTime(timestamp) {
    try {
        if (!timestamp) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const now = new Date();
        const msgTime = new Date(timestamp);

        if (isNaN(msgTime.getTime())) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const diffSeconds = Math.floor((now - msgTime) / 1000);

        // Just now (less than 60 seconds)
        if (diffSeconds < 60) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.just_now') : 'Just now';
        }

        // Minutes ago
        if (diffSeconds < 3600) {
            const minutes = Math.floor(diffSeconds / 60);
            const minText = window.i18n && window.i18n.t ? window.i18n.t('messages.minutes_ago') : 'min ago';
            return `${minutes} ${minText}`;
        }

        // Hours ago (same day)
        if (msgTime.toDateString() === now.toDateString()) {
            return msgTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Yesterday
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (msgTime.toDateString() === yesterday.toDateString()) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.yesterday') : 'Yesterday';
        }

        // Older messages
        return msgTime.toLocaleDateString();
    } catch (error) {
        console.error('Error formatting time:', error);
        return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
    }
}

        // Feed Calendar Variables
        let feedSelectedDate = new Date();
        let feedCurrentMonth = new Date();
        let feedSavedDates = [];

        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);

                if (response.status === 401) {
                    showAuthContainer();
                    return null;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation Functions
        document.getElementById('navAbout').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('aboutPage').classList.remove('hidden');
        });

        document.getElementById('navSupport').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('supportPage').classList.remove('hidden');
        });

        document.getElementById('navHome').addEventListener('click', (e) => {
            e.preventDefault();
            goHome();
        });

        function goHome() {
            hideAllViews();
            if (currentUser) {
                document.getElementById('dashboard').style.display = 'block';
            } else {
                document.getElementById('authContainer').style.display = 'flex';
            }
        }

        function hideAllViews() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('aboutPage').classList.add('hidden');
            document.getElementById('supportPage').classList.add('hidden');
        }

        // Auth Functions
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                document.getElementById('authTitle').setAttribute('data-i18n', 'auth.welcome');
                document.getElementById('authSubmit').setAttribute('data-i18n', 'btn.signin');
                document.getElementById('usernameGroup').style.display = 'none';
                document.getElementById('toggleAuth').setAttribute('data-i18n', 'auth.toggle_signup');
            } else {
                document.getElementById('authTitle').setAttribute('data-i18n', 'auth.create');
                document.getElementById('authSubmit').setAttribute('data-i18n', 'btn.signup');
                document.getElementById('usernameGroup').style.display = 'block';
                document.getElementById('toggleAuth').setAttribute('data-i18n', 'auth.toggle_signin');
            }

            if (window.i18n && window.i18n.applyLanguage) {
                window.i18n.applyLanguage();
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const username = document.getElementById('usernameInput').value;

            try {
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                const body = { email, password };

                if (!isLoginMode) {
                    body.username = username || email.split('@')[0];
                    // Send current language selection
                    body.preferred_language = window.i18n && window.i18n.getCurrentLanguage ?
                        window.i18n.getCurrentLanguage() : 'en';
                }
                const response = await apiCall(endpoint, 'POST', body);

                if (response && response.success) {
                    currentUser = response.user;
                    showDashboard();
                }
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await apiCall('/auth/logout', 'POST');
            } catch (error) {
                // Ignore logout errors
            }

            currentUser = null;
            showAuthContainer();
        });

        function showAuthContainer() {
            hideAllViews();
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // Dashboard Functions
         function showDashboard() {
            hideAllViews();
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';

            if (currentUser && currentUser.username) {
                document.getElementById('profileAvatar').textContent = currentUser.username[0].toUpperCase();
                document.getElementById('profileUsername').textContent = currentUser.username;
            }

            initFeedCalendar();
            // Note: loadAlerts() now called from DOMContentLoaded after i18n check
        }

        // Sidebar Navigation
     // Sidebar Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

                const view = item.dataset.view;
                document.getElementById(`${view}View`).classList.remove('hidden');

                // Update mobile nav active state
                document.querySelectorAll('.mobile-nav-item').forEach(mobileItem => {
                    mobileItem.classList.remove('active');
                    if (mobileItem.dataset.view === view) {
                        mobileItem.classList.add('active');
                    }
                });

                switch(view) {
                    case 'feed':
                        initFeedCalendar();
                        break;
                    case 'profile':
                        loadProfile();
                        break;
                    case 'circles':
                        loadCircles();
                        break;
                    case 'messages':
                        loadConversations();
                        break;
                    case 'tracking':
                        initCalendar();
                        break;
                }
            });
        });

        // Mobile Navigation
        function showView(viewName) {
            // Update desktop sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });

            // Update mobile nav
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });

            // Show/hide views
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const selectedView = document.getElementById(`${viewName}View`);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }

            // Load view content
            switch(viewName) {
                case 'feed':
                    initFeedCalendar();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'circles':
                    loadCircles();
                    break;
                case 'messages':
                    loadConversations();
                    break;
                case 'parameters':
case 'tracking':
    initCalendar();
    break;
            }
        }

        // Feed Calendar Functions
        function initFeedCalendar() {
            loadFeedSavedDates();
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

        async function loadFeedSavedDates() {
            try {
                const response = await apiCall('/feed/dates');
                if (response) {
                    feedSavedDates = Object.keys(response.dates || {});
                }
            } catch (error) {
                console.error('Failed to load feed dates:', error);
            }
        }

        function renderFeedCalendar() {
            const year = feedCurrentMonth.getFullYear();
            const month = feedCurrentMonth.getMonth();

            // FIX: Use numeric month index directly
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + month) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

            document.getElementById('feedCurrentMonth').textContent = `${translatedMonth} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('feedCalendarGrid');
            grid.innerHTML = '';

            // FIX: Get day headers using individual day keys
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            dayNames.forEach(dayKey => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = window.i18n && window.i18n.translate ?
                    window.i18n.translate('day.' + dayKey) :
                    dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
                grid.appendChild(header);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'feed-calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (feedSavedDates.includes(dateStr)) {
                    dayCell.classList.add('has-posts');
                }

                if (feedSelectedDate.getDate() === day &&
                    feedSelectedDate.getMonth() === month &&
                    feedSelectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectFeedDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

        function selectFeedDate(year, month, day) {
            feedSelectedDate = new Date(year, month, day);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

        function updateFeedSelectedDateDisplay() {
            const date = feedSelectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('feedSelectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function feedPreviousMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() - 1);
            renderFeedCalendar();
        }

        function feedNextMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() + 1);
            renderFeedCalendar();
        }

        async function loadFeedForDate() {
            const dateStr = feedSelectedDate.toISOString().split('T')[0];
            const visibility = document.getElementById('visibilitySelect').value;

            try {
                const response = await apiCall(`/feed/${dateStr}?visibility=${visibility}`);

                if (response) {
                    document.getElementById('postInput').value = response.content || '';

                    if (response.content) {
                        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.loaded') : 'Loaded') + ` ${visibility.replace('_', ' ')} feed from ${dateStr}`);
                    } else {
                        alert((window.i18n && window.i18n.t ? window.i18n.t('feed.no_activity') : 'No activity') + ` for ${visibility.replace('_', ' ')} feed on this date`);
                    }
                }
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Feed Functions
        async function loadFeed() {
            try {
                const response = await apiCall('/feed');
                if (!response) return;

                const feedContainer = document.getElementById('feedPosts');
                feedContainer.innerHTML = '';

                if (response.posts && response.posts.length > 0) {
                    response.posts.forEach(post => {
                        const postCard = createPostCard(post);
                        feedContainer.appendChild(postCard);
                    });
                } else {
                    feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }

        function createPostCard(post) {
            const div = document.createElement('div');
            div.className = 'post-card fade-in';

            const author = post.author || 'Anonymous';
            const initial = author.charAt(0).toUpperCase();
            const timeAgo = getTimeAgo(new Date(post.created_at));

            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar">${initial}</div>
                    <div class="post-meta">
                        <div class="post-author">${author}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
            `;

            return div;
        }

        document.getElementById('postBtn').addEventListener('click', async () => {
            const content = document.getElementById('postInput').value.trim();
            const visibility = document.getElementById('visibilitySelect').value;

            if (!content) return;

            try {
                const dateStr = feedSelectedDate.toISOString().split('T')[0];

                await apiCall('/posts', 'POST', {
                    content: content,
                    visibility: visibility,
                    date: dateStr
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ' successfully!');
                loadFeedSavedDates();
                renderFeedCalendar();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Profile Functions
        async function loadProfile() {
            try {
                const response = await apiCall('/profile');
                if (!response) return;

                document.getElementById('profileBio').value = response.bio || '';
                document.getElementById('profileInterests').value = response.interests || '';
                document.getElementById('profileOccupation').value = response.occupation || '';
                document.getElementById('profileGoals').value = response.goals || '';
                document.getElementById('profileFavoriteHobbies').value = response.favorite_hobbies || '';
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const profileData = {
                bio: document.getElementById('profileBio').value,
                interests: document.getElementById('profileInterests').value,
                occupation: document.getElementById('profileOccupation').value,
                goals: document.getElementById('profileGoals').value,
                favorite_hobbies: document.getElementById('profileFavoriteHobbies').value
            };

            try {
                await apiCall('/profile', 'PUT', profileData);
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ' successfully!');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Circles Functions
        async function loadCircles() {
            try {
                const response = await apiCall('/circles');
                if (!response) return;

                updateCircleDisplay('general', response.general || []);
                updateCircleDisplay('close_friends', response.close_friends || []);
                updateCircleDisplay('family', response.family || []);
            } catch (error) {
                console.error('Failed to load circles:', error);
            }
        }

        function updateCircleDisplay(type, members) {
            let containerId, countId;

            if (type === 'general') {
                containerId = 'generalMembers';
                countId = 'generalCount';
            } else if (type === 'close_friends') {
                containerId = 'closeFriendsMembers';
                countId = 'closeFriendsCount';
            } else {
                containerId = 'familyMembers';
                countId = 'familyCount';
            }

            const container = document.getElementById(containerId);
            const count = document.getElementById(countId);

            count.textContent = members.length;

            if (members.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_members') : 'No members yet')}</p>`;
            } else {
                container.innerHTML = members.map(member => `
                    <div class="member-item">
                        <div class="member-avatar">${member.username[0].toUpperCase()}</div>
                        <span class="member-name">${member.username}</span>
                        <button class="remove-btn" onclick="removeFromCircle(${member.id}, '${type}')" data-i18n="circles.remove">${(window.i18n && window.i18n.t ? window.i18n.t('circles.remove') : 'Remove')}</button>
                    </div>
                `).join('');
            }
        }

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value;

            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('searchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" style="display: block; padding: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div class="member-avatar" style="margin-right: 10px;">${user.username[0].toUpperCase()}</div>
                                <div style="flex: 1;">
                                    <strong>${user.username}</strong><br>
                                    <small style="color: var(--gray);">${user.email}</small>
                                    ${user.bio ? `<br><small style="color: var(--gray); font-style: italic;">${user.bio.substring(0, 60)}${user.bio.length > 60 ? '...' : ''}</small>` : ''}
                                </div>
                            </div>
                            <select onchange="addToCircle(${user.id}, this.value, '${user.username}')" style="width: 100%;">
                                <option value="">${(window.i18n && window.i18n.t ? window.i18n.t('circles.add_to') : 'Add to circle...')}</option>
                                <option value="general">${(window.i18n && window.i18n.t ? window.i18n.t('visibility.general') : 'General')}</option>
                                <option value="close_friends">${(window.i18n && window.i18n.t ? window.i18n.t('visibility.close_friends') : 'Close Friends')}</option>
                                <option value="family">${(window.i18n && window.i18n.t ? window.i18n.t('visibility.family') : 'Family')}</option>
                            </select>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function addToCircle(userId, circleType, username) {
            if (!circleType) return;

            try {
                await apiCall('/circles', 'POST', {
                    user_id: userId,
                    circle_type: circleType
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + `! ${username} added to ${circleType.replace('_', ' ')} circle`);
                loadCircles();
                document.getElementById('userSearchInput').value = '';
                document.getElementById('searchResults').classList.remove('active');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        async function removeFromCircle(userId, circleType) {
            if (!confirm((window.i18n && window.i18n.t ? window.i18n.t('circles.remove') : 'Remove') + '?')) return;

            try {
                await apiCall('/circles/remove', 'DELETE', {
                    user_id: userId,
                    circle_type: circleType
                });

                loadCircles();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Messages Functions
        async function searchUsersForMessage() {
            const query = document.getElementById('messageUserSearch').value;

            if (query.length < 2) {
                document.getElementById('messageSearchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('messageSearchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" onclick="startConversation(${user.id}, '${user.username}')">
                            <strong>${user.username}</strong>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function startConversation(userId, username) {
            currentRecipient = { id: userId, username: username };
            document.getElementById('messageUserSearch').value = '';
            document.getElementById('messageSearchResults').classList.remove('active');
            loadMessages(userId, username);

            const convList = document.getElementById('conversationsList');
            const existingConv = Array.from(convList.children).find(
                child => child.dataset.userId == userId
            );

            if (!existingConv) {
                loadConversations();
            }
        }

   async function loadConversations() {
    try {
        const response = await apiCall('/messages/conversations');
        console.log('Conversations response:', response);
        if (!response) return;

        const container = document.getElementById('conversationsList');

        // Cache translation strings
       const noConversationsText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_conversations') : 'No conversations yet';
const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

        // FIX: response is already parsed JSON from apiCall, don't parse again
        const data = response;

        if (!data.conversations || data.conversations.length === 0) {
            container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">${noConversationsText}</div>`;
          } else {
            container.innerHTML = data.conversations.map(conv => {
                // Safely access nested properties with fallbacks
                const userId = conv.user && conv.user.id ? conv.user.id : 0;
                const username = conv.user && conv.user.username ? conv.user.username : 'Unknown User';
                const lastMessageCreatedAt = conv.last_message && conv.last_message.created_at ? conv.last_message.created_at : null;
              const lastMessageTime = lastMessageCreatedAt ? formatMessageTime(lastMessageCreatedAt) : '';
                const lastMessageContent = conv.last_message && conv.last_message.content ? conv.last_message.content : noMessagesText;
                const isOwn = conv.last_message && conv.last_message.is_own === true;
                const unreadCount = conv.unread_count || 0;

                // Prevent errors if userId or username is invalid
                if (!userId || !username) {
                    console.warn('Invalid conversation data:', conv);
                    return '';
                }

                // Escape HTML in username to prevent XSS
                const safeUsername = escapeHtml(username);

                return `
                    <div class="conversation-item" data-user-id="${userId}" onclick="loadMessages(${userId}, '${safeUsername}')">
                        <div class="conversation-header">
                            <span class="conversation-username">${safeUsername}</span>
                            <span class="conversation-time">${lastMessageTime}</span>
                        </div>
                        <div class="conversation-preview">
                            ${isOwn ? (youText + ': ') : ''}${escapeHtml(lastMessageContent.substring(0, 50))}${lastMessageContent.length > 50 ? '...' : ''}
                        </div>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                `;
            }).filter(html => html !== '').join('');

            if (currentRecipient && currentRecipient.id) {
                const activeItem = container.querySelector(`[data-user-id="${currentRecipient.id}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }
    } catch (error) {
        console.error('Failed to load conversations:', error);
        const container = document.getElementById('conversationsList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading conversations';
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--danger);">${errorText}</div>`;
    }
}

      async function loadMessages(userId, username) {
    // Validate inputs
    if (!userId || !username) {
        console.error('Invalid userId or username:', { userId, username });
        alert(window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error: Invalid user data');
        return;
    }

    currentRecipient = { id: userId, username: username };

    document.getElementById('chatHeader').textContent = username;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendMessageBtn').disabled = false;

    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.userId == userId) {
            item.classList.add('active');
        }
    });

    try {
        const response = await apiCall(`/messages?recipient_id=${userId}`);
        console.log('Messages response:', response);
        if (!response) return;

        const container = document.getElementById('messagesList');
       const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet. Start the conversation!';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

     if (response.messages && response.messages.length > 0) {
            container.innerHTML = response.messages.map(msg => {
                // Safely check if sender exists and get ID
                const senderId = msg.sender && msg.sender.id ? msg.sender.id : null;
                const currentUserId = currentUser && currentUser.id ? currentUser.id : null;
                const isOwn = senderId === currentUserId;
                const content = msg.content || '';
                const senderPrefix = isOwn ? youText : (msg.sender && msg.sender.username ? msg.sender.username : 'Unknown');

                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        <div class="message-bubble">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; opacity: 0.8;">${escapeHtml(senderPrefix)}</div>
                            <div>${escapeHtml(content)}</div>
                            <div class="message-time">${formatMessageTime(msg.created_at)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">${noMessagesText}</div>`;
        }

        container.scrollTop = container.scrollHeight;

        await apiCall(`/messages/read/${userId}`, 'POST');
        loadConversations();
    } catch (error) {
        console.error('Failed to load messages:', error);
        const container = document.getElementById('messagesList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading messages';
        container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--danger);">${errorText}</div>`;
    }
}

    document.getElementById('sendMessageBtn').addEventListener('click', async () => {
    // Check if recipient is selected
    if (!currentRecipient || !currentRecipient.id) {
       const errorText = window.i18n && window.i18n.t ? window.i18n.t('messages.select_conversation') : 'Please select a conversation first';
        alert(errorText);
        return;
    }

    const content = document.getElementById('messageInput').value.trim();
    if (!content) return;

    try {
        const response = await apiCall('/messages', 'POST', {
            recipient_id: currentRecipient.id,
            content: content
        });

        // Validate response before proceeding
        if (response && response.success) {
            document.getElementById('messageInput').value = '';
            await loadMessages(currentRecipient.id, currentRecipient.username);
            await loadConversations();
        } else {
            throw new Error(response && response.error ? response.error : 'Failed to send message');
        }
    } catch (error) {
        console.error('Send message error:', error);
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error';
        alert(errorText + ': ' + (error.message || 'Failed to send message'));
    }
});

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Parameters/Tracking Functions
        function initCalendar() {
            loadSavedDates();
            renderCalendar();
            updateSelectedDateDisplay();
        }

        async function loadSavedDates() {
            try {
                const response = await apiCall('/parameters/dates');
                if (response) {
                    savedDates = response.dates || [];
                }
            } catch (error) {
                console.error('Failed to load saved dates:', error);
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            // FIX: Use numeric month index directly
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + month) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

            document.getElementById('currentMonth').textContent = `${translatedMonth} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // FIX: Get day headers using individual day keys
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            dayNames.forEach(dayKey => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = window.i18n && window.i18n.translate ?
                    window.i18n.translate('day.' + dayKey) :
                    dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
                grid.appendChild(header);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (savedDates.includes(dateStr)) {
                    dayCell.classList.add('has-data');
                }

                if (selectedDate.getDate() === day &&
                    selectedDate.getMonth() === month &&
                    selectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            renderCalendar();
            updateSelectedDateDisplay();
        }

        function updateSelectedDateDisplay() {
            const date = selectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('selectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        document.getElementById('sleepInput').addEventListener('input', (e) => {
            const hours = e.target.value || 0;
            const hoursText = window.i18n && window.i18n.t ? window.i18n.t('parameters.sleep_hours') : 'Hours';
            document.getElementById('sleepDisplay').innerHTML = `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;
        });

        async function saveParameters() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            const parameters = {
                date: dateStr,
                mood: document.getElementById('moodInput').value,
                sleep_hours: parseFloat(document.getElementById('sleepInput').value) || 0,
                exercise: document.getElementById('exerciseInput').value,
                anxiety: document.getElementById('anxietyInput').value,
                energy: document.getElementById('energyInput').value,
                notes: document.getElementById('notesInput').value
            };

            try {
                await apiCall('/parameters/save', 'POST', parameters);
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ` for ${dateStr}`);
                loadSavedDates();
                renderCalendar();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        async function loadParameters() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            try {
                const response = await apiCall(`/parameters/load/${dateStr}`);

                if (response && response.success) {
                    const data = response.data;
                    document.getElementById('moodInput').value = data.mood || '';
                    document.getElementById('sleepInput').value = data.sleep_hours || '';
                    document.getElementById('exerciseInput').value = data.exercise || '';
                    document.getElementById('anxietyInput').value = data.anxiety || '';
                    document.getElementById('energyInput').value = data.energy || '';
                    document.getElementById('notesInput').value = data.notes || '';

                    const hours = data.sleep_hours || 0;
                    const hoursText = window.i18n && window.i18n.t ? window.i18n.t('parameters.sleep_hours') : 'Hours';
                    document.getElementById('sleepDisplay').innerHTML = `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;

                    console.log('Parameters loaded from', dateStr);
                } else {
                    alert((window.i18n && window.i18n.t ? window.i18n.t('parameters.no_data') : 'No data') + ' for this date');
                }
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Alerts Functions
  async function loadAlerts() {
            try {
                const response = await apiCall('/alerts');
                if (!response) return;

                const container = document.getElementById('alertsList');

                if (!response.alerts || response.alerts.length === 0) {
                    container.innerHTML = `<p style="color: var(--gray);" data-i18n="alerts.no_alerts">${translateKey('alerts.no_alerts')}</p>`;
                } else {
                    container.innerHTML = response.alerts.map(alert => {
                        let title = alert.title || '';
                        let content = alert.message || alert.content || '';

                        // Handle JSON-structured titles (new format from backend)
                        try {
                            const titleData = JSON.parse(title);
                            if (titleData.key && titleData.params) {
                                const translatedBase = translateKey(titleData.key);
                                if (titleData.params.username) {
                                    title = `${translatedBase} ${titleData.params.username}`;
                                } else {
                                    title = translatedBase;
                                }
                            }
                        } catch (e) {
                            // Not JSON, handle as plain string
                            if (title.startsWith('alerts.')) {
                                title = translateKey(title);
                            }
                            // Handle legacy "New message from" format (old alerts in DB)
                            else if (title.startsWith('New message from ')) {
                                const username = title.replace('New message from ', '');
                                title = `${translateKey('alerts.new_message_from')} ${username}`;
                            }
                        }

                        // Translate content if it's a key
                        if (content.startsWith('alerts.')) {
                            content = translateKey(content);
                        }

                        return `
                            <div class="alert-item ${alert.type || 'info'}">
                                <strong>${escapeHtml(title)}</strong><br>
                                <small>${escapeHtml(content)}</small>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        // Helper function for translations - place this RIGHT AFTER loadAlerts()
        function translateKey(key) {
            if (window.i18n && window.i18n.translate) {
                return window.i18n.translate(key);
            }
            return key;
        }

        // Support Form
        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const subject = document.getElementById('supportSubject').value;
            const message = document.getElementById('supportMessage').value;

            try {
                await apiCall('/support/contact', 'POST', {
                    subject: subject,
                    message: message
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.sent') : 'Message sent') + ' successfully!');
                document.getElementById('supportForm').reset();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }



        // Check authentication on load
    // Check authentication on load
// Check authentication on load
window.addEventListener('DOMContentLoaded', async () => {
    // Wait for i18n to be ready (max 1 second)
    let i18nReady = false;
    let attempts = 0;
    while (!i18nReady && attempts < 20) {
        if (window.i18n && window.i18n.translate) {
            i18nReady = true;
        } else {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
        }
    }

    if (!i18nReady) {
        console.warn('i18n not loaded in time, using fallback');
    }

    // Set up language selector event listener
    const langSelector = document.getElementById('languageSelector');
    if (langSelector) {
        langSelector.addEventListener('change', function() {
            if (window.i18n && window.i18n.setLanguage) {
                window.i18n.setLanguage(this.value);
            }
        });
    }

    try {
        const response = await fetch(`${API_URL}/auth/session`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data && data.authenticated) {
                currentUser = data.user;
                showDashboard();
                // Load alerts AFTER dashboard is shown and i18n is ready
                await loadAlerts();
            } else {
                showAuthContainer();
            }
        } else if (response.status === 401) {
            showAuthContainer();
        } else {
            console.error('Session check failed:', response.status);
            showAuthContainer();
        }
    } catch (error) {
        console.error('Session check error:', error);
        showAuthContainer();
    }
});

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchResults = document.getElementById('searchResults');
            const messageSearchResults = document.getElementById('messageSearchResults');

            if (searchResults && !searchResults.contains(e.target) && e.target.id !== 'userSearchInput') {
                searchResults.classList.remove('active');
            }

            if (messageSearchResults && !messageSearchResults.contains(e.target) && e.target.id !== 'messageUserSearch') {
                messageSearchResults.classList.remove('active');
            }
        });

        // Auto-refresh alerts
        setInterval(() => {
            if (currentUser) {
                loadAlerts().catch(() => {});
            }
        }, 30000);

        // Listen for language changes
  // Listen for language changes
   window.addEventListener('languageChanged', () => {
    if (document.getElementById('feedView').classList.contains('hidden') === false) {
        renderFeedCalendar();
        updateFeedSelectedDateDisplay();
    }
    if (document.getElementById('trackingView').classList.contains('hidden') === false) {
        renderCalendar();
        updateSelectedDateDisplay();
    }
    // Reload alerts to apply new translations
    if (currentUser) {
        loadAlerts().catch(() => {});
    }
    // Reload conversations to apply new translations
    if (document.getElementById('messagesView') && !document.getElementById('messagesView').classList.contains('hidden')) {
        loadConversations();
        if (currentRecipient && currentRecipient.id) {
            loadMessages(currentRecipient.id, currentRecipient.username);
        }
    }
});
    </script>
</body>
</html>