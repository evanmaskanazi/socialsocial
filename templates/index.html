<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thera Social - Anonymous Wellness Community</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #EC4899;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        /* Auth Forms */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 70px);
        }

        .auth-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            margin-top: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar-item:hover {
            background: var(--light);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
        }

        /* Feed - Enhanced with Calendar */
        .feed-calendar-section {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feed-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .feed-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .feed-calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--white);
        }

        .feed-calendar-day:hover {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.has-posts::after {
            content: '•';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        .post-form {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            align-items: center;
        }

        .visibility-select {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            background: var(--white);
        }

        .post-card {
            background: var(--white);
            border: 1px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .post-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 12px;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--dark);
        }

        .post-time {
            font-size: 12px;
            color: var(--gray);
        }

        .post-content {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Enhanced Profile Section */
        .profile-section {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 15px;
        }

        .profile-fields {
            display: grid;
            gap: 20px;
        }

        .profile-field {
            position: relative;
        }

        .profile-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Parameters with Calendar */
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
        }

        .parameter-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .parameter-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .parameter-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
        }

        .calendar-section {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--light);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-day.has-data::after {
            content: '•';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        /* Enhanced Circles */
        .circles-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .circle-card {
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .circle-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .circle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .circle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .circle-count {
            background: var(--primary);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .circle-members {
            max-height: 200px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .member-item:hover {
            background: var(--light);
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 12px;
        }

        .member-name {
            flex: 1;
        }

        .remove-btn {
            background: var(--danger);
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .member-item:hover .remove-btn {
            opacity: 1;
        }

        .user-search {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        /* Messages - Enhanced */
        .messages-container {
            display: flex;
            height: 600px;
        }

        .conversations-list {
            width: 300px;
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--light);
        }

        .conversation-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .conversation-username {
            font-weight: 600;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--gray);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .unread-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            font-weight: 600;
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            background: var(--light);
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: var(--white);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
        }

        /* Right Sidebar */
        .right-sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
        }

        .alert-item.high {
            border-left-color: var(--danger);
        }

        .alert-item.low {
            border-left-color: var(--success);
        }

        /* About and Support Pages */
        .page-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.2);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .sidebar, .right-sidebar {
                display: none;
            }

            .messages-container {
                flex-direction: column;
            }

            .conversations-list {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">🧠 Thera Social</div>
            <div class="nav-menu">
                <a href="#" class="nav-link" id="navHome">Home</a>
                <a href="#" class="nav-link" id="navAbout">About</a>
                <a href="#" class="nav-link" id="navSupport">Support</a>
                <button class="btn btn-primary" id="logoutBtn" style="display: none; width: auto;">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card fade-in">
            <h2 class="auth-title" id="authTitle">Welcome Back</h2>
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="emailInput" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="passwordInput" autocomplete="current-password" required>
                </div>
                <div class="form-group" id="usernameGroup" style="display: none;">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="usernameInput" autocomplete="username" placeholder="Choose a username">
                </div>
                <button type="submit" class="btn btn-primary" id="authSubmit">Sign In</button>
            </form>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" id="toggleAuth" style="color: var(--primary);">New here? Create an account</a>
            </p>
        </div>
    </div>

    <!-- About Page -->
    <div id="aboutPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title">About Thera Social</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;">
                Your safe space for wellness, connection, and personal growth
            </p>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🛡️</div>
                    <h3>Privacy First</h3>
                    <p>Your wellness journey is private and secure. Share only what you're comfortable with.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3>Track Progress</h3>
                    <p>Monitor your wellness parameters and see your growth over time with insights.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">👥</div>
                    <h3>Supportive Community</h3>
                    <p>Connect with others on similar journeys in a judgment-free environment.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">💬</div>
                    <h3>Safe Communication</h3>
                    <p>Private messaging and circles let you control who sees your content.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🎯</div>
                    <h3>Goal Setting</h3>
                    <p>Set and track personal goals with community support and accountability.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🌟</div>
                    <h3>Daily Check-ins</h3>
                    <p>Regular parameter tracking helps you understand patterns and triggers.</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" style="width: 200px;" onclick="goHome()">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Support Page -->
    <div id="supportPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title">Support Center</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;">
                We're here to help you on your wellness journey
            </p>

            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">How do I track my wellness parameters?</h4>
                    <p style="color: var(--gray);">Navigate to the Parameters tab in your dashboard. You can input daily values for mood, sleep, exercise, anxiety, and energy levels. Use the calendar to save and load parameters for different dates.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">What are Circles?</h4>
                    <p style="color: var(--gray);">Circles allow you to organize your connections into groups: General, Close Friends, and Family. You can control who sees your posts based on these circles.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">How do I update my profile?</h4>
                    <p style="color: var(--gray);">Go to the Profile tab to update your bio, interests, occupation, goals, and favorite hobbies. These help others understand you better.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">Is my data private?</h4>
                    <p style="color: var(--gray);">Yes! We take privacy seriously. Your wellness data is encrypted and only visible to you unless you choose to share it.</p>
                </div>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Contact Support</h3>
                <form id="supportForm">
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="supportSubject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-input" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </form>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" style="width: 200px;" onclick="goHome()">Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard container">
        <div class="dashboard-grid">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" data-view="feed">
                        <i>📱</i> Feed
                    </li>
                    <li class="sidebar-item" data-view="profile">
                        <i>👤</i> Profile
                    </li>
                    <li class="sidebar-item" data-view="circles">
                        <i>👥</i> Circles
                    </li>
                    <li class="sidebar-item" data-view="messages">
                        <i>💬</i> Messages
                    </li>
                    <li class="sidebar-item" data-view="tracking">
                        <i>📊</i> Parameters
                    </li>
                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
              <!-- Feed View - Date-Based Journal -->
<div id="feedView" class="view">
    <h2 style="margin-bottom: 20px;">Your Feed Journal</h2>
    <p style="color: var(--gray); margin-bottom: 20px;">Save your thoughts for each day. Select a date from the calendar, write your update, and save it. Green dots show dates with saved entries.</p>

    <!-- Feed Calendar -->
    <div class="feed-calendar-section">
        <div class="feed-calendar-header">
            <button class="btn btn-secondary" onclick="feedPreviousMonth()">←</button>
            <span id="feedCurrentMonth" style="font-weight: 600;">January 2025</span>
            <button class="btn btn-secondary" onclick="feedNextMonth()">→</button>
        </div>
        <div class="feed-calendar-grid" id="feedCalendarGrid"></div>
        <div style="text-align: center; margin-top: 15px;">
            <p>Selected Date: <strong id="feedSelectedDateDisplay">Today</strong></p>
        </div>
    </div>

    <!-- Post Form -->
    <div class="post-form">
        <textarea class="post-input" placeholder="How are you feeling today?" id="postInput"></textarea>
        <div class="post-actions">
            <select class="visibility-select" id="visibilitySelect">
                <option value="general">General</option>
                <option value="close_friends">Close Friends</option>
                <option value="family">Family</option>
                <option value="private">Private</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: auto;" onclick="loadFeedForDate()">Load Update</button>
                <button class="btn btn-primary" style="width: auto;" id="postBtn">Save Update</button>
            </div>
        </div>
    </div>
</div>

                <!-- Profile View (Enhanced with 5 fields) -->
                <div id="profileView" class="view hidden">
                    <h2 style="margin-bottom: 20px;">Your Profile</h2>
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <h3 id="profileUsername">Username</h3>
                        </div>

                        <div class="profile-fields">
                            <div class="form-group">
                                <label class="form-label">Bio</label>
                                <textarea class="profile-textarea" id="profileBio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Interests</label>
                                <textarea class="profile-textarea" id="profileInterests" placeholder="What are you interested in?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Occupation</label>
                                <input type="text" class="form-input" id="profileOccupation" placeholder="What do you do?">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Goals</label>
                                <textarea class="profile-textarea" id="profileGoals" placeholder="What are your personal or professional goals?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Favorite Hobbies</label>
                                <textarea class="profile-textarea" id="profileFavoriteHobbies" placeholder="What do you love to do in your free time?" maxlength="300"></textarea>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" style="width: 200px;" id="updateProfileBtn">Save Profile</button>
                        </div>
                    </div>
                </div>

                <!-- Circles View (Enhanced) -->
                <div id="circlesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;">Your Circles</h2>

                    <div class="user-search">
                        <input type="text" class="search-input" id="userSearchInput" placeholder="Search users to add to circles..." onkeyup="searchUsers()">
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <div class="circles-container">
                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">👥 General</span>
                                <span class="circle-count" id="generalCount">0</span>
                            </div>
                            <div class="circle-members" id="generalMembers">
                                <p style="text-align: center; color: var(--gray);">No members yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">❤️ Close Friends</span>
                                <span class="circle-count" id="closeFriendsCount">0</span>
                            </div>
                            <div class="circle-members" id="closeFriendsMembers">
                                <p style="text-align: center; color: var(--gray);">No close friends yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">👨‍👩‍👧‍👦 Family</span>
                                <span class="circle-count" id="familyCount">0</span>
                            </div>
                            <div class="circle-members" id="familyMembers">
                                <p style="text-align: center; color: var(--gray);">No family members yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages View - Enhanced -->
                <div id="messagesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;">Messages</h2>
                    <div class="user-search" style="margin-bottom: 20px;">
                        <input type="text" class="search-input" id="messageUserSearch" placeholder="Search users to message..." onkeyup="searchUsersForMessage()">
                        <div class="search-results" id="messageSearchResults"></div>
                    </div>

                    <div class="messages-container">
                        <div class="conversations-list" id="conversationsList">
                            <div style="padding: 20px; text-align: center; color: var(--gray);">
                                No conversations yet
                            </div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader">Select a conversation</div>
                            <div class="messages-list" id="messagesList">
                                <div style="text-align: center; padding: 50px; color: var(--gray);">
                                    Select a conversation to start messaging
                                </div>
                            </div>
                            <div class="message-input-area">
                                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." disabled>
                                <button class="btn btn-primary" style="width: auto;" id="sendMessageBtn" disabled>Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking/Parameters View (Enhanced with save/load) -->
                <div id="trackingView" class="view hidden">
                    <h2 style="margin-bottom: 20px;">Wellness Parameters</h2>

                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="previousMonth()">←</button>
                            <span id="currentMonth" style="font-weight: 600;">January 2025</span>
                            <button class="btn btn-secondary" onclick="nextMonth()">→</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                        <div style="text-align: center; margin-top: 15px;">
                            <p>Selected Date: <strong id="selectedDateDisplay">Today</strong></p>
                        </div>
                    </div>

                    <div class="parameter-grid">
                        <div class="parameter-card">
                            <div class="parameter-name">Mood</div>
                            <input type="text" class="parameter-input" id="moodInput" placeholder="e.g., Happy, Calm, Anxious">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name">Sleep</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" class="parameter-input" id="sleepInput" placeholder="Hours" min="0" max="24" step="0.5" style="width: 100px;">
                                <span style="color: white; font-weight: 600;" id="sleepDisplay">0 Hours</span>
                            </div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name">Exercise</div>
                            <input type="text" class="parameter-input" id="exerciseInput" placeholder="e.g., Running, Yoga, Gym">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name">Anxiety</div>
                            <input type="text" class="parameter-input" id="anxietyInput" placeholder="e.g., None, Mild, Moderate">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name">Energy</div>
                            <input type="text" class="parameter-input" id="energyInput" placeholder="e.g., Low, Normal, High">
                        </div>

                        <div class="parameter-card" style="grid-column: span 2;">
                            <div class="parameter-name">Notes</div>
                            <textarea class="parameter-input" id="notesInput" placeholder="Additional notes..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveParameters()">Save Parameters</button>
                        <button class="btn btn-secondary" style="width: 200px;" onclick="loadParameters()">Load Parameters</button>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Insights</h3>
                    <div id="insights"></div>
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <h3 style="margin-bottom: 15px;">Alerts</h3>
                <div class="alerts-list" id="alertsList"></div>
            </aside>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let isLoginMode = true;
        let selectedDate = new Date();
        let currentMonth = new Date();
        let savedDates = [];
        let currentRecipient = null;

        // Feed Calendar Variables
        let feedSelectedDate = new Date();
        let feedCurrentMonth = new Date();
        let feedSavedDates = [];

        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);

                if (response.status === 401) {
                    // Not authenticated
                    showAuthContainer();
                    return null;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation Functions
        document.getElementById('navAbout').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('aboutPage').classList.remove('hidden');
        });

        document.getElementById('navSupport').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('supportPage').classList.remove('hidden');
        });

        document.getElementById('navHome').addEventListener('click', (e) => {
            e.preventDefault();
            goHome();
        });

        function goHome() {
            hideAllViews();
            if (currentUser) {
                document.getElementById('dashboard').style.display = 'block';
            } else {
                document.getElementById('authContainer').style.display = 'flex';
            }
        }

        function hideAllViews() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('aboutPage').classList.add('hidden');
            document.getElementById('supportPage').classList.add('hidden');
        }

        // Auth Functions
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                document.getElementById('authTitle').textContent = 'Welcome Back';
                document.getElementById('authSubmit').textContent = 'Sign In';
                document.getElementById('usernameGroup').style.display = 'none';
                document.getElementById('toggleAuth').textContent = 'New here? Create an account';
            } else {
                document.getElementById('authTitle').textContent = 'Create Account';
                document.getElementById('authSubmit').textContent = 'Sign Up';
                document.getElementById('usernameGroup').style.display = 'block';
                document.getElementById('toggleAuth').textContent = 'Already have an account? Sign in';
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const username = document.getElementById('usernameInput').value;

            try {
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                const body = { email, password };

                if (!isLoginMode) {
                    body.username = username || email.split('@')[0];
                }

                const response = await apiCall(endpoint, 'POST', body);

                if (response && response.success) {
                    currentUser = response.user;
                    showDashboard();
                }
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await apiCall('/auth/logout', 'POST');
            } catch (error) {
                // Ignore logout errors
            }

            currentUser = null;
            showAuthContainer();
        });

        function showAuthContainer() {
            hideAllViews();
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // Dashboard Functions
        function showDashboard() {
            hideAllViews();
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';

            // Update profile avatar
            if (currentUser && currentUser.username) {
                document.getElementById('profileAvatar').textContent = currentUser.username[0].toUpperCase();
                document.getElementById('profileUsername').textContent = currentUser.username;
            }

            initFeedCalendar();

            loadAlerts();
        }

        // Sidebar Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Hide all views
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

                // Show selected view
                const view = item.dataset.view;
                document.getElementById(`${view}View`).classList.remove('hidden');

                // Load view data
                switch(view) {
                    case 'feed':
                        initFeedCalendar();
                        
                        break;
                    case 'profile':
                        loadProfile();
                        break;
                    case 'circles':
                        loadCircles();
                        break;
                    case 'messages':
                        loadConversations();
                        break;
                    case 'tracking':
                        initCalendar();
                        break;
                }
            });
        });

        // Feed Calendar Functions
        function initFeedCalendar() {
            loadFeedSavedDates();
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

        async function loadFeedSavedDates() {
    try {
        const response = await apiCall('/feed/dates');
        if (response) {
            feedSavedDates = Object.keys(response.dates || {});
        }
    } catch (error) {
        console.error('Failed to load feed dates:', error);
    }
}

        function renderFeedCalendar() {
            const year = feedCurrentMonth.getFullYear();
            const month = feedCurrentMonth.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('feedCurrentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('feedCalendarGrid');
            grid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'feed-calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (feedSavedDates.includes(dateStr)) {
                    dayCell.classList.add('has-posts');
                }

                if (feedSelectedDate.getDate() === day &&
                    feedSelectedDate.getMonth() === month &&
                    feedSelectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectFeedDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

        function selectFeedDate(year, month, day) {
            feedSelectedDate = new Date(year, month, day);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

        function updateFeedSelectedDateDisplay() {
            const dateStr = feedSelectedDate.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('feedSelectedDateDisplay').textContent = dateStr;
        }

        function feedPreviousMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() - 1);
            renderFeedCalendar();
        }

        function feedNextMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() + 1);
            renderFeedCalendar();
        }

      async function loadFeedForDate() {
    const dateStr = feedSelectedDate.toISOString().split('T')[0];
    const visibility = document.getElementById('visibilitySelect').value;

    try {
        // Use the new load endpoint with visibility parameter
        const response = await apiCall(`/feed/${dateStr}?visibility=${visibility}`);

        if (response) {
            // Load the content into the textarea
            document.getElementById('postInput').value = response.content || '';

            if (response.content) {
                alert(`Loaded ${visibility.replace('_', ' ')} feed from ${dateStr}`);
            } else {
                alert(`No ${visibility.replace('_', ' ')} feed for this date`);
            }
        }
    } catch (error) {
        alert('Failed to load feed: ' + error.message);
    }
}

        // Feed Functions
        async function loadFeed() {
            try {
                const response = await apiCall('/feed');
                if (!response) return;

                const feedContainer = document.getElementById('feedPosts');
                feedContainer.innerHTML = '';

                if (response.posts && response.posts.length > 0) {
                    response.posts.forEach(post => {
                        const postCard = createPostCard(post);
                        feedContainer.appendChild(postCard);
                    });
                } else {
                    feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }

        function createPostCard(post) {
            const div = document.createElement('div');
            div.className = 'post-card fade-in';

            const author = post.author || 'Anonymous';
            const initial = author.charAt(0).toUpperCase();
            const timeAgo = getTimeAgo(new Date(post.created_at));

            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar">${initial}</div>
                    <div class="post-meta">
                        <div class="post-author">${author}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
            `;

            return div;
        }

    document.getElementById('postBtn').addEventListener('click', async () => {
    const content = document.getElementById('postInput').value.trim();
    const visibility = document.getElementById('visibilitySelect').value;

    if (!content) return;

    try {
        const dateStr = feedSelectedDate.toISOString().split('T')[0];

        await apiCall('/posts', 'POST', {
            content: content,
            visibility: visibility,
            date: dateStr
        });

        alert('Feed saved successfully!');
        loadFeedSavedDates();
        renderFeedCalendar();
    } catch (error) {
        alert('Failed to save feed: ' + error.message);
    }
});

        // Profile Functions (Enhanced) - CORRECTED field name
        async function loadProfile() {
            try {
                const response = await apiCall('/profile');
                if (!response) return;

                document.getElementById('profileBio').value = response.bio || '';
                document.getElementById('profileInterests').value = response.interests || '';
                document.getElementById('profileOccupation').value = response.occupation || '';
                document.getElementById('profileGoals').value = response.goals || '';
                document.getElementById('profileFavoriteHobbies').value = response.favorite_hobbies || '';
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const profileData = {
                bio: document.getElementById('profileBio').value,
                interests: document.getElementById('profileInterests').value,
                occupation: document.getElementById('profileOccupation').value,
                goals: document.getElementById('profileGoals').value,
                favorite_hobbies: document.getElementById('profileFavoriteHobbies').value
            };

            try {
                await apiCall('/profile', 'PUT', profileData);
                alert('Profile updated successfully!');
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        });

        // Circles Functions (Enhanced)
        async function loadCircles() {
            try {
                const response = await apiCall('/circles');
                if (!response) return;

                updateCircleDisplay('general', response.general || []);
                updateCircleDisplay('close_friends', response.close_friends || []);
                updateCircleDisplay('family', response.family || []);
            } catch (error) {
                console.error('Failed to load circles:', error);
            }
        }

        function updateCircleDisplay(type, members) {
            let containerId, countId;

            if (type === 'general') {
                containerId = 'generalMembers';
                countId = 'generalCount';
            } else if (type === 'close_friends') {
                containerId = 'closeFriendsMembers';
                countId = 'closeFriendsCount';
            } else {
                containerId = 'familyMembers';
                countId = 'familyCount';
            }

            const container = document.getElementById(containerId);
            const count = document.getElementById(countId);

            count.textContent = members.length;

            if (members.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">No members yet</p>';
            } else {
                container.innerHTML = members.map(member => `
                    <div class="member-item">
                        <div class="member-avatar">${member.username[0].toUpperCase()}</div>
                        <span class="member-name">${member.username}</span>
                        <button class="remove-btn" onclick="removeFromCircle(${member.id}, '${type}')">Remove</button>
                    </div>
                `).join('');
            }
        }

      async function searchUsers() {
    const query = document.getElementById('userSearchInput').value;

    if (query.length < 2) {
        document.getElementById('searchResults').classList.remove('active');
        return;
    }

    try {
        const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
        if (!response) return;

        const container = document.getElementById('searchResults');

        if (response.users.length === 0) {
            container.innerHTML = '<div class="search-result-item">No users found</div>';
        } else {
            container.innerHTML = response.users.map(user => `
                <div class="search-result-item" style="display: block; padding: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <div class="member-avatar" style="margin-right: 10px;">${user.username[0].toUpperCase()}</div>
                        <div style="flex: 1;">
                            <strong>${user.username}</strong><br>
                            <small style="color: var(--gray);">${user.email}</small>
                            ${user.bio ? `<br><small style="color: var(--gray); font-style: italic;">${user.bio.substring(0, 60)}${user.bio.length > 60 ? '...' : ''}</small>` : ''}
                        </div>
                    </div>
                    <select onchange="addToCircle(${user.id}, this.value, '${user.username}')" style="width: 100%;">
                        <option value="">Add to circle...</option>
                        <option value="general">General</option>
                        <option value="close_friends">Close Friends</option>
                        <option value="family">Family</option>
                    </select>
                </div>
            `).join('');
        }

        container.classList.add('active');
    } catch (error) {
        console.error('Failed to search users:', error);
    }
}

        async function addToCircle(userId, circleType, username) {
            if (!circleType) return;

            try {
                await apiCall('/circles', 'POST', {
                    user_id: userId,
                    circle_type: circleType
                });

                alert(`${username} added to ${circleType.replace('_', ' ')} circle!`);
                loadCircles();
                document.getElementById('userSearchInput').value = '';
                document.getElementById('searchResults').classList.remove('active');
            } catch (error) {
                alert('Failed to add to circle: ' + error.message);
            }
        }

        async function removeFromCircle(userId, circleType) {
            if (!confirm('Remove this user from the circle?')) return;

            try {
                await apiCall('/circles/remove', 'DELETE', {
                    user_id: userId,
                    circle_type: circleType
                });

                loadCircles();
            } catch (error) {
                alert('Failed to remove from circle: ' + error.message);
            }
        }

        // Messages Functions - Enhanced
        async function searchUsersForMessage() {
            const query = document.getElementById('messageUserSearch').value;

            if (query.length < 2) {
                document.getElementById('messageSearchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('messageSearchResults');

                if (response.users.length === 0) {
                    container.innerHTML = '<div class="search-result-item">No users found</div>';
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" onclick="startConversation(${user.id}, '${user.username}')">
                            <strong>${user.username}</strong>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function startConversation(userId, username) {
            currentRecipient = { id: userId, username: username };
            document.getElementById('messageUserSearch').value = '';
            document.getElementById('messageSearchResults').classList.remove('active');
            loadMessages(userId, username);

            // If conversation doesn't exist, add it to the list
            const convList = document.getElementById('conversationsList');
            const existingConv = Array.from(convList.children).find(
                child => child.dataset.userId == userId
            );

            if (!existingConv) {
                loadConversations();
            }
        }

        async function loadConversations() {
            try {
                const response = await apiCall('/messages/conversations');
                if (!response) return;

                const container = document.getElementById('conversationsList');

                if (response.conversations && response.conversations.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">No conversations yet</div>';
                } else if (response.conversations) {
                    container.innerHTML = response.conversations.map(conv => {
                        const lastMessageTime = conv.last_message && conv.last_message.created_at ?
                            getTimeAgo(new Date(conv.last_message.created_at)) : '';
                        const lastMessageContent = conv.last_message && conv.last_message.content ?
                            conv.last_message.content : 'No messages yet';
                        const isOwn = conv.last_message && conv.last_message.is_own;

                        return `
                            <div class="conversation-item" data-user-id="${conv.user.id}" onclick="loadMessages(${conv.user.id}, '${conv.user.username}')">
                                <div class="conversation-header">
                                    <span class="conversation-username">${conv.user.username}</span>
                                    <span class="conversation-time">${lastMessageTime}</span>
                                </div>
                                <div class="conversation-preview">
                                    ${isOwn ? 'You: ' : ''}${lastMessageContent.substring(0, 50)}${lastMessageContent.length > 50 ? '...' : ''}
                                </div>
                                ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count}</span>` : ''}
                            </div>
                        `;
                    }).join('');

                    // Update active state
                    if (currentRecipient) {
                        const activeItem = container.querySelector(`[data-user-id="${currentRecipient.id}"]`);
                        if (activeItem) {
                            activeItem.classList.add('active');
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        async function loadMessages(userId, username) {
            currentRecipient = { id: userId, username: username };

            // Update UI
            document.getElementById('chatHeader').textContent = username;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;

            // Update active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.userId == userId) {
                    item.classList.add('active');
                }
            });

            try {
                const response = await apiCall(`/messages?recipient_id=${userId}`);
                if (!response) return;

                const container = document.getElementById('messagesList');

                if (response.messages && response.messages.length > 0) {
                    container.innerHTML = response.messages.map(msg => `
                        <div class="message ${msg.sender.id === currentUser.id ? 'own' : ''}">
                            <div class="message-bubble">
                                ${escapeHtml(msg.content)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--gray);">No messages yet. Start the conversation!</div>';
                }

                container.scrollTop = container.scrollHeight;

                // Mark messages as read
                await apiCall(`/messages/read/${userId}`, 'POST');

                // Refresh conversation list to update unread badges
                loadConversations();
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            if (!currentRecipient) return;

            const content = document.getElementById('messageInput').value.trim();
            if (!content) return;

            try {
                await apiCall('/messages', 'POST', {
                    recipient_id: currentRecipient.id,
                    content: content
                });

                document.getElementById('messageInput').value = '';
                loadMessages(currentRecipient.id, currentRecipient.username);
                loadConversations();
            } catch (error) {
                alert('Failed to send message: ' + error.message);
            }
        });

        // Handle Enter key for sending messages
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Parameters/Tracking Functions (Enhanced with save/load)
        function initCalendar() {
            loadSavedDates();
            renderCalendar();
            updateSelectedDateDisplay();
        }

        async function loadSavedDates() {
            try {
                const response = await apiCall('/parameters/dates');
                if (response) {
                    savedDates = response.dates || [];
                }
            } catch (error) {
                console.error('Failed to load saved dates:', error);
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (savedDates.includes(dateStr)) {
                    dayCell.classList.add('has-data');
                }

                if (selectedDate.getDate() === day &&
                    selectedDate.getMonth() === month &&
                    selectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            renderCalendar();
            updateSelectedDateDisplay();
        }

        function updateSelectedDateDisplay() {
            const dateStr = selectedDate.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('selectedDateDisplay').textContent = dateStr;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        // Update sleep display
        document.getElementById('sleepInput').addEventListener('input', (e) => {
            const hours = e.target.value || 0;
            const text = hours == 1 ? 'Hour' : 'Hours';
            document.getElementById('sleepDisplay').textContent = `${hours} ${text}`;
        });

        async function saveParameters() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            const parameters = {
                date: dateStr,
                mood: document.getElementById('moodInput').value,
                sleep_hours: parseFloat(document.getElementById('sleepInput').value) || 0,
                exercise: document.getElementById('exerciseInput').value,
                anxiety: document.getElementById('anxietyInput').value,
                energy: document.getElementById('energyInput').value,
                notes: document.getElementById('notesInput').value
            };

            try {
                await apiCall('/parameters/save', 'POST', parameters);
                alert(`Parameters saved for ${dateStr}`);
                loadSavedDates();
                renderCalendar();
            } catch (error) {
                alert('Failed to save parameters: ' + error.message);
            }
        }

        async function loadParameters() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            try {
                const response = await apiCall(`/parameters/load/${dateStr}`);

                if (response && response.success) {
                    const data = response.data;
                    document.getElementById('moodInput').value = data.mood || '';
                    document.getElementById('sleepInput').value = data.sleep_hours || '';
                    document.getElementById('exerciseInput').value = data.exercise || '';
                    document.getElementById('anxietyInput').value = data.anxiety || '';
                    document.getElementById('energyInput').value = data.energy || '';
                    document.getElementById('notesInput').value = data.notes || '';

                    // Update sleep display
                    const hours = data.sleep_hours || 0;
                    const text = hours == 1 ? 'Hour' : 'Hours';
                    document.getElementById('sleepDisplay').textContent = `${hours} ${text}`;

                    alert(`Loaded parameters from ${dateStr}`);
                } else {
                    alert('No saved parameters for this date');
                }
            } catch (error) {
                alert('Failed to load parameters: ' + error.message);
            }
        }

        // Alerts Functions
        async function loadAlerts() {
            try {
                const response = await apiCall('/alerts');
                if (!response) return;

                const container = document.getElementById('alertsList');

                if (!response.alerts || response.alerts.length === 0) {
                    container.innerHTML = '<p style="color: var(--gray);">No new alerts</p>';
                } else {
                    container.innerHTML = response.alerts.map(alert => `
                        <div class="alert-item ${alert.type}">
                            <strong>${alert.title}</strong><br>
                            <small>${alert.content || alert.message || ''}</small>
                        </div>
                    `).join('');
                }
            } catch (error) {
                // Silently fail for alerts to avoid disrupting user experience
                console.error('Failed to load alerts:', error);
            }
        }

        // Support Form
        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const subject = document.getElementById('supportSubject').value;
            const message = document.getElementById('supportMessage').value;

            try {
                await apiCall('/support/contact', 'POST', {
                    subject: subject,
                    message: message
                });

                alert('Support message sent successfully!');
                document.getElementById('supportForm').reset();
            } catch (error) {
                alert('Failed to send support message: ' + error.message);
            }
        });

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }

        // Check authentication on load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await apiCall('/auth/session');
                if (response && response.authenticated) {
                    currentUser = response.user;
                    showDashboard();
                } else {
                    showAuthContainer();
                }
            } catch (error) {
                showAuthContainer();
            }
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchResults = document.getElementById('searchResults');
            const messageSearchResults = document.getElementById('messageSearchResults');

            if (searchResults && !searchResults.contains(e.target) && e.target.id !== 'userSearchInput') {
                searchResults.classList.remove('active');
            }

            if (messageSearchResults && !messageSearchResults.contains(e.target) && e.target.id !== 'messageUserSearch') {
                messageSearchResults.classList.remove('active');
            }
        });

        // Auto-refresh alerts (but with error handling)
        setInterval(() => {
            if (currentUser) {
                loadAlerts().catch(() => {
                    // Silently catch errors to avoid console spam
                });
            }
        }, 30000);
    </script>
</body>
</html>