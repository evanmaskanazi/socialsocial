<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thera Social - Anonymous Wellness Community</title>
   <script src="/static/js/utilities.js"></script>
    <script src="/static/js/onboarding.js"></script>
    <script src="/static/js/triggers.js"></script>
    <script src="/static/js/follow-requests.js"></script>


    <style>


        /* User card styles for following/followers */
.user-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    font-weight: 600;
    flex-shrink: 0;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.25rem;
}

.user-location {
    font-size: 0.875rem;
    color: var(--gray);
}

.follow-btn, .unfollow-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.follow-btn:hover {
    transform: scale(1.05);
}

.unfollow-btn {
    background: var(--light);
    color: var(--gray);
}

.unfollow-btn:hover {
    background: var(--danger);
    color: white;
}

.back-to-following-btn {
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .user-card {
        padding: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .follow-btn, .unfollow-btn {
        padding: 0.375rem 1rem;
        font-size: 0.875rem;
    }
}

/* City Selector Styles */
.city-selector-container {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.city-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
}

.city-selector {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    font-size: 16px;
    background: white;
}

.city-time-display {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    text-align: center;
    padding: 15px;
    background: var(--light);
    border-radius: 10px;
}

/* Following/Followers Styles */
.follow-card {
    background: white;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: box-shadow 0.3s;
}

.follow-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.follow-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
}

.follow-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
}

.follow-btn.following {
    background: var(--success);
}

.recommendation-reason {
    font-size: 12px;
    color: var(--gray);
    margin-top: 5px;
}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #EC4899;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        /* RTL Support */
        [dir="rtl"] {
            direction: rtl;
        }

        [dir="rtl"] .nav-menu {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .avatar,
        [dir="rtl"] .member-avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        [dir="rtl"] .post-header .avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .language-selector {
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: var(--white);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Auth Forms */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 70px);
        }

        .auth-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            margin-top: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar-item:hover {
            background: var(--light);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
        }

        /* Feed - Enhanced with Calendar */
        .feed-calendar-section {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feed-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .feed-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .feed-calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--white);
        }

        .feed-calendar-day:hover {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.has-posts::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        .post-form {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            align-items: center;
        }

        .visibility-select {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            background: var(--white);
        }

        .post-card {
            background: var(--white);
            border: 1px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .post-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 12px;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--dark);
        }

        .post-time {
            font-size: 12px;
            color: var(--gray);
        }

        .post-content {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Enhanced Profile Section */
        .profile-section {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 15px;
        }

        .profile-fields {
            display: grid;
            gap: 20px;
        }

        .profile-field {
            position: relative;
        }

        .profile-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Parameters with Calendar */
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
        }

        .parameter-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .parameter-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .parameter-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
        }

        .calendar-section {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--light);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-day.has-data::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        /* Enhanced Circles */
        .circles-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .circle-card {
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .circle-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .circle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .circle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .circle-count {
            background: var(--primary);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .circle-members {
            max-height: 200px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .member-item:hover {
            background: var(--light);
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 12px;
        }

        .member-name {
            flex: 1;
        }

        .remove-btn {
            background: var(--danger);
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .member-item:hover .remove-btn {
            opacity: 1;
        }

        .user-search {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        /* Messages - Enhanced */
        .messages-container {
            display: flex;
            height: 600px;
        }

        .conversations-list {
            width: 300px;
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
        }

        [dir="rtl"] .conversations-list {
            border-right: none;
            border-left: 1px solid #E5E7EB;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--light);
        }

        .conversation-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .conversation-username {
            font-weight: 600;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--gray);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .unread-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        [dir="rtl"] .unread-badge {
            right: auto;
            left: 15px;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            font-weight: 600;
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            background: var(--light);
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: var(--white);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
        }

        /* Right Sidebar */
        .right-sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
        }

        [dir="rtl"] .alert-item {
            border-left: none;
            border-right: 4px solid var(--warning);
        }

        .alert-item.high {
            border-left-color: var(--danger);
        }

        [dir="rtl"] .alert-item.high {
            border-left-color: transparent;
            border-right-color: var(--danger);
        }

        .alert-item.low {
            border-left-color: var(--success);
        }

        [dir="rtl"] .alert-item.low {
            border-left-color: transparent;
            border-right-color: var(--success);
        }

        /* About and Support Pages */
        .page-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.2);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Responsive */
  /* Mobile Navigation Bar */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 8px 0;
            border-top: 1px solid #E5E7EB;
        }

        .mobile-nav-menu {
            display: flex;
            justify-content: space-around;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mobile-nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            color: var(--gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        .mobile-nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* RTL Support for Mobile Navigation */
        [dir="rtl"] .mobile-nav-menu {
            direction: rtl;
        }

        [dir="rtl"] .mobile-nav-item {
            direction: rtl;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding-bottom: 70px; /* Space for bottom nav */
            }

            .sidebar {
                display: none;
            }

            .right-sidebar {
                display: none;
            }

            .mobile-nav {
                display: block;
            }

            .main-content {
                margin-bottom: 60px; /* Prevent content being hidden behind nav */
                border-radius: 15px 15px 0 0;
            }

            .messages-container {
                flex-direction: column;
                margin-bottom: 60px;
            }

            .conversations-list {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }

            /* Adjust navbar on mobile */
            .navbar {
                padding: 10px 15px;
            }

            .nav-content {
                padding: 10px 15px;
            }

            .logo {
                font-size: 20px;
            }

            .nav-menu {
                gap: 10px;
            }

            /* Hide desktop navigation links on mobile */
            .nav-link {
                display: none;
            }

            /* Keep language selector visible */
            .language-selector {
                padding: 6px 10px;
                font-size: 14px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }




        .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 900px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: #333;
}

.close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    transition: color 0.2s;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}

.date-range-info {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Calendar update indicator - green dots for days with updates */
.update-indicator {
    width: 8px;
    height: 8px;
    background-color: #4CAF50;
    border-radius: 50%;
    position: absolute;
    bottom: 2px;
    right: 2px;
}

/* User update modal for viewing other users' feed updates */
#user-update-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

#user-update-modal .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#user-update-modal .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

#user-update-modal .close-modal:hover,
#user-update-modal .close-modal:focus {
    color: #000;
}

#update-content-display {
    margin: 20px 0;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 4px;
    min-height: 100px;
}

#edit-update-btn {
    background-color: #667eea;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 15px;
}

#edit-update-btn:hover {
    background-color: #5568d3;
}


        /* Invite View Styles */
.invite-section {
    display: grid;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.share-link-card,
.recommendations-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.share-link-card h3,
.recommendations-card h3 {
    color: #667eea;
    margin-bottom: 10px;
}

.link-display {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.invite-link-input {
    flex: 1;
    padding: 12px;
    border: 2px solid #f0f0f0;
    border-radius: 8px;
    font-family: monospace;
    background: #f8f9fa;
}

.share-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.share-buttons .btn {
    flex: 1;
    min-width: 120px;
}

.recommendations-list {
    margin-top: 20px;
}

.empty-state,
.error-state,
.loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

@media (max-width: 768px) {
    .link-display {
        flex-direction: column;
    }

    .share-buttons {
        flex-direction: column;
    }

    .share-buttons .btn {
        width: 100%;
    }
}



    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo" data-i18n="nav.logo">üß† Thera Social</div>
            <div class="nav-menu">
                <select id="languageSelector" class="language-selector">
                    <option value="en">English</option>
                    <option value="he">◊¢◊ë◊®◊ô◊™</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                </select>
                <a href="#" class="nav-link" id="navHome" data-i18n="nav.home">Home</a>
                <a href="#" class="nav-link" id="navAbout" data-i18n="nav.about">About</a>
                <a href="#" class="nav-link" id="navSupport" data-i18n="nav.support">Support</a>
                <button class="btn btn-primary" id="logoutBtn" style="display: none; width: auto;" data-i18n="nav.logout">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card fade-in">
            <h2 class="auth-title" id="authTitle" data-i18n="auth.welcome">Welcome Back</h2>
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email">Email</label>
                    <input type="email" class="form-input" id="emailInput" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.password">Password</label>
                    <input type="password" class="form-input" id="passwordInput" autocomplete="current-password" required>
                </div>
                <div class="form-group" id="usernameGroup" style="display: none;">
                    <label class="form-label" data-i18n="auth.username">Username</label>
                    <input type="text" class="form-input" id="usernameInput" autocomplete="username" data-i18n="auth.username_placeholder" placeholder="Choose a username">
                </div>
                <button type="submit" class="btn btn-primary" id="authSubmit" data-i18n="btn.signin">Sign In</button>
            </form>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" id="toggleAuth" style="color: var(--primary);" data-i18n="auth.toggle_signup">New here? Create an account</a>
            </p>
        </div>
    </div>

    <!-- About Page -->
    <div id="aboutPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="about.title">About Thera Social</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="about.subtitle">
                Your safe space for wellness, connection, and personal growth
            </p>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üõ°Ô∏è</div>
                    <h3 data-i18n="about.privacy_title">Privacy First</h3>
                    <p data-i18n="about.privacy_desc">Your wellness journey is private and secure. Share only what you're comfortable with.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3 data-i18n="about.track_title">Track Progress</h3>
                    <p data-i18n="about.track_desc">Monitor your wellness parameters and see your growth over time with insights.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üí•</div>
                    <h3 data-i18n="about.community_title">Supportive Community</h3>
                    <p data-i18n="about.community_desc">Connect with others on similar journeys in a judgment-free environment.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üí¨</div>
                    <h3 data-i18n="about.communication_title">Safe Communication</h3>
                    <p data-i18n="about.communication_desc">Private messaging and circles let you control who sees your content.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3 data-i18n="about.goals_title">Goal Setting</h3>
                    <p data-i18n="about.goals_desc">Set and track personal goals with community support and accountability.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üåü</div>
                    <h3 data-i18n="about.checkin_title">Daily Check-ins</h3>
                    <p data-i18n="about.checkin_desc">Regular parameter tracking helps you understand patterns and triggers.</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" style="width: 200px;" onclick="goHome()" data-i18n="btn.getstarted">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Support Page -->
    <div id="supportPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="support.title">Support Center</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="support.subtitle">
                We're here to help you on your wellness journey
            </p>

            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.faq_title">Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq1_q">How do I track my wellness parameters?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq1_a">Navigate to the Parameters tab in your dashboard. You can input daily values for mood, sleep, exercise, anxiety, and energy levels. Use the calendar to save and load parameters for different dates.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq2_q">What are Circles?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq2_a">Circles allow you to organize your connections into groups: General, Close Friends, and Family. You can control who sees your posts based on these circles.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq3_q">How do I update my profile?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq3_a">Go to the Profile tab to update your bio, interests, occupation, goals, and favorite hobbies. These help others understand you better.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq4_q">Is my data private?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq4_a">Yes! We take privacy seriously. Your wellness data is encrypted and only visible to you unless you choose to share it.</p>
                </div>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.contact_title">Contact Support</h3>
                <form id="supportForm">
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.subject">Subject</label>
                        <input type="text" class="form-input" id="supportSubject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.message">Message</label>
                        <textarea class="form-input" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" data-i18n="support.send">Send Message</button>
                </form>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" style="width: 200px;" onclick="goHome()" data-i18n="btn.back">Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
 <div id="dashboard" class="dashboard container">
    <!-- Mobile Navigation Bar -->
    <nav class="mobile-nav">
        <ul class="mobile-nav-menu">
            <li class="mobile-nav-item active" data-view="feed" onclick="showView('feed')">
                <span class="mobile-nav-icon">üè†</span>
                <span class="mobile-nav-label" data-i18n="menu.feed">Feed</span>
            </li>
            <li class="mobile-nav-item" data-view="profile" onclick="showView('profile')">
                <span class="mobile-nav-icon">üë§</span>
                <span class="mobile-nav-label" data-i18n="menu.profile">Profile</span>
            </li>
            <li class="mobile-nav-item" data-view="circles" onclick="showView('circles')">
                <span class="mobile-nav-icon">‚≠ï</span>
                <span class="mobile-nav-label" data-i18n="menu.circles">Circles</span>
            </li>
            <li class="mobile-nav-item" id="mobileMessagesNav" data-view="messages" onclick="showView('messages')">
                <span class="mobile-nav-icon">üí¨</span>
                <span class="mobile-nav-label" data-i18n="menu.messages">Messages</span>
            </li>
            <li class="mobile-nav-item" data-view="tracking" onclick="handleParametersClick(event)">
    <span class="mobile-nav-icon">üìä</span>
    <span class="mobile-nav-label" data-i18n="menu.parameters">Parameters</span>
</li>
<li class="mobile-nav-item" data-view="following" onclick="showView('following')">
    <span class="mobile-nav-icon">‚ûï</span>
    <span class="mobile-nav-label" data-i18n="menu.following">Following</span>
</li>
<li class="mobile-nav-item" data-view="followers" onclick="showView('followers')">
    <span class="mobile-nav-icon">üë•</span>
    <span class="mobile-nav-label" data-i18n="menu.followers">Followers</span>
</li>
<li class="mobile-nav-item" data-view="invite" onclick="showView('invite')">
    <span class="mobile-nav-icon">üëã</span>
    <span class="mobile-nav-label" data-i18n="menu.invite">Invite</span>
</li>

        </ul>
    </nav>

    <div class="dashboard-grid">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" data-view="feed" data-i18n="menu.feed">
                        üì± Feed
                    </li>
                    <li class="sidebar-item" data-view="profile" data-i18n="menu.profile">
                        üë§ Profile
                    </li>
                    <li class="sidebar-item" data-view="circles" data-i18n="menu.circles">
                        üë• Circles
                    </li>
                    <li class="sidebar-item" id="desktopMessagesNav" data-view="messages" data-i18n="menu.messages">
                        üí¨ Messages
                    </li>
                   <li class="sidebar-item" data-view="tracking" onclick="handleParametersClick(event)" style="cursor: pointer;">
    üìä <span data-i18n="menu.parameters">Parameters</span>
</li>

<li class="sidebar-item" data-view="following" data-i18n="menu.following">
    ‚ûï Following
</li>
<li class="sidebar-item" data-view="followers" data-i18n="menu.followers">
    üë• Followers
</li>
<li class="sidebar-item" data-view="invite" onclick="showView('invite')" data-i18n="menu.invite">
    üëã Invite
</li>

                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
              <!-- Feed View - Date-Based Journal -->
<!-- Feed View - Date-Based Journal -->
<div id="feedView" class="view">
    <!-- City Selector and Time Display -->
    <div class="city-selector-container">
        <div class="city-selector-wrapper">
            <label for="citySelector" style="font-weight: 600;" data-i18n="feed.select_city">Select City:</label>
            <select id="citySelector" class="city-selector">
                <option value="Jerusalem, Israel">Jerusalem, Israel</option>
                <option value="Tokyo, Japan">Tokyo, Japan</option>
                <option value="Delhi, India">Delhi, India</option>
                <option value="Shanghai, China">Shanghai, China</option>
                <option value="Mexico City, Mexico">Mexico City, Mexico</option>
                <option value="S√£o Paulo, Brazil">S√£o Paulo, Brazil</option>
                <option value="Cairo, Egypt">Cairo, Egypt</option>
                <option value="Dhaka, Bangladesh">Dhaka, Bangladesh</option>
                <option value="Beijing, China">Beijing, China</option>
                <option value="Mumbai, India">Mumbai, India</option>
                <option value="Osaka, Japan">Osaka, Japan</option>
                <option value="Karachi, Pakistan">Karachi, Pakistan</option>
                <option value="Chongqing, China">Chongqing, China</option>
                <option value="Kinshasa, DR Congo">Kinshasa, DR Congo</option>
                <option value="New York City, USA">New York City, USA</option>
                <option value="Istanbul, Turkey">Istanbul, Turkey</option>
                <option value="London, United Kingdom">London, United Kingdom</option>
                <option value="Paris, France">Paris, France</option>
                <option value="Buenos Aires, Argentina">Buenos Aires, Argentina</option>
                <option value="Moscow, Russia">Moscow, Russia</option>
                <option value="Seoul, South Korea">Seoul, South Korea</option>
                <option value="Hong Kong, China">Hong Kong, China</option>
                <option value="Dubai, UAE">Dubai, UAE</option>
                <option value="Sydney, Australia">Sydney, Australia</option>
                <option value="Singapore, Singapore">Singapore, Singapore</option>
                <option value="Los Angeles, USA">Los Angeles, USA</option>
                <option value="Chicago, USA">Chicago, USA</option>
                <option value="Melbourne, Australia">Melbourne, Australia</option>
                <option value="Berlin, Germany">Berlin, Germany</option>
                <option value="Madrid, Spain">Madrid, Spain</option>
                <option value="Rome, Italy">Rome, Italy</option>
                <option value="Bangkok, Thailand">Bangkok, Thailand</option>
                <option value="Jakarta, Indonesia">Jakarta, Indonesia</option>
                <option value="Tehran, Iran">Tehran, Iran</option>
                <option value="Lagos, Nigeria">Lagos, Nigeria</option>
                <option value="Rio de Janeiro, Brazil">Rio de Janeiro, Brazil</option>
                <option value="Vancouver, Canada">Vancouver, Canada</option>
                <option value="Amsterdam, Netherlands">Amsterdam, Netherlands</option>
                <option value="Washington, USA">Washington, USA</option>
                <option value="Houston, USA">Houston, USA</option>
            </select>
        </div>
        <div class="city-time-display" id="cityTimeDisplay">
            <!-- Time will be displayed here -->
        </div>
    </div>

    <h2 style="margin-bottom: 20px;" data-i18n="feed.title">Your Feed Journal</h2>
    <p style="color: var(--gray); margin-bottom: 20px;" data-i18n="feed.subtitle">Save your thoughts for each day. Select a date from the calendar, write your update, and save it. Green dots show dates with saved entries.</p>

    <!-- Feed Calendar -->
    <div class="feed-calendar-section">
        <div class="feed-calendar-header">
            <button class="btn btn-secondary" onclick="feedPreviousMonth()" data-i18n="calendar.prev">‚Üê</button>
            <span id="feedCurrentMonth" style="font-weight: 600;">January 2025</span>
            <button class="btn btn-secondary" onclick="feedNextMonth()" data-i18n="calendar.next">‚Üí</button>
        </div>
        <div class="feed-calendar-grid" id="feedCalendarGrid"></div>
        <div style="text-align: center; margin-top: 15px;">
            <p><span data-i18n="feed.selected_date">Selected Date:</span> <strong id="feedSelectedDateDisplay" data-i18n="feed.today">Today</strong></p>
        </div>
    </div>

    <!-- Post Form -->
    <div class="post-form">
        <textarea class="post-input" data-i18n="feed.placeholder" placeholder="How are you feeling today?" id="postInput"></textarea>
        <div class="post-actions">
            <select class="visibility-select" id="visibilitySelect">
                <option value="general">Public</option>
<option value="close_friends">Class B (Friends)</option>
<option value="family">Class A (Family)</option>

            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: auto;" onclick="loadFeedForDate()" data-i18n="feed.load_update">Load Update</button>
                <button class="btn btn-primary" style="width: auto;" id="postBtn" data-i18n="feed.save_update">Save Update</button>
               </div>
        </div>
    </div>

    <!-- Posts Display Container -->
    <div class="feed-posts" id="feedPostsContainer" style="margin-top: 20px;">
        <!-- Posts will be displayed here -->
    </div>
</div>

                <!-- Profile View (Enhanced with 5 fields) -->
                <div id="profileView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="profile.title">Your Profile</h2>
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <h3 id="profileUsername">Username</h3>
                        </div>

                        <div class="profile-fields">
                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.bio">Bio</label>
                                <textarea class="profile-textarea" id="profileBio" data-i18n="profile.bio_placeholder" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.interests">Interests</label>
                                <textarea class="profile-textarea" id="profileInterests" data-i18n="profile.interests_placeholder" placeholder="What are you interested in?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.occupation">Occupation</label>
                                <input type="text" class="form-input" id="profileOccupation" data-i18n="profile.occupation_placeholder" placeholder="What do you do?">
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.goals">Goals</label>
                                <textarea class="profile-textarea" id="profileGoals" data-i18n="profile.goals_placeholder" placeholder="What are your personal or professional goals?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.hobbies">Favorite Hobbies</label>
                                <textarea class="profile-textarea" id="profileFavoriteHobbies" data-i18n="profile.hobbies_placeholder" placeholder="What do you love to do in your free time?" maxlength="300"></textarea>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" style="width: 200px;" id="updateProfileBtn" data-i18n="profile.save">Save Profile</button>
                        </div>
                    </div>
                </div>

                <!-- Circles View (Enhanced) -->
                <div id="circlesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="circles.title">Your Circles</h2>

                    <div class="user-search">
                        <input type="text" class="search-input" id="userSearchInput" data-i18n="circles.search_placeholder" placeholder="Search users to add to circles..." onkeyup="searchUsers()">
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <div class="circles-container">
                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">üí• Public</span>
                                <span class="circle-count" id="generalCount">0</span>
                            </div>
                            <div class="circle-members" id="generalMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No members yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">‚ù§Ô∏è Class B (Friends)</span>
                                <span class="circle-count" id="closeFriendsCount">0</span>
                            </div>
                            <div class="circle-members" id="closeFriendsMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No close friends yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Class A (Family)</span>
                                <span class="circle-count" id="familyCount">0</span>
                            </div>
                            <div class="circle-members" id="familyMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No family members yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages View - Enhanced -->
                <div id="messagesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="messages.title">Messages</h2>
                    <div class="user-search" style="margin-bottom: 20px;">
                        <input type="text" class="search-input" id="messageUserSearch" data-i18n="messages.search_placeholder" placeholder="Search users to message..." onkeyup="searchUsersForMessage()">
                        <div class="search-results" id="messageSearchResults"></div>
                    </div>

                    <div class="messages-container">
                        <div class="conversations-list" id="conversationsList">
                            <div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">
                                No conversations yet
                            </div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader" data-i18n="messages.select_conversation">Select a conversation</div>
                            <div class="messages-list" id="messagesList">
                                <div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">
                                    Select a conversation to start messaging
                                </div>
                            </div>
                            <div class="message-input-area">
                                <input type="text" class="message-input" id="messageInput" data-i18n="messages.type_message" placeholder="Type a message..." disabled>
                                <button class="btn btn-primary" style="width: auto;" id="sendMessageBtn" disabled data-i18n="btn.send">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking/Parameters View (Enhanced with save/load) -->
                <div id="trackingView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="parameters.title">Wellness Parameters</h2>

                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="previousMonth()" data-i18n="calendar.prev">‚Üê</button>
                            <span id="currentMonth" style="font-weight: 600;">January 2025</span>
                            <button class="btn btn-secondary" onclick="nextMonth()" data-i18n="calendar.next">‚Üí</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                        <div style="text-align: center; margin-top: 15px;">
                            <p><span data-i18n="parameters.selected_date">Selected Date:</span> <strong id="selectedDateDisplay" data-i18n="feed.today">Today</strong></p>
                        </div>
                    </div>

                    <div id="parametersContainer" class="parameter-grid">
                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.mood">Mood</div>
                            <div id="moodInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.sleep">Sleep</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" class="parameter-input" id="sleepInput" data-i18n="parameters.sleep_placeholder" placeholder="Hours" min="0" max="24" step="0.5" style="width: 100px;">
                                <span style="color: white; font-weight: 600;" id="sleepDisplay"><span>0</span> <span data-i18n="parameters.sleep_hours">Hours</span></span>
                            </div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.exercise">Exercise</div>
                            <div id="exerciseInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.anxiety">Anxiety</div>
                            <input type="text" class="parameter-input" id="anxietyInput" data-i18n="parameters.anxiety_placeholder" placeholder="e.g., None, Mild, Moderate">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.energy">Energy</div>
                            <input type="text" class="parameter-input" id="energyInput" data-i18n="parameters.energy_placeholder" placeholder="e.g., Low, Normal, High">
                        </div>

                        <div class="parameter-card" style="grid-column: span 2;">
                            <div class="parameter-name" data-i18n="parameters.notes">Notes</div>
                            <textarea class="parameter-input" id="notesInput" data-i18n="parameters.notes_placeholder" placeholder="Additional notes..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveParameters()" data-i18n="parameters.save">Save Parameters</button>
                        <button class="btn btn-secondary" style="width: 200px;" onclick="loadParameters()" data-i18n="parameters.load">Load Parameters</button>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;" data-i18n="parameters.insights">Insights</h3>
                    <div id="insights"></div>
                </div>

<!-- Following View -->
<div id="followingView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="following.title">Following</h2>

    <!-- Recommendations Section -->
    <div style="margin-bottom: 30px;">
        <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="following.recommendations">Recommended for You</h3>
        <div id="recommendationsList"></div>
    </div>

    <!-- Following List -->
    <div>
        <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="following.your_following">People You Follow</h3>
        <div id="followingList"></div>
    </div>
</div>

<!-- Followers View -->
<div id="followersView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="followers.title">Followers</h2>
    <div id="followersList"></div>
</div>

<!-- Invite View -->
<div id="inviteView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="invite.title">Invite Friends to Your Wellness Journey</h2>

    <div class="invite-section">
        <div class="share-link-card">
            <h3 data-i18n="invite.your_link">Your Personal Invite Link</h3>
            <p data-i18n="invite.link_description">Share this link with friends and family so they can follow your wellness journey</p>

            <div class="link-display">
                <input type="text" id="userInviteLink" readonly class="invite-link-input">
                <button onclick="copyUserInviteLink()" class="btn btn-primary">
                    <span data-i18n="invite.copy">üìã Copy Link</span>
                </button>
            </div>

            <div class="share-buttons">
                <button onclick="shareViaEmail()" class="btn btn-secondary">
                    <span data-i18n="invite.email">‚úâÔ∏è Email</span>
                </button>
                <button onclick="shareViaSMS()" class="btn btn-secondary">
                    <span data-i18n="invite.sms">üí¨ SMS</span>
                </button>
                <button onclick="shareViaWhatsApp()" class="btn btn-secondary">
                    <span data-i18n="invite.whatsapp">üì± WhatsApp</span>
                </button>
            </div>
        </div>

        <div class="recommendations-card">
            <h3 data-i18n="invite.suggested">Suggested People to Invite</h3>
            <p data-i18n="invite.suggested_description">Based on your location and connections</p>

            <div id="recommendationsList" class="recommendations-list">
                <div class="loading">Loading recommendations...</div>
            </div>
        </div>
    </div>
</div>



            </main>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <h3 style="margin-bottom: 15px;" data-i18n="alerts.title">Alerts</h3>
                <div class="alerts-list" id="alertsList"></div>
            </aside>
        </div>
    </div>

    <script src="/static/js/i18n.js"></script>
 <script>
    // Global variables needed by parameters-social.js - MUST be declared first
    let selectedDate = new Date();
    let currentMonth = new Date();
    let savedDates = [];
    let currentYear = new Date().getFullYear(); // ADD THIS LINE
    let currentRecipient = null;
</script>
<script src="/static/js/parameters-social.js"></script>
    <script src="/static/js/feed-updates.js?v=1.0"></script>
<script>
    // API Configuration
    const API_URL = window.location.origin + '/api';
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;
    let isLoginMode = true;
    let viewingUserId = null; // Track which user profile we're viewing
let currentUserId = null;
    // Variables above already declared before parameters-social.js

        // Helper function to format message time with translation
      function formatMessageTime(timestamp) {
    try {
        if (!timestamp) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const now = new Date();
        const msgTime = new Date(timestamp);

        if (isNaN(msgTime.getTime())) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const diffSeconds = Math.floor((now - msgTime) / 1000);

        // Just now (less than 60 seconds)
        if (diffSeconds < 60) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.just_now') : 'Just now';
        }

        // Minutes ago
        if (diffSeconds < 3600) {
            const minutes = Math.floor(diffSeconds / 60);
            const minText = window.i18n && window.i18n.t ? window.i18n.t('messages.minutes_ago') : 'min ago';
            return `${minutes} ${minText}`;
        }

        // Hours ago (same day)
        if (msgTime.toDateString() === now.toDateString()) {
            return msgTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Yesterday
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (msgTime.toDateString() === yesterday.toDateString()) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.yesterday') : 'Yesterday';
        }

        // Older messages
        return msgTime.toLocaleDateString();
    } catch (error) {
        console.error('Error formatting time:', error);
        return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
    }
}

        // Feed Calendar Variables
        let feedSelectedDate = new Date();
        let feedCurrentMonth = new Date();
        let feedSavedDates = [];
        // Global variables for calendar state





        // City and Timezone Functions
        const timezoneOffsets = {
            'Jerusalem, Israel': 2,
            'Tokyo, Japan': 9,
            'Delhi, India': 5.5,
            'Shanghai, China': 8,
            'Mexico City, Mexico': -6,
            'S√£o Paulo, Brazil': -3,
            'Cairo, Egypt': 2,
            'Dhaka, Bangladesh': 6,
            'Beijing, China': 8,
            'Mumbai, India': 5.5,
            'Osaka, Japan': 9,
            'Karachi, Pakistan': 5,
            'Chongqing, China': 8,
            'Kinshasa, DR Congo': 1,
            'New York City, USA': -5,
            'Istanbul, Turkey': 3,
            'London, United Kingdom': 0,
            'Paris, France': 1,
            'Buenos Aires, Argentina': -3,
            'Moscow, Russia': 3,
            'Seoul, South Korea': 9,
            'Hong Kong, China': 8,
            'Dubai, UAE': 4,
            'Sydney, Australia': 11,
            'Singapore, Singapore': 8,
            'Los Angeles, USA': -8,
            'Chicago, USA': -6,
            'Melbourne, Australia': 11,
            'Berlin, Germany': 1,
            'Madrid, Spain': 1,
            'Rome, Italy': 1,
            'Bangkok, Thailand': 7,
            'Jakarta, Indonesia': 7,
            'Tehran, Iran': 3.5,
            'Lagos, Nigeria': 1,
            'Rio de Janeiro, Brazil': -3,
            'Vancouver, Canada': -8,
            'Amsterdam, Netherlands': 1,
            'Washington, USA': -5,
            'Houston, USA': -6
        };

        function updateCityTime() {
            const city = document.getElementById('citySelector').value;
            const offset = timezoneOffsets[city] || 0;

            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const cityTime = new Date(utc + (3600000 * offset));

            const timeString = cityTime.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });

            const dateString = cityTime.toLocaleDateString([], {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            document.getElementById('cityTimeDisplay').innerHTML =
                `${timeString}<br><span style="font-size: 16px;">${dateString}</span>`;
        }

        async function loadUserCity() {
            try {
                const response = await apiCall('/user/city');
                if (response && response.selected_city) {
                    document.getElementById('citySelector').value = response.selected_city;
                    updateCityTime();
                }
            } catch (error) {
                console.error('Error loading city:', error);
            }
        }

        async function saveUserCity(city) {
            try {
                await apiCall('/user/city', 'POST', { selected_city: city });
            } catch (error) {
                console.error('Error saving city:', error);
            }
        }






        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);

                if (response.status === 401) {
                    showAuthContainer();
                    return null;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation Functions
        document.getElementById('navAbout').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('aboutPage').classList.remove('hidden');
        });

        document.getElementById('navSupport').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('supportPage').classList.remove('hidden');
        });

        document.getElementById('navHome').addEventListener('click', (e) => {
            e.preventDefault();
            goHome();
        });

        function goHome() {
            hideAllViews();
            if (currentUser) {
                document.getElementById('dashboard').style.display = 'block';
            } else {
                document.getElementById('authContainer').style.display = 'flex';
            }
        }

        function hideAllViews() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('aboutPage').classList.add('hidden');
            document.getElementById('supportPage').classList.add('hidden');
        }

        // Auth Functions
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                document.getElementById('authTitle').setAttribute('data-i18n', 'auth.welcome');
                document.getElementById('authSubmit').setAttribute('data-i18n', 'btn.signin');
                document.getElementById('usernameGroup').style.display = 'none';
                document.getElementById('toggleAuth').setAttribute('data-i18n', 'auth.toggle_signup');
            } else {
                document.getElementById('authTitle').setAttribute('data-i18n', 'auth.create');
                document.getElementById('authSubmit').setAttribute('data-i18n', 'btn.signup');
                document.getElementById('usernameGroup').style.display = 'block';
                document.getElementById('toggleAuth').setAttribute('data-i18n', 'auth.toggle_signin');
            }

            if (window.i18n && window.i18n.applyLanguage) {
                window.i18n.applyLanguage();
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const username = document.getElementById('usernameInput').value;

            try {
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                const body = { email, password };

                if (!isLoginMode) {
                    body.username = username || email.split('@')[0];
                    // Send current language selection
                    body.preferred_language = window.i18n && window.i18n.getCurrentLanguage ?
                        window.i18n.getCurrentLanguage() : 'en';
                }
                const response = await apiCall(endpoint, 'POST', body);

              if (response && response.success) {
    currentUser = response.user;
    currentUserId = response.user.id; // Store the user ID
    showDashboard();
                }
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await apiCall('/auth/logout', 'POST');
            } catch (error) {
                // Ignore logout errors
            }

            currentUser = null;
            showAuthContainer();
        });

        function showAuthContainer() {
            hideAllViews();
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // Dashboard Functions
  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'block';

    if (currentUser && currentUser.username) {
        document.getElementById('profileAvatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('profileUsername').textContent = currentUser.username;
        currentUserId = currentUser.id; // Ensure user ID is set
    }

    initFeedCalendar();
    loadUserCity();
    updateCityTime();

    // Initialize parameter calendar
    if (typeof initializeCalendar === 'function') {
        initializeCalendar();
    }

            // Initialize city selector event
            const citySelector = document.getElementById('citySelector');
            if (citySelector && !citySelector.hasAttribute('data-initialized')) {
                citySelector.addEventListener('change', function() {
                    const city = this.value;
                    saveUserCity(city);
                    updateCityTime();
                });
                citySelector.setAttribute('data-initialized', 'true');

                // Start time update interval
                setInterval(updateCityTime, 1000);
            }
            // Note: loadAlerts() now called from DOMContentLoaded after i18n check
        }

        // Sidebar Navigation
     // Sidebar Navigation
      // Sidebar Navigation - use showView to maintain viewingUserId state
// Sidebar Navigation
document.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('click', (e) => {
        // Skip this handler if the tracking/parameters item was clicked
        // (it has its own onclick handler)
        if (item.dataset.view === 'tracking') {
            console.log('[DEBUG] Skipping generic handler for tracking item');
            return;
        }

        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

        const view = item.dataset.view;
        document.getElementById(`${view}View`).classList.remove('hidden');

        // Update mobile nav active state
        document.querySelectorAll('.mobile-nav-item').forEach(mobileItem => {
            mobileItem.classList.remove('active');
            if (mobileItem.dataset.view === view) {
                mobileItem.classList.add('active');
            }
        });

  switch(view) {
                    case 'feed':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserFeed(viewingUserId);
                        } else {
                            initFeedCalendar();
                        }
                        break;
                    case 'profile':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserProfileView(viewingUserId);
                        } else {
                            loadProfile();
                        }
                        break;
                    case 'circles':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserCircles(viewingUserId);
                        } else {
                            loadCircles();
                        }
                        break;
                    case 'messages':
                        loadConversations();
                        break;
                   case 'tracking':
    // Let showView handle the logic - don't duplicate here
    break;
                    case 'following':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserFollowing(viewingUserId);
                        } else {
                            loadFollowing();
                        }
                        break;
                    case 'followers':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserFollowers(viewingUserId);
                        } else {
                            loadFollowers();
                        }
                        break;
                }
    });
});



// Handle parameters click - redirect to /parameters page for own data, show trackingView for other users
function handleParametersClick(event) {
    // Stop event propagation to prevent both handlers from firing
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    console.log('[DEBUG] handleParametersClick called, viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);

    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user - show their parameters in modal
        console.log('[DEBUG] Fetching profile for user:', viewingUserId);
        fetch(`/api/users/${viewingUserId}/profile`, { credentials: 'include' })
            .then(r => {
                console.log('[DEBUG] Profile fetch status:', r.status);
                return r.ok ? r.json() : Promise.reject('Failed to fetch profile');
            })
            .then(data => {
                console.log('[DEBUG] Profile data received, calling viewUserParameters');
                viewUserParameters(viewingUserId, data.username || 'User');
            })
            .catch(err => {
                console.error('[DEBUG] Error in handleParametersClick:', err);
                showNotification('Error loading parameters', 'error');
            });
    } else {
        // Viewing own parameters - redirect to full parameters page
        console.log('[DEBUG] Redirecting to /parameters for own data');
        window.location.href = '/parameters';
    }
}






 function showView(viewName) {
    // Only reset viewing mode when navigating to views that should go back to own account
    // Maintain viewing mode for: profile, feed, circles, parameters, tracking, following, followers
    const viewsToMaintainUser = ['profile', 'feed', 'circles', 'parameters', 'tracking', 'following', 'followers'];

    if (!viewsToMaintainUser.includes(viewName)) {
        if (viewingUserId !== null) {
            viewingUserId = null;
            updateMessagesNavVisibility();

            // Re-enable profile fields
            const bioElement = document.getElementById('profileBio');
            const interestsElement = document.getElementById('profileInterests');
            const occupationElement = document.getElementById('profileOccupation');
            const goalsElement = document.getElementById('profileGoals');
            const hobbiesElement = document.getElementById('profileFavoriteHobbies');
            const saveButton = document.getElementById('updateProfileBtn');

            // Re-enable all fields
            [bioElement, interestsElement, occupationElement, goalsElement, hobbiesElement].forEach(el => {
                if (el) {
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                }
            });

            // Show save button
            if (saveButton) {
                saveButton.style.display = '';
            }

            // Show edit buttons again
            const editButtons = document.querySelectorAll('.btn-primary, .btn-secondary');
            editButtons.forEach(btn => {
                if (btn.textContent.includes('Edit') || btn.textContent.includes('Save') || btn.textContent.includes('Add')) {
                    btn.style.display = '';
                }
            });
            // Remove back button if exists
            const backBtn = document.querySelector('.back-to-following-btn');
            if (backBtn) backBtn.remove();

            // Reset view headers
            const profileHeader = document.querySelector('#profileView h2');
            if (profileHeader) profileHeader.textContent = 'Profile';
            const feedHeader = document.querySelector('#feedView h2');
            if (feedHeader) feedHeader.textContent = 'Feed';
            const circlesHeader = document.querySelector('#circlesView h2');
            if (circlesHeader) circlesHeader.textContent = 'Circles';
            const parametersHeader = document.querySelector('#parametersView h2, #trackingView h2');
            if (parametersHeader) parametersHeader.textContent = 'Wellness Parameters';

            // Show input forms again
            document.querySelectorAll('form, .post-creation, .parameter-inputs').forEach(form => {
                form.style.display = '';
            });
        }
    }

    // Update desktop sidebar
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewName) {
            item.classList.add('active');
        }
    });

    // Update mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewName) {
            item.classList.add('active');
        }
    });

    // Show/hide views
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const selectedView = document.getElementById(`${viewName}View`);
    if (selectedView) {
        selectedView.classList.remove('hidden');
    }

    // Load view content - check if viewing another user
    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user's profile
        switch(viewName) {
            case 'feed':
                loadUserFeed(viewingUserId);
                break;
            case 'profile':
                loadUserProfileView(viewingUserId);
                break;
            case 'circles':
                loadUserCircles(viewingUserId);
                break;
            case 'parameters':
          case 'tracking':
    // Get username first, then view parameters in modal
    fetch(`/api/users/${viewingUserId}/profile`, {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch profile');
        return response.json();
    })
    .then(data => {
        viewUserParameters(viewingUserId, data.username || 'User');
    })
    .catch(error => {
        console.error('Error loading user parameters:', error);
        showNotification('Error loading parameters', 'error');
    });
    break;
            case 'following':
                loadUserFollowing(viewingUserId);
                break;
            case 'followers':
                loadUserFollowers(viewingUserId);
                break;
            case 'messages':
                // Don't allow viewing another user's messages
                showNotification('Cannot view another user\'s messages', 'error');
                showView('following');
                break;
            default:
                // For other views, go back to own profile
                viewingUserId = null;
                showView('following');
        }
  } else {
        // Viewing own profile
        switch(viewName) {
            case 'feed':
                viewingUserId = null; // Reset viewing user when returning to own feed
                restoreFeedEditMode(); // Restore editable mode
                initFeedCalendar();
                break;
            case 'profile':
                loadProfile();
                break;
            case 'circles':
                // Reset viewingUserId if returning to own circles
                if (viewingUserId === null || viewingUserId === currentUserId) {
                    viewingUserId = null;
                }
                loadCircles();
                break;
            case 'messages':
                loadConversations();
                break;
            case 'parameters':
            case 'tracking':
                // Initialize parameters calendar
                if (typeof initializeCalendar === 'function') {
                    initializeCalendar();
                }
                // Initialize parameter options (1-4 buttons)
                if (typeof createParameterOptions === 'function') {
                    setTimeout(function() {
                        createParameterOptions('moodInput', 'mood');
                        createParameterOptions('sleepInput', 'sleep');
                        createParameterOptions('exerciseInput', 'exercise');
                        createParameterOptions('stressInput', 'stress');
                        createParameterOptions('socialInput', 'social');
                    }, 100);
                }
                break;
            case 'following':
                loadFollowing();
                break;
            case 'followers':
                loadFollowers();
                break;
                 case 'invite':
                loadInviteView();
                break;
        }
    }
}


// ===============================================
// INVITE VIEW FUNCTIONS
// ===============================================

function loadInviteView() {
    console.log('Loading invite view...');

    fetch('/api/auth/session', {
        credentials: 'include'
    })
        .then(response => {
            console.log('Session response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            const username = data.user?.username || 'user';
            const inviteLink = `${window.location.origin}/invite/${username}`;
            const linkInput = document.getElementById('userInviteLink');
            if (linkInput) {
                linkInput.value = inviteLink;
                console.log('Invite link set:', inviteLink);
            }
        })
        .catch(error => {
            console.error('Error loading invite link:', error);
            if (typeof currentUser !== 'undefined' && currentUser?.username) {
                const linkInput = document.getElementById('userInviteLink');
                if (linkInput) {
                    linkInput.value = `${window.location.origin}/invite/${currentUser.username}`;
                }
            }
        });

    loadUserRecommendations();
}

function loadUserRecommendations() {
    const list = document.getElementById('recommendationsList');
    if (!list) return;

    list.innerHTML = '<div class="loading">Loading recommendations...</div>';

   fetch('/api/users/recommendations', {
        credentials: 'include'
    })
        .then(response => {
            console.log('Recommendations status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.recommendations && data.recommendations.length > 0) {
                list.innerHTML = data.recommendations.map(user => `
                    <div class="user-card">
                        <div class="user-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            ${user.location ? `<div class="user-location">üìç ${user.location}</div>` : ''}
                        </div>
                        <button class="follow-btn" onclick="sendFollowRequestFromInvite(${user.id})">
                            <span data-i18n="invite.send_request">Send Request</span>
                        </button>
                    </div>
                `).join('');

                // Apply translations
                if (window.i18n && window.i18n.applyLanguage) {
                    window.i18n.applyLanguage();
                }
            } else {
                list.innerHTML = '<div class="empty-state">No recommendations available yet. Check back soon!</div>';
            }
        })
       .catch(error => {
            console.error('Error loading recommendations:', error);
            list.innerHTML = `<div class="error-state">Failed to load recommendations: ${error.message}</div>`;
        });
}

function copyUserInviteLink() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        linkInput.select();
        navigator.clipboard.writeText(linkInput.value).then(() => {
            showNotification('Invite link copied to clipboard! üìã', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showNotification('Failed to copy link', 'error');
        });
    }
}

function shareViaEmail() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const subject = encodeURIComponent('Join me on my wellness journey!');
        const body = encodeURIComponent(`I'd love for you to follow my wellness journey on TheraSocial. Click here to connect: ${link}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
}

function shareViaSMS() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const message = encodeURIComponent(`Join me on my wellness journey! ${link}`);
        window.location.href = `sms:?body=${message}`;
    }
}

function shareViaWhatsApp() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const message = encodeURIComponent(`Join me on my wellness journey on TheraSocial! ${link}`);
        window.open(`https://wa.me/?text=${message}`, '_blank');
    }
}

function sendFollowRequestFromInvite(userId) {
    if (typeof followRequestsManager !== 'undefined' && followRequestsManager.sendFollowRequest) {
        followRequestsManager.sendFollowRequest(userId);
    } else {
        // Fallback direct API call
        fetch('/api/follow-requests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ target_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Follow request sent!', 'success');
                // Reload recommendations
                setTimeout(() => loadUserRecommendations(), 1000);
            } else {
                showNotification(data.error || 'Failed to send request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to send follow request', 'error');
        });
    }
}







        // Feed Calendar Functions
     function initFeedCalendar(userId = null) {
            loadFeedSavedDates(userId);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

        async function loadFeedSavedDates(userId = null) {
            try {
                const endpoint = userId ? `/users/${userId}/feed/dates` : '/feed/dates';
                const response = await apiCall(endpoint);
                if (response) {
                    feedSavedDates = Object.keys(response.dates || {});
                }
            } catch (error) {
                console.error('Failed to load feed dates:', error);
            }
        }

        function renderFeedCalendar() {
            const year = feedCurrentMonth.getFullYear();
            const month = feedCurrentMonth.getMonth();

            // FIX: Use numeric month index directly
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + month) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

            document.getElementById('feedCurrentMonth').textContent = `${translatedMonth} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('feedCalendarGrid');
            grid.innerHTML = '';

            // FIX: Get day headers using individual day keys
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            dayNames.forEach(dayKey => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = window.i18n && window.i18n.translate ?
                    window.i18n.translate('day.' + dayKey) :
                    dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
                grid.appendChild(header);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'feed-calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (feedSavedDates.includes(dateStr)) {
                    dayCell.classList.add('has-posts');
                }

                if (feedSelectedDate.getDate() === day &&
                    feedSelectedDate.getMonth() === month &&
                    feedSelectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectFeedDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

    function selectFeedDate(year, month, day) {
            feedSelectedDate = new Date(year, month, day);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();

            // Format date as string for API calls
            const dateStr = feedSelectedDate.toISOString().split('T')[0];

            // Check if viewing another user's feed
            if (viewingUserId !== null && viewingUserId !== currentUserId) {
                loadUserFeedForDate(viewingUserId, dateStr);
            } else {
                loadFeedForDate();
            }
        }

// Load a specific user's feed for a date (read-only)
// Load a specific user's feed for a date (read-only)
// Load a specific user's feed for a date (read-only)
async function loadUserFeedForDate(userId, dateStr) {
    try {
        const response = await fetch(`/api/users/${userId}/feed/${dateStr}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('This update is not available to you based on your circle membership', 'error');
                return;
            }
            throw new Error('Failed to load feed for date');
        }

        const data = await response.json();

        // Display posts in the feed container
        const feedContainer = document.getElementById('feedPostsContainer');
        if (!feedContainer) {
            console.error('Feed posts container not found');
            return;
        }

        const circleNames = {
            1: 'Public',
            2: 'Class B (Friends)',
            3: 'Class A (Family)',
            'general': 'Public',
            'close_friends': 'Class B (Friends)',
            'family': 'Class A (Family)',
            'private': 'Private'
        };

        if (data.posts && data.posts.length > 0) {
            feedContainer.innerHTML = data.posts.map(post => `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${post.category || 'General'}</span>
                        <span class="post-date">${new Date(post.created_at).toLocaleDateString()}</span>
                        ${post.circle_id ? `<span class="post-visibility" style="margin-left: 0.5rem; font-size: 0.85rem; color: var(--gray);">(${circleNames[post.circle_id] || circleNames[post.circle] || 'Public'})</span>` : ''}
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.mood ? `<div class="post-mood" style="margin-top: 0.5rem; color: var(--gray);">Mood: ${post.mood}</div>` : ''}
                    <div class="post-footer" style="margin-top: 1rem;">
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${post.likes_count || 0}</span>
                            <span style="margin-left: 1rem;">üí¨ ${post.comments_count || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No post for this date.</p>';
        }
    } catch (error) {
        console.error('Error loading user feed for date:', error);
        showNotification('Error loading post', 'error');
    }
}





        function updateFeedSelectedDateDisplay() {
            const date = feedSelectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('feedSelectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function feedPreviousMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() - 1);
            renderFeedCalendar();
        }

        function feedNextMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() + 1);
            renderFeedCalendar();
        }

     async function loadFeedForDate() {
    const dateStr = feedSelectedDate.toISOString().split('T')[0];
    let visibility = document.getElementById('visibilitySelect').value;

    // Map old visibility values to ensure backward compatibility
    const visibilityMap = {
        'general': 'general',
        'public': 'general',
        'close_friends': 'close_friends',
        'class_b': 'close_friends',
        'family': 'family',
        'class_a': 'family'
    };

    visibility = visibilityMap[visibility] || visibility;

    try {
        const response = await apiCall(`/feed/${dateStr}?visibility=${visibility}`);

                if (response) {
                    document.getElementById('postInput').value = response.content || '';

                    if (response.content) {
                        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.loaded') : 'Loaded') + ` ${visibility.replace('_', ' ')} feed from ${dateStr}`);
                    } else {
                        alert((window.i18n && window.i18n.t ? window.i18n.t('feed.no_activity') : 'No activity') + ` for ${visibility.replace('_', ' ')} feed on this date`);
                    }
                }
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Feed Functions
        async function loadFeed() {
            try {
                const response = await apiCall('/feed');
                if (!response) return;

                const feedContainer = document.getElementById('feedPosts');
                feedContainer.innerHTML = '';

                if (response.posts && response.posts.length > 0) {
                    response.posts.forEach(post => {
                        const postCard = createPostCard(post);
                        feedContainer.appendChild(postCard);
                    });
                } else {
                    feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }

        function createPostCard(post) {
            const div = document.createElement('div');
            div.className = 'post-card fade-in';

            const author = post.author || 'Anonymous';
            const initial = author.charAt(0).toUpperCase();
            const timeAgo = getTimeAgo(new Date(post.created_at));

            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar">${initial}</div>
                    <div class="post-meta">
                        <div class="post-author">${author}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
            `;

            return div;
        }

        document.getElementById('postBtn').addEventListener('click', async () => {
            const content = document.getElementById('postInput').value.trim();
            const visibility = document.getElementById('visibilitySelect').value;

            if (!content) return;

            try {
                const dateStr = feedSelectedDate.toISOString().split('T')[0];

                await apiCall('/posts', 'POST', {
                    content: content,
                    visibility: visibility,
                    date: dateStr
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ' successfully!');
                loadFeedSavedDates();
                renderFeedCalendar();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Profile Functions

function showNotification(message, type = 'info') {
    // Simple alert for now - you can enhance this later
    alert(message);

    // OR if you have a custom notification system, use it:
    // For example: if you have a div with id="notification"
    // const notif = document.getElementById('notification');
    // notif.textContent = message;
    // notif.className = type;
    // notif.style.display = 'block';
    // setTimeout(() => notif.style.display = 'none', 3000);
}






       async function loadProfile() {
            viewingUserId = null; // Reset when viewing own profile
            try {
                const response = await apiCall('/profile');
                if (!response) return;

                document.getElementById('profileBio').value = response.bio || '';
                document.getElementById('profileInterests').value = response.interests || '';
                document.getElementById('profileOccupation').value = response.occupation || '';
                document.getElementById('profileGoals').value = response.goals || '';
                document.getElementById('profileFavoriteHobbies').value = response.favorite_hobbies || '';
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const profileData = {
                bio: document.getElementById('profileBio').value,
                interests: document.getElementById('profileInterests').value,
                occupation: document.getElementById('profileOccupation').value,
                goals: document.getElementById('profileGoals').value,
                favorite_hobbies: document.getElementById('profileFavoriteHobbies').value
            };

            try {
                await apiCall('/profile', 'PUT', profileData);
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ' successfully!');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Circles Functions
    async function loadCircles() {
    try {
        let response;

        // Check if viewing another user's circles
        if (viewingUserId !== null && viewingUserId !== currentUserId) {
            // Load another user's circles (read-only)
            response = await fetch(`/api/users/${viewingUserId}/circles`, {
                credentials: 'include'
            });

            if (!response.ok) {
                if (response.status === 403) {
                    showNotification('You must follow this user to view their circles', 'error');
                    return;
                }
                throw new Error('Failed to load user circles');
            }

            response = await response.json();

            // Hide add/remove functionality when viewing another user
            hideCircleEditControls();
        } else {
            // Load own circles (editable)
            response = await apiCall('/circles');
            if (!response) return;

            // Show add/remove functionality for own circles
            showCircleEditControls();
        }

        // Handle both old and new data structures
        let generalMembers = response.general || response.public || [];
        let closeFriendsMembers = response.close_friends || response.class_b || [];
        let familyMembers = response.family || response.class_a || [];

        // If circles object exists, use it (new structure)
        if (response.circles) {
            generalMembers = response.circles.general || response.circles.public || [];
            closeFriendsMembers = response.circles.close_friends || response.circles.class_b || [];
            familyMembers = response.circles.family || response.circles.class_a || [];
        }

        updateCircleDisplay('general', generalMembers);
        updateCircleDisplay('close_friends', closeFriendsMembers);
        updateCircleDisplay('family', familyMembers);
    } catch (error) {
        console.error('Failed to load circles:', error);
    }
}

 function hideCircleEditControls() {
    // Hide search box and add buttons
    const searchBox = document.getElementById('userSearchInput');
    const searchResults = document.getElementById('searchResults');

    if (searchBox) {
        searchBox.style.display = 'none';
        searchBox.parentElement.style.display = 'none';
    }
    if (searchResults) {
        searchResults.style.display = 'none';
    }

    // Hide all remove buttons
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.style.display = 'none';
    });
}

function showCircleEditControls() {
    // Show search box and add buttons
    const searchBox = document.getElementById('userSearchInput');

    if (searchBox) {
        searchBox.style.display = '';
        searchBox.parentElement.style.display = '';
    }

    // Show all remove buttons
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.style.display = '';
    });
}




function updateCircleDisplay(type, members) {
    let containerId, countId, displayLabel;

    // Map internal types to display labels and container IDs
    if (type === 'general') {
        containerId = 'generalMembers';
        countId = 'generalCount';
        displayLabel = 'Public';
    } else if (type === 'close_friends') {
        containerId = 'closeFriendsMembers';
        countId = 'closeFriendsCount';
        displayLabel = 'Class B (Friends)';
    } else {
        containerId = 'familyMembers';
        countId = 'familyCount';
        displayLabel = 'Class A (Family)';
    }

    const container = document.getElementById(containerId);
    const count = document.getElementById(countId);

    if (!container || !count) {
        console.error('Container or count element not found for type:', type);
        return;
    }

    count.textContent = members.length;

    // Update the circle header to show the correct label
    const circleSection = container.closest('.circle-card');
    if (circleSection) {
        const headerElement = circleSection.querySelector('.circle-title');
        if (headerElement) {
            // Update the label text while keeping the emoji
            const emoji = type === 'general' ? 'üí•' :
                         type === 'close_friends' ? '‚ù§Ô∏è' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            headerElement.textContent = `${emoji} ${displayLabel}`;
        }
    }

    if (members.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_members') : 'No members yet')}</p>`;
    } else {
        // Check if viewing another user's circles (read-only mode)
        const isReadOnly = viewingUserId !== null && viewingUserId !== currentUserId;

        container.innerHTML = members.map(member => `
            <div class="member-item">
                <div class="member-avatar">${member.username[0].toUpperCase()}</div>
                <span class="member-name">${member.username}</span>
                ${!isReadOnly ? `<button class="remove-btn" onclick="removeFromCircle(${member.id}, '${type}')" data-i18n="circles.remove">${(window.i18n && window.i18n.t ? window.i18n.t('circles.remove') : 'Remove')}</button>` : ''}
            </div>
        `).join('');
    }
}

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value;

            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('searchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" style="display: block; padding: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div class="member-avatar" style="margin-right: 10px;">${user.username[0].toUpperCase()}</div>
                                <div style="flex: 1;">
                                    <strong>${user.username}</strong><br>
                                    <small style="color: var(--gray);">${user.email}</small>
                                    ${user.bio ? `<br><small style="color: var(--gray); font-style: italic;">${user.bio.substring(0, 60)}${user.bio.length > 60 ? '...' : ''}</small>` : ''}
                                </div>
                            </div>
                           <select onchange="addToCircle(${user.id}, this.value, '${user.username}')" style="width: 100%;">
    <option value="">${(window.i18n && window.i18n.t ? window.i18n.t('circles.add_to') : 'Add to circle...')}</option>
    <option value="general">Public</option>
    <option value="close_friends">Class B (Friends)</option>
    <option value="family">Class A (Family)</option>
</select>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function addToCircle(userId, circleType, username) {
            if (!circleType) return;

            try {
                await apiCall('/circles', 'POST', {
                    user_id: userId,
                    circle_type: circleType
                });

                const circleLabels = {
    'general': 'Public',
    'close_friends': 'Class B (Friends)',
    'family': 'Class A (Family)'
};
alert(`${username} added to ${circleLabels[circleType]} circle!`);
                loadCircles();
                document.getElementById('userSearchInput').value = '';
                document.getElementById('searchResults').classList.remove('active');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        async function removeFromCircle(userId, circleType) {
            if (!confirm((window.i18n && window.i18n.t ? window.i18n.t('circles.remove') : 'Remove') + '?')) return;

            try {
                await apiCall('/circles/remove', 'DELETE', {
                    user_id: userId,
                    circle_type: circleType
                });

                loadCircles();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Messages Functions
        async function searchUsersForMessage() {
            const query = document.getElementById('messageUserSearch').value;

            if (query.length < 2) {
                document.getElementById('messageSearchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('messageSearchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" onclick="startConversation(${user.id}, '${user.username}')">
                            <strong>${user.username}</strong>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function startConversation(userId, username) {
            currentRecipient = { id: userId, username: username };
            document.getElementById('messageUserSearch').value = '';
            document.getElementById('messageSearchResults').classList.remove('active');
            loadMessages(userId, username);

            const convList = document.getElementById('conversationsList');
            const existingConv = Array.from(convList.children).find(
                child => child.dataset.userId == userId
            );

            if (!existingConv) {
                loadConversations();
            }
        }

   async function loadConversations() {
    try {
        const response = await apiCall('/messages/conversations');
        console.log('Conversations response:', response);
        if (!response) return;

        const container = document.getElementById('conversationsList');

        // Cache translation strings
       const noConversationsText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_conversations') : 'No conversations yet';
const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

        // FIX: response is already parsed JSON from apiCall, don't parse again
        const data = response;

        if (!data.conversations || data.conversations.length === 0) {
            container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">${noConversationsText}</div>`;
          } else {
            container.innerHTML = data.conversations.map(conv => {
                // Safely access nested properties with fallbacks
                const userId = conv.user && conv.user.id ? conv.user.id : 0;
                const username = conv.user && conv.user.username ? conv.user.username : 'Unknown User';
                const lastMessageCreatedAt = conv.last_message && conv.last_message.created_at ? conv.last_message.created_at : null;
              const lastMessageTime = lastMessageCreatedAt ? formatMessageTime(lastMessageCreatedAt) : '';
                const lastMessageContent = conv.last_message && conv.last_message.content ? conv.last_message.content : noMessagesText;
                const isOwn = conv.last_message && conv.last_message.is_own === true;
                const unreadCount = conv.unread_count || 0;

                // Prevent errors if userId or username is invalid
                if (!userId || !username) {
                    console.warn('Invalid conversation data:', conv);
                    return '';
                }

                // Escape HTML in username to prevent XSS
                const safeUsername = escapeHtml(username);

                return `
                    <div class="conversation-item" data-user-id="${userId}" onclick="loadMessages(${userId}, '${safeUsername}')">
                        <div class="conversation-header">
                            <span class="conversation-username">${safeUsername}</span>
                            <span class="conversation-time">${lastMessageTime}</span>
                        </div>
                        <div class="conversation-preview">
                            ${isOwn ? (youText + ': ') : ''}${escapeHtml(lastMessageContent.substring(0, 50))}${lastMessageContent.length > 50 ? '...' : ''}
                        </div>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                `;
            }).filter(html => html !== '').join('');

            if (currentRecipient && currentRecipient.id) {
                const activeItem = container.querySelector(`[data-user-id="${currentRecipient.id}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }
    } catch (error) {
        console.error('Failed to load conversations:', error);
        const container = document.getElementById('conversationsList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading conversations';
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--danger);">${errorText}</div>`;
    }
}

      async function loadMessages(userId, username) {
    // Validate inputs
    if (!userId || !username) {
        console.error('Invalid userId or username:', { userId, username });
        alert(window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error: Invalid user data');
        return;
    }

    currentRecipient = { id: userId, username: username };

    document.getElementById('chatHeader').textContent = username;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendMessageBtn').disabled = false;

    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.userId == userId) {
            item.classList.add('active');
        }
    });

    try {
        const response = await apiCall(`/messages?recipient_id=${userId}`);
        console.log('Messages response:', response);
        if (!response) return;

        const container = document.getElementById('messagesList');
       const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet. Start the conversation!';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

     if (response.messages && response.messages.length > 0) {
            container.innerHTML = response.messages.map(msg => {
                // Safely check if sender exists and get ID
                const senderId = msg.sender && msg.sender.id ? msg.sender.id : null;
                currentUserId = currentUser && currentUser.id ? currentUser.id : null;  // Remove 'const' - just assign to existing variable
                const isOwn = senderId === currentUserId;
                const content = msg.content || '';
                const senderPrefix = isOwn ? youText : (msg.sender && msg.sender.username ? msg.sender.username : 'Unknown');

                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        <div class="message-bubble">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; opacity: 0.8;">${escapeHtml(senderPrefix)}</div>
                            <div>${escapeHtml(content)}</div>
                            <div class="message-time">${formatMessageTime(msg.created_at)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">${noMessagesText}</div>`;
        }

        container.scrollTop = container.scrollHeight;

        await apiCall(`/messages/read/${userId}`, 'POST');
        loadConversations();
    } catch (error) {
        console.error('Failed to load messages:', error);
        const container = document.getElementById('messagesList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading messages';
        container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--danger);">${errorText}</div>`;
    }
}

    document.getElementById('sendMessageBtn').addEventListener('click', async () => {
    // Check if recipient is selected
    if (!currentRecipient || !currentRecipient.id) {
       const errorText = window.i18n && window.i18n.t ? window.i18n.t('messages.select_conversation') : 'Please select a conversation first';
        alert(errorText);
        return;
    }

    const content = document.getElementById('messageInput').value.trim();
    if (!content) return;

    try {
        const response = await apiCall('/messages', 'POST', {
            recipient_id: currentRecipient.id,
            content: content
        });

        // Validate response before proceeding
        if (response && response.success) {
            document.getElementById('messageInput').value = '';
            await loadMessages(currentRecipient.id, currentRecipient.username);
            await loadConversations();
        } else {
            throw new Error(response && response.error ? response.error : 'Failed to send message');
        }
    } catch (error) {
        console.error('Send message error:', error);
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error';
        alert(errorText + ': ' + (error.message || 'Failed to send message'));
    }
});

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Parameters/Tracking Functions
        // Parameters/Tracking Functions
function initCalendar() {
    // Call the calendar initialization from parameters-social.js
    if (typeof initializeCalendar === 'function') {
        initializeCalendar();
    }

    // Also initialize the 1-4 parameter options
    if (typeof createParameterOptions === 'function') {
        // Small delay to ensure DOM is ready
        setTimeout(function() {
            createParameterOptions('moodInput', 'mood');
            createParameterOptions('sleepInput', 'sleep');
            createParameterOptions('exerciseInput', 'exercise');
            createParameterOptions('stressInput', 'stress');
            createParameterOptions('socialInput', 'social');
        }, 100);
    }
}




// Initialize calendar with saved dates
async function initializeCalendar() {
    try {
        // Load saved dates first
        if (typeof loadSavedDates === 'function') {
            await loadSavedDates();
        }
        // Then render the calendar
        renderCalendar();
        updateSelectedDateDisplay();
    } catch (error) {
        console.error('Error initializing calendar:', error);
    }
}



// Remove or comment out your local loadSavedDates function
// The one in parameters-social.js will be used instead
function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    // FIX: Use numeric month index directly
    const translatedMonth = window.i18n && window.i18n.translate ?
        window.i18n.translate('calendar.' + month) :
        ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

    document.getElementById('currentMonth').textContent = `${translatedMonth} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    // FIX: Get day headers using individual day keys
    const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    dayNames.forEach(dayKey => {
        const header = document.createElement('div');
        header.style.fontWeight = '600';
        header.style.textAlign = 'center';
        header.style.padding = '8px';
        header.textContent = window.i18n && window.i18n.translate ?
            window.i18n.translate('day.' + dayKey) :
            dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
        grid.appendChild(header);
    });

    for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        dayCell.textContent = day;

        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // Check if this date has saved data
        if (savedDates && savedDates.includes(dateStr)) {
            dayCell.classList.add('has-data');
            // Add green dot indicator
            const dot = document.createElement('div');
            dot.className = 'parameter-dot';
            dot.style.cssText = 'width: 6px; height: 6px; background: #10B981; border-radius: 50%; position: absolute; bottom: 2px; right: 2px;';
            dayCell.style.position = 'relative';
            dayCell.appendChild(dot);
        }

        if (selectedDate.getDate() === day &&
            selectedDate.getMonth() === month &&
            selectedDate.getFullYear() === year) {
            dayCell.classList.add('selected');
        }

        dayCell.onclick = () => selectDate(year, month, day);
        grid.appendChild(dayCell);
    }

    // Ensure saved dates are loaded
    if (typeof loadSavedDates === 'function') {
        loadSavedDates();
    }
}

  function selectDate(year, month, day) {
    selectedDate = new Date(year, month, day);
    renderCalendar();
    updateSelectedDateDisplay();

    const dateStr = selectedDate.toISOString().split('T')[0];

    // Check if viewing another user's parameters
    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        loadUserParametersForDate(viewingUserId, dateStr);
    } else {
        loadParametersForDate(dateStr);
    }
}




// Load a specific user's parameters for a date (read-only)
async function loadUserParametersForDate(userId, dateStr) {
    try {
        const response = await fetch(`/api/user/${userId}/parameters/${dateStr}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their parameters', 'error');
                return;
            }
            throw new Error('Failed to load parameters for date');
        }

        const data = await response.json();

        if (data.success && data.data) {
            const params = data.data.parameters;

            // Display parameters as read-only
            displayParameterReadOnly('moodInput', params.mood, 'Mood');
            displayParameterReadOnly('sleepInput', params.sleep_quality, 'Sleep');
            displayParameterReadOnly('exerciseInput', params.physical_activity, 'Exercise');
            displayParameterReadOnly('anxietyInput', params.anxiety, 'Anxiety');

            // Display notes if present
            const notesElement = document.getElementById('parameterNotes');
            if (notesElement) {
                notesElement.value = data.data.notes || 'No notes for this date';
                notesElement.disabled = true;
                notesElement.style.backgroundColor = '#f3f4f6';
                notesElement.style.cursor = 'default';
            }
        } else {
            // No data for this date
            clearParameterDisplays();
        }

        // Hide all save buttons
        document.querySelectorAll('#trackingView button, #parametersView button').forEach(btn => {
            if (btn.textContent.includes('Save') || btn.textContent.includes('Submit') || btn.type === 'submit') {
                btn.style.display = 'none';
            }
        });
    } catch (error) {
        console.error('Error loading user parameters for date:', error);
        clearParameterDisplays();
    }
}

// Helper function to display a single parameter as read-only
function displayParameterReadOnly(elementId, value, label) {
    const element = document.getElementById(elementId);
    if (!element) return;

    if (value !== null && value !== undefined && value !== '') {
        // Create a read-only display
        element.innerHTML = `
            <div style="padding: 10px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: 600;">
                ${label}: ${value}/4
            </div>
        `;
    } else {
        element.innerHTML = `
            <div style="padding: 10px; background: var(--light); color: var(--gray); border-radius: 8px; text-align: center;">
                No data
            </div>
        `;
    }
}

// Helper function to clear all parameter displays
function clearParameterDisplays() {
    displayParameterReadOnly('moodInput', null, 'Mood');
    displayParameterReadOnly('sleepInput', null, 'Sleep');
    displayParameterReadOnly('exerciseInput', null, 'Exercise');
    displayParameterReadOnly('anxietyInput', null, 'Anxiety');

    const notesElement = document.getElementById('parameterNotes');
    if (notesElement) {
        notesElement.value = 'No data for this date';
        notesElement.disabled = true;
        notesElement.style.backgroundColor = '#f3f4f6';
        notesElement.style.cursor = 'default';
    }
}




        function updateSelectedDateDisplay() {
            const date = selectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('selectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        document.getElementById('sleepInput').addEventListener('input', (e) => {
            const hours = e.target.value || 0;
            const hoursText = window.i18n && window.i18n.t ? window.i18n.t('parameters.sleep_hours') : 'Hours';
            document.getElementById('sleepDisplay').innerHTML = `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;
        });

    async function saveParameters() {
    const dateStr = selectedDate.toISOString().split('T')[0];

    // Helper to get selected radio button value
    function getSelectedRadioValue(name) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : '';
    }

    const parameters = {
        date: dateStr,
        mood: getSelectedRadioValue('mood'),
        sleep_hours: getSelectedRadioValue('sleep'),
        exercise: getSelectedRadioValue('exercise'),
        stress: getSelectedRadioValue('stress'),
        social: getSelectedRadioValue('social'),
        notes: document.getElementById('notesInput') ?
               document.getElementById('notesInput').value : ''
    };

    try {
        await apiCall('/parameters/save', 'POST', parameters);
        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ` for ${dateStr}`);

        // Reload calendar to show saved dates
        if (typeof loadSavedDates === 'function') {
            loadSavedDates();
        }
        if (typeof renderCalendar === 'function') {
            renderCalendar();
        }
    } catch (error) {
        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
    }
}

     async function loadParameters() {
    const dateStr = selectedDate.toISOString().split('T')[0];

    // Helper to set radio button selection
    function setRadioValue(name, value) {
        if (value) {
            const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
            }
        }
    }

    try {
        const response = await apiCall(`/parameters/load/${dateStr}`);

        if (response && response.success) {
            const data = response.data;

            // Set radio button selections
            setRadioValue('mood', data.mood);
            setRadioValue('sleep', data.sleep_hours);
            setRadioValue('exercise', data.exercise);
            setRadioValue('stress', data.stress || data.anxiety); // Handle old 'anxiety' field
            setRadioValue('social', data.social || data.energy); // Handle old 'energy' field

            // Set notes if textarea exists
            if (document.getElementById('notesInput') && data.notes) {
                document.getElementById('notesInput').value = data.notes;
            }

            // Update sleep display if it exists
            if (document.getElementById('sleepDisplay') && data.sleep_hours) {
                const hours = data.sleep_hours || 0;
                const hoursText = window.i18n && window.i18n.t ?
                    window.i18n.t('parameters.sleep_hours') : 'Hours';
                document.getElementById('sleepDisplay').innerHTML =
                    `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;
            }

            console.log('Parameters loaded from', dateStr);
        } else {
            alert((window.i18n && window.i18n.t ?
                window.i18n.t('parameters.no_data') : 'No data') + ' for this date');
        }
    } catch (error) {
        alert((window.i18n && window.i18n.t ?
            window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
    }
}


// Fix parameter persistence when switching dates
async function loadParametersForDate(dateStr) {
    // Clear all previous selections first
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
    });

    // Clear notes
    const notesInput = document.getElementById('notesInput');
    if (notesInput) {
        notesInput.value = '';
    }

    try {
        const response = await apiCall(`/parameters/load/${dateStr}`);

        if (response && response.success && response.data) {
            const data = response.data;

            // Set radio button selections using proper value matching
            if (data.mood) {
                const moodRadio = document.querySelector(`input[name="mood"][value="${data.mood}"]`);
                if (moodRadio) moodRadio.checked = true;
            }

            if (data.sleep_hours) {
                const sleepRadio = document.querySelector(`input[name="sleep"][value="${data.sleep_hours}"]`);
                if (sleepRadio) sleepRadio.checked = true;
            }

            if (data.exercise) {
                const exerciseRadio = document.querySelector(`input[name="exercise"][value="${data.exercise}"]`);
                if (exerciseRadio) exerciseRadio.checked = true;
            }

            if (data.stress || data.anxiety) {
                const stressRadio = document.querySelector(`input[name="stress"][value="${data.stress || data.anxiety}"]`);
                if (stressRadio) stressRadio.checked = true;
            }

            if (data.social || data.energy) {
                const socialRadio = document.querySelector(`input[name="social"][value="${data.social || data.energy}"]`);
                if (socialRadio) socialRadio.checked = true;
            }

            // Set notes
            if (notesInput && data.notes) {
                notesInput.value = data.notes;
            }
        }
    } catch (error) {
        console.error('Error loading parameters:', error);
    }
}




// Following/Followers Functions
    async function loadFollowing() {
    try {
        // Load people user is following
        const followingResponse = await fetch('/api/following', {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!followingResponse.ok) throw new Error('Failed to load following');
        const followingData = await followingResponse.json();

        // Load recommended users
        const recommendedResponse = await fetch('/api/recommendations', {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!recommendedResponse.ok) throw new Error('Failed to load recommended');
        const recommendedData = await recommendedResponse.json();

        // Display following
        const followingContainer = document.querySelector('#followingList');
        if (followingContainer) {
            if (followingData.following && followingData.following.length > 0) {
                followingContainer.innerHTML = followingData.following.map(user => `
                    <div class="user-card" data-user-id="${user.id}">
                        <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-location">${user.selected_city || user.city || 'Unknown'}</div>
                        </div>
                        <button class="btn-secondary unfollow-btn" data-user-id="${user.id}">
                            Unfollow
                        </button>
                    </div>
                `).join('');

                // Add click handlers to view profiles
                followingContainer.querySelectorAll('.user-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('unfollow-btn')) {
                            const userId = card.dataset.userId;
                            viewUserProfile(parseInt(userId));
                        }
                    });
                });

                // Add unfollow handlers
                followingContainer.querySelectorAll('.unfollow-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const userId = btn.dataset.userId;
                        await unfollowUser(parseInt(userId));
                        loadFollowing();
                    });
                });
            } else {
                followingContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">You are not following anyone yet. Check out recommended users below!</p>';
            }
        }

        // Display recommended
        const recommendedContainer = document.querySelector('#recommendationsList');
        if (recommendedContainer) {
            const recommendations = recommendedData.recommendations || [];

            if (recommendations && recommendations.length > 0) {
                recommendedContainer.innerHTML = recommendations.map(user => `
                    <div class="user-card">
                        <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-location">${user.selected_city || user.city || 'Unknown'}</div>
                            ${user.reason ? `<div class="user-reason" style="font-size: 0.75rem; color: var(--gray);">${user.reason}</div>` : ''}
                        </div>
                        <button class="btn-primary follow-btn" data-user-id="${user.id}">
                            Follow
                        </button>
                    </div>
                `).join('');

                // Add follow handlers
                recommendedContainer.querySelectorAll('.follow-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const userId = btn.dataset.userId;
                        await followUser(parseInt(userId));
                        loadFollowing();
                    });
                });
            } else {
                recommendedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No recommendations available. Try updating your city in your profile!</p>';
            }
        }
    } catch (error) {
        console.error('Error loading following:', error);
        showNotification('Failed to load following', 'error');
    }
}



async function loadUserFollowing(userId) {
    try {
        // Get the user's profile first for the username
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (!profileResponse.ok) {
            throw new Error('Failed to load user profile');
        }
        const userProfile = await profileResponse.json();

        // Update header
        const followingHeader = document.querySelector('#followingView h2');
        if (followingHeader) {
            followingHeader.textContent = `${userProfile.username}'s Following`;
        }

        // For now, show a message that this feature requires backend support
        const container = document.getElementById('followingList') || document.querySelector('#followingView .following-list');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <p style="margin-bottom: 1rem;">Following list for other users is currently view-only.</p>
                    <p style="font-size: 0.875rem;">This user's following list is private.</p>
                </div>
            `;
        }

        // Add back button
        addBackToFollowingButton('followingView');

    } catch (error) {
        console.error('Error loading user following:', error);
        showNotification('Failed to load user following', 'error');
    }
}




    async function loadFollowers() {
    try {
        const response = await fetch('/api/followers', {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load followers');
        const data = await response.json();

        const followersContainer = document.querySelector('#followersList');
        if (followersContainer) {
            if (data.followers && data.followers.length > 0) {
                followersContainer.innerHTML = data.followers.map(user => `
                    <div class="user-card" data-user-id="${user.id}">
                        <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-location">${user.selected_city || user.city || 'Unknown'}</div>
                        </div>
                        ${user.is_following_back ? '<span style="color: var(--success); font-size: 0.875rem;">Following back</span>' : ''}
                    </div>
                `).join('');

                // Add click handlers to view profiles
                followersContainer.querySelectorAll('.user-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const userId = card.dataset.userId;
                        viewUserProfile(parseInt(userId));
                    });
                });
            } else {
                followersContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No one is following you yet.</p>';
            }
        }
    } catch (error) {
        console.error('Error loading followers:', error);
        showNotification('Failed to load followers', 'error');
    }
}



async function loadUserFollowers(userId) {
    try {
        // Get the user's profile first for the username
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (!profileResponse.ok) {
            throw new Error('Failed to load user profile');
        }
        const userProfile = await profileResponse.json();

        // Update header
        const followersHeader = document.querySelector('#followersView h2');
        if (followersHeader) {
            followersHeader.textContent = `${userProfile.username}'s Followers`;
        }

        // For now, show a message that this feature requires backend support
        const container = document.getElementById('followersList') || document.querySelector('#followersView .followers-list');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <p style="margin-bottom: 1rem;">Followers list for other users is currently view-only.</p>
                    <p style="font-size: 0.875rem;">This user's followers list is private.</p>
                </div>
            `;
        }

        // Add back button
        addBackToFollowingButton('followersView');

    } catch (error) {
        console.error('Error loading user followers:', error);
        showNotification('Failed to load user followers', 'error');
    }
}








async function followUser(userId) {
    try {
        const response = await fetch(`/api/follow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to follow user');
        showNotification('Successfully followed user', 'success');
    } catch (error) {
        console.error('Error following user:', error);
        showNotification('Failed to follow user', 'error');
    }
}

async function unfollowUser(userId) {
    try {
        const response = await fetch(`/api/unfollow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to unfollow user');
        showNotification('Successfully unfollowed user', 'success');
    } catch (error) {
        console.error('Error unfollowing user:', error);
        showNotification('Failed to unfollow user', 'error');
    }
}

async function viewUserProfile(userId) {
    try {
        viewingUserId = userId;

        // Get current user ID from session or local storage
        const sessionResponse = await fetch('/api/profile', {credentials: 'include'});
        if (sessionResponse.ok) {
            const sessionData = await sessionResponse.json();
            currentUserId = sessionData.id || sessionData.user_id;
        }

        // Show profile view first
       // Show profile view first
showView('profile');

// Hide messages tab when viewing another user
updateMessagesNavVisibility();

    } catch (error) {
        console.error('Error viewing user profile:', error);
        showNotification('Failed to load user profile', 'error');
    }
}

// Function to view another user's parameters
async function viewUserParameters(userId, username) {
    console.log('[DEBUG] viewUserParameters called with userId:', userId, 'username:', username);

    // Prevent duplicate calls - stop double modal issue
    if (window._loadingParametersFor === userId) {
        console.log('[DEBUG] Already loading parameters for user', userId, '- ignoring duplicate call');
        return;
    }
    window._loadingParametersFor = userId;

    console.log('[DEBUG] Showing loading modal');
    // Show loading modal immediately
    showLoadingModal();

    try {
        console.log(`[DEBUG] Loading parameters for user ${userId} (${username})`);

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);

        const start = startDate.toISOString().split('T')[0];
        const end = endDate.toISOString().split('T')[0];

        console.log('[DEBUG] Fetching parameters from API:', start, 'to', end);
        const response = await fetch(`/api/users/${userId}/parameters?start_date=${start}&end_date=${end}`);
        console.log('[DEBUG] API response status:', response.status);

        if (response.status === 401) {
            console.log('[DEBUG] Unauthorized - redirecting to login');
            closeLoadingModal();
            window.location.href = '/';
            return;
        }

        if (response.status === 403) {
            console.log('[DEBUG] Forbidden - must follow user');
            closeLoadingModal();
            showNotification('You must follow this user to view their parameters', 'error');
            return;
        }

        if (!response.ok) {
            console.log('[DEBUG] Response not OK:', response.status);
            closeLoadingModal();
            throw new Error(`Failed to load parameters: ${response.status}`);
        }

        const parameters = await response.json();
        console.log('[DEBUG] Parameters received:', parameters.length, 'entries');
        console.log('[DEBUG] Parameters data:', parameters);

        // Close loading modal before showing parameters
        console.log('[DEBUG] Closing loading modal');
        closeLoadingModal();

        // Show parameters modal
        console.log('[DEBUG] Calling showUserParametersModal');
        showUserParametersModal(userId, username, parameters, start, end);
        console.log('[DEBUG] showUserParametersModal completed');

    } catch (error) {
        console.error('[DEBUG] Error loading user parameters:', error);
        closeLoadingModal();
        showNotification('Failed to load user parameters', 'error');
    } finally {
        // Always clear the flag when done (even if error occurred)
        console.log('[DEBUG] Clearing loading flag');
        window._loadingParametersFor = null;
    }
}

function showUserParametersModal(userId, username, parameters, startDate, endDate) {
    console.log('[DEBUG] showUserParametersModal called');
    console.log('[DEBUG] Parameters:', parameters.length, 'entries');

    // Remove any existing modal first
    const existing = document.getElementById('userParametersModal');
    if (existing) {
        console.log('[DEBUG] Removing existing modal');
        existing.remove();
    }

   // Format the date range display
    const formatDate = (dateStr) => {
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    // Build the parameters display for ALL entries
    let parametersHtml = '';

    if (!parameters || parameters.length === 0) {
        parametersHtml = '<p style="text-align: center; color: #666;">No data available for this period</p>';
    } else {
        // Group parameters by date and display each one
        parametersHtml = '<div class="parameters-timeline">';

        parameters.forEach(param => {
            // Parse date string as local date to avoid timezone issues
            const [year, month, day] = param.date.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            parametersHtml += `
                <div class="parameter-day" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: #333;">${dateStr}</h4>
                    <div class="parameter-values" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            `;

            // Display each parameter with privacy handling
            const paramLabels = {
                mood: 'üòä Mood',
                energy: '‚ö° Energy',
                sleep_quality: 'üò¥ Sleep Quality',
                physical_activity: 'üèÉ Physical Activity',
                anxiety: 'üò∞ Anxiety'
            };

            for (const [key, label] of Object.entries(paramLabels)) {
                if (param[key] !== null && param[key] !== undefined) {
                    parametersHtml += `
                        <div class="param-item" style="padding: 8px; background: white; border-radius: 5px;">
                            <span style="font-size: 0.9em; color: #666;">${label}:</span>
                            <strong style="margin-left: 5px; color: #333;">${param[key]}/4</strong>
                        </div>
                    `;
                } else {
                    parametersHtml += `
                        <div class="param-item" style="padding: 8px; background: white; border-radius: 5px; opacity: 0.5;">
                            <span style="font-size: 0.9em; color: #999;">${label}:</span>
                            <span style="margin-left: 5px; color: #999;">Private</span>
                        </div>
                    `;
                }
            }

            // Add notes if available
            if (param.notes) {
                parametersHtml += `
                    <div style="grid-column: 1 / -1; margin-top: 10px; padding: 8px; background: white; border-radius: 5px;">
                        <span style="font-size: 0.9em; color: #666;">üìù Notes:</span>
                        <div style="margin-top: 5px; color: #333;">${escapeHtml(param.notes)}</div>
                    </div>
                `;
            }

            parametersHtml += '</div></div>';
        });

        parametersHtml += '</div>';
    }

    const modalHtml = `
        <div id="userParametersModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>${escapeHtml(username)}'s Parameters</h2>
                    <span class="close" onclick="closeUserParametersModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p style="color: #666; margin-bottom: 20px;">
                        Showing data from ${formatDate(startDate)} to ${formatDate(endDate)}
                        <br><small>(${parameters.length} ${parameters.length === 1 ? 'entry' : 'entries'})</small>
                    </p>
                    ${parametersHtml}
                </div>
            </div>
        </div>
    `;

    console.log('[DEBUG] Inserting modal HTML');
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const modal = document.getElementById('userParametersModal');
    console.log('[DEBUG] Modal element:', modal ? 'found' : 'NOT FOUND');

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeUserParametersModal();
        });
        console.log('[DEBUG] Modal event listener added');
    }
}

function closeUserParametersModal() {
    const modal = document.getElementById('userParametersModal');
    if (modal) modal.remove();
}


function showLoadingModal() {
    // Remove any existing loading modal
    const existing = document.getElementById('loadingParametersModal');
    if (existing) existing.remove();

    const loadingHtml = `
        <div id="loadingParametersModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div class="modal-body" style="padding: 2rem;">
                    <div class="loading-spinner" style="
                        width: 50px;
                        height: 50px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #667eea;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 1rem;
                    "></div>
                    <p style="color: #666; font-size: 16px;">Loading parameters...</p>
                </div>
            </div>
        </div>
        <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
    `;

    document.body.insertAdjacentHTML('beforeend', loadingHtml);
}

function closeLoadingModal() {
    const modal = document.getElementById('loadingParametersModal');
    if (modal) modal.remove();
}




function formatDateDisplay(dateString) {
    // Handle date string as local date, not UTC
    // If dateString is "2025-10-11", treat it as October 11 in local time
    const [year, month, day] = dateString.split('-').map(Number);
    const date = new Date(year, month - 1, day); // month is 0-indexed
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}





async function loadUserProfileView(userId) {
    // Set the viewing user ID so feed knows we're viewing another user
    viewingUserId = userId;

    try {
        const response = await fetch(`/api/users/${userId}/profile`, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their profile', 'error');
                showView('following');
                return;
            }
            throw new Error('Failed to load profile');
        }

        const userData = await response.json();

        // Update header
        const profileHeader = document.querySelector('#profileView h2');
        if (profileHeader) {
            profileHeader.textContent = `${userData.username}'s Profile`;
        }

        // Update profile avatar and username
        const profileAvatar = document.getElementById('profileAvatar');
        const profileUsername = document.getElementById('profileUsername');
        if (profileAvatar) {
            profileAvatar.textContent = userData.username.charAt(0).toUpperCase();
        }
        if (profileUsername) {
            profileUsername.textContent = userData.username;
        }

        // Populate all profile fields with user data
        const bioElement = document.getElementById('profileBio');
        const interestsElement = document.getElementById('profileInterests');
        const occupationElement = document.getElementById('profileOccupation');
        const goalsElement = document.getElementById('profileGoals');
        const hobbiesElement = document.getElementById('profileFavoriteHobbies');

        if (bioElement) {
            bioElement.value = userData.bio || '';
            bioElement.disabled = true;
            bioElement.style.backgroundColor = '#f3f4f6';
            bioElement.style.cursor = 'default';
        }

        if (interestsElement) {
            interestsElement.value = userData.interests || '';
            interestsElement.disabled = true;
            interestsElement.style.backgroundColor = '#f3f4f6';
            interestsElement.style.cursor = 'default';
        }

        if (occupationElement) {
            occupationElement.value = userData.occupation || '';
            occupationElement.disabled = true;
            occupationElement.style.backgroundColor = '#f3f4f6';
            occupationElement.style.cursor = 'default';
        }

        if (goalsElement) {
            goalsElement.value = userData.goals || '';
            goalsElement.disabled = true;
            goalsElement.style.backgroundColor = '#f3f4f6';
            goalsElement.style.cursor = 'default';
        }

        if (hobbiesElement) {
            hobbiesElement.value = userData.favorite_hobbies || '';
            hobbiesElement.disabled = true;
            hobbiesElement.style.backgroundColor = '#f3f4f6';
            hobbiesElement.style.cursor = 'default';
        }

        // Hide the Save Profile button and any edit buttons
        const saveButton = document.getElementById('updateProfileBtn');
        if (saveButton) {
            saveButton.style.display = 'none';
        }

        document.querySelectorAll('#profileView .btn-primary, #profileView .btn-secondary').forEach(btn => {
            if (btn.textContent.includes('Edit') || btn.textContent.includes('Save') || btn.textContent.includes('Add')) {
                btn.style.display = 'none';
            }
        });

        // Add back button
        addBackToFollowingButton('profileView');

    } catch (error) {
        console.error('Error loading user profile:', error);
        showNotification('Failed to load user profile', 'error');
    }
}



// Hide or show messages nav based on viewing context
function updateMessagesNavVisibility() {
    const mobileMessagesNav = document.getElementById('mobileMessagesNav');
    const desktopMessagesNav = document.getElementById('desktopMessagesNav');

    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user - hide messages
        if (mobileMessagesNav) mobileMessagesNav.style.display = 'none';
        if (desktopMessagesNav) desktopMessagesNav.style.display = 'none';
    } else {
        // Viewing own profile - show messages
        if (mobileMessagesNav) mobileMessagesNav.style.display = '';
        if (desktopMessagesNav) desktopMessagesNav.style.display = '';
    }
}




async function loadUserFeed(userId) {
    try {
        // Get current user ID to check if viewing own feed
        const sessionResponse = await fetch('/api/auth/session', {
            credentials: 'include'
        });
        const sessionData = await sessionResponse.json();
        const isOwnFeed = sessionData.user_id === userId;

        // Load the calendar for this user
        window.viewingUserId = userId;
        window.currentUserId = sessionData.user_id;
        initFeedCalendar(isOwnFeed ? null : userId);

        const response = await fetch(`/api/users/${userId}/posts`, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their feed', 'error');
                showView('following');
                return;
            }
            throw new Error('Failed to load feed');
        }

        const data = await response.json();

        // Get username for header
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (profileResponse.ok) {
            const user = await profileResponse.json();
            const feedHeader = document.querySelector('#feedView h2');
            if (feedHeader) feedHeader.textContent = `${user.username}'s Feed`;
        }

        // Hide post creation form when viewing others' feeds
     // Hide/modify elements when viewing others' feeds
        if (!isOwnFeed) {
            // Hide textarea
            const postInput = document.getElementById('postInput');
            if (postInput) {
                postInput.style.display = 'none';
            }

            // Hide visibility selector
            const visibilitySelect = document.getElementById('visibilitySelect');
            if (visibilitySelect) {
                visibilitySelect.style.display = 'none';
            }

            // Hide ONLY the Save Update button, keep Load Update visible
            const saveBtn = document.getElementById('postBtn');
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        }

        // Display posts
        const feedContainer = document.querySelector('#feedView .feed-posts, #feedView .posts-container, #feedView .feed-content');
        if (!feedContainer) {
            console.error('Feed container not found');
            return;
        }

        const circleNames = {
            1: 'Public',
            2: 'Class B (Friends)',
            3: 'Class A (Family)',
            'general': 'Public',
            'close_friends': 'Class B (Friends)',
            'family': 'Class A (Family)',
            'private': 'Private'
        };

        if (data.posts && data.posts.length > 0) {
            feedContainer.innerHTML = data.posts.map(post => `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${post.category || 'General'}</span>
                        <span class="post-date">${new Date(post.created_at).toLocaleDateString()}</span>
                        ${post.circle_id ? `<span class="post-visibility" style="margin-left: 0.5rem; font-size: 0.85rem; color: var(--gray);">(${circleNames[post.circle_id] || circleNames[post.circle] || 'Public'})</span>` : ''}
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.mood ? `<div class="post-mood" style="margin-top: 0.5rem; color: var(--gray);">Mood: ${post.mood}</div>` : ''}
                    <div class="post-footer" style="margin-top: 1rem; display: flex; justify-content: space-between;">
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${post.likes_count || 0}</span>
                            <span style="margin-left: 1rem;">üí¨ ${post.comments_count || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No posts yet.</p>';
        }

        // Add back button
        addBackToFollowingButton('feedView');

    } catch (error) {
        console.error('Error loading user feed:', error);
        showNotification('Failed to load user feed', 'error');
    }
}

async function loadUserCircles(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/circles`, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their circles', 'error');
                showView('following');
                return;
            }
            throw new Error('Failed to load circles');
        }

        const data = await response.json();

        // Get username for header
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (profileResponse.ok) {
            const user = await profileResponse.json();
            const circlesHeader = document.querySelector('#circlesView h2');
            if (circlesHeader) circlesHeader.textContent = `${user.username}'s Circles`;
        }

        // Hide the user search bar completely (can't add people to their circles)
        const userSearch = document.querySelector('#circlesView .user-search');
        if (userSearch) userSearch.style.display = 'none';

        // Hide all buttons (add, remove, etc)
        document.querySelectorAll('#circlesView button').forEach(btn => {
            if (!btn.classList.contains('back-to-following-btn')) {
                btn.style.display = 'none';
            }
        });

        // Display the three circle types with their members
        const generalContainer = document.getElementById('generalMembers');
        const closeFriendsContainer = document.getElementById('closeFriendsMembers');
        const familyContainer = document.getElementById('familyMembers');
        const generalCount = document.getElementById('generalCount');
        const closeFriendsCount = document.getElementById('closeFriendsCount');
        const familyCount = document.getElementById('familyCount');

        // FIXED: Backend now returns {general: [...], close_friends: [...], family: [...]}
        // Convert to the format this function expects
         const generalCircle = {members: data.public || []};
        const closeFriendsCircle = {members: data.class_b || []};
        const familyCircle = {members: data.class_a || []};

        // Helper function to display members read-only (UNCHANGED)
        function displayMembersReadOnly(container, countElement, circle) {
            if (!container || !countElement) return;

            const members = circle && circle.members ? circle.members : [];
            countElement.textContent = members.length;

            if (members.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">No members yet</p>';
            } else {
                container.innerHTML = members.map(member => `
                    <div class="member-item" style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div class="member-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: 600;">
                            ${member.username ? member.username[0].toUpperCase() : 'U'}
                        </div>
                        <span style="font-weight: 500;">${member.username || 'Unknown'}</span>
                    </div>
                `).join('');
            }

            // Remove all action buttons from member items
            container.querySelectorAll('button').forEach(btn => btn.remove());
        }

        displayMembersReadOnly(generalContainer, generalCount, generalCircle);
        displayMembersReadOnly(closeFriendsContainer, closeFriendsCount, closeFriendsCircle);
        displayMembersReadOnly(familyContainer, familyCount, familyCircle);

        // Add back button
        addBackToFollowingButton('circlesView');

    } catch (error) {
        console.error('Error loading user circles:', error);
        showNotification('Failed to load user circles', 'error');
    }
}

// Old loadUserParameters function removed - now using viewUserParameters with modal display

function addBackToFollowingButton(viewId) {
    const view = document.getElementById(viewId);
    if (!view) return;

    // Check if back button already exists
    if (view.querySelector('.back-to-following-btn')) return;

    const backButton = document.createElement('button');
    backButton.className = 'btn-secondary back-to-following-btn';
    backButton.textContent = '‚Üê Back to Following';
    backButton.style.marginBottom = '1rem';
    backButton.onclick = () => {
        viewingUserId = null;

        // Re-enable profile fields if in profile view
        if (viewId === 'profileView') {
            const bioElement = document.getElementById('profileBio');
            const interestsElement = document.getElementById('profileInterests');
            const occupationElement = document.getElementById('profileOccupation');
            const goalsElement = document.getElementById('profileGoals');
            const hobbiesElement = document.getElementById('profileFavoriteHobbies');
            const saveButton = document.getElementById('updateProfileBtn');

            // Re-enable all fields
            [bioElement, interestsElement, occupationElement, goalsElement, hobbiesElement].forEach(el => {
                if (el) {
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                }
            });

            // Show save button
            if (saveButton) {
                saveButton.style.display = '';
            }

            // Reload current user's profile data
            loadProfile();
        }

        // Show all edit buttons again
        document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => {
            btn.style.display = '';
        });
        // Show post forms again
        document.querySelectorAll('form, .post-creation, .parameter-inputs').forEach(form => {
            form.style.display = '';
        });
        // Reset headers
        const profileHeader = document.querySelector('#profileView h2');
        if (profileHeader) profileHeader.textContent = 'Profile';
        const feedHeader = document.querySelector('#feedView h2');
        if (feedHeader) feedHeader.textContent = 'Feed';
        const circlesHeader = document.querySelector('#circlesView h2');
        if (circlesHeader) circlesHeader.textContent = 'Circles';
        const parametersHeader = document.querySelector('#parametersView h2, #trackingView h2');
        if (parametersHeader) parametersHeader.textContent = 'Wellness Parameters';

        showView('following');
    };

    view.insertBefore(backButton, view.firstChild);
}





        // Alerts Functions
  async function loadAlerts() {
            try {
                const response = await apiCall('/alerts');
                if (!response) return;

                const container = document.getElementById('alertsList');

                if (!response.alerts || response.alerts.length === 0) {
                    container.innerHTML = `<p style="color: var(--gray);" data-i18n="alerts.no_alerts">${translateKey('alerts.no_alerts')}</p>`;
                } else {
                    container.innerHTML = response.alerts.map(alert => {
                        let title = alert.title || '';
                        let content = alert.message || alert.content || '';

                        // Handle JSON-structured titles (new format from backend)
                        try {
                            const titleData = JSON.parse(title);
                            if (titleData.key && titleData.params) {
                                const translatedBase = translateKey(titleData.key);
                                if (titleData.params.username) {
                                    title = `${translatedBase} ${titleData.params.username}`;
                                } else {
                                    title = translatedBase;
                                }
                            }
                        } catch (e) {
                            // Not JSON, handle as plain string
                            if (title.startsWith('alerts.')) {
                                title = translateKey(title);
                            }
                            // Handle legacy "New message from" format (old alerts in DB)
                            else if (title.startsWith('New message from ')) {
                                const username = title.replace('New message from ', '');
                                title = `${translateKey('alerts.new_message_from')} ${username}`;
                            }
                        }

                        // Translate content if it's a key
                        if (content.startsWith('alerts.')) {
                            content = translateKey(content);
                        }

                        return `
                            <div class="alert-item ${alert.type || 'info'}">
                                <strong>${escapeHtml(title)}</strong><br>
                                <small>${escapeHtml(content)}</small>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        // Helper function for translations - place this RIGHT AFTER loadAlerts()
        function translateKey(key) {
            if (window.i18n && window.i18n.translate) {
                return window.i18n.translate(key);
            }
            return key;
        }

        // Support Form
        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const subject = document.getElementById('supportSubject').value;
            const message = document.getElementById('supportMessage').value;

            try {
                await apiCall('/support/contact', 'POST', {
                    subject: subject,
                    message: message
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.sent') : 'Message sent') + ' successfully!');
                document.getElementById('supportForm').reset();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }



        // Check authentication on load
    // Check authentication on load
// Check authentication on load
window.addEventListener('DOMContentLoaded', async () => {
    // Wait for i18n to be ready (max 1 second)
    let i18nReady = false;
    let attempts = 0;
    while (!i18nReady && attempts < 20) {
        if (window.i18n && window.i18n.translate) {
            i18nReady = true;
        } else {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
        }
    }

    if (!i18nReady) {
        console.warn('i18n not loaded in time, using fallback');
    }

    // Set up language selector event listener
    const langSelector = document.getElementById('languageSelector');
    if (langSelector) {
        langSelector.addEventListener('change', function() {
            if (window.i18n && window.i18n.setLanguage) {
                window.i18n.setLanguage(this.value);
            }
        });
    }

    try {
        const response = await fetch(`${API_URL}/auth/session`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data && data.authenticated) {
                currentUser = data.user;
                showDashboard();
                // Load alerts AFTER dashboard is shown and i18n is ready
                await loadAlerts();
            } else {
                showAuthContainer();
            }
        } else if (response.status === 401) {
            showAuthContainer();
        } else {
            console.error('Session check failed:', response.status);
            showAuthContainer();
        }
    } catch (error) {
        console.error('Session check error:', error);
        showAuthContainer();
    }
});

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchResults = document.getElementById('searchResults');
            const messageSearchResults = document.getElementById('messageSearchResults');

            if (searchResults && !searchResults.contains(e.target) && e.target.id !== 'userSearchInput') {
                searchResults.classList.remove('active');
            }

            if (messageSearchResults && !messageSearchResults.contains(e.target) && e.target.id !== 'messageUserSearch') {
                messageSearchResults.classList.remove('active');
            }
        });

        // Auto-refresh alerts
        setInterval(() => {
            if (currentUser) {
                loadAlerts().catch(() => {});
            }
        }, 30000);

        // Listen for language changes
  // Listen for language changes
   window.addEventListener('languageChanged', () => {
    if (document.getElementById('feedView').classList.contains('hidden') === false) {
        renderFeedCalendar();
        updateFeedSelectedDateDisplay();
    }
    if (document.getElementById('trackingView').classList.contains('hidden') === false) {
        renderCalendar();
        updateSelectedDateDisplay();
    }
    // Reload alerts to apply new translations
    if (currentUser) {
        loadAlerts().catch(() => {});
    }
    // Reload conversations to apply new translations
    if (document.getElementById('messagesView') && !document.getElementById('messagesView').classList.contains('hidden')) {
        loadConversations();
        if (currentRecipient && currentRecipient.id) {
            loadMessages(currentRecipient.id, currentRecipient.username);
        }
    }
});
    </script>


<script>
// Handle active_view from Flask backend
{% if active_view %}
document.addEventListener('DOMContentLoaded', function() {
    // Wait for all scripts to load
    setTimeout(function() {
        // Call showView with the tracking view
        if (typeof showView === 'function') {
            showView('{{ active_view }}');
        }

        // Ensure calendar and options are initialized for parameters
        if ('{{ active_view }}' === 'tracking') {
            // Initialize the calendar
            if (typeof initializeCalendar === 'function') {
                initializeCalendar();
            }

            // Create parameter options
            if (typeof createParameterOptions === 'function') {
                createParameterOptions('moodInput', 'mood');
                createParameterOptions('sleepInput', 'sleep');
                createParameterOptions('exerciseInput', 'exercise');
                createParameterOptions('stressInput', 'stress');
                createParameterOptions('socialInput', 'social');
            }
        }
    }, 500); // Increased delay from 200 to 500
});
{% endif %}
</script>



// Handle URL parameters for navigation
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const viewParam = urlParams.get('view');

    if (viewParam) {
        // Wait for page to fully load
        window.addEventListener('load', function() {
            // Remove the parameter from URL without reload
            window.history.replaceState({}, document.title, window.location.pathname);

            // Navigate to the specified view
            if (typeof showView === 'function') {
                showView(viewParam);
            }
        });
    }
})();


</body>
</html>