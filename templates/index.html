<!DOCTYPE html>
<!-- TheraSocial Version PJ40E v2014 -->
<!-- PJ6018: ALERT EMAIL MODE CONFIGURATION -->
<!-- Alert behavior is controlled by ALERT_EMAIL_MODE constant in backend (appchoice.py) -->
<!-- Two modes available: -->
<!--   "new_alerts_only" - Only email for NEW patterns never seen before -->
<!--   "daily_reminder" - Re-email every time watched user saves (after 24hr window) -->
<!-- To change mode: Edit ALERT_EMAIL_MODE in appchoice.py near top of file -->
<!-- PJ40E: THREE FIXES (NO CHANGES TO /parameters route) -->
<!-- FIX 1: Daily reminder email link now works correctly for logged-in AND logged-out users -->
<!--        Created NEW route /diary-redirect that handles the login check -->
<!--        If logged in ‚Üí redirects to /parameters (diary page) -->
<!--        If not logged in ‚Üí redirects to / (login page) -->
<!--        Email link changed from /parameters to /diary-redirect -->
<!--        /parameters route is COMPLETELY UNTOUCHED -->
<!-- FIX 2: Birth year now displayed when viewing another user's profile -->
<!--        Backend now includes birth_year in /api/users/<id>/profile response -->
<!-- FIX 3: Fixed timezone mapping for all valid cities (including "Chicago, USA" etc.) -->
<!--        Added full city names with countries to CITY_TIMEZONE_MAP -->
<!-- PJ6014: MULTIPLE FIXES -->
<!-- FIX 1: Search results in Circles/Following/Invite now show mutual connection & same city instead of email -->
<!-- FIX 2: "Recommended for You" and "Suggested People to Invite" now show mutual/city reason -->
<!-- FIX 3: Birth Year Update button only visible on OWN profile, hidden when viewing others -->
<!-- PJ6013: Mobile notification toggles now load correctly from backend -->
<!-- PJ6012: Consolidated batch emails now sent from TRIGGER SCHEDULER path -->
<!-- PJ6011: Backend fix - Trigger alerts no longer send individual emails, only consolidated batch emails -->
<!-- PJ6010: MOBILE FIX - About and Support links now visible on mobile -->
<!-- ROOT CAUSE: .nav-link had display:none in @media max-width:768px, hiding About/Support buttons -->
<!-- FIX: Changed .nav-link from display:none to display:inline-block with responsive sizing -->
<!-- PJ5002: Mobile Navigation Consolidation - 10 tabs reduced to 5 -->
<!-- ROOT CAUSE: Too many tabs (10) on mobile made navigation confusing and touch targets too small -->
<!-- FIX 1: Consolidated into 5 primary tabs: Home, Feed, Diary, Messages, More -->
<!-- FIX 2: Fixed Feed icon from üè† to üìù (journal/post icon) -->
<!-- FIX 3: Added proper Home tab with üè† icon for dashboard/progress page -->
<!-- FIX 4: Created "More" slide-up menu containing: Profile, Circles, Social section (Following/Followers/Invite), Alerts -->
<!-- FIX 5: Alert badge now shows on both main nav "More" button and inside More menu on Alerts item -->
<!-- FIX 6: More menu follows iOS/Android bottom sheet UX pattern -->
<!-- PJ5001: CRITICAL FIX - Mobile Alerts View -->
<!-- ROOT CAUSE: .right-sidebar was hidden on mobile (display:none in @media max-width:768px) -->
<!-- This caused ALL alerts to be invisible on iPhone and similar small screens -->
<!-- FIX 1: Added dedicated Alerts tab to mobile navigation bar -->
<!-- FIX 2: Created alertsView section with mobile-optimized layout -->
<!-- FIX 3: loadAlerts() now populates both desktop and mobile alert lists -->
<!-- FIX 4: dismissAlert() syncs removal between desktop and mobile lists -->
<!-- FIX 5: Added mobile alerts badge showing unread count -->
<!-- FIX 6: Added syncMobileNotificationSettings() for toggle sync -->
<!-- PJ816: CRITICAL FIX - Trigger alert emails now sent WITHOUT requiring watcher login -->
<!-- ROOT CAUSE: check_parameter_triggers() required @login_required and only ran on polling -->
<!-- Emails were only sent when the WATCHER logged in, not when WATCHED user's data triggered -->
<!-- FIX 1: Added background trigger scheduler that runs every 5 minutes -->
<!-- FIX 2: New function run_background_trigger_check_for_watcher() processes all triggers -->
<!-- FIX 3: Emails sent automatically when trigger conditions are met (like message notifications) -->
<!-- PJ815: CRITICAL FIX - Reverted broken v1704 trigger deduplication -->
<!-- ROOT CAUSE: v1704 merged triggers upfront, losing all parameter flags (mood_alert, etc.) -->
<!-- Because triggers use OLD schema (parameter_name) not NEW schema flags, bool(None)=False broke everything -->
<!-- FIX 1: Process each trigger row individually - no upfront deduplication -->
<!-- FIX 2: Use patterns_seen SET to deduplicate RESULTS not inputs -->
<!-- FIX 3: Each trigger checked for its actual schema (old vs new) and processed accordingly -->
<!-- Added extensive [PJ815 DEBUG] and [PJ815 PATTERN] logging for diagnostics -->
<!-- PJ813: Fixed trigger alerts - each date range creates separate alert, all patterns found -->
<!-- Features: User Blocking with Toggle, Diary Reminder 24hr Time, Fixed Circle Recommendations, Improved Login Form -->
<!-- PJ501 Changes: Fixed block message to "Account Not Available", Fixed Block button translation, Added recommended user profile preview -->
<!-- PJ601 Changes: Block/Unblock toggle button fix in Following and Profile views, Fixed Follow button width, Fixed navigation loop after 403 on Circles/Feed -->
<!-- PJ602 Changes: Fixed Follow button width (override CSS width:100%), Fixed action buttons persisting on own profile, Fixed double 403 message on Circles -->
<!-- PJ701 Changes: Fixed HTML/CSS security - added escapeHtml for user input in innerHTML to prevent XSS attacks -->
<!-- PJ702 Changes: 
     1. Fixed Add to Circle button - now checks if user is already in circles before showing
     2. Fixed Following search Block button - now has Block/Unblock toggle functionality  
     3. Added clickable names in Invite tab Suggested People section
     4. Added search bar to Invite tab with Send Request button
-->
<!-- PJ703 Changes:
     1. Fixed Block button showing "following.block" - changed to use correct translation key "block.block_user"
     2. Fixed Followers tab profile viewing - now works same as Following tab with preview mode
     3. Fixed Invite section follow status - now always checks actual following status via API
-->
<!-- PJ704 Changes:
     1. Backend fix - Alerts for new followers, invites, and messages were being incorrectly filtered out
     2. The get_alerts endpoint was filtering ALL alerts with source_user_id by following status
     3. Now only 'trigger' and 'feed' category alerts are filtered - follow/invite/message alerts always show

     2. Fixed Followers tab - clicking on user names now works same as Following tab (uses viewUserProfileFromFollowers)
     3. Fixed Invite section follow tracking - now properly shows Unfollow when already following a user
-->
<!-- PJ801 Changes:
     1. Fixed circle restriction message persisting after navigating away
     2. When viewing another user's private circles and then going back to own circles,
        the yellow "Restricted Access" box was not being cleared
     3. Added 'circle-restriction-message' class to restriction message div
     4. Updated clearViewActionButtons to also remove restriction messages
     5. Added explicit removal in loadCircles for safety
-->
<!-- PJ806 Changes:
     1. CRITICAL BUG FIX: Fixed repeated email spam from trigger alerts
     2. The /api/parameters/check-triggers endpoint no longer creates alerts (READ-ONLY)
     3. Alerts are now only created when parameters are saved (via process_parameter_triggers)
-->
<!-- PJ807 Changes:
     1. Backend: Reduced duplicate detection window from 7 days to 1 day
     2. Backend: Added comprehensive logging for process_parameter_triggers debugging
     3. Frontend: Fixed JavaScript error in displayParameterAlerts for old schema alerts
-->
<!-- PJ808 Changes:
     1. Backend: REMOVED 24-hour cooldown that was blocking ALL legitimate alerts
-->
<!-- PJ809 Changes (version 1500):
     1. Backend: Enhanced logging for save_parameters function
     2. Backend: Reduced duplicate detection window from 1 day to 4 hours
     3. This allows more frequent alerts while still preventing spam
-->
<!-- PJ811 Changes (version 1700):
     1. CRITICAL FIX: Trigger alerts now persist in database and don't vanish
     2. Backend: check_parameter_triggers now creates database alerts with 24hr duplicate detection
     3. Backend: Emails are sent when trigger alerts are created (if email_on_alert enabled)
     4. Frontend: No longer adds ephemeral DOM alerts that disappear on refresh
     5. Frontend: loadAlerts() fetches persistent alerts from /api/alerts
     6. Added comprehensive logging: [TRIGGER CHECK], [TRIGGER CREATE], [TRIGGER DUPLICATE], [TRIGGER EMAIL]
-->
<!-- PJ812 Changes (version 1701):
     1. FIX: Frontend now calls checkParameterAlerts() after login completes (3 second delay)
     2. FIX: checkParameterAlerts checks if user is logged in before making API call
     3. FIX: Backend formats dates nicely (e.g., "Dec 05 - Dec 07") instead of ISO format
     4. This ensures trigger checks happen when user is authenticated, not just on page load
-->
<!-- PJ812 Changes (version 1702):
     1. FIX: Double message on Enter key - improved debouncing with multiple prevention layers
     2. FIX: Added 1-second time-based debounce between messages
     3. FIX: Clear input immediately before async send to prevent re-sending
     4. FIX: Using keydown instead of keypress for reliable Enter detection
     5. FIX: Increased alerts-list max-height to 600px for more alerts visibility
     6. BACKEND: Increased alerts limit from 50 to 100 for full month of alerts
     7. BACKEND: process_parameter_triggers now includes privacy checks (matching check_triggers)
     8. BACKEND: Trigger emails now sent when watched user saves parameters (no login required)
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thera Social - Anonymous Wellness Community</title>
   <script src="/static/js/utilities.js"></script>
    <script src="/static/js/onboarding.js"></script>
    <script src="/static/js/triggers.js"></script>
    <script src="/static/js/follow-requests.js"></script>


    <style>


        /* User card styles for following/followers */
.user-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    font-weight: 600;
    flex-shrink: 0;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.25rem;
}

.user-location {
    font-size: 0.875rem;
    color: var(--gray);
}

.follow-btn, .unfollow-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.follow-btn:hover {
    transform: scale(1.05);
}

.follow-note-btn {
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.follow-note-btn:hover {
    opacity: 0.9;
    transform: scale(1.05);
}

.follow-actions-container {
    display: flex;
    gap: 4px;
    align-items: stretch;
    flex-direction: column;
}

[dir="rtl"] .follow-actions-container {
    flex-direction: column-reverse;
}

.unfollow-btn {
    background: var(--light);
    color: var(--gray);
}

.unfollow-btn:hover {
    background: var(--danger);
    color: white;
}

.back-to-following-btn {
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .user-card {
        padding: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .follow-btn, .unfollow-btn {
        padding: 0.375rem 1rem;
        font-size: 0.875rem;
    }
}

/* City Selector Styles */
.city-selector-container {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.city-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
}

.city-selector {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    font-size: 16px;
    background: white;
}

.city-time-display {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    text-align: center;
    padding: 15px;
    background: var(--light);
    border-radius: 10px;
}

/* Following/Followers Styles */
.follow-card {
    background: white;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: box-shadow 0.3s;
}

.follow-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.follow-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
}

.follow-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
}

.follow-btn.following {
    background: var(--success);
}

.recommendation-reason {
    font-size: 12px;
    color: var(--gray);
    margin-top: 5px;
}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #EC4899;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        /* RTL Support */
        [dir="rtl"] {
            direction: rtl;
        }

        [dir="rtl"] .nav-menu {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .avatar,
        [dir="rtl"] .member-avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        [dir="rtl"] .post-header .avatar {
            margin-right: 0;
            margin-left: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .language-selector {
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: var(--white);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Auth Forms */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 70px);
        }

        .auth-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            margin-top: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar-item:hover {
            background: var(--light);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
        }

        /* Feed - Enhanced with Calendar */
        .feed-calendar-section {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feed-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .feed-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .feed-calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--white);
        }

        .feed-calendar-day:hover {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .feed-calendar-day.has-posts::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        .post-form {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            align-items: center;
        }

        .visibility-select {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            background: var(--white);
        }

        .post-card {
            background: var(--white);
            border: 1px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .post-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 12px;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--dark);
        }

        .post-time {
            font-size: 12px;
            color: var(--gray);
        }

        .post-content {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Enhanced Profile Section */
        .profile-section {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 15px;
        }

        .profile-fields {
            display: grid;
            gap: 20px;
        }

        .profile-field {
            position: relative;
        }

        .profile-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Parameters with Calendar */
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
        }

        .parameter-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .parameter-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .parameter-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
        }

        .calendar-section {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--light);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-day.has-data::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 2px;
            color: var(--success);
            font-size: 20px;
        }

        /* Enhanced Circles */
        .circles-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .circle-card {
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .circle-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .circle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .circle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .circle-count {
            background: var(--primary);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .circle-members {
            max-height: 200px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .member-item:hover {
            background: var(--light);
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 12px;
        }

        .member-name {
            flex: 1;
        }

        .remove-btn {
            background: var(--danger);
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .member-item:hover .remove-btn {
            opacity: 1;
        }

        .user-search {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        /* Messages - Enhanced */
        .messages-container {
            display: flex;
            height: 600px;
        }

        .conversations-list {
            width: 300px;
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
        }

        [dir="rtl"] .conversations-list {
            border-right: none;
            border-left: 1px solid #E5E7EB;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--light);
        }

        .conversation-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .conversation-username {
            font-weight: 600;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--gray);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .unread-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        [dir="rtl"] .unread-badge {
            right: auto;
            left: 15px;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            font-weight: 600;
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            background: var(--light);
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: var(--white);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
        }

        /* Right Sidebar */
        .right-sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
        }

        .alerts-list {
            max-height: 600px;  /* PJ812: Increased from 400px for more alerts */
            overflow-y: auto;
        }

      .alert-item {
    padding: 12px;
    background: var(--light);
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid var(--warning);
    cursor: pointer;
    transition: background-color 0.2s, opacity 0.3s;
    position: relative;
}

.alert-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.alert-item:hover .alert-dismiss {
    opacity: 1 !important;
}

[dir="rtl"] .alert-item {
    border-left: none;
    border-right: 4px solid var(--warning);
}

        .alert-item.high {
            border-left-color: var(--danger);
        }

        [dir="rtl"] .alert-item.high {
            border-left-color: transparent;
            border-right-color: var(--danger);
        }

        .alert-item.low {
            border-left-color: var(--success);
        }

        [dir="rtl"] .alert-item.low {
            border-left-color: transparent;
            border-right-color: var(--success);
        }

        /* About and Support Pages */
        .page-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.2);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Responsive */
  /* Mobile Navigation Bar */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 8px 0;
            border-top: 1px solid #E5E7EB;
        }

        .mobile-nav-menu {
            display: flex;
            justify-content: space-around;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mobile-nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            color: var(--gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        .mobile-nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* RTL Support for Mobile Navigation */
        [dir="rtl"] .mobile-nav-menu {
            direction: rtl;
        }

        [dir="rtl"] .mobile-nav-item {
            direction: rtl;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding-bottom: 70px; /* Space for bottom nav */
            }

            .sidebar {
                display: none;
            }

            .right-sidebar {
                display: none;
            }

            .mobile-nav {
                display: block;
            }

            .main-content {
                margin-bottom: 60px; /* Prevent content being hidden behind nav */
                border-radius: 15px 15px 0 0;
            }

            .messages-container {
                flex-direction: column;
                margin-bottom: 60px;
            }

            .conversations-list {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }

            /* Adjust navbar on mobile */
            .navbar {
                padding: 10px 15px;
            }

            .nav-content {
                padding: 10px 15px;
            }

            .logo {
                font-size: 20px;
            }

            .nav-menu {
                gap: 10px;
            }

            /* PJ6010: MOBILE FIX - Show About and Support links on mobile */
            /* Previously hidden, now visible with responsive styling */
            .nav-link {
                display: inline-block;
                font-size: 14px;
                padding: 6px 10px;
            }

            /* Keep language selector visible */
            .language-selector {
                padding: 6px 10px;
                font-size: 14px;
            }
            
            /* Mobile Alerts View Styles */
            #alertsView {
                display: block; /* Allow alerts view to show on mobile */
            }
            
            #alertsView.hidden {
                display: none !important;
            }
            
            .mobile-alerts-container {
                max-height: calc(100vh - 250px);
                overflow-y: auto;
            }
            
            .mobile-alerts-container .alerts-list {
                max-height: none;
            }
        }
        
        /* Mobile Alerts Badge Styling */
        .mobile-alerts-badge {
            position: absolute;
            top: 2px;
            right: 50%;
            transform: translateX(15px);
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }
        
        .mobile-nav-item {
            position: relative;
        }
        
        /* PJ5002: Mobile More Menu Styles */
        .mobile-more-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .mobile-more-menu.hidden {
            display: none !important;
        }
        
        .mobile-more-menu-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeInBackdrop 0.2s ease;
        }
        
        @keyframes fadeInBackdrop {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .mobile-more-menu-sheet {
            position: relative;
            background: white;
            border-radius: 20px 20px 0 0;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideUpSheet 0.3s ease;
            padding-bottom: 20px;
        }
        
        @keyframes slideUpSheet {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .mobile-more-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 20px 20px 0 0;
        }
        
        .mobile-more-menu-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--dark);
        }
        
        .mobile-more-close-btn {
            background: var(--light);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
        }
        
        .mobile-more-close-btn:hover {
            background: #E5E7EB;
        }
        
        .mobile-more-menu-list {
            list-style: none;
            padding: 10px 0;
            margin: 0;
        }
        
        .mobile-more-menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .mobile-more-menu-item:hover {
            background: var(--light);
        }
        
        .mobile-more-menu-item:active {
            background: #E5E7EB;
        }
        
        .mobile-more-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 28px;
            text-align: center;
        }
        
        [dir="rtl"] .mobile-more-icon {
            margin-right: 0;
            margin-left: 15px;
        }
        
        .mobile-more-label {
            font-size: 16px;
            color: var(--dark);
            flex: 1;
        }
        
        .mobile-more-badge {
            background: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .mobile-more-menu-divider {
            height: 1px;
            background: #E5E7EB;
            margin: 10px 20px;
        }
        
        .mobile-more-menu-section-header {
            padding: 10px 20px 5px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }




        .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 900px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: #333;
}

.close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    transition: color 0.2s;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}

.date-range-info {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Calendar update indicator - green dots for days with updates */
.update-indicator {
    width: 8px;
    height: 8px;
    background-color: #4CAF50;
    border-radius: 50%;
    position: absolute;
    bottom: 2px;
    right: 2px;
}

/* User update modal for viewing other users' feed updates */
#user-update-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

#user-update-modal .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#user-update-modal .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

#user-update-modal .close-modal:hover,
#user-update-modal .close-modal:focus {
    color: #000;
}

#update-content-display {
    margin: 20px 0;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 4px;
    min-height: 100px;
}

#edit-update-btn {
    background-color: #667eea;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 15px;
}

#edit-update-btn:hover {
    background-color: #5568d3;
}


        /* Invite View Styles */
.invite-section {
    display: grid;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.share-link-card,
.recommendations-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.share-link-card h3,
.recommendations-card h3 {
    color: #667eea;
    margin-bottom: 10px;
}

.link-display {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.invite-link-input {
    flex: 1;
    padding: 12px;
    border: 2px solid #f0f0f0;
    border-radius: 8px;
    font-family: monospace;
    background: #f8f9fa;
}

.share-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.share-buttons .btn {
    flex: 1;
    min-width: 120px;
}

.recommendations-list {
    margin-top: 20px;
}

.empty-state,
.error-state,
.loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

@media (max-width: 768px) {
    .link-display {
        flex-direction: column;
    }

    .share-buttons {
        flex-direction: column;
    }

    .share-buttons .btn {
        width: 100%;
    }
}



    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo" data-i18n="nav.logo">üß† Thera Social</div>
            <div class="nav-menu">
                <!-- PJ6004: About and Support shown when logged out, language selector at end -->
                <a href="#" class="nav-link auth-only-hide" id="navAbout" data-i18n="nav.about">About</a>
                <a href="#" class="nav-link auth-only-hide" id="navSupport" data-i18n="nav.support">Support</a>
                <select id="languageSelector" class="language-selector">
                    <option value="en">English</option>
                    <option value="he">◊¢◊ë◊®◊ô◊™</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                </select>
                <button class="btn btn-primary" id="logoutBtn" style="display: none; width: auto;" data-i18n="nav.logout">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card fade-in">
            <!-- FIX #1: Login Error Message -->
            <div id="loginErrorMessage" class="login-error-message" style="display: none; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 12px 20px; margin-bottom: 20px; color: #dc2626; text-align: center; font-weight: 500;">
                <span data-i18n="auth.invalid_credentials">You have entered an invalid username or password</span>
            </div>
            <h2 class="auth-title" id="authTitle" data-i18n="auth.welcome">Welcome Back</h2>
            
            <!-- LOGIN MODE: Single email/password form -->
            <form id="authForm">
                <div id="loginSection">
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.email">Email</label>
                        <input type="email" class="form-input" id="emailInput" autocomplete="email" required>
                    </div>

                    <div class="form-group" id="passwordGroup">
                        <label class="form-label" data-i18n="auth.password">Password</label>
                        <input type="password" class="form-input" id="passwordInput" autocomplete="current-password">
                    </div>

                    <button type="submit" class="btn btn-primary" id="authSubmit" data-i18n="btn.signin">Sign In</button>
                </div>
            </form>
            
            <!-- SIGNUP MODE: Magic Link + OR + Traditional Signup -->
            <div id="signupSection" style="display: none;">
                <!-- Magic Link Option (TOP) -->
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email">Email</label>
                    <input type="email" class="form-input" id="magicLinkEmailInput" autocomplete="email" placeholder="Enter your email">
                </div>
                <button type="button" class="magic-link-btn" onclick="requestMagicLinkSignup()" data-i18n="auth.magic_link">
                    Send me a magic link to sign in
                </button>
                
                <!-- OR Divider -->
                <div class="auth-divider">
                    <span data-i18n="auth.or">OR</span>
                </div>
                
                <!-- Traditional Signup (BOTTOM) -->
                <form id="signupForm">
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.email">Email</label>
                        <input type="email" class="form-input" id="signupEmailInput" autocomplete="email" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.password">Password</label>
                        <input type="password" class="form-input" id="signupPasswordInput" autocomplete="new-password" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span data-i18n="auth.username">Username</span>
                            <span style="color: #666; font-size: 12px;" data-i18n="username.optional">(optional)</span>
                        </label>
                        <input type="text" class="form-input" id="signupUsernameInput" autocomplete="username"
                               data-i18n-placeholder="username.blank_for_email"
                               placeholder="Leave blank to use email prefix">
                        <small style="color: #666;" id="signupEmailPrefixHint"></small>
                    </div>

                    <button type="submit" class="btn btn-primary" data-i18n="btn.signup">Sign Up</button>
                </form>
            </div>
            
            <p style="text-align: center; margin-top: 15px;">
                <a href="#" id="forgotPasswordLink" style="color: var(--primary); font-size: 14px;" data-i18n="auth.forgot_password" onclick="showForgotPassword(); return false;">Forgot Your Password?</a>
            </p>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" id="toggleAuth" style="color: var(--primary);" data-i18n="auth.toggle_signup">New here? Create an account</a>
            </p>
        </div>
    </div>

    <!-- Forgot Password Container -->
    <div id="forgotPasswordContainer" class="auth-container" style="display: none;">
        <div class="auth-card fade-in">
            <h2 class="auth-title" data-i18n="auth.reset_password">Reset Password</h2>
            <p style="text-align: center; color: var(--gray); margin-bottom: 20px;" data-i18n="auth.reset_instructions">Enter your email address and we will send you a password reset link.</p>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email">Email Address</label>
                    <input type="email" id="forgotEmail" required class="form-input" data-i18n-placeholder="auth.enter_email" placeholder="Enter your email">
                </div>
                <button type="submit" class="btn btn-primary" data-i18n="auth.send_reset_link">Send Reset Link</button>
                <p style="text-align: center; margin-top: 20px;">
                    <a href="#" style="color: var(--primary);" data-i18n="auth.back_to_login" onclick="showLogin(); return false;">Back to Login</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Reset Password Container (accessed via email link) -->
    <div id="resetPasswordContainer" class="auth-container" style="display: none;">
        <div class="auth-card fade-in">
            <h2 class="auth-title" data-i18n="auth.set_new_password">Set New Password</h2>
            <p style="text-align: center; color: var(--gray); margin-bottom: 20px;" data-i18n="auth.enter_new_password">Enter your new password below.</p>
            <form id="resetPasswordForm" autocomplete="off">
    <input type="text" name="username" autocomplete="username" style="display:none;" aria-hidden="true">
                <input type="hidden" id="resetToken">
               <div class="form-group">
                    <label class="form-label" data-i18n="auth.new_password">New Password</label>
                    <input type="password" id="resetNewPassword" name="new_password" autocomplete="new-password" required class="form-input" data-i18n-placeholder="auth.enter_new_password" placeholder="Enter new password">
                    <small style="color: #6B7280; display: block; margin-top: 5px;" data-i18n="auth.password_requirements">Password must be at least 12 characters with uppercase, lowercase, number, and special character.</small>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.confirm_password">Confirm Password</label>
                    <input type="password" id="resetConfirmPassword" name="confirm_password" autocomplete="new-password" required class="form-input" data-i18n-placeholder="auth.confirm_new_password" placeholder="Confirm new password">
                </div>
                <button type="submit" class="btn btn-primary" data-i18n="auth.reset_password_button">Reset Password</button>
                <p style="text-align: center; margin-top: 20px;">
                    <a href="#" style="color: var(--primary);" data-i18n="auth.back_to_login" onclick="showLogin(); return false;">Back to Login</a>
                </p>
            </form>
        </div>
    </div>


<!-- Consent Modal with integrated username option -->
<div id="consentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <h2 data-i18n="consent.title">Welcome to TheraSocial</h2>
        <p data-i18n="consent.subtitle">Please review and accept our terms to continue</p>

        <!-- Optional Username Field -->
        <div class="form-group" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <label class="form-label">
                <span data-i18n="auth.username">Username</span>
                <span style="color: #666; font-size: 14px;" data-i18n="username.optional">(optional)</span>
            </label>
            <input type="text" id="consentUsername" class="form-input"
                   placeholder="Leave blank to use your email prefix"
                   data-i18n-placeholder="username.blank_for_email">
            <small id="suggestedUsername" style="color: #666; display: block; margin-top: 5px;"></small>
        </div>

        <!-- PJ6001: Birth Year Field (Required) -->
        <div class="form-group" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <label class="form-label">
                <span data-i18n="profile.birth_year">Birth Year</span>
                <span style="color: #dc2626; font-size: 14px;">*</span>
            </label>
            <input type="number" id="consentBirthYear" class="form-input"
                   placeholder="YYYY" min="1900" max="2025" maxlength="4"
                   data-i18n-placeholder="profile.birth_year_placeholder"
                   style="width: 120px;" required>
            <small style="color: #666; display: block; margin-top: 5px;" data-i18n="profile.birth_year_hint">Enter your birth year (4 digits)</small>
        </div>

        <!-- Consent checkboxes -->
        <div class="consent-items" style="margin: 20px 0;">
            <label class="consent-item">
                <input type="checkbox" id="emailUpdates">
                <span data-i18n="consent.email_updates">I want to receive email updates about new features</span>
            </label>

            <label class="consent-item">
                <input type="checkbox" id="privacyAccepted" required>
                <span data-i18n="consent.privacy">I accept the privacy policy and understand my data will be protected</span>
            </label>

            <label class="consent-item">
                <input type="checkbox" id="researchData">
                <span data-i18n="consent.research">I agree to share de-identified data for platform improvement</span>
            </label>

            <label class="consent-item">
                <input type="checkbox" id="teamDeclaration" required>
                <span data-i18n="consent.team">I understand this is a good-faith community platform</span>
            </label>

            <label class="consent-item">
                <input type="checkbox" id="responsibleUse" required>
                <span data-i18n="consent.responsible">I will use this platform responsibly and respectfully</span>
            </label>

            <label class="consent-item">
                <input type="checkbox" id="waiverClaims" required>
                <span data-i18n="consent.waiver">I understand and accept the terms of service</span>
            </label>
        </div>

        <div class="consent-actions">
            <button type="button" class="btn btn-primary" onclick="submitConsent()" data-i18n="consent.accept">Accept and Continue</button>
            <p style="color: red; display: none;" id="consentError" data-i18n="consent.error">Please accept all required terms</p>
        </div>
    </div>
</div>

<!-- Styles for modals -->
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
    }
    .consent-item {
        display: block;
        margin: 15px 0;
        cursor: pointer;
    }
    .consent-item input {
        margin-right: 10px;
    }
    .auth-divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }
    .auth-divider:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e0e0e0;
    }
    .auth-divider span {
        background: white;
        padding: 0 15px;
        position: relative;
        color: #666;
    }
    .magic-link-btn {
        width: 100%;
        padding: 12px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }
    .magic-link-btn:hover {
        background: #e5e7eb;
    }
</style>


    <!-- About Page -->
    <div id="aboutPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="about.title">About Thera Social</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="about.subtitle">
                Your safe space for wellness, connection, and personal growth
            </p>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üõ°Ô∏è</div>
                    <h3 data-i18n="about.privacy_title">Privacy First</h3>
                    <p data-i18n="about.privacy_desc">Your wellness journey is private and secure. Share only what you're comfortable with.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3 data-i18n="about.track_title">Track Progress</h3>
                    <p data-i18n="about.track_desc">Monitor your wellness parameters and see your growth over time with insights.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üí•</div>
                    <h3 data-i18n="about.community_title">Supportive Community</h3>
                    <p data-i18n="about.community_desc">Connect with others on similar journeys in a judgment-free environment.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üí¨</div>
                    <h3 data-i18n="about.communication_title">Safe Communication</h3>
                    <p data-i18n="about.communication_desc">Private messaging and circles let you control who sees your content.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3 data-i18n="about.goals_title">Goal Setting</h3>
                    <p data-i18n="about.goals_desc">Set and track personal goals with community support and accountability.</p>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">üåü</div>
                    <h3 data-i18n="about.checkin_title">Daily Check-ins</h3>
                    <p data-i18n="about.checkin_desc">Regular parameter tracking helps you understand patterns and triggers.</p>
                </div>
            </div>

 <div class="mission-section" style="margin-top: 40px;">
                <h2 style="color: #667eea; margin-bottom: 20px;" data-i18n="about.team_title">Our Team & Story</h2>

                <p style="margin-bottom: 20px;" data-i18n="about.team_intro">
                    The primary team behind this is CEO Benny Brandstetter and CTO Evan Askanazi.
                </p>

                <p style="margin-bottom: 15px;" data-i18n="about.story_para1">
                    Thera Social was created for those who feel disconnected, struggling, or unseen. War veterans carrying invisible wounds, young adults navigating isolation, survivors of trauma and abuse, students overwhelmed by pressure‚Äîall deserve genuine connection and support, not just another feed of curated highlights.
                </p>

                <p style="margin-bottom: 15px;" data-i18n="about.story_para2">
                    Current social media platforms have failed us. They amplify comparison, enable harassment, and leave the vulnerable more isolated than before. We need something fundamentally different.
                </p>

                <p style="margin-bottom: 20px;" data-i18n="about.story_para3">
                    That's why we built Thera Social. This platform offers real community support through complete anonymity and customizable trust circles. Share your feelings, track what matters (sleep, mood, health, exercise), and receive alerts on trends in people you care about‚Äîall while choosing exactly who sees what. Thera Social isn't designed for endless selfies or internet arguments‚Äîit's built for mutual care, authentic check-ins through private messaging, and the meaningful support we all need.
                </p>

                <p>
                    <span data-i18n="about.find_team">You can find</span>
                    <a href="https://www.linkedin.com/in/bennybrandst/" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">Benny Brandstetter</a>
                    <span data-i18n="about.and"> and </span>
                    <a href="https://www.linkedin.com/in/evan-askanazi/" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">Evan Askanazi</a>
                    <span data-i18n="about.on_linkedin"> on LinkedIn</span>.
                </p>
            </div>


            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" style="width: 200px;" onclick="goHome()" data-i18n="btn.getstarted">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Support Page -->
    <div id="supportPage" class="container hidden">
        <div class="page-content">
            <h1 class="page-title" data-i18n="support.title">Support Center</h1>
            <p style="text-align: center; font-size: 18px; color: var(--gray); margin-bottom: 30px;" data-i18n="support.subtitle">
                We're here to help you on your wellness journey
            </p>

            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.faq_title">Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq1_q">How do I track my wellness parameters?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq1_a">Navigate to the Parameters tab in your dashboard. You can input daily values for mood, sleep, exercise, anxiety, and energy levels. Use the calendar to save and load parameters for different dates.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq2_q">What are Circles?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq2_a">Circles allow you to organize your connections into groups: General, Close Friends, and Family. You can control who sees your posts based on these circles.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq3_q">How do I update my profile?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq3_a">Go to the Profile tab to update your bio, interests, occupation, goals, and favorite hobbies. These help others understand you better.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;" data-i18n="support.faq4_q">Is my data private?</h4>
                    <p style="color: var(--gray);" data-i18n="support.faq4_a">Yes! We take privacy seriously. Your wellness data is encrypted and only visible to you unless you choose to share it.</p>
                </div>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="support.contact_title">Contact Support</h3>
                <form id="supportForm">
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.subject">Subject</label>
                        <input type="text" class="form-input" id="supportSubject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="support.message">Message</label>
                        <textarea class="form-input" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" data-i18n="support.send">Send Message</button>
                </form>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" style="width: 200px;" onclick="goHome()" data-i18n="btn.back">Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
 <div id="dashboard" class="dashboard container">
    <!-- Mobile Navigation Bar - PJ5002: Consolidated 5-tab navigation -->
    <nav class="mobile-nav">
        <ul class="mobile-nav-menu">
            <li class="mobile-nav-item" data-view="home" onclick="showView('home')">
                <span class="mobile-nav-icon">üè†</span>
                <span class="mobile-nav-label" data-i18n="menu.home">Home</span>
            </li>
            <li class="mobile-nav-item active" data-view="feed" onclick="showView('feed')">
                <span class="mobile-nav-icon">üìù</span>
                <span class="mobile-nav-label" data-i18n="menu.feed">Feed</span>
            </li>
            <li class="mobile-nav-item" data-view="tracking" onclick="handleParametersClick(event)">
                <span class="mobile-nav-icon">üìä</span>
                <span class="mobile-nav-label" data-i18n="menu.diary">Diary</span>
            </li>
            <li class="mobile-nav-item" id="mobileMessagesNav" data-view="messages" onclick="showView('messages')">
                <span class="mobile-nav-icon">üí¨</span>
                <span class="mobile-nav-label" data-i18n="menu.messages">Messages</span>
            </li>
            <li class="mobile-nav-item" data-view="more" onclick="toggleMobileMoreMenu()">
                <span class="mobile-nav-icon">‚ò∞</span>
                <span class="mobile-nav-label" data-i18n="menu.more">More</span>
                <span class="mobile-alerts-badge" id="mobileAlertsBadge" style="display: none;"></span>
            </li>
        </ul>
    </nav>
    
    <!-- Mobile More Menu Sheet - PJ5002 -->
    <div id="mobileMoreMenu" class="mobile-more-menu hidden">
        <div class="mobile-more-menu-backdrop" onclick="closeMobileMoreMenu()"></div>
        <div class="mobile-more-menu-sheet">
            <div class="mobile-more-menu-header">
                <h3 data-i18n="menu.more">More</h3>
                <button class="mobile-more-close-btn" onclick="closeMobileMoreMenu()">‚úï</button>
            </div>
            <ul class="mobile-more-menu-list">
                <li class="mobile-more-menu-item" onclick="showViewFromMore('profile')">
                    <span class="mobile-more-icon">üë§</span>
                    <span class="mobile-more-label" data-i18n="menu.profile">Profile</span>
                </li>
                <li class="mobile-more-menu-item" onclick="showViewFromMore('circles')">
                    <span class="mobile-more-icon">‚≠ï</span>
                    <span class="mobile-more-label" data-i18n="menu.circles">Circles</span>
                </li>
                <li class="mobile-more-menu-divider"></li>
                <li class="mobile-more-menu-section-header" data-i18n="menu.social">Social</li>
                <li class="mobile-more-menu-item" onclick="showViewFromMore('following')">
                    <span class="mobile-more-icon">‚ûï</span>
                    <span class="mobile-more-label" data-i18n="menu.following">Following</span>
                </li>
                <li class="mobile-more-menu-item" onclick="showViewFromMore('followers')">
                    <span class="mobile-more-icon">üë•</span>
                    <span class="mobile-more-label" data-i18n="menu.followers">Followers</span>
                </li>
                <li class="mobile-more-menu-item" onclick="showViewFromMore('invite')">
                    <span class="mobile-more-icon">üëã</span>
                    <span class="mobile-more-label" data-i18n="menu.invite">Invite</span>
                </li>
                <li class="mobile-more-menu-divider"></li>
                <li class="mobile-more-menu-item" onclick="showViewFromMore('alerts')">
                    <span class="mobile-more-icon">üîî</span>
                    <span class="mobile-more-label" data-i18n="alerts.title">Alerts</span>
                    <span class="mobile-more-badge" id="mobileMoreAlertsBadge" style="display: none;"></span>
                </li>
            </ul>
        </div>
    </div>

    <div class="dashboard-grid">
            <!-- Left Sidebar -->
          <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" data-view="home" data-i18n="menu.home">
                        üè† Home
                    </li>
                    <li class="sidebar-item" data-view="feed" data-i18n="menu.feed">
                        üì± Feed
                    </li>
                    <li class="sidebar-item" data-view="profile" data-i18n="menu.profile">
                        üë§ Profile
                    </li>
                    <li class="sidebar-item" data-view="circles" onclick="handleCirclesClick(event)" style="cursor: pointer;" data-i18n="menu.circles">
                        üë• Circles
                    </li>
                    <li class="sidebar-item" id="desktopMessagesNav" data-view="messages" data-i18n="menu.messages">
                        üí¨ Messages
                    </li>
                   <li class="sidebar-item" data-view="tracking" onclick="handleParametersClick(event)" style="cursor: pointer;">
    üìî <span data-i18n="menu.diary">Diary</span>
</li>

<li class="sidebar-item" data-view="following" data-i18n="menu.following">
    ‚ûï Following
</li>
<li class="sidebar-item" data-view="followers" data-i18n="menu.followers">
    üë• Followers
</li>
<li class="sidebar-item" data-view="invite" onclick="showView('invite')" data-i18n="menu.invite">
    üëã Invite
</li>

                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Home View (Settings) -->
              <div id="homeView" class="view">
                  <h2 style="margin-bottom: 20px;" data-i18n="home.title">Home</h2>

                  <!-- Welcome Section -->
                  <div class="content" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                      <p data-i18n="about.intro" style="line-height: 1.8; color: #4B5563; margin-bottom: 20px;">
                          Welcome to TheraSocial - a comprehensive platform designed to support both therapists and individuals on their wellness journey. We combine professional tools with personal tracking features to create a holistic approach to mental health and wellbeing.
                      </p>

                      <div class="mission-section" style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius: 10px;">
                          <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.5rem;" data-i18n="about.mission_title">Our Mission</h2>
                          <p data-i18n="about.mission_text" style="line-height: 1.8; color: #4B5563;">
                              We believe in making mental health support accessible, organized, and effective. Our mission is to empower therapists with the tools they need to provide excellent care, while giving individuals the resources to track and improve their wellbeing.
                          </p>
                      </div>
                  </div>

                <!-- City Selector Section -->
                  <div class="city-selector-container" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                      <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.3rem;" data-i18n="home.location_settings">Location Settings</h3>

                      <div class="city-selector-wrapper" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                          <label style="font-weight: 600; color: #4B5563; min-width: 120px;" data-i18n="home.select_city">Select City:</label>
                  <select id="homeCitySelector" class="city-selector" style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 16px;">
    <!-- Israel (10 cities) -->
    <option value="Jerusalem, Israel" data-i18n="city.jerusalem_israel">Jerusalem, Israel</option>
    <option value="Tel Aviv, Israel" data-i18n="city.tel_aviv_israel">Tel Aviv, Israel</option>
    <option value="Haifa, Israel" data-i18n="city.haifa_israel">Haifa, Israel</option>
    <option value="Beer Sheva, Israel" data-i18n="city.beer_sheva_israel">Beer Sheva, Israel</option>
    <option value="Netanya, Israel" data-i18n="city.netanya_israel">Netanya, Israel</option>
    <option value="Rishon LeZion, Israel" data-i18n="city.rishon_lezion_israel">Rishon LeZion, Israel</option>
    <option value="Petah Tikva, Israel" data-i18n="city.petah_tikva_israel">Petah Tikva, Israel</option>
    <option value="Ashdod, Israel" data-i18n="city.ashdod_israel">Ashdod, Israel</option>
    <option value="Eilat, Israel" data-i18n="city.eilat_israel">Eilat, Israel</option>
    <option value="Herzliya, Israel" data-i18n="city.herzliya_israel">Herzliya, Israel</option>
    <!-- USA (25 cities) -->
    <option value="New York City, USA" data-i18n="city.new_york_city_usa">New York City, USA</option>
    <option value="Los Angeles, USA" data-i18n="city.los_angeles_usa">Los Angeles, USA</option>
    <option value="Chicago, USA" data-i18n="city.chicago_usa">Chicago, USA</option>
    <option value="Washington, USA" data-i18n="city.washington_usa">Washington, USA</option>
    <option value="Houston, USA" data-i18n="city.houston_usa">Houston, USA</option>
    <option value="San Francisco, USA" data-i18n="city.san_francisco_usa">San Francisco, USA</option>
    <option value="Boston, USA" data-i18n="city.boston_usa">Boston, USA</option>
    <option value="Philadelphia, USA" data-i18n="city.philadelphia_usa">Philadelphia, USA</option>
    <option value="Phoenix, USA" data-i18n="city.phoenix_usa">Phoenix, USA</option>
    <option value="San Diego, USA" data-i18n="city.san_diego_usa">San Diego, USA</option>
    <option value="Dallas, USA" data-i18n="city.dallas_usa">Dallas, USA</option>
    <option value="Seattle, USA" data-i18n="city.seattle_usa">Seattle, USA</option>
    <option value="Miami, USA" data-i18n="city.miami_usa">Miami, USA</option>
    <option value="Atlanta, USA" data-i18n="city.atlanta_usa">Atlanta, USA</option>
    <option value="Denver, USA" data-i18n="city.denver_usa">Denver, USA</option>
    <option value="Austin, USA" data-i18n="city.austin_usa">Austin, USA</option>
    <option value="San Jose, USA" data-i18n="city.san_jose_usa">San Jose, USA</option>
    <option value="Portland, USA" data-i18n="city.portland_usa">Portland, USA</option>
    <option value="Las Vegas, USA" data-i18n="city.las_vegas_usa">Las Vegas, USA</option>
    <option value="Minneapolis, USA" data-i18n="city.minneapolis_usa">Minneapolis, USA</option>
    <option value="Detroit, USA" data-i18n="city.detroit_usa">Detroit, USA</option>
    <option value="Baltimore, USA" data-i18n="city.baltimore_usa">Baltimore, USA</option>
    <option value="Nashville, USA" data-i18n="city.nashville_usa">Nashville, USA</option>
    <option value="Charlotte, USA" data-i18n="city.charlotte_usa">Charlotte, USA</option>
    <option value="Orlando, USA" data-i18n="city.orlando_usa">Orlando, USA</option>
    <!-- UK (15 cities) -->
    <option value="London, UK" data-i18n="city.london_uk">London, UK</option>
    <option value="Manchester, UK" data-i18n="city.manchester_uk">Manchester, UK</option>
    <option value="Birmingham, UK" data-i18n="city.birmingham_uk">Birmingham, UK</option>
    <option value="Edinburgh, UK" data-i18n="city.edinburgh_uk">Edinburgh, UK</option>
    <option value="Glasgow, UK" data-i18n="city.glasgow_uk">Glasgow, UK</option>
    <option value="Bristol, UK" data-i18n="city.bristol_uk">Bristol, UK</option>
    <option value="Liverpool, UK" data-i18n="city.liverpool_uk">Liverpool, UK</option>
    <option value="Leeds, UK" data-i18n="city.leeds_uk">Leeds, UK</option>
    <option value="Sheffield, UK" data-i18n="city.sheffield_uk">Sheffield, UK</option>
    <option value="Newcastle, UK" data-i18n="city.newcastle_uk">Newcastle, UK</option>
    <option value="Nottingham, UK" data-i18n="city.nottingham_uk">Nottingham, UK</option>
    <option value="Southampton, UK" data-i18n="city.southampton_uk">Southampton, UK</option>
    <option value="Cardiff, UK" data-i18n="city.cardiff_uk">Cardiff, UK</option>
    <option value="Belfast, UK" data-i18n="city.belfast_uk">Belfast, UK</option>
    <option value="Cambridge, UK" data-i18n="city.cambridge_uk">Cambridge, UK</option>
</select>
                      </div>

                      <div class="city-time-display" id="homeCityTimeDisplay" style="font-size: 24px; font-weight: bold; color: var(--primary); text-align: center; padding: 15px; background: var(--light); border-radius: 10px;">
                          <!-- Time will be displayed here -->
                      </div>
                  </div>

                  <!-- Progress Chart Section -->
                  <div id="progressChartSection" class="settings-section" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                      <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3rem;" data-i18n="progress.title">Your Progress</h3>
                      
                      <div style="text-align: center; margin-bottom: 20px;">
                          <label data-i18n="progress.view_progress" style="font-weight: 600; margin-right: 10px;">View Progress:</label>
                          <select id="progressTimeRange" onchange="updateProgressChart()" style="padding: 10px 15px; border-radius: 8px; border: 2px solid #E5E7EB; font-size: 16px;">
                              <option value="7" data-i18n="progress.last_7_days">Last 7 days</option>
                              <option value="30" data-i18n="progress.last_30_days">Last 30 days</option>
                              <option value="90" data-i18n="progress.last_90_days">Last 90 days</option>
                              <option value="365" data-i18n="progress.last_year">Last year</option>
                          </select>
                          <button onclick="updateProgressChart()" class="btn btn-secondary" style="margin-left: 10px; padding: 10px 20px;" data-i18n="progress.update">Update</button>
                      </div>

                      <!-- Progress Chart Container -->
                      <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                          <canvas id="progressChart" style="width: 100%; height: 300px;"></canvas>
                      </div>

                      <!-- Personalized Insights -->
                      <div id="personalizedInsights" style="background: linear-gradient(135deg, #667eea11 0%, #764ba211 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                          <h4 style="margin-bottom: 10px; color: #667eea;" data-i18n="progress.insights_title">Personalized Insights</h4>
                          <p id="insightsContent" style="color: #4B5563;">
                              <span data-i18n="progress.loading_insights">Loading insights...</span>
                          </p>
                      </div>

                      <!-- Daily Check-in Summary -->
                      <div id="dailyCheckinSummary" style="background: white; padding: 20px; border-radius: 15px; border: 1px solid #E5E7EB;">
                          <h4 style="margin-bottom: 15px; color: #374151;" data-i18n="progress.daily_checkin">Daily Check-in Summary</h4>
                          <div id="checkinStats" style="display: grid; gap: 10px;">
                              <p><span data-i18n="progress.total_checkins">Total check-ins:</span> <strong id="totalCheckins">0</strong></p>
                              <p><span data-i18n="progress.avg_mood">Average mood rating:</span> <strong id="avgMood">-</strong></p>
                              <p><span data-i18n="progress.avg_energy">Average energy level:</span> <strong id="avgEnergy">-</strong></p>
                              <p><span data-i18n="progress.avg_sleep">Average sleep quality:</span> <strong id="avgSleep">-</strong></p>
                              <p><span data-i18n="progress.avg_activity">Average activity level:</span> <strong id="avgActivity">-</strong></p>
                          </div>
                      </div>
                      
                      <!-- Report Generation Section -->
                      <div id="reportGeneration" style="background: white; padding: 20px; border-radius: 15px; border: 1px solid #E5E7EB; margin-top: 20px;">
                          <h4 style="margin-bottom: 10px; color: #374151;" data-i18n="reports.title">Generate Report</h4>
                          <p style="margin-bottom: 15px; color: #6B7280; font-size: 0.9rem;" data-i18n="reports.description">Generate a comprehensive report of your check-ins for the past 7 days.</p>
                          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                              <button class="btn" style="background: #667eea; color: white;" onclick="generateExcelReport()" data-i18n="reports.excel">
                                  Generate Excel Report
                              </button>
                              <button class="btn" style="background: #EC4899; color: white;" onclick="generatePdfReport()" data-i18n="reports.pdf">
                                  Generate PDF Report
                              </button>
                              <button class="btn" style="background: #E5E7EB; color: #374151;" onclick="prepareEmailReport()" data-i18n="reports.email">
                                  Prepare Email Report
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
              <!-- Feed View - Date-Based Journal -->
<!-- Feed View - Date-Based Journal -->
<div id="feedView" class="view">
   <!-- City selector removed - now only in Home page -->

    <h2 style="margin-bottom: 20px;" data-i18n="feed.title">Your Feed Journal</h2>
    <p style="color: var(--gray); margin-bottom: 20px;" data-i18n="feed.subtitle">Save your thoughts for each day. Select a date from the calendar, write your update, and save it. Green dots show dates with saved entries.</p>

    <!-- Feed Calendar -->
    <div class="feed-calendar-section">
        <div class="feed-calendar-header">
            <button class="btn btn-secondary" onclick="feedPreviousMonth()" data-i18n="calendar.prev">‚Üê</button>
            <span id="feedCurrentMonth" style="font-weight: 600;">January 2025</span>
            <button class="btn btn-secondary" onclick="feedNextMonth()" data-i18n="calendar.next">‚Üí</button>
        </div>
        <div class="feed-calendar-grid" id="feedCalendarGrid"></div>
        <div style="text-align: center; margin-top: 15px;">
            <p><span data-i18n="feed.selected_date">Selected Date:</span> <strong id="feedSelectedDateDisplay" data-i18n="feed.today">Today</strong></p>
        </div>
    </div>

    <!-- Post Form -->
    <div class="post-form">
        <textarea class="post-input" data-i18n="feed.placeholder" placeholder="How are you feeling today?" id="postInput"></textarea>
        <div class="post-actions">
 <select class="visibility-select" id="visibilitySelect">
                <option value="general" data-i18n="privacy.public">Public</option>
                <option value="close_friends" data-i18n="privacy.class_b">Close Friends</option>
                <option value="family" data-i18n="privacy.class_a">Family</option>
                <option value="private" data-i18n="privacy.private" selected>Private</option>
            </select>
            <div style="display: flex; gap: 10px;">
    <button class="btn btn-primary" style="width: auto;" id="postBtn" data-i18n="feed.save_update">Save Update</button>
</div>
        </div>
    </div>

    <!-- Posts Display Container -->
    <div class="feed-posts" id="feedPostsContainer" style="margin-top: 20px;">
        <!-- Posts will be displayed here -->
    </div>
</div>

                <!-- Profile View (Enhanced with 5 fields) -->
                <div id="profileView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="profile.title">Your Profile</h2>
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <h3 id="profileUsername">Username</h3>
                        </div>

                        <div class="profile-fields">
                            <!-- PJ6001: Birth Year Field -->
                            <div class="form-group" id="birthYearSection">
                                <label class="form-label" data-i18n="profile.birth_year">Birth Year</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" class="form-input" id="profileBirthYear" 
                                           min="1900" max="2025" maxlength="4"
                                           placeholder="YYYY" style="width: 120px;">
                                    <button type="button" class="btn btn-secondary" id="birthYearUpdateBtn" style="padding: 8px 16px;" 
                                            onclick="updateBirthYear()" data-i18n="profile.update_birth_year">Update</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.bio">Bio</label>
                                <textarea class="profile-textarea" id="profileBio" data-i18n="profile.bio_placeholder" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.interests">Interests</label>
                                <textarea class="profile-textarea" id="profileInterests" data-i18n="profile.interests_placeholder" placeholder="What are you interested in?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.occupation">Occupation</label>
                                <input type="text" class="form-input" id="profileOccupation" data-i18n="profile.occupation_placeholder" placeholder="What do you do?">
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.goals">Goals</label>
                                <textarea class="profile-textarea" id="profileGoals" data-i18n="profile.goals_placeholder" placeholder="What are your personal or professional goals?" maxlength="300"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="profile.hobbies">Favorite Hobbies</label>
                                <textarea class="profile-textarea" id="profileFavoriteHobbies" data-i18n="profile.hobbies_placeholder" placeholder="What do you love to do in your free time?" maxlength="300"></textarea>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" style="width: 200px;" id="updateProfileBtn" data-i18n="profile.save">Save Profile</button>
                        </div>
                    </div>

                    <!-- Change Password Section -->
                    <div id="changePasswordSection" class="settings-section" style="background: white; padding: 25px; border-radius: 15px; margin-top: 25px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3rem;" data-i18n="home.change_password">Change Password</h3>

                        <p style="color: #6B7280; margin-bottom: 15px;" data-i18n="home.password_requirements">Password must be at least 12 characters long.</p>
                        <p style="color: #6B7280; margin-bottom: 20px;" data-i18n="home.password_requirements_detail">Password must have uppercase, lowercase, number and special character.</p>

                        <form id="changePasswordForm" onsubmit="updatePassword(); return false;" autocomplete="off">
                            <input type="text" name="username" autocomplete="username" style="display:none;" aria-hidden="true">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;" data-i18n="home.current_password">Current Password</label>
                                    <input type="password" id="currentPassword" name="current_password" autocomplete="current-password" class="form-input" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 16px;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;" data-i18n="home.new_password">New Password</label>
                                    <input type="password" id="newPassword" name="new_password" autocomplete="new-password" class="form-input" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 16px;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;" data-i18n="home.confirm_new_password">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" name="confirm_password" autocomplete="new-password" class="form-input" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 16px;">
                                </div>

                                <button type="submit" class="btn btn-primary" style="padding: 12px 24px; font-size: 16px; font-weight: 600;" data-i18n="home.update_password">Update Password</button>
                            </div>
                        </form>
                    </div>

                    <!-- Account Deletion Section -->
                    <div id="accountDeletionSection" class="settings-section" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #EF4444; margin-bottom: 20px; font-size: 1.3rem;" data-i18n="home.account_deletion">Account Deletion</h3>

                        <p style="color: #6B7280; margin-bottom: 20px;" data-i18n="home.deletion_warning">Request deletion of your account and all associated data</p>

                        <div style="background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <div>
                                <p style="color: #92400E; font-weight: 600; margin-bottom: 5px;" data-i18n="home.deletion_permanent">This action cannot be undone</p>
                                <p style="color: #92400E; font-size: 14px;" data-i18n="home.deletion_permanent_detail">All your data will be permanently deleted.</p>
                            </div>
                        </div>

                        <button onclick="requestAccountDeletion()" class="btn" style="background: #EF4444; color: white; padding: 12px 24px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;" data-i18n="home.delete_account">Delete Account</button>
                    </div>
                </div>

                <!-- Circles View (Enhanced) -->
                <div id="circlesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="circles.title">Your Circles</h2>

                    <!-- Circle Visibility Setting -->
                    <div id="circleVisibilityContainer" style="margin-bottom: 20px; text-align: center;">
                        <label for="circleVisibility" style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--dark);">
                            <span data-i18n="circles.visibility_label">Circle Visibility</span>
                        </label>
                        <select id="circleVisibility" style="
                            padding: 10px 15px;
                            border-radius: 8px;
                            border: 2px solid var(--primary);
                            background: white;
                            font-size: 16px;
                            cursor: pointer;
                            min-width: 200px;
                        " onchange="(function(el){ console.log('Privacy dropdown changed to:', el.value); updateCirclesPrivacy(el.value); })(this)">
                            <option value="private" data-i18n="circles.visibility_private">Private üîí</option>
                            <option value="public" data-i18n="circles.visibility_public">Public üåç</option>
                            <option value="class_b" data-i18n="circles.visibility_class_b">Close Friends üë•</option>
                            <option value="class_a" data-i18n="circles.visibility_class_a">Family üë®‚Äçüë©‚Äçüëß‚Äçüë¶</option>
                        </select>
                    </div>

                    <div class="user-search">
                        <input type="text" class="search-input" id="userSearchInput" data-i18n="circles.search_placeholder" placeholder="Search users to add to circles..." onkeyup="searchUsers()">
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <!-- Recommended Users to Add to Circle Section -->
                    <div id="circleRecommendationsSection" style="margin: 20px 0; background: var(--light); border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;" data-i18n="circles.recommended_title">Recommended Users to Add to Circle</h3>
                        <div id="circleRecommendationsList" style="max-height: 250px; overflow-y: auto;">
                            <p style="color: var(--gray); text-align: center;">Loading recommendations...</p>
                        </div>
                    </div>

                    <div class="circles-container">
                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.title_public">Public</span>
                                <span class="circle-count" id="generalCount">0</span>
                            </div>
                            <div class="circle-members" id="generalMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No members yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.title_class_b">Close Friends</span>
                                <span class="circle-count" id="closeFriendsCount">0</span>
                            </div>
                            <div class="circle-members" id="closeFriendsMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No close friends yet</p>
                            </div>
                        </div>

                        <div class="circle-card">
                            <div class="circle-header">
                                <span class="circle-title" data-i18n="circles.title_class_a">Family</span>
                                <span class="circle-count" id="familyCount">0</span>
                            </div>
                            <div class="circle-members" id="familyMembers">
                                <p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">No family members yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages View - Enhanced -->
                <div id="messagesView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="messages.title">Messages</h2>
                    <div class="user-search" style="margin-bottom: 20px;">
                        <input type="text" class="search-input" id="messageUserSearch" data-i18n="messages.search_placeholder" placeholder="Search users to message..." onkeyup="searchUsersForMessage()">
                        <div class="search-results" id="messageSearchResults"></div>
                    </div>

                    <div class="messages-container">
                        <div class="conversations-list" id="conversationsList">
                            <div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">
                                No conversations yet
                            </div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader" data-i18n="messages.select_conversation">Select a conversation</div>
                            <div class="messages-list" id="messagesList">
                                <div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">
                                    Select a conversation to start messaging
                                </div>
                            </div>
                            <div class="message-input-area">
                                <input type="text" class="message-input" id="messageInput" data-i18n="messages.type_message" placeholder="Type a message..." disabled>
                                <button class="btn btn-primary" style="width: auto;" id="sendMessageBtn" disabled data-i18n="btn.send">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking/Parameters View (Enhanced with save/load) -->
                <div id="trackingView" class="view hidden">
                    <h2 style="margin-bottom: 20px;" data-i18n="parameters.title">Wellness Parameters</h2>

                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="previousMonth()" data-i18n="calendar.prev">‚Üê</button>
                            <span id="currentMonth" style="font-weight: 600;">January 2025</span>
                            <button class="btn btn-secondary" onclick="nextMonth()" data-i18n="calendar.next">‚Üí</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                        <div style="text-align: center; margin-top: 15px;">
                            <p><span data-i18n="parameters.selected_date">Selected Date:</span> <strong id="selectedDateDisplay" data-i18n="feed.today">Today</strong></p>
                        </div>
                    </div>

                    <div id="parametersContainer" class="parameter-grid">
                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.mood">Mood</div>
                            <div id="moodInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.sleep">Sleep</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" class="parameter-input" id="sleepInput" data-i18n="parameters.sleep_placeholder" placeholder="Hours" min="0" max="24" step="0.5" style="width: 100px;">
                                <span style="color: white; font-weight: 600;" id="sleepDisplay"><span>0</span> <span data-i18n="parameters.sleep_hours">Hours</span></span>
                            </div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.exercise">Exercise</div>
                            <div id="exerciseInput"></div>
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.anxiety">Anxiety</div>
                            <input type="text" class="parameter-input" id="anxietyInput" data-i18n="parameters.anxiety_placeholder" placeholder="e.g., None, Mild, Moderate">
                        </div>

                        <div class="parameter-card">
                            <div class="parameter-name" data-i18n="parameters.energy">Energy</div>
                            <input type="text" class="parameter-input" id="energyInput" data-i18n="parameters.energy_placeholder" placeholder="e.g., Low, Normal, High">
                        </div>

                        <div class="parameter-card" style="grid-column: span 2;">
                            <div class="parameter-name" data-i18n="parameters.notes">Notes</div>
                            <textarea class="parameter-input" id="notesInput" data-i18n="parameters.notes_placeholder" placeholder="Additional notes..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveParameters()" data-i18n="parameters.save">Save Parameters</button>
                        <button class="btn btn-secondary" style="width: 200px;" onclick="loadParameters()" data-i18n="parameters.load">Load Parameters</button>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;" data-i18n="parameters.insights">Insights</h3>
                    <div id="insights"></div>
                </div>

<!-- Following View -->
<div id="followingView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="following.title">Following</h2>

    <!-- ADD THIS SEARCH BAR HERE (right after the H2, before Recommendations Section) -->
    <div style="margin: 20px 0;">
        <div style="position: relative; max-width: 600px; margin: 0 auto;">
            <input type="text"
                id="followSearchInput"
                placeholder="Search users to follow..."
                style="
                    width: 100%;
                    padding: 12px 20px;
                    border: none;
                    border-radius: 25px;
                    font-size: 16px;
                    background: white;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                "
                oninput="searchUsersToFollowInstant(this.value)"
            >
        </div>

        <!-- Search Results Container -->
        <div id="followSearchResults" style="
            display: none;
            background: white;
            border-radius: 12px;
            margin-top: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        "></div>
    </div>
    <!-- END OF SEARCH BAR ADDITION -->






    <!-- Recommendations Section -->
    <div style="margin-bottom: 30px;">
        <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="following.recommendations">Recommended for You</h3>
        <div id="followingRecommendationsList"></div>
    </div>

    <!-- Following List -->
    <div>
        <h3 style="color: var(--primary); margin-bottom: 15px;" data-i18n="following.your_following">People You Follow</h3>
        <div id="followingList"></div>
    </div>


</div>

<!-- Followers View -->
<div id="followersView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="followers.title">Followers</h2>
    <div id="followersList"></div>
</div>

<!-- Invite View -->
<div id="inviteView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="invite.title">Invite Friends to Your Wellness Journey</h2>

    <div class="invite-section">
        <div class="share-link-card">
            <h3 data-i18n="invite.your_link">Your Personal Invite Link</h3>
            <p data-i18n="invite.link_description">Share this link with friends and family so they can follow your wellness journey</p>

            <div class="link-display">
                <input type="text" id="userInviteLink" readonly class="invite-link-input">
                <button onclick="copyUserInviteLink()" class="btn btn-primary">
                    <span data-i18n="invite.copy">üìã Copy Link</span>
                </button>
            </div>

            <div class="share-buttons">
                <button onclick="shareViaEmail()" class="btn btn-secondary">
                    <span data-i18n="invite.email">‚úâÔ∏è Email</span>
                </button>
                <button onclick="shareViaSMS()" class="btn btn-secondary">
                    <span data-i18n="invite.sms">üí¨ SMS</span>
                </button>
                <button onclick="shareViaWhatsApp()" class="btn btn-secondary">
                    <span data-i18n="invite.whatsapp">üì± WhatsApp</span>
                </button>
            </div>
        </div>

        <div class="recommendations-card">
            <h3 data-i18n="invite.suggested">Suggested People to Invite</h3>
            <p data-i18n="invite.suggested_description">Based on your location and connections</p>

            <!-- PJ702: Search bar for Invite tab -->
            <div style="margin: 20px 0;">
                <div style="position: relative; max-width: 600px;">
                    <input type="text"
                        id="inviteSearchInput"
                        placeholder="Search users to invite..."
                        style="
                            width: 100%;
                            padding: 12px 20px;
                            border: none;
                            border-radius: 25px;
                            font-size: 16px;
                            background: #f5f5f5;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                        "
                        oninput="searchUsersToInviteInstant(this.value)"
                    >
                </div>

                <!-- Invite Search Results Container -->
                <div id="inviteSearchResults" style="
                    display: none;
                    background: white;
                    border-radius: 12px;
                    margin-top: 1rem;
                    padding: 1rem;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    max-width: 600px;
                "></div>
            </div>
            <!-- End of PJ702 search bar -->

            <div id="recommendationsList" class="recommendations-list">
                <div class="loading">Loading recommendations...</div>
            </div>
        </div>
    </div>
</div>


<!-- Mobile Alerts View (only visible on mobile) -->
<div id="alertsView" class="view hidden">
    <h2 style="margin-bottom: 20px;" data-i18n="alerts.title">Alerts</h2>
    
    <!-- PJ6001: Email Options for Mobile -->
    <div id="mobileNotificationSettingsPanel" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 12px 0; color: var(--primary); font-size: 14px;" data-i18n="notifications.email_options">Email Options</h4>
        
        <!-- Email on Alert Toggle (Wellness Alerts) -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.email_on_alert">Email me on new alerts</label>
            <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                    <input type="checkbox" id="mobileEmailOnAlertToggle" onchange="updateNotificationSetting('email_on_alert', this.checked); document.getElementById('emailOnAlertToggle').checked = this.checked;" style="opacity: 0; width: 0; height: 0;">
                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                </label>
                <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
            </div>
        </div>
        
        <!-- PJ6001: Email on Notification Toggle (Messages, Followers, Invites) -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.email_on_notification">Email me on new notifications</label>
            <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                    <input type="checkbox" id="mobileEmailOnNotificationToggle" onchange="updateNotificationSetting('email_on_notification', this.checked); if(document.getElementById('emailOnNotificationToggle')) document.getElementById('emailOnNotificationToggle').checked = this.checked;" style="opacity: 0; width: 0; height: 0;">
                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                </label>
                <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
            </div>
        </div>
        
        <!-- Daily Diary Reminder Toggle -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.daily_diary_reminder">Daily diary reminder</label>
            <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                    <input type="checkbox" id="mobileDailyDiaryReminderToggle" onchange="updateNotificationSetting('email_daily_diary_reminder', this.checked); document.getElementById('dailyDiaryReminderToggle').checked = this.checked;" style="opacity: 0; width: 0; height: 0;">
                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                </label>
                <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
            </div>
        </div>
        
        <!-- Diary Reminder Time Input -->
        <div id="mobileDiaryReminderTimeContainer" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg, #f5f5f5); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.reminder_time">Reminder time</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="text" id="mobileDiaryReminderTimeInput" 
                        value="09:00" 
                        pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                        maxlength="5"
                        placeholder="HH:MM"
                        onchange="updateDiaryReminderTime(this.value); document.getElementById('diaryReminderTimeInput').value = this.value;"
                        onkeyup="formatTimeInput(this)"
                        style="padding: 6px 10px; border: 1px solid var(--border-color, #ddd); border-radius: 6px; font-size: 14px; background: var(--card-bg, #fff); color: var(--text-primary, #333); width: 70px; text-align: center; font-family: monospace;">
                    <span style="font-size: 11px; color: #888;">(24h)</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PJ6001: Wellness Alerts List for Mobile -->
    <h3 style="margin-bottom: 10px;" data-i18n="alerts.title">Alerts</h3>
    <div class="mobile-alerts-container" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="alerts-list" id="mobileAlertsList"></div>
        <div id="mobileNoAlertsMessage" style="display: none; text-align: center; padding: 20px; color: #666;">
            <span data-i18n="alerts.no_alerts">No alerts to display</span>
        </div>
    </div>
    
    <!-- PJ6001: Notifications List for Mobile (messages, followers, invites) -->
    <h3 style="margin-bottom: 10px;" data-i18n="notifications.title">Notifications</h3>
    <div class="mobile-alerts-container" style="background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="alerts-list" id="mobileNotificationsList"></div>
        <div id="mobileNoNotificationsMessage" style="display: none; text-align: center; padding: 20px; color: #666;">
            <span data-i18n="notifications.no_notifications">No notifications to display</span>
        </div>
    </div>
</div>


           </main>
            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <!-- PJ6001: Email Options (renamed from Email Notifications) -->
                <div id="notificationSettingsPanel" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 12px 0; color: var(--primary); font-size: 14px;" data-i18n="notifications.email_options">Email Options</h4>
                    
                    <!-- Email on Alert Toggle (Wellness Alerts only) -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.email_on_alert">Email me on new alerts</label>
                        <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                            <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                <input type="checkbox" id="emailOnAlertToggle" onchange="updateNotificationSetting('email_on_alert', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                            </label>
                            <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
                        </div>
                    </div>
                    
                    <!-- PJ6001: Email on Notification Toggle (Messages, Followers, Invites) -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.email_on_notification">Email me on new notifications</label>
                        <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                            <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                <input type="checkbox" id="emailOnNotificationToggle" onchange="updateNotificationSetting('email_on_notification', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                            </label>
                            <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
                        </div>
                    </div>
                    
                    <!-- Daily Diary Reminder Toggle -->
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.daily_diary_reminder">Daily diary reminder</label>
                        <div class="toggle-container" style="display: flex; align-items: center; gap: 8px;">
                            <span class="toggle-off-label" style="font-size: 11px; color: #999;">OFF</span>
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                <input type="checkbox" id="dailyDiaryReminderToggle" onchange="updateNotificationSetting('email_daily_diary_reminder', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .3s; border-radius: 24px;"></span>
                            </label>
                            <span class="toggle-on-label" style="font-size: 11px; color: #999;">ON</span>
                        </div>
                    </div>
                    
                    <!-- Diary Reminder Time Input -->
                    <div id="diaryReminderTimeContainer" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg, #f5f5f5); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <label style="font-size: 13px; color: var(--dark);" data-i18n="notifications.reminder_time">Reminder time</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- 24-hour format time input -->
                                <input type="text" id="diaryReminderTimeInput" 
                                    value="09:00" 
                                    pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                                    maxlength="5"
                                    placeholder="HH:MM"
                                    onchange="updateDiaryReminderTime(this.value)"
                                    onkeyup="formatTimeInput(this)"
                                    style="padding: 6px 10px; border: 1px solid var(--border-color, #ddd); border-radius: 6px; font-size: 14px; background: var(--card-bg, #fff); color: var(--text-primary, #333); width: 70px; text-align: center; font-family: monospace;">
                                <span style="font-size: 11px; color: #888;">(24h)</span>
                                <span id="diaryReminderTimezone" style="font-size: 11px; color: #666; font-weight: 500;" data-i18n-timezone="true"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PJ6001: Wellness Alerts Section (trigger alerts only) -->
                <h3 style="margin-bottom: 15px;" data-i18n="alerts.title">Alerts</h3>
                <div class="alerts-list" id="alertsList"></div>
                
                <!-- PJ6001: Notifications Section (messages, followers, invites) -->
                <h3 style="margin-top: 20px; margin-bottom: 15px;" data-i18n="notifications.title">Notifications</h3>
                <div class="alerts-list" id="notificationsList"></div>
            </aside>
        </div>
    </div>
    
    <style>
    /* Toggle Switch Styles */
    .toggle-switch input:checked + .toggle-slider {
        background-color: #3b82f6; /* Blue when ON */
    }

.toggle-switch .toggle-slider {
    background-color: #ccc;
}



    .toggle-switch .toggle-slider:before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    /* Highlight active label */
    .toggle-container:has(input:checked) .toggle-on-label {
        color: #3b82f6;
        font-weight: 600;
    }
    .toggle-container:has(input:not(:checked)) .toggle-off-label {
        color: #666;
        font-weight: 600;
    }
    </style>
    
    <script>
    // Toggle label translations
    function updateToggleLabels() {
        const lang = localStorage.getItem('selectedLanguage') || 'en';
        const labels = {
            'en': { on: 'ON', off: 'OFF' },
            'he': { on: '◊§◊¢◊ô◊ú', off: '◊õ◊ë◊ï◊ô' },
            'ar': { on: 'ÿ™ÿ¥ÿ∫ŸäŸÑ', off: 'ÿ•ŸäŸÇÿßŸÅ' },
            'ru': { on: '–í–ö–õ', off: '–í–´–ö–õ' }
        };
        const t = labels[lang] || labels['en'];
        
        document.querySelectorAll('.toggle-on-label').forEach(el => el.textContent = t.on);
        document.querySelectorAll('.toggle-off-label').forEach(el => el.textContent = t.off);
    }
    
    // Update labels on language change
    window.addEventListener('languageChanged', updateToggleLabels);
    // Initial update
    document.addEventListener('DOMContentLoaded', updateToggleLabels);
    </script>
    
    <!-- FIX: Intercept and protect language selector changes -->
    <script>
    (function() {
        console.log('[INTERCEPTOR] Language interceptor script loading... v4005');
        
        // Track if user has ACTUALLY clicked/interacted with the selector
        window._userClickedLanguageSelector = false;
        window._lastLanguageSelectorInteraction = 0;
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INTERCEPTOR] DOMContentLoaded - setting up interceptor');
            
            const langSelector = document.getElementById('languageSelector');
            if (!langSelector) {
                console.error('[INTERCEPTOR] ERROR: Language selector not found!');
                return;
            }
            
            console.log('[INTERCEPTOR] Found language selector, options:', 
                Array.from(langSelector.options).map(o => o.value).join(', '));
            
            // Track REAL user interaction - mousedown/focus events confirm user intent
            langSelector.addEventListener('mousedown', function() {
                console.log('[INTERCEPTOR] User mousedown on selector');
                window._userClickedLanguageSelector = true;
                window._lastLanguageSelectorInteraction = Date.now();
            });
            
            langSelector.addEventListener('focus', function() {
                console.log('[INTERCEPTOR] Selector focused');
                window._lastLanguageSelectorInteraction = Date.now();
            });
            
            langSelector.addEventListener('keydown', function() {
                window._userClickedLanguageSelector = true;
                window._lastLanguageSelectorInteraction = Date.now();
            });
            
            // Add a capturing phase listener to intercept changes FIRST
            langSelector.addEventListener('change', function(e) {
                console.log('[INTERCEPTOR] ========================================');
                console.log('[INTERCEPTOR] CHANGE EVENT DETECTED');
                console.log('[INTERCEPTOR] Timestamp:', new Date().toISOString());
                console.log('[INTERCEPTOR] Event isTrusted:', e.isTrusted);
                console.log('[INTERCEPTOR] _updatingSelectorProgrammatically:', window._updatingSelectorProgrammatically);
                console.log('[INTERCEPTOR] _userClickedLanguageSelector:', window._userClickedLanguageSelector);
                console.log('[INTERCEPTOR] Time since last interaction:', Date.now() - window._lastLanguageSelectorInteraction, 'ms');
                console.log('[INTERCEPTOR] New value:', this.value);
                console.log('[INTERCEPTOR] localStorage.selectedLanguage:', localStorage.getItem('selectedLanguage'));
                
                // If being updated programmatically, allow it
                if (window._updatingSelectorProgrammatically) {
                    console.log('[INTERCEPTOR] Programmatic update, allowing through');
                    console.log('[INTERCEPTOR] ========================================');
                    return;
                }
                
                const newValue = this.value;
                const storedLang = localStorage.getItem('selectedLanguage');
                const timeSinceInteraction = Date.now() - window._lastLanguageSelectorInteraction;
                
                // FIX: BLOCK changes that don't come from real user interaction
                // A real user interaction means:
                // 1. User clicked/focused/keyed on the selector recently (within 10 seconds)
                // 2. The _userClickedLanguageSelector flag is set
                
                const isRealUserInteraction = window._userClickedLanguageSelector && timeSinceInteraction < 10000;
                
                // If the value is changing to something DIFFERENT from what's stored,
                // and it's NOT a confirmed user interaction, BLOCK it
                if (newValue !== storedLang && !isRealUserInteraction) {
                    console.error('[INTERCEPTOR] BLOCKING SUSPICIOUS CHANGE!');
                    console.error('[INTERCEPTOR]   From:', storedLang, '-> To:', newValue);
                    console.error('[INTERCEPTOR]   Reason: Not a confirmed user interaction');
                    console.error('[INTERCEPTOR]   _userClickedLanguageSelector:', window._userClickedLanguageSelector);
                    console.error('[INTERCEPTOR]   timeSinceInteraction:', timeSinceInteraction, 'ms');
                    
                    // BLOCK the event
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // Restore to correct value
                    if (storedLang) {
                        console.log('[INTERCEPTOR] Restoring to stored language:', storedLang);
                        window._updatingSelectorProgrammatically = true;
                        this.value = storedLang;
                        window._updatingSelectorProgrammatically = false;
                    }
                    
                    console.log('[INTERCEPTOR] ========================================');
                    return false;
                }
                
                // If selector is empty but we have a stored language, this is a BUG - restore it
                if (!newValue || newValue === '') {
                    console.error('[INTERCEPTOR] BLOCKING: Empty value detected!');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    if (storedLang) {
                        window._updatingSelectorProgrammatically = true;
                        this.value = storedLang;
                        window._updatingSelectorProgrammatically = false;
                    }
                    console.log('[INTERCEPTOR] ========================================');
                    return false;
                }
                
                // This is a valid user-initiated change
                console.log('[INTERCEPTOR] VALID USER CHANGE:', storedLang, '->', newValue);
                
                // Reset the flag after processing a valid change
                window._userClickedLanguageSelector = false;
                
                console.log('[INTERCEPTOR] ========================================');
            }, true); // Use capturing phase to intercept before other handlers
            
            // Also add a MutationObserver to watch for value changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        console.log('[INTERCEPTOR OBSERVER] Value attribute changed to:', langSelector.value);
                    }
                });
            });
            observer.observe(langSelector, { attributes: true });
            
            console.log('[INTERCEPTOR] Setup complete with user interaction tracking');
        });
    })();
    </script>
    
    <!-- CRITICAL FIX: Intercept fetch to block unwanted language POSTs from i18n.js -->
    <!-- This MUST be before i18n.js loads -->
    <script>
    (function() {
        console.log('[FETCH INTERCEPTOR] Installing fetch interceptor for language API...');
        
        // Store the original fetch
        const originalFetch = window.fetch;
        
        // Flag to allow language posts (set by user-initiated changes only)
        window._allowLanguagePost = false;
        window._languagePostBlockedCount = 0;
        
        // Override fetch
        window.fetch = function(url, options) {
            // Check if this is a POST to /api/user/language
            const urlStr = typeof url === 'string' ? url : url.toString();
            const isLanguagePost = urlStr.includes('/api/user/language') && 
                                   options && 
                                   options.method && 
                                   options.method.toUpperCase() === 'POST';
            
            if (isLanguagePost) {
                console.log('[FETCH INTERCEPTOR] ========================================');
                console.log('[FETCH INTERCEPTOR] Detected POST to /api/user/language');
                console.log('[FETCH INTERCEPTOR] _allowLanguagePost:', window._allowLanguagePost);
                console.log('[FETCH INTERCEPTOR] Body:', options.body);
                
                // If not explicitly allowed, BLOCK the request
                if (!window._allowLanguagePost) {
                    window._languagePostBlockedCount++;
                    console.warn('[FETCH INTERCEPTOR] BLOCKED! Unwanted language POST #' + window._languagePostBlockedCount);
                    console.warn('[FETCH INTERCEPTOR] This is likely from i18n.js auto-sync');
                    console.log('[FETCH INTERCEPTOR] ========================================');
                    
                    // Return a fake successful response to prevent errors
                    return Promise.resolve(new Response(JSON.stringify({
                        success: true,
                        message: 'Blocked by interceptor - language already set correctly',
                        blocked: true
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    }));
                }
                
                // Reset the flag after allowing one POST
                window._allowLanguagePost = false;
                console.log('[FETCH INTERCEPTOR] ALLOWED - User-initiated language change');
                console.log('[FETCH INTERCEPTOR] ========================================');
            }
            
            // Call original fetch
            return originalFetch.apply(this, arguments);
        };
        
        console.log('[FETCH INTERCEPTOR] Fetch interceptor installed');
    })();
    </script>
    
    <!-- CRITICAL FIX: Pre-fetch backend language and set localStorage BEFORE i18n.js loads -->
    <script>
    (function() {
        console.log('[PRE-FETCH] ========================================');
        console.log('[PRE-FETCH] Pre-fetching backend language preference...');
        
        // Initialize user interaction tracking flags EARLY
        window._userClickedLanguageSelector = false;
        window._lastLanguageSelectorInteraction = 0;
        window._updatingSelectorProgrammatically = false;
        
        // Use synchronous XHR to fetch backend language BEFORE i18n.js initializes
        // This is necessary because we need to set localStorage before i18n.js reads it
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/user/profile', false); // Synchronous!
            xhr.withCredentials = true;
            xhr.send();
            
            if (xhr.status === 200) {
                const profile = JSON.parse(xhr.responseText);
                const backendLang = profile.preferred_language;
                
                console.log('[PRE-FETCH] Backend language:', backendLang);
                console.log('[PRE-FETCH] Current localStorage.selectedLanguage:', localStorage.getItem('selectedLanguage'));
                
                if (backendLang) {
                    // Set localStorage to match backend BEFORE i18n.js loads
                    localStorage.setItem('selectedLanguage', backendLang);
                    localStorage.setItem('userLanguage', backendLang);
                    console.log('[PRE-FETCH] SUCCESS: localStorage updated to backend value:', backendLang);
                } else {
                    console.log('[PRE-FETCH] No backend language set, keeping localStorage');
                }
            } else if (xhr.status === 401) {
                console.log('[PRE-FETCH] Not authenticated yet - will sync after login');
            } else {
                console.warn('[PRE-FETCH] Unexpected status:', xhr.status);
            }
        } catch (e) {
            console.warn('[PRE-FETCH] Error pre-fetching language:', e.message);
            // Don't block page load on error
        }
        
        console.log('[PRE-FETCH] ========================================');
    })();
    </script>
    
    <script src="/static/js/i18n.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables needed by parameters-social.js - MUST be declared first
    let selectedDate = new Date();
    let currentMonth = new Date();
    let savedDates = [];
    let currentYear = new Date().getFullYear(); // ADD THIS LINE
    if (typeof currentRecipient === 'undefined') {
        var currentRecipient = null;
    }
</script>
<script src="/static/js/parameters-social.js"></script>
   <script src="/static/js/circles-messages.js?v=702.0"></script>
<script src="/static/js/feed-updates.js?v=3.0"></script>
<script>
    // API Configuration
    const API_URL = window.location.origin + '/api';
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;
    let isLoginMode = true;
    let viewingUserId = null; // Track which user profile we're viewing
    if (typeof currentUserId === 'undefined') {
        var currentUserId = null;
    }
    // Variables above already declared before parameters-social.js
    // Helper function to format message time with translation
    function formatMessageTime(timestamp) {
    try {
        if (!timestamp) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const now = new Date();
        const msgTime = new Date(timestamp);

        if (isNaN(msgTime.getTime())) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
        }

        const diffSeconds = Math.floor((now - msgTime) / 1000);

        // Just now (less than 60 seconds)
        if (diffSeconds < 60) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.just_now') : 'Just now';
        }

        // Minutes ago
        if (diffSeconds < 3600) {
            const minutes = Math.floor(diffSeconds / 60);
            const minText = window.i18n && window.i18n.t ? window.i18n.t('messages.minutes_ago') : 'min ago';
            return `${minutes} ${minText}`;
        }

        // Hours ago (same day)
        if (msgTime.toDateString() === now.toDateString()) {
            return msgTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Yesterday
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (msgTime.toDateString() === yesterday.toDateString()) {
            return window.i18n && window.i18n.t ? window.i18n.t('messages.yesterday') : 'Yesterday';
        }

        // Older messages
        return msgTime.toLocaleDateString();
    } catch (error) {
        console.error('Error formatting time:', error);
        return window.i18n && window.i18n.t ? window.i18n.t('messages.unknown_time') : 'Unknown time';
    }
}

        // Feed Calendar Variables
        let feedSelectedDate = new Date();
        let feedCurrentMonth = new Date();
        let feedSavedDates = [];
         let feedSavedDatesByVisibility = {
            'general': [],
            'close_friends': [],
            'family': [],
            'private': []
        };
        // Global variables for calendar state





        // City and Timezone Functions - Israel, USA, UK only (MVP)
        const timezoneOffsets = {
            // Israel (all use Israel Standard Time, UTC+2, or UTC+3 during DST)
            'Jerusalem, Israel': 2,
            'Tel Aviv, Israel': 2,
            'Haifa, Israel': 2,
            'Beer Sheva, Israel': 2,
            'Netanya, Israel': 2,
            'Rishon LeZion, Israel': 2,
            'Petah Tikva, Israel': 2,
            'Ashdod, Israel': 2,
            'Eilat, Israel': 2,
            'Herzliya, Israel': 2,
            // USA (multiple timezones)
            'New York City, USA': -5,   // Eastern
            'Los Angeles, USA': -8,      // Pacific
            'Chicago, USA': -6,          // Central
            'Washington, USA': -5,       // Eastern
            'Houston, USA': -6,          // Central
            'San Francisco, USA': -8,    // Pacific
            'Boston, USA': -5,           // Eastern
            'Philadelphia, USA': -5,     // Eastern
            'Phoenix, USA': -7,          // Mountain (no DST)
            'San Diego, USA': -8,        // Pacific
            'Dallas, USA': -6,           // Central
            'Seattle, USA': -8,          // Pacific
            'Miami, USA': -5,            // Eastern
            'Atlanta, USA': -5,          // Eastern
            'Denver, USA': -7,           // Mountain
            'Austin, USA': -6,           // Central
            'San Jose, USA': -8,         // Pacific
            'Portland, USA': -8,         // Pacific
            'Las Vegas, USA': -8,        // Pacific
            'Minneapolis, USA': -6,      // Central
            'Detroit, USA': -5,          // Eastern
            'Baltimore, USA': -5,        // Eastern
            'Nashville, USA': -6,        // Central
            'Charlotte, USA': -5,        // Eastern
            'Orlando, USA': -5,          // Eastern
            // UK (all use GMT/BST, UTC+0 or UTC+1 during DST)
            'London, UK': 0,
            'Manchester, UK': 0,
            'Birmingham, UK': 0,
            'Edinburgh, UK': 0,
            'Glasgow, UK': 0,
            'Bristol, UK': 0,
            'Liverpool, UK': 0,
            'Leeds, UK': 0,
            'Sheffield, UK': 0,
            'Newcastle, UK': 0,
            'Nottingham, UK': 0,
            'Southampton, UK': 0,
            'Cardiff, UK': 0,
            'Belfast, UK': 0,
            'Cambridge, UK': 0
        };

   function updateCityTime() {
    // FIXED: Check if citySelector exists before accessing
    const citySelector = document.getElementById('citySelector');
    const homeCitySelector = document.getElementById('homeCitySelector');

    // Use whichever selector is available
    const activeSelector = citySelector || homeCitySelector;

    if (!activeSelector) {
        // No selector available, skip update
        return;
    }

    const city = activeSelector.value;
    const offset = timezoneOffsets[city] || 0;

    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const cityTime = new Date(utc + (3600000 * offset));

    const timeString = cityTime.toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });

    // FIXED: Use i18n for date formatting instead of toLocaleDateString
    const monthNames = [
        'january', 'february', 'march', 'april', 'may', 'june',
        'july', 'august', 'september', 'october', 'november', 'december'
    ];
    const dayNames = [
        'sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'
    ];

    // Get translation function
    const t = (key) => window.i18n ? window.i18n.translate(key) : key;

    // Build translated date string
    const dayName = t(`day.${dayNames[cityTime.getDay()]}`);
    const monthName = t(`month.${monthNames[cityTime.getMonth()]}`);
    const dayNumber = cityTime.getDate();
    const year = cityTime.getFullYear();

    const dateString = `${dayName}, ${monthName} ${dayNumber}, ${year}`;

    // FIXED: Translate city name
    // FIXED: Translate city name - handle comma+space correctly
    const cityKey = city.toLowerCase()
        .replace(/,\s*/g, '_')   // Comma + optional spaces ‚Üí single underscore
        .replace(/\s+/g, '_')    // Remaining spaces ‚Üí underscores
        .replace(/'+/g, '')      // Remove apostrophes
        .replace(/√©/g, 'e')      // Special character replacements
        .replace(/√£/g, 'a')
        .replace(/√µ/g, 'o')
        .replace(/√ß/g, 'c')
        .replace(/_+/g, '_');    // Multiple underscores ‚Üí single underscore
    const translatedCity = t(`city.${cityKey}`) || city;

    // Update both displays (feed page has cityTimeDisplay, home page has homeCityTimeDisplay)
    const feedDisplay = document.getElementById('cityTimeDisplay');
    const homeDisplay = document.getElementById('homeCityTimeDisplay');

    // FIXED: Include translated city name in display
    const timeHtml = `<div style="font-size: 14px; color: #6B7280; margin-bottom: 4px;">${translatedCity}</div><div style="font-size: 24px; font-weight: bold;">${timeString}</div><div style="font-size: 16px;">${dateString}</div>`;

    if (feedDisplay) {
        feedDisplay.innerHTML = timeHtml;
    }
    if (homeDisplay) {
        homeDisplay.innerHTML = timeHtml;
    }
}


async function loadUserCity() {
    try {
        const response = await apiCall('/user/city');
        if (response && response.selected_city) {
            const feedSelector = document.getElementById('citySelector');
            const homeSelector = document.getElementById('homeCitySelector');

            if (feedSelector) {
                feedSelector.value = response.selected_city;
            }
            if (homeSelector) {
                homeSelector.value = response.selected_city;
            }

            // FIXED: Only update time if at least one selector exists
            if (feedSelector || homeSelector) {
                updateCityTime();
            }
        }
    } catch (error) {
        console.error('Error loading city:', error);
    }
}

        async function saveUserCity(city) {
            try {
                await apiCall('/user/city', 'POST', { selected_city: city });
            } catch (error) {
                console.error('Error saving city:', error);
            }
        }






        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);

                if (response.status === 401) {
                    // Don't call showAuthContainer for login/register endpoints - let the form handle it
                    if (!endpoint.includes('/auth/login') && !endpoint.includes('/auth/register')) {
                        showAuthContainer();
                    }
                    return null;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation Functions
        document.getElementById('navAbout').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('aboutPage').classList.remove('hidden');
        });

        document.getElementById('navSupport').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllViews();
            document.getElementById('supportPage').classList.remove('hidden');
        });

        // PJ6004: Removed navHome button and event listener

        function goHome() {
            hideAllViews();
            if (currentUser) {
                document.getElementById('dashboard').style.display = 'block';
            } else {
                document.getElementById('authContainer').style.display = 'flex';
            }
        }

        function hideAllViews() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('aboutPage').classList.add('hidden');
            document.getElementById('supportPage').classList.add('hidden');
        }

        // Auth Functions
     // Toggle between login and signup
        document.getElementById('toggleAuth').addEventListener('click', function(e) {
            e.preventDefault();
            
            // FIX: Properly get authTitle element and use reliable mode detection
            const authTitle = document.getElementById('authTitle');
            const loginSection = document.getElementById('loginSection');
            const signupSection = document.getElementById('signupSection');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            
            // Check if currently in login mode by checking if loginSection is visible
            const isLoginMode = loginSection.style.display !== 'none';

            if (isLoginMode) {
                // Switch to signup mode
                authTitle.setAttribute('data-i18n', 'auth.create_account');
                authTitle.textContent = 'Create Account';
                loginSection.style.display = 'none';
                signupSection.style.display = 'block';
                forgotPasswordLink.style.display = 'none';
                this.setAttribute('data-i18n', 'auth.toggle_signin');
                this.textContent = 'Already have an account? Sign in';
            } else {
                // Switch to login mode
                authTitle.setAttribute('data-i18n', 'auth.welcome');
                authTitle.textContent = 'Welcome Back';
                loginSection.style.display = 'block';
                signupSection.style.display = 'none';
                forgotPasswordLink.style.display = 'block';
                this.setAttribute('data-i18n', 'auth.toggle_signup');
                this.textContent = "New here? Create an account";
            }
            
            // Apply translations if i18n is available
            // PJ4007: Use safe wrapper to protect language selector
            safeApplyLanguage();
        });

  // Login form handler (authForm is now only for login)
  document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // FIX #1: Hide any previous error message
        const loginError = document.getElementById('loginErrorMessage');
        if (loginError) loginError.style.display = 'none';

        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;

        try {
            const response = await apiCall('/auth/login', 'POST', { email, password });

            if (response && response.success) {
                currentUser = response.user;
                currentUserId = response.user.id;

                // FIX #5: Check if user needs to fill diary before showing dashboard
                const needsDiary = await checkAndRedirectToDiary();
                if (!needsDiary) {
                    showDashboard();
                    // Load notification settings after login
                    console.log('[LOGIN DEBUG] Login successful, calling loadNotificationSettings');
                    loadNotificationSettings();
                    
                    // PJ812 FIX: Check trigger alerts after login (with delay to ensure session is ready)
                    console.log('[PJ812] Login successful, will check trigger alerts in 3 seconds');
                    setTimeout(() => {
                        if (typeof checkParameterAlerts === 'function') {
                            console.log('[PJ812] Calling checkParameterAlerts after login');
                            checkParameterAlerts();
                        } else {
                            console.warn('[PJ812] checkParameterAlerts not available');
                        }
                    }, 3000);
                }
            } else {
                // Show translated login error message
                const lang = localStorage.getItem('selectedLanguage') || 'en';
                const errorTexts = {
                    'en': 'You have entered an invalid username or password',
                    'he': '◊î◊ñ◊†◊™ ◊©◊ù ◊û◊©◊™◊û◊© ◊ê◊ï ◊°◊ô◊°◊û◊î ◊ú◊ê ◊™◊ß◊ô◊†◊ô◊ù',
                    'ar': 'ŸÑŸÇÿØ ÿ£ÿØÿÆŸÑÿ™ ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©',
                    'ru': '–í—ã –≤–≤–µ–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
                };
                const errorSpan = loginError.querySelector('span');
                if (errorSpan) {
                    errorSpan.textContent = errorTexts[lang] || errorTexts['en'];
                }
                loginError.style.display = 'block';
                setTimeout(() => { loginError.style.display = 'none'; }, 5000);
            }
        } catch (error) {
            const lang = localStorage.getItem('selectedLanguage') || 'en';
            const errorTexts = {
                'en': 'You have entered an invalid username or password',
                'he': '◊î◊ñ◊†◊™ ◊©◊ù ◊û◊©◊™◊û◊© ◊ê◊ï ◊°◊ô◊°◊û◊î ◊ú◊ê ◊™◊ß◊ô◊†◊ô◊ù',
                'ar': 'ŸÑŸÇÿØ ÿ£ÿØÿÆŸÑÿ™ ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©',
                'ru': '–í—ã –≤–≤–µ–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
            };
            const errorSpan = loginError.querySelector('span');
            if (errorSpan) {
                errorSpan.textContent = errorTexts[lang] || errorTexts['en'];
            }
            loginError.style.display = 'block';
            setTimeout(() => { loginError.style.display = 'none'; }, 5000);
        }
    });

  // Signup form handler (traditional email/password signup)
  document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('signupEmailInput').value;
        const password = document.getElementById('signupPasswordInput').value;
        const usernameInput = document.getElementById('signupUsernameInput').value;

        // Handle username - can be blank, will use email prefix
        let username = usernameInput ? usernameInput.trim() : '';
        if (!username) {
            username = email.split('@')[0];
        }

        try {
            const body = { 
                email, 
                password,
                username,
                preferred_language: window.i18n && window.i18n.getCurrentLanguage ?
                    window.i18n.getCurrentLanguage() : 'en'
            };
            
            const response = await apiCall('/auth/register', 'POST', body);

            if (response && response.success) {
                currentUser = response.user;
                currentUserId = response.user.id;

                // Check if new user needs consent
                const consentCheck = await fetch('/api/auth/session');
                const sessionData = await consentCheck.json();
                if (sessionData.authenticated) {
                    const consentResponse = await fetch('/api/user/consent-status');
                    const consentData = await consentResponse.json();
                    if (!consentData.has_consent) {
                        showConsentModal();
                        return;
                    }
                }

                // Check if user needs to fill diary before showing dashboard
                const needsDiary = await checkAndRedirectToDiary();
                if (!needsDiary) {
                    showDashboard();
                    loadNotificationSettings();
                }
            } else {
                alert('Registration failed. Please try again.');
            }
        } catch (error) {
            console.error('Signup error:', error);
            alert(error.message || 'Registration failed. Please try again.');
        }
    });

  // Magic link signup function
  async function requestMagicLinkSignup() {
      const email = document.getElementById('magicLinkEmailInput').value;
      if (!email) {
          alert('Please enter your email address');
          return;
      }
      
      // Use correct API endpoint
      try {
          const response = await fetch('/api/auth/request-magic-link', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                  email,
                  language: window.i18n && window.i18n.getCurrentLanguage ? window.i18n.getCurrentLanguage() : 'en'
              })
          });
          
          const data = await response.json();
          
          if (response.ok) {
              const lang = localStorage.getItem('selectedLanguage') || 'en';
              const successMessages = {
                  'en': 'Magic link sent! Check your email.',
                  'he': '◊ß◊ô◊©◊ï◊® ◊î◊ß◊°◊ù ◊†◊©◊ú◊ó! ◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊ê◊ô◊û◊ô◊ô◊ú ◊©◊ú◊ö.',
                  'ar': 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ≥ÿ≠ÿ±! ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä.',
                  'ru': '–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ—é –ø–æ—á—Ç—É.'
              };
              alert(successMessages[lang] || successMessages['en']);
          } else {
              alert(data.error || 'Failed to send magic link');
          }
      } catch (error) {
          console.error('Magic link error:', error);
          alert('Failed to send magic link. Please try again.');
      }
  }
  
  // Make function globally available
  window.requestMagicLinkSignup = requestMagicLinkSignup;

  // Update email prefix hint when typing in signup email
  document.getElementById('signupEmailInput').addEventListener('input', function() {
      const email = this.value;
      const hintEl = document.getElementById('signupEmailPrefixHint');
      if (hintEl && email.includes('@')) {
          const prefix = email.split('@')[0];
          const lang = localStorage.getItem('selectedLanguage') || 'en';
          const hintTexts = {
              'en': `If blank, username will be: ${prefix}`,
              'he': `◊ê◊ù ◊®◊ô◊ß, ◊©◊ù ◊î◊û◊©◊™◊û◊© ◊ô◊î◊ô◊î: ${prefix}`,
              'ar': `ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÅÿßÿ±ÿ∫Ÿãÿßÿå ÿ≥ŸäŸÉŸàŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${prefix}`,
              'ru': `–ï—Å–ª–∏ –ø—É—Å—Ç–æ, –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç: ${prefix}`
          };
          hintEl.textContent = hintTexts[lang] || hintTexts['en'];
      } else if (hintEl) {
          hintEl.textContent = '';
      }
  });


// Forgot Password form
   document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('forgotEmail').value;
    const language = document.getElementById('languageSelector').value;

    try {
        const response = await fetch(`${API_URL}/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, language })
        });

                const data = await response.json();

                if (response.ok) {
                    alert(window.i18n ? window.i18n.translate('auth.reset_link_sent') : 'Password reset link has been sent to your email');
                    showLogin();
                } else {
                    alert(data.error || (window.i18n ? window.i18n.translate('auth.reset_failed') : 'Failed to send reset link'));
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                alert(window.i18n ? window.i18n.translate('auth.error_occurred') : 'An error occurred. Please try again.');
            }
        });

        // Reset Password form
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert(window.i18n ? window.i18n.translate('auth.passwords_no_match') : 'Passwords do not match');
                return;
            }

            if (newPassword.length < 12) {
                alert(window.i18n ? window.i18n.translate('auth.password_too_short') : 'Password must be at least 12 characters');
                return;
            }

            // Check complexity
            const hasUpper = /[A-Z]/.test(newPassword);
            const hasLower = /[a-z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);

            if (!hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                alert(window.i18n ? window.i18n.translate('auth.password_complexity') : 'Password must contain uppercase, lowercase, number, and special character');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ token, new_password: newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(window.i18n ? window.i18n.translate('auth.password_reset_success') : 'Password has been reset successfully');
                    showLogin();
                } else {
                    alert(data.error || (window.i18n ? window.i18n.translate('auth.reset_failed') : 'Failed to reset password'));
                }
            } catch (error) {
                console.error('Reset password error:', error);
                alert(window.i18n ? window.i18n.translate('auth.error_occurred') : 'An error occurred. Please try again.');
            }
        });


        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await apiCall('/auth/logout', 'POST');
            } catch (error) {
                // Ignore logout errors
            }

            currentUser = null;
            
            // FIX: Clear diary redirect check flag on logout
            if (typeof clearDiaryRedirectCheck === 'function') {
                clearDiaryRedirectCheck();
            } else {
                sessionStorage.removeItem('diary_redirect_checked');
            }
            
            showAuthContainer();
        });

        function showAuthContainer() {
            hideAllViews();
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            // PJ6001: Show nav links when logged out
            document.querySelectorAll('.auth-only-hide').forEach(el => el.style.display = '');
        }





// Magic Link and Consent Functions with Email-Based Username Support

// Show email prefix hint for username field
function updateEmailPrefixHint() {
    const email = document.getElementById('emailInput').value;
    const hint = document.getElementById('emailPrefixHint');
    const suggestedUsername = document.getElementById('suggestedUsername');

    if (email && email.includes('@')) {
        const prefix = email.split('@')[0];
        if (hint) {
            hint.textContent = `If blank, username will be: ${prefix}`;
        }
        if (suggestedUsername) {
            suggestedUsername.textContent = `If blank, username will be: ${prefix}`;
        }
    }
}

// Add event listener for email input
document.getElementById('emailInput')?.addEventListener('input', updateEmailPrefixHint);

// Request magic link
async function requestMagicLink() {
    const email = document.getElementById('emailInput').value;
    const language = document.getElementById('languageSelector').value;

    if (!email) {
        showNotification('Please enter your email', 'error');
        return;
    }

    try {
        const response = await fetch('/api/auth/request-magic-link', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, language})
        });

        const data = await response.json();
        if (response.ok) {
            showNotification('Magic link sent! Check your email', 'success');
            document.getElementById('authForm').reset();
        } else {
            showNotification(data.error || 'Failed to send magic link', 'error');
        }
    } catch (error) {
        showNotification('Network error', 'error');
    }
}

// Check for magic token on page load
async function checkMagicToken() {
    const params = new URLSearchParams(window.location.search);
    const magicToken = params.get('magic_token');

    if (magicToken) {
        try {
            const response = await fetch('/api/auth/verify-magic-link', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: magicToken})
            });

            const data = await response.json();
            if (response.ok) {
                // Clear token from URL
                window.history.replaceState({}, document.title, "/");

                // Store user email for username suggestion
                if (data.user && data.user.email) {
                    sessionStorage.setItem('userEmail', data.user.email);
                }
                if (data.suggested_username) {
                    sessionStorage.setItem('suggestedUsername', data.suggested_username);
                }

                // Go straight to consent (username is optional there)
                if (data.needs_consent) {
                    showConsentModal();
                } else {
                    window.location.reload();
                }
            } else {
                showNotification(data.error || 'Invalid or expired link', 'error');
            }
        } catch (error) {
            showNotification('Verification failed', 'error');
        }
    }
}

// Show consent modal with optional username
function showConsentModal() {
    const email = sessionStorage.getItem('userEmail');
    const suggested = sessionStorage.getItem('suggestedUsername');

    if (suggested || email) {
        const prefix = suggested || email.split('@')[0];
        const suggestedElem = document.getElementById('suggestedUsername');
        if (suggestedElem) {
            suggestedElem.textContent = `If blank, username will be: ${prefix}`;
        }
        const usernameInput = document.getElementById('consentUsername');
        if (usernameInput) {
            usernameInput.placeholder = `Leave blank for: ${prefix}`;
        }
    }

    document.getElementById('consentModal').style.display = 'flex';
}

// Submit consent with optional username and required birth year
async function submitConsent() {
    const username = document.getElementById('consentUsername').value.trim(); // Can be empty
    const birthYearInput = document.getElementById('consentBirthYear').value.trim();
    
    // PJ6001: Validate birth year
    const birthYear = parseInt(birthYearInput);
    if (!birthYearInput || isNaN(birthYear) || birthYear < 1900 || birthYear > 2025) {
        document.getElementById('consentError').textContent = t('profile.birth_year_error') || 'Please enter a valid birth year (4 digits)';
        document.getElementById('consentError').style.display = 'block';
        return;
    }

    const consent = {
        username: username, // Empty string is valid - backend will use email prefix
        birth_year: birthYear, // PJ6001: Add birth year
        email_updates: document.getElementById('emailUpdates').checked,
        privacy_accepted: document.getElementById('privacyAccepted').checked,
        research_data: document.getElementById('researchData').checked,
        team_declaration: document.getElementById('teamDeclaration').checked,
        responsible_use: document.getElementById('responsibleUse').checked,
        waiver_claims: document.getElementById('waiverClaims').checked,
        language: document.getElementById('languageSelector').value
    };

    // Check required consents
    const required = ['privacy_accepted', 'team_declaration', 'responsible_use', 'waiver_claims'];
    const allAccepted = required.every(field => consent[field]);

    if (!allAccepted) {
        document.getElementById('consentError').textContent = t('consent.error') || 'Please accept all required terms';
        document.getElementById('consentError').style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/api/auth/save-consent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(consent)
        });

        const data = await response.json();
        if (response.ok) {
            document.getElementById('consentModal').style.display = 'none';
            sessionStorage.removeItem('userEmail');
            sessionStorage.removeItem('suggestedUsername');
            window.location.reload();
        } else {
            document.getElementById('consentError').textContent = data.error;
            document.getElementById('consentError').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('consentError').textContent = 'Failed to save consent';
        document.getElementById('consentError').style.display = 'block';
    }
}



        // Dashboard Functions
  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'block';
    // PJ6001: Hide nav links when logged in
    document.querySelectorAll('.auth-only-hide').forEach(el => el.style.display = 'none');

    if (currentUser && currentUser.username) {
        document.getElementById('profileAvatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('profileUsername').textContent = currentUser.username;

        currentUserId = currentUser.id; // Ensure user ID is set
        console.log('[DEBUG] Page load - set currentUserId to:', currentUserId);
    }

  initFeedCalendar();
    loadUserCity();

    // FIXED: Only call updateCityTime if selector exists
    setTimeout(() => {
        const citySelector = document.getElementById('citySelector');
        const homeCitySelector = document.getElementById('homeCitySelector');
        if (citySelector || homeCitySelector) {
            updateCityTime();
            // Start time update interval only if we have a selector
            setInterval(updateCityTime, 1000);
        }
    }, 100);

    // Initialize parameter calendar
    if (typeof initializeCalendar === 'function') {
        initializeCalendar();
    }

    // Initialize city selector event
    // City selector removed from feed page - time updates handled by home page selector only

            // Initialize home city selector event
            const homeCitySelector = document.getElementById('homeCitySelector');
            if (homeCitySelector && !homeCitySelector.hasAttribute('data-initialized')) {
                homeCitySelector.addEventListener('change', function() {
                    const city = this.value;
                    saveUserCity(city);
                    updateCityTime();
                });
                homeCitySelector.setAttribute('data-initialized', 'true');
            }


   async function loadUserLanguage() {
    console.log('[LANG DEBUG] ========================================');
    console.log('[LANG DEBUG] loadUserLanguage() STARTED');
    console.log('[LANG DEBUG] Timestamp:', new Date().toISOString());
    
    try {
        // Log current state BEFORE any changes
        const currentLocalLang = localStorage.getItem('selectedLanguage');
        const currentUserLang = localStorage.getItem('userLanguage');
        const langSelector = document.getElementById('languageSelector');
        
        console.log('[LANG DEBUG] BEFORE STATE:');
        console.log('[LANG DEBUG]   localStorage.selectedLanguage:', currentLocalLang);
        console.log('[LANG DEBUG]   localStorage.userLanguage:', currentUserLang);
        console.log('[LANG DEBUG]   selector exists:', !!langSelector);
        console.log('[LANG DEBUG]   selector.value:', langSelector ? langSelector.value : 'N/A');
        console.log('[LANG DEBUG]   i18n.currentLanguage:', window.i18n?.currentLanguage);

        // Fetch user profile from backend - THIS IS THE SOURCE OF TRUTH
        console.log('[LANG DEBUG] Fetching backend profile...');
        const response = await fetch(`${API_URL}/user/profile`);

        if (response.ok) {
            const profile = await response.json();
            const backendLang = profile.preferred_language || 'en';

            console.log('[LANG DEBUG] Backend response:');
            console.log('[LANG DEBUG]   profile.preferred_language:', profile.preferred_language);
            console.log('[LANG DEBUG]   backendLang (with fallback):', backendLang);

            // CRITICAL FIX: ALWAYS trust backend as source of truth
            // Never POST to backend from here - only POST when user explicitly changes selector
            const savedLang = backendLang;
            
            console.log('[LANG DEBUG] USING BACKEND LANGUAGE:', savedLang);
            console.log('[LANG DEBUG] (localStorage was:', currentLocalLang, '- will be overwritten)');

            // Update localStorage to match backend (cache the source of truth)
            localStorage.setItem('selectedLanguage', savedLang);
            localStorage.setItem('userLanguage', savedLang);
            console.log('[LANG DEBUG] localStorage updated to:', savedLang);

            // Apply language using i18n
            if (window.i18n && window.i18n.setLanguage) {
                console.log('[LANG DEBUG] Calling i18n.setLanguage with:', savedLang);
                await window.i18n.setLanguage(savedLang);
                console.log('[LANG DEBUG] i18n.setLanguage completed');
            } else {
                console.warn('[LANG DEBUG] i18n.setLanguage not available!');
            }

            // Update language selector to match
            if (langSelector) {
                console.log('[LANG DEBUG] Updating selector:');
                console.log('[LANG DEBUG]   Current value:', langSelector.value);
                console.log('[LANG DEBUG]   Setting to:', savedLang);
                
                // Check if option exists
                const optionExists = Array.from(langSelector.options).some(opt => opt.value === savedLang);
                console.log('[LANG DEBUG]   Option exists:', optionExists);
                
                if (optionExists) {
                    window._updatingSelectorProgrammatically = true;
                    langSelector.value = savedLang;
                    window._updatingSelectorProgrammatically = false;
                    console.log('[LANG DEBUG]   Selector updated, new value:', langSelector.value);
                } else {
                    console.error('[LANG DEBUG]   ERROR: Option not found for language:', savedLang);
                }
            } else {
                console.error('[LANG DEBUG] Language selector not found in DOM!');
            }

            // Set RTL for Hebrew/Arabic
            const rtlLanguages = ['ar', 'he'];
            if (rtlLanguages.includes(savedLang)) {
                document.body.setAttribute('dir', 'rtl');
                console.log('[LANG DEBUG] Set RTL direction');
            } else {
                document.body.setAttribute('dir', 'ltr');
                console.log('[LANG DEBUG] Set LTR direction');
            }
            
            console.log('[LANG DEBUG] AFTER STATE:');
            console.log('[LANG DEBUG]   localStorage.selectedLanguage:', localStorage.getItem('selectedLanguage'));
            console.log('[LANG DEBUG]   selector.value:', langSelector ? langSelector.value : 'N/A');
            console.log('[LANG DEBUG]   i18n.currentLanguage:', window.i18n?.currentLanguage);
            
        } else {
            console.error('[LANG DEBUG] Failed to fetch profile, status:', response.status);
        }
    } catch (error) {
        console.error('[LANG DEBUG] ERROR in loadUserLanguage:', error);
    }
    
    console.log('[LANG DEBUG] loadUserLanguage() COMPLETED');
    console.log('[LANG DEBUG] ========================================');
}

loadUserLanguage();

// FIX: Sync language selector on tab navigation to prevent it from becoming blank
// This function ensures the language selector always displays the correct language
function syncLanguageSelector() {
    console.log('[SYNC DEBUG] ========================================');
    console.log('[SYNC DEBUG] syncLanguageSelector() CALLED');
    console.log('[SYNC DEBUG] Timestamp:', new Date().toISOString());
    console.log('[SYNC DEBUG] Call stack:', new Error().stack.split('\n').slice(1, 4).join('\n'));
    
    const selector = document.getElementById('languageSelector');
    if (!selector) {
        console.error('[SYNC DEBUG] ERROR: Selector not found in DOM!');
        return;
    }
    
    // Log current state
    console.log('[SYNC DEBUG] CURRENT STATE:');
    console.log('[SYNC DEBUG]   selector.value:', selector.value);
    console.log('[SYNC DEBUG]   selector.selectedIndex:', selector.selectedIndex);
    console.log('[SYNC DEBUG]   selector.options.length:', selector.options.length);
    console.log('[SYNC DEBUG]   localStorage.selectedLanguage:', localStorage.getItem('selectedLanguage'));
    console.log('[SYNC DEBUG]   localStorage.userLanguage:', localStorage.getItem('userLanguage'));
    console.log('[SYNC DEBUG]   i18n.currentLanguage:', window.i18n?.currentLanguage);
    
    // Get the current language from multiple sources
    const currentLang = localStorage.getItem('selectedLanguage') || 
                        localStorage.getItem('userLanguage') || 
                        (window.i18n && window.i18n.getCurrentLanguage ? window.i18n.getCurrentLanguage() : null) ||
                        'en';
    
    console.log('[SYNC DEBUG] Resolved language to use:', currentLang);
    
    // Only update if different to avoid triggering change events
    if (selector.value !== currentLang) {
        console.log('[SYNC DEBUG] VALUES DIFFER - Syncing selector');
        console.log('[SYNC DEBUG]   FROM:', selector.value, '-> TO:', currentLang);
        
        // Verify option exists
        const optionExists = Array.from(selector.options).some(opt => opt.value === currentLang);
        console.log('[SYNC DEBUG]   Option exists:', optionExists);
        
        if (optionExists) {
            window._updatingSelectorProgrammatically = true;
            selector.value = currentLang;
            window._updatingSelectorProgrammatically = false;
            console.log('[SYNC DEBUG]   Selector updated, new value:', selector.value);
        } else {
            console.error('[SYNC DEBUG]   ERROR: Option not found for:', currentLang);
        }
    } else {
        console.log('[SYNC DEBUG] Values match, no sync needed');
    }
    
    // Fallback: if selector is still empty, force set it
    if (!selector.value || selector.value === '') {
        console.warn('[SYNC DEBUG] FALLBACK: Selector is EMPTY after sync!');
        console.log('[SYNC DEBUG]   Forcing to:', currentLang || 'en');
        window._updatingSelectorProgrammatically = true;
        selector.value = currentLang || 'en';
        window._updatingSelectorProgrammatically = false;
        console.log('[SYNC DEBUG]   After force set, value:', selector.value);
    }
    
    console.log('[SYNC DEBUG] FINAL STATE:');
    console.log('[SYNC DEBUG]   selector.value:', selector.value);
    console.log('[SYNC DEBUG] ========================================');
}

// Make function globally available
window.syncLanguageSelector = syncLanguageSelector;

// PJ4007: Safe wrapper for i18n.applyLanguage that protects the language selector
// The i18n.applyLanguage() function has a bug that sets selector.value to undefined
function safeApplyLanguage(lang) {
    if (!window.i18n || !window.i18n.applyLanguage) return;
    
    const selector = document.getElementById('languageSelector');
    const savedValue = selector ? selector.value : null;
    
    // Call the original applyLanguage
    if (lang) {
        window.i18n.applyLanguage(lang);
    } else {
        window.i18n.applyLanguage();
    }
    
    // Restore selector if it was corrupted (set to undefined/empty)
    if (selector && savedValue && (!selector.value || selector.value === '')) {
        console.log('[PJ4007] Restoring selector from empty to', savedValue);
        selector.value = savedValue;
    }
}
window.safeApplyLanguage = safeApplyLanguage;

    // Hide feed view on initial dashboard load (feed should only show when Feed tab is clicked)
    const feedView = document.getElementById('feedView');
    if (feedView) {
        feedView.classList.add('hidden');
    }

    // Show home view by default
    const homeView = document.getElementById('homeView');
    if (homeView) {
        homeView.classList.remove('hidden');
    }

           // Note: loadAlerts() now called from DOMContentLoaded after i18n check
        }

       // Auth navigation functions
        function showLogin() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('forgotPasswordContainer').style.display = 'none';
            document.getElementById('resetPasswordContainer').style.display = 'none';
            document.getElementById('authSubmit').setAttribute('data-i18n', 'btn.signin');
            document.getElementById('authSubmit').textContent = 'Sign In';
        }

        function showForgotPassword() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'flex';
            document.getElementById('resetPasswordContainer').style.display = 'none';
        }

        function showResetPassword(token) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'none';
            document.getElementById('resetPasswordContainer').style.display = 'flex';
            document.getElementById('resetToken').value = token;
        }



// Sidebar Navigation
document.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('click', async (e) => {
        // Skip this handler if the tracking/parameters item was clicked
        // (it has its own onclick handler)
        if (item.dataset.view === 'tracking') {
            console.log('[DEBUG] Skipping generic handler for tracking item');
            return;
        }
        
        // PJ602: Skip circles handler - it has its own onclick="handleCirclesClick" handler
        // This prevents double-calling loadUserCircles and double 403 messages
        if (item.dataset.view === 'circles') {
            console.log('[DEBUG] Skipping generic handler for circles item');
            return;
        }
        
        // PJ4007: Skip invite handler - it has its own onclick="showView('invite')" handler
        // This prevents the generic handler from running after showView() already completed
        // The fix ensures only showView()'s syncLanguageSelector() call happens, not a duplicate
        if (item.dataset.view === 'invite') {
            console.log('[DEBUG] Skipping generic handler for invite item');
            return;
        }

        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

      const view = item.dataset.view;

        // Reset viewing context ONLY for following, followers, messages, and invite
        // Keep viewingUserId for feed, profile, circles, parameters, tracking so user can navigate between viewed user's data
       if (['following', 'followers', 'messages', 'invite'].includes(view)) {
            console.log('[NAV] Resetting viewingUserId for main nav:', view);
            viewingUserId = null;
            window.viewingUserId = null;
        }

        document.getElementById(`${view}View`).classList.remove('hidden');

        // Update mobile nav active state
        document.querySelectorAll('.mobile-nav-item').forEach(mobileItem => {
            mobileItem.classList.remove('active');
            if (mobileItem.dataset.view === view) {
                mobileItem.classList.add('active');
            }
        });

  switch(view) {
                    case 'home':
                        // FIXED: If viewing another user, show their feed instead of static home
                        // Static home page isn't user-specific, so redirect to their feed
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            console.log('[DEBUG] Home clicked while viewing user:', viewingUserId, '- loading their feed');
                            loadUserFeed(viewingUserId);
                        } else {
                            // Initialize home view for own account
                            // Initialize home view for own account
                            console.log('[DEBUG] Home clicked - showing static home page, resetting viewingUserId');
                            viewingUserId = null;
                            window.viewingUserId = null;
                            initializeHomeView();
                            initializeHomeView();
                        }
                        break;
             case 'feed':
                        // Check if viewing another user
                        console.log('[DEBUG] Feed case - viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);

                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            console.log('[DEBUG] Feed view - loading feed for user:', viewingUserId);
                            loadUserFeed(viewingUserId);
                        } else {
                            console.log('[DEBUG] Feed view - loading own feed, resetting viewingUserId');
                            viewingUserId = null;  // Explicitly reset
                            window.viewingUserId = null;

                            // CRITICAL: Restore ALL post creation UI elements
                            console.log('[DEBUG] Restoring post creation UI');
                            const postInput = document.getElementById('postInput');
                            const visibilitySelect = document.getElementById('visibilitySelect');
                            const saveBtn = document.getElementById('postBtn');
                            const postForm = document.querySelector('.post-form');
                            const feedHeader = document.querySelector('#feedView h2');

                            if (postInput) {
                                postInput.style.display = '';
                                console.log('[DEBUG] Restored postInput');
                            }
                            if (visibilitySelect) {
                                visibilitySelect.style.display = '';
                                console.log('[DEBUG] Restored visibilitySelect');
                            }
                            if (saveBtn) {
                                saveBtn.style.display = '';
                                console.log('[DEBUG] Restored saveBtn');
                            }
                            if (postForm) {
                                postForm.style.display = '';
                                console.log('[DEBUG] Restored postForm div');
                            }
                            if (feedHeader) {
                                feedHeader.setAttribute('data-i18n', 'feed.title');
                                if (typeof translatePage === 'function') {
                                    translatePage(currentLanguage);
                                }
                                console.log('[DEBUG] Restored feedHeader');
                            }

                            initFeedCalendar();
                            loadFeed();
                        }
                        break;
                    case 'profile':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserProfileView(viewingUserId);
                        } else {
                            viewingUserId = null;  // Reset when viewing own profile
                            window.viewingUserId = null;
                            loadProfile();
                        }
                        break;
                  case 'circles':
                        console.log('[DEBUG] Circles case - viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            console.log('[DEBUG] Loading another user circles:', viewingUserId);
                            loadUserCircles(viewingUserId);
                        } else {
                            console.log('[DEBUG] Loading own circles');
                            console.log('[DEBUG] Loading own circles, resetting viewingUserId');
                            viewingUserId = null;
                            window.viewingUserId = null;
                            loadCircles();
                        }
                        break;
                    case 'messages':
                        loadConversations();
                        break;
                   case 'tracking':
    // Let showView handle the logic - don't duplicate here
    break;
                    case 'following':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserFollowing(viewingUserId);
                        } else {
                            viewingUserId = null;  // Reset when viewing own following
                            window.viewingUserId = null;
                            loadFollowing();
                        }
                        break;
                    case 'followers':
                        // Check if viewing another user
                        if (viewingUserId !== null && viewingUserId !== currentUserId) {
                            loadUserFollowers(viewingUserId);
                        } else {
                            viewingUserId = null;  // Reset when viewing own followers
                            window.viewingUserId = null;
                            loadFollowers();
                        }
                        break;
                }
    });
});



// Handle parameters click - redirect to /parameters page for own data, show trackingView for other users
function handleParametersClick(event) {
    // Stop event propagation to prevent both handlers from firing
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    console.log('[DEBUG] handleParametersClick called, viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);

    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user - show their parameters in modal
        console.log('[DEBUG] Fetching profile for user:', viewingUserId);
        fetch(`/api/users/${viewingUserId}/profile`, { credentials: 'include' })
            .then(r => {
                console.log('[DEBUG] Profile fetch status:', r.status);
                return r.ok ? r.json() : Promise.reject('Failed to fetch profile');
            })
            .then(data => {
                console.log('[DEBUG] Profile data received, calling viewUserParameters');
                viewUserParameters(viewingUserId, data.username || 'User');
            })
            .catch(err => {
                console.error('[DEBUG] Error in handleParametersClick:', err);
                showNotification('Error loading parameters', 'error');
            });
    } else {
        // Viewing own parameters - redirect to full parameters page
        console.log('[DEBUG] Redirecting to /parameters for own data');
        window.location.href = '/parameters';
    }
}


function handleCirclesClick(event) {
    // Stop event propagation to prevent both handlers from firing
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    console.log('[DEBUG] handleCirclesClick called, viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);

    // FIXED: Use showView to stay on same page and maintain back button functionality
    // Don't redirect to /circles page - stay on index.html so back button works
    showView('circles');
}


// ===============================================
// PJ5002: MOBILE MORE MENU FUNCTIONS
// ===============================================

function toggleMobileMoreMenu() {
    const moreMenu = document.getElementById('mobileMoreMenu');
    if (moreMenu) {
        if (moreMenu.classList.contains('hidden')) {
            moreMenu.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        } else {
            closeMobileMoreMenu();
        }
    }
}

function closeMobileMoreMenu() {
    const moreMenu = document.getElementById('mobileMoreMenu');
    if (moreMenu) {
        moreMenu.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }
}

function showViewFromMore(viewName) {
    closeMobileMoreMenu();
    
    // Handle circles specially
    if (viewName === 'circles') {
        handleCirclesClick(null);
    } else {
        showView(viewName);
    }
}

// Close More menu when pressing Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMobileMoreMenu();
    }
});

// Make functions globally available
window.toggleMobileMoreMenu = toggleMobileMoreMenu;
window.closeMobileMoreMenu = closeMobileMoreMenu;
window.showViewFromMore = showViewFromMore;

// ===============================================
// END MOBILE MORE MENU FUNCTIONS
// ===============================================


function showView(viewName) {
    console.log('[DEBUG] showView called:', viewName, 'viewingUserId:', viewingUserId, 'currentUserId:', currentUserId);
    
    // FIX: Sync language selector on every view change to prevent blank dropdown
    if (typeof syncLanguageSelector === 'function') {
        syncLanguageSelector();
    }
    
    // UPDATED BEHAVIOR: When viewing another user, ALL tabs maintain viewing context
    // Only the "Back to Following" button should reset to current user's account
    // This provides a consistent experience when navigating between tabs while viewing someone else

    // REMOVED: The automatic reset behavior for certain views
    // The viewingUserId is now only reset by:
    // 1. The "Back to Following" button click handler
    // 2. Calling loadProfile() for own profile
    // 3. Explicitly setting viewingUserId = null

    // Update desktop sidebar
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewName) {
            item.classList.add('active');
        }
    });

    // Update mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewName) {
            item.classList.add('active');
        }
    });

    // Show/hide views
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const selectedView = document.getElementById(`${viewName}View`);
    if (selectedView) {
        selectedView.classList.remove('hidden');
    }

    // Load view content - check if viewing another user
    // Ensure currentUserId is set from currentUser before comparison
    if (!currentUserId && currentUser && currentUser.id) {
        currentUserId = currentUser.id;
    }

    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user's profile
        switch(viewName) {
            case 'feed':
                loadUserFeed(viewingUserId);
                break;
            case 'profile':
                loadUserProfileView(viewingUserId);
                break;
            case 'circles':
                loadUserCircles(viewingUserId);
                break;
            case 'parameters':
          case 'tracking':
    // Get username first, then view parameters in modal
    fetch(`/api/users/${viewingUserId}/profile`, {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch profile');
        return response.json();
    })
    .then(data => {
        viewUserParameters(viewingUserId, data.username || 'User');
    })
    .catch(error => {
        console.error('Error loading user parameters:', error);
        showNotification('Error loading parameters', 'error');
    });
    break;
            case 'following':
                loadUserFollowing(viewingUserId);
                break;
            case 'followers':
                loadUserFollowers(viewingUserId);
                break;
            case 'messages':
                // Don't allow viewing another user's messages
                showNotification('Cannot view another user\'s messages', 'error');
                showView('following');
                break;
            default:
                // For other views, go back to own profile
                viewingUserId = null;
                showView('following');
        }
  } else {
        // Viewing own profile
        switch(viewName) {
            case 'feed':
                // Reset viewingUserId and restore UI when viewing own feed
                viewingUserId = null;
                window.viewingUserId = null;

                // Restore post creation UI
                const postInput = document.getElementById('postInput');
                const visibilitySelect = document.getElementById('visibilitySelect');
                const saveBtn = document.getElementById('postBtn');
                const feedHeader = document.querySelector('#feedView h2');

                if (postInput) postInput.style.display = '';
                if (visibilitySelect) visibilitySelect.style.display = '';
                if (saveBtn) saveBtn.style.display = '';
                if (feedHeader) {
                    feedHeader.setAttribute('data-i18n', 'feed.title');
                    if (typeof translatePage === 'function') {
                        translatePage(currentLanguage);
                    }
                }

                initFeedCalendar();
                loadFeed();
                break;
            case 'profile':
                loadProfile();
                break;
            case 'circles':
                // Reset viewingUserId if returning to own circles
                if (viewingUserId === null || viewingUserId === currentUserId) {
                    viewingUserId = null;
                }
                loadCircles();
                break;
            case 'messages':
                loadConversations();
                break;
            case 'parameters':
            case 'tracking':
                // Initialize parameters calendar
                if (typeof initializeCalendar === 'function') {
                    initializeCalendar();
                }
                // Initialize parameter options (1-4 buttons)
                if (typeof createParameterOptions === 'function') {
                    setTimeout(function() {
                        createParameterOptions('moodInput', 'mood');
                        createParameterOptions('sleepInput', 'sleep');
                        createParameterOptions('exerciseInput', 'exercise');
                        createParameterOptions('stressInput', 'stress');
                        createParameterOptions('socialInput', 'social');
                    }, 100);
                }
                break;
            case 'following':
                loadFollowing();
                break;
            case 'followers':
                loadFollowers();
                break;
                 case 'invite':
                loadInviteView();
                break;
            case 'alerts':
                // PJ5001: Load alerts for mobile view
                loadAlerts();
                // Also sync mobile notification toggles with desktop toggles
                syncMobileNotificationSettings();
                break;
        }
    }
}


// ===============================================
// INVITE VIEW FUNCTIONS
// ===============================================

function loadInviteView() {
    console.log('Loading invite view...');
    
    // PJ4007: REMOVED redundant syncLanguageSelector call - showView() already calls it
    // Having two calls was unnecessary since the generic sidebar handler is now skipped for invite

    fetch('/api/auth/session', {
        credentials: 'include'
    })
        .then(response => {
            console.log('Session response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            const username = data.user?.username || 'user';
            const inviteLink = `${window.location.origin}/invite/${username}`;
            const linkInput = document.getElementById('userInviteLink');
            if (linkInput) {
                linkInput.value = inviteLink;
                console.log('Invite link set:', inviteLink);
            }
        })
        .catch(error => {
            console.error('Error loading invite link:', error);
            if (typeof currentUser !== 'undefined' && currentUser?.username) {
                const linkInput = document.getElementById('userInviteLink');
                if (linkInput) {
                    linkInput.value = `${window.location.origin}/invite/${currentUser.username}`;
                }
            }
        });

    loadUserRecommendations();
}

function loadUserRecommendations() {
    console.log('üîç loadUserRecommendations called');

    const list = document.getElementById('recommendationsList');
    console.log('üîç recommendationsList element:', list);

    if (!list) {
        console.error('‚ùå recommendationsList element not found!');
        return;
    }

    // Prevent multiple simultaneous loads
    if (list.dataset.loading === 'true') {
        console.log('‚ö†Ô∏è Already loading, skipping...');
        return;
    }
    list.dataset.loading = 'true';

    list.innerHTML = '<div class="loading">Loading recommendations...</div>';
    console.log('üîç Set loading state');

    fetch('/api/users/recommendations', {
        credentials: 'include'
    })
        .then(response => {
            console.log('üîç Recommendations status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('üîç Recommendations data:', data);
            console.log('üîç Recommendations array:', data.recommendations);
            console.log('üîç Array length:', data.recommendations?.length);
            console.log('üîç Count:', data.count);

            if (data.recommendations && data.recommendations.length > 0) {
                console.log('‚úÖ Rendering', data.recommendations.length, 'recommendations');

                // PJ702: Added clickable names to view user profile
                // PJ6014: Updated to show mutual/city info like circle recommendations
                const html = data.recommendations.map(user => `
                    <div class="user-card">
                        <div style="display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1;" onclick="viewUserProfileFromInvite(${user.id})">
                            <div class="user-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                ${user.reason ? `<div style="font-size: 12px; color: var(--gray);">${user.reason}</div>` : ''}
                                ${user.location ? `<div class="user-location">üìç ${user.location}</div>` : ''}
                            </div>
                        </div>
                        <button class="follow-btn" onclick="sendFollowRequestFromInvite(${user.id})">
                            <span data-i18n="invite.send_request">Send Request</span>
                        </button>
                    </div>
                `).join('');

                console.log('üîç Generated HTML length:', html.length);
                list.innerHTML = html;
                console.log('‚úÖ HTML set to list');

                // PJ4007: Use safe wrapper to protect language selector
                safeApplyLanguage();
            } else {
                console.log('‚ö†Ô∏è No recommendations in array');
                list.innerHTML = '<div class="empty-state">No recommendations available yet. Check back soon!</div>';
            }
            list.dataset.loading = 'false';
            console.log('‚úÖ Loading complete');
        })
        .catch(error => {
            console.error('‚ùå Error loading recommendations:', error);
            list.innerHTML = `<div class="error-state">Failed to load recommendations: ${error.message}</div>`;
            list.dataset.loading = 'false';
        });
}

function copyUserInviteLink() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        linkInput.select();
        navigator.clipboard.writeText(linkInput.value).then(() => {
            showNotification('Invite link copied to clipboard! üìã', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showNotification('Failed to copy link', 'error');
        });
    }
}

function shareViaEmail() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const subject = encodeURIComponent('Join me on my wellness journey!');
        const body = encodeURIComponent(`I'd love for you to follow my wellness journey on TheraSocial. Click here to connect: ${link}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
}

function shareViaSMS() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const message = encodeURIComponent(`Join me on my wellness journey! ${link}`);
        window.location.href = `sms:?body=${message}`;
    }
}

function shareViaWhatsApp() {
    const linkInput = document.getElementById('userInviteLink');
    if (linkInput) {
        const link = linkInput.value;
        const message = encodeURIComponent(`Join me on my wellness journey on TheraSocial! ${link}`);
        window.open(`https://wa.me/?text=${message}`, '_blank');
    }
}

function sendFollowRequestFromInvite(userId) {
    if (typeof followRequestsManager !== 'undefined' && followRequestsManager.sendFollowRequest) {
        followRequestsManager.sendFollowRequest(userId);
    } else {
        // Fallback direct API call
        fetch('/api/follow-requests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ target_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Follow request sent!', 'success');
                // Reload recommendations
                setTimeout(() => loadUserRecommendations(), 1000);
            } else {
                showNotification(data.error || 'Failed to send request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to send follow request', 'error');
        });
    }
}

// PJ702: View user profile from Invite tab recommendations
async function viewUserProfileFromInvite(userId) {
    // Check if blocked by this user first
    try {
        const blockStatus = await checkIfBlockedByUser(userId);
        if (blockStatus.blockedBy || blockStatus.is_blocked) {
            showBlockedMessage();
            return;
        }
    } catch (e) {
        console.error('Error checking block status:', e);
    }
    
    // Navigate to user profile with preview mode (since not following)
    viewUserProfile(userId, true);
}

window.viewUserProfileFromInvite = viewUserProfileFromInvite;

// PJ702: Instant search for Invite tab with Send Request button
let inviteSearchDebounceTimer = null;

async function searchUsersToInviteInstant(query) {
    const resultsContainer = document.getElementById('inviteSearchResults');
    
    // Clear previous timer
    if (inviteSearchDebounceTimer) {
        clearTimeout(inviteSearchDebounceTimer);
    }
    
    // If empty query, hide results
    if (!query || query.trim().length < 1) {
        if (resultsContainer) {
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
        }
        return;
    }
    
    // Debounce: wait 200ms before searching
    inviteSearchDebounceTimer = setTimeout(async () => {
        try {
            const response = await apiCall(`/users/search?q=${encodeURIComponent(query.trim())}`);
            
            if (!response) {
                throw new Error('Search failed');
            }
            
            const users = response.users || (Array.isArray(response) ? response : []);
            
            if (resultsContainer) {
                if (users.length === 0) {
                    const noUsersText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('following.no_users') : 'No users found';
                    resultsContainer.innerHTML = `<p style="text-align: center; color: #6B7280; padding: 15px;">${noUsersText}</p>`;
                } else {
                    const sendRequestText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('invite.send_request') : 'Send Request';
                    
                    // PJ6014: Updated to show mutual/city info like circle recommendations
                    resultsContainer.innerHTML = users.map(user => {
                        // Build reason string like circle recommendations
                        let reason = '';
                        if (user.is_mutual && user.is_same_city) {
                            reason = 'Mutual connection & same city';
                        } else if (user.is_mutual) {
                            reason = 'Mutual connection';
                        } else if (user.is_same_city) {
                            reason = 'Same city';
                        }
                        
                        return `
                        <div class="search-result-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #E5E7EB;">
                            <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="viewUserProfileFromInviteSearch(${user.id})">
                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;">
                                    ${user.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <strong style="display: block;">${user.username}</strong>
                                    ${reason ? `<small style="color: var(--gray);">${reason}</small><br>` : ''}
                                    ${user.selected_city ? `<small style="color: #6B7280;">üìç ${user.selected_city}</small>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button onclick="event.stopPropagation(); sendFollowRequestFromInviteSearch(${user.id})" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px; width: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    ${sendRequestText}
                                </button>
                            </div>
                        </div>
                    `}).join('');
                }
                resultsContainer.style.display = 'block';
            }
        } catch (error) {
            console.error('Invite search error:', error);
            if (resultsContainer) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #EF4444; padding: 15px;">Search failed. Please try again.</p>';
                resultsContainer.style.display = 'block';
            }
        }
    }, 200);
}

// PJ702: View user profile from invite search results
async function viewUserProfileFromInviteSearch(userId) {
    // Clear search and hide results
    document.getElementById('inviteSearchInput').value = '';
    document.getElementById('inviteSearchResults').style.display = 'none';
    
    // Check if blocked first
    try {
        const blockStatus = await checkIfBlockedByUser(userId);
        if (blockStatus.blockedBy || blockStatus.is_blocked) {
            showBlockedMessage();
            return;
        }
    } catch (e) {
        console.error('Error checking block status:', e);
    }
    
    // Navigate to user profile with preview mode
    viewUserProfile(userId, true);
}

// PJ702: Send follow request from invite search
async function sendFollowRequestFromInviteSearch(userId) {
    // Clear search and hide results first
    document.getElementById('inviteSearchInput').value = '';
    document.getElementById('inviteSearchResults').style.display = 'none';
    
    // Use existing function
    sendFollowRequestFromInvite(userId);
}

window.searchUsersToInviteInstant = searchUsersToInviteInstant;
window.viewUserProfileFromInviteSearch = viewUserProfileFromInviteSearch;
window.sendFollowRequestFromInviteSearch = sendFollowRequestFromInviteSearch;







        // Feed Calendar Functions
    function initFeedCalendar(userId = null) {
            console.log('[DEBUG] initFeedCalendar called with userId:', userId);

            // CRITICAL: If userId is null, we're viewing OWN feed
            // Reset viewingUserId to ensure consistency
            if (userId === null) {
                console.log('[DEBUG] initFeedCalendar - resetting viewingUserId');
                viewingUserId = null;
                window.viewingUserId = null;

                // Restore post creation UI when viewing own feed
                const postInput = document.getElementById('postInput');
                const visibilitySelect = document.getElementById('visibilitySelect');
                const saveBtn = document.getElementById('postBtn');
                const feedHeader = document.querySelector('#feedView h2');

                if (postInput) postInput.style.display = '';
                if (visibilitySelect) visibilitySelect.style.display = '';
                if (saveBtn) saveBtn.style.display = '';
                if (feedHeader) {
                    feedHeader.setAttribute('data-i18n', 'feed.title');
                    // Re-translate if translation function exists
                    if (typeof translatePage === 'function') {
                        translatePage(currentLanguage);
                    }
                }
            }

            loadFeedSavedDates(userId);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();
        }

      async function loadFeedSavedDates(userId = null) {
    try {
        const endpoint = userId ? `/users/${userId}/feed/dates` : '/feed/dates';
        console.log('[DEBUG] loadFeedSavedDates - userId:', userId, 'endpoint:', endpoint);
        const response = await apiCall(endpoint);
        if (response) {
            // Store dates organized by visibility
            if (response.dates_by_visibility) {
                feedSavedDatesByVisibility = response.dates_by_visibility;
            }
            // For backward compatibility, keep the combined dates
            feedSavedDates = Object.keys(response.dates || {});
        }
    } catch (error) {
        console.error('Failed to load feed dates:', error);
    }
}

        function renderFeedCalendar() {
            const year = feedCurrentMonth.getFullYear();
            const month = feedCurrentMonth.getMonth();

            // FIX: Use numeric month index directly
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + month) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

            document.getElementById('feedCurrentMonth').textContent = `${translatedMonth} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('feedCalendarGrid');
            grid.innerHTML = '';

            // FIX: Get day headers using individual day keys
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            dayNames.forEach(dayKey => {
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                header.style.textAlign = 'center';
                header.style.padding = '8px';
                header.textContent = window.i18n && window.i18n.translate ?
                    window.i18n.translate('day.' + dayKey) :
                    dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
                grid.appendChild(header);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Get current visibility selection
            const visibilitySelect = document.getElementById('visibilitySelect');
            const currentVisibility = visibilitySelect ? visibilitySelect.value : 'general';

            // Map visibility values
            const visibilityMap = {
                'general': 'general',
                'public': 'general',
                'close_friends': 'close_friends',
                'class_b': 'close_friends',
                'family': 'family',
                'class_a': 'family',
                'private': 'private'
            };
            const mappedVisibility = visibilityMap[currentVisibility] || 'general';

            // Get dates for current visibility level
            const visibilityDates = feedSavedDatesByVisibility && feedSavedDatesByVisibility[mappedVisibility]
                ? feedSavedDatesByVisibility[mappedVisibility]
                : [];

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'feed-calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Only highlight dates that have content for the CURRENT visibility level
                if (visibilityDates.includes(dateStr)) {
                    dayCell.classList.add('has-posts');
                }

                if (feedSelectedDate.getDate() === day &&
                    feedSelectedDate.getMonth() === month &&
                    feedSelectedDate.getFullYear() === year) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => selectFeedDate(year, month, day);
                grid.appendChild(dayCell);
            }
        }

    function selectFeedDate(year, month, day) {
            feedSelectedDate = new Date(year, month, day);
            renderFeedCalendar();
            updateFeedSelectedDateDisplay();

            // Format date as string for API calls
            const dateStr = feedSelectedDate.toISOString().split('T')[0];

            // Check if viewing another user's feed
            if (viewingUserId !== null && viewingUserId !== currentUserId) {
                loadUserFeedForDate(viewingUserId, dateStr);
            } else {
                loadFeedForDate();
            }
        }

// Load a specific user's feed for a date (read-only)
// Load a specific user's feed for a date (read-only)
// Load a specific user's feed for a date (read-only)
async function loadUserFeedForDate(userId, dateStr) {
    try {
        const response = await fetch(`/api/users/${userId}/feed/${dateStr}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('This update is not available to you based on your circle membership', 'error');
                return;
            }
            throw new Error('Failed to load feed for date');
        }

        const data = await response.json();

        // Display posts in the feed container
        const feedContainer = document.getElementById('feedPostsContainer');
        if (!feedContainer) {
            console.error('Feed posts container not found');
            return;
        }

        const circleNames = {
            1: 'Public',
            2: 'Close Friends',
            3: 'Family',
            'general': 'Public',
            'close_friends': 'Close Friends',
            'family': 'Family',
            'private': 'Private'
        };

        if (data.posts && data.posts.length > 0) {
            feedContainer.innerHTML = data.posts.map(post => `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${post.category || 'General'}</span>
                        <span class="post-date">${new Date(post.created_at).toLocaleDateString()}</span>
                        ${post.circle_id ? `<span class="post-visibility" style="margin-left: 0.5rem; font-size: 0.85rem; color: var(--gray);">(${circleNames[post.circle_id] || circleNames[post.circle] || 'Public'})</span>` : ''}
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.mood ? `<div class="post-mood" style="margin-top: 0.5rem; color: var(--gray);">Mood: ${post.mood}</div>` : ''}
                   <div class="post-footer" style="margin-top: 1rem;">
                        <div class="post-stats">
                            <button class="like-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem;">
                                <span class="like-icon">${post.user_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span class="like-count">${post.likes_count || 0}</span>
                            </button>
                            <button class="comment-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem; margin-left: 1rem;">
                                üí¨ <span class="comment-count">${post.comments_count || 0}</span>
                            </button>
                        </div>
                        <div class="comments-section" id="comments-${post.id}" style="display: none; margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <div class="comments-list" id="comments-list-${post.id}"></div>
                            <div style="margin-top: 1rem;">
                                <input type="text" id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="submitComment(${post.id})" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Post Comment</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No post for this date.</p>';
        }
    } catch (error) {
        console.error('Error loading user feed for date:', error);
        showNotification('Error loading post', 'error');
    }
}





        function updateFeedSelectedDateDisplay() {
            const date = feedSelectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('feedSelectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function feedPreviousMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() - 1);
            renderFeedCalendar();
        }

        function feedNextMonth() {
            feedCurrentMonth.setMonth(feedCurrentMonth.getMonth() + 1);
            renderFeedCalendar();
        }

    async function loadFeedForDate() {
    const dateStr = feedSelectedDate.toISOString().split('T')[0];
    let visibility = document.getElementById('visibilitySelect').value;

    // Map old visibility values to ensure backward compatibility
    const visibilityMap = {
        'general': 'general',
        'public': 'general',
        'close_friends': 'close_friends',
        'class_b': 'close_friends',
        'family': 'family',
        'class_a': 'family',
        'private': 'private'  // ‚Üê ADDED: private support
    };

    visibility = visibilityMap[visibility] || visibility;

    try {
        const response = await apiCall(`/feed/${dateStr}?visibility=${visibility}`);

        if (response) {
            const content = response.content || '';
            document.getElementById('postInput').value = content;

            // Optional: Show console log instead of alerts
            if (content) {
                console.log(`Loaded ${visibility.replace('_', ' ')} content for ${dateStr}`);
            } else {
                console.log(`No ${visibility.replace('_', ' ')} content for ${dateStr}`);
            }
        }
    } catch (error) {
        console.error('Error loading feed:', error);
        // Clear the input if there's an error
        document.getElementById('postInput').value = '';
    }
}

// Like and Comment Functions
async function toggleLike(postId) {
    try {
        const response = await fetch(`${API_URL}/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to toggle like');
        }

        const data = await response.json();

        // Update UI
        const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
        if (likeBtn) {
            const likeIcon = likeBtn.querySelector('.like-icon');
            const likeCount = likeBtn.querySelector('.like-count');

            likeIcon.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
            likeCount.textContent = data.likes_count;
        }

    } catch (error) {
        console.error('Error toggling like:', error);
        showNotification('Failed to update like', 'error');
    }
}

async function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);

    if (commentsSection.style.display === 'none') {
        // Load and show comments
        await loadComments(postId);
        commentsSection.style.display = 'block';
    } else {
        // Hide comments
        commentsSection.style.display = 'none';
    }
}

async function loadComments(postId) {
    try {
        const response = await fetch(`${API_URL}/posts/${postId}/comments`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load comments');
        }

        const data = await response.json();
        const commentsList = document.getElementById(`comments-list-${postId}`);

        if (data.comments && data.comments.length > 0) {
            commentsList.innerHTML = data.comments.map(comment => `
                <div class="comment" style="margin-bottom: 0.75rem; padding: 0.5rem; background: white; border-radius: 4px;">
                    <div style="font-weight: 600; font-size: 0.9rem;">${comment.author.username}</div>
                    <div style="margin-top: 0.25rem; font-size: 0.95rem;">${comment.content}</div>
                    <div style="margin-top: 0.25rem; font-size: 0.8rem; color: var(--gray);">${new Date(comment.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        } else {
            commentsList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 1rem;">No comments yet.</p>';
        }

    } catch (error) {
        console.error('Error loading comments:', error);
        showNotification('Failed to load comments', 'error');
    }
}

async function submitComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const content = commentInput.value.trim();

    if (!content) {
        showNotification('Please enter a comment', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ content })
        });

        if (!response.ok) {
            throw new Error('Failed to add comment');
        }

        const data = await response.json();

        // Clear input
        commentInput.value = '';

        // Reload comments
        await loadComments(postId);

        // Update comment count
        const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
        if (commentBtn) {
            const commentCount = commentBtn.querySelector('.comment-count');
            commentCount.textContent = data.comments_count;
        }

        showNotification('Comment added successfully', 'success');

    } catch (error) {
        console.error('Error submitting comment:', error);
        showNotification('Failed to add comment', 'error');
    }
}

// Event delegation for like and comment buttons
document.addEventListener('click', function(e) {
    // Handle like button clicks
    if (e.target.closest('.like-btn')) {
        const btn = e.target.closest('.like-btn');
        const postId = btn.getAttribute('data-post-id');
        toggleLike(postId);
    }

    // Handle comment button clicks
    if (e.target.closest('.comment-btn')) {
        const btn = e.target.closest('.comment-btn');
        const postId = btn.getAttribute('data-post-id');
        toggleComments(postId);
    }
});


        // Feed Functions
        async function loadFeed() {
            try {
                // PJ708: Remove action buttons from viewing another user
                if (typeof clearViewActionButtons === 'function') {
                    clearViewActionButtons('feedView');
                }
                
                // Restore post creation UI when viewing own feed
                const postInput = document.getElementById('postInput');
                const visibilitySelect = document.getElementById('visibilitySelect');
                const saveBtn = document.getElementById('postBtn');
                const feedHeader = document.querySelector('#feedView h2');

                if (postInput) postInput.style.display = '';
                if (visibilitySelect) visibilitySelect.style.display = '';
                if (saveBtn) saveBtn.style.display = '';
                if (feedHeader) feedHeader.setAttribute('data-i18n', 'feed.title');

                // Re-translate the header in case it was changed
                if (typeof translatePage === 'function') {
                    translatePage(currentLanguage);
                }

                const response = await apiCall('/feed');
                if (!response) return;

                const feedContainer = document.getElementById('feedPostsContainer');
                feedContainer.innerHTML = '';

                if (response.posts && response.posts.length > 0) {
                    response.posts.forEach(post => {
                        const postCard = createPostCard(post);
                        feedContainer.appendChild(postCard);
                    });
                } else {
                    feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">No posts yet. Be the first to share!</p>';
                }
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";

            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";

            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";

            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";

            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";

            return "just now";
        }

        function createPostCard(post) {
            const div = document.createElement('div');
            div.className = 'post-card fade-in';

            const author = post.author || 'Anonymous';
            const initial = author.charAt(0).toUpperCase();
            const timeAgo = getTimeAgo(new Date(post.created_at));

            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar">${escapeHtml(initial)}</div>
                    <div class="post-meta">
                        <div class="post-author">${escapeHtml(author)}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
                <div class="post-footer" style="margin-top: 1rem;">
                    <div class="post-stats">
                        <button class="like-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem;">
                            <span class="like-icon">${post.user_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                            <span class="like-count">${post.reactions_count || 0}</span>
                        </button>
                        <button class="comment-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem; margin-left: 1rem;">
                            üí¨ <span class="comment-count">${post.comments_count || 0}</span>
                        </button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}" style="display: none; margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                        <div class="comments-list" id="comments-list-${post.id}"></div>
                        <div style="margin-top: 1rem;">
                            <input type="text" id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="submitComment(${post.id})" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Post Comment</button>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

       document.getElementById('postBtn').addEventListener('click', async () => {
            const content = document.getElementById('postInput').value.trim();
            const visibility = document.getElementById('visibilitySelect').value;

            if (!content) {
                alert('Please enter some content before saving.');
                return;
            }

            try {
                const dateStr = feedSelectedDate.toISOString().split('T')[0];

                await apiCall('/posts', 'POST', {
                    content: content,
                    visibility: visibility,
                    date: dateStr
                });

                const visibilityDisplay = visibility.replace('_', ' ').toUpperCase();
                alert(`Saved successfully as ${visibilityDisplay}!`);
                await loadFeedSavedDates();
                renderFeedCalendar();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

  document.getElementById('visibilitySelect').addEventListener('change', async () => {
            // Reload calendar to show correct highlighted dates for new visibility
            await loadFeedSavedDates();
            renderFeedCalendar();

            // Reload content for current date with new visibility
            await loadFeedForDate();
        });


        // Profile Functions

function showNotification(message, type = 'info') {
    // Simple alert for now - you can enhance this later
    alert(message);

    // OR if you have a custom notification system, use it:
    // For example: if you have a div with id="notification"
    // const notif = document.getElementById('notification');
    // notif.textContent = message;
    // notif.className = type;
    // notif.style.display = 'block';
    // setTimeout(() => notif.style.display = 'none', 3000);
}


// =====================
// NOTIFICATION SETTINGS FUNCTIONS
// =====================

// Load notification settings when page loads
async function loadNotificationSettings() {
    console.log('[NOTIFICATION DEBUG] ========================================');
    console.log('[NOTIFICATION DEBUG] loadNotificationSettings() CALLED');
    console.log('[NOTIFICATION DEBUG] Current time:', new Date().toISOString());
    console.log('[NOTIFICATION DEBUG] Current user:', currentUser ? currentUser.id : 'NOT SET');
    
    // Check if toggles exist in DOM
    const emailOnAlertToggle = document.getElementById('emailOnAlertToggle');
    const emailOnNotificationToggle = document.getElementById('emailOnNotificationToggle'); // PJ6001
    const dailyDiaryReminderToggle = document.getElementById('dailyDiaryReminderToggle');
    
    console.log('[NOTIFICATION DEBUG] emailOnAlertToggle element found:', !!emailOnAlertToggle);
    console.log('[NOTIFICATION DEBUG] emailOnNotificationToggle element found:', !!emailOnNotificationToggle);
    console.log('[NOTIFICATION DEBUG] dailyDiaryReminderToggle element found:', !!dailyDiaryReminderToggle);
    
    if (emailOnAlertToggle) {
        console.log('[NOTIFICATION DEBUG] emailOnAlertToggle BEFORE fetch - checked:', emailOnAlertToggle.checked);
    }
    if (dailyDiaryReminderToggle) {
        console.log('[NOTIFICATION DEBUG] dailyDiaryReminderToggle BEFORE fetch - checked:', dailyDiaryReminderToggle.checked);
    }
    
    try {
        console.log('[NOTIFICATION DEBUG] Fetching /api/notification-settings...');
        const response = await fetch('/api/notification-settings', {
            credentials: 'include'
        });
        
        console.log('[NOTIFICATION DEBUG] Response status:', response.status);
        console.log('[NOTIFICATION DEBUG] Response ok:', response.ok);
        
        if (!response.ok) {
            console.error('[NOTIFICATION DEBUG] FAILED to load notification settings - status:', response.status);
            return;
        }
        
        const settings = await response.json();
        console.log('[NOTIFICATION DEBUG] Received settings from server:', JSON.stringify(settings, null, 2));
        console.log('[NOTIFICATION DEBUG] email_on_alert value:', settings.email_on_alert, 'type:', typeof settings.email_on_alert);
        console.log('[NOTIFICATION DEBUG] email_on_notification value:', settings.email_on_notification, 'type:', typeof settings.email_on_notification);
        console.log('[NOTIFICATION DEBUG] email_daily_diary_reminder value:', settings.email_daily_diary_reminder, 'type:', typeof settings.email_daily_diary_reminder);
        
        // Re-get elements (in case DOM changed)
        const emailToggle = document.getElementById('emailOnAlertToggle');
        const notificationToggle = document.getElementById('emailOnNotificationToggle'); // PJ6001
        const diaryToggle = document.getElementById('dailyDiaryReminderToggle');
        
        console.log('[NOTIFICATION DEBUG] Re-checking elements after fetch...');
        console.log('[NOTIFICATION DEBUG] emailOnAlertToggle still exists:', !!emailToggle);
        console.log('[NOTIFICATION DEBUG] emailOnNotificationToggle still exists:', !!notificationToggle);
        console.log('[NOTIFICATION DEBUG] dailyDiaryReminderToggle still exists:', !!diaryToggle);
        
        if (emailToggle) {
            const oldValue = emailToggle.checked;
            const newValue = settings.email_on_alert || false;
            console.log('[NOTIFICATION DEBUG] Setting emailOnAlertToggle from', oldValue, 'to', newValue);
            emailToggle.checked = newValue;
            console.log('[NOTIFICATION DEBUG] emailOnAlertToggle AFTER setting - checked:', emailToggle.checked);
        } else {
            console.error('[NOTIFICATION DEBUG] ERROR: emailOnAlertToggle element NOT FOUND!');
        }
        
        // PJ6001: Set email on notification toggle
        if (notificationToggle) {
            const oldValue = notificationToggle.checked;
            const newValue = settings.email_on_notification !== false; // Default to true
            console.log('[NOTIFICATION DEBUG] Setting emailOnNotificationToggle from', oldValue, 'to', newValue);
            notificationToggle.checked = newValue;
        }
        
        if (diaryToggle) {
            const oldValue = diaryToggle.checked;
            const newValue = settings.email_daily_diary_reminder || false;
            console.log('[NOTIFICATION DEBUG] Setting dailyDiaryReminderToggle from', oldValue, 'to', newValue);
            diaryToggle.checked = newValue;
            console.log('[NOTIFICATION DEBUG] dailyDiaryReminderToggle AFTER setting - checked:', diaryToggle.checked);
        
        // PJ6013: CRITICAL FIX - Also set MOBILE toggles (they have separate IDs)
        // Without this, mobile toggles show incorrect state after page load
        const mobileEmailToggle = document.getElementById('mobileEmailOnAlertToggle');
        const mobileNotificationToggle = document.getElementById('mobileEmailOnNotificationToggle');
        const mobileDiaryToggle = document.getElementById('mobileDailyDiaryReminderToggle');
        
        if (mobileEmailToggle) {
            mobileEmailToggle.checked = settings.email_on_alert || false;
            console.log('[NOTIFICATION DEBUG] PJ6013: Set mobileEmailOnAlertToggle to', mobileEmailToggle.checked);
        }
        if (mobileNotificationToggle) {
            mobileNotificationToggle.checked = settings.email_on_notification !== false;
            console.log('[NOTIFICATION DEBUG] PJ6013: Set mobileEmailOnNotificationToggle to', mobileNotificationToggle.checked);
        }
        if (mobileDiaryToggle) {
            mobileDiaryToggle.checked = settings.email_daily_diary_reminder || false;
            console.log('[NOTIFICATION DEBUG] PJ6013: Set mobileDailyDiaryReminderToggle to', mobileDiaryToggle.checked);
            
            // Also show/hide mobile time container
            const mobileTimeContainer = document.getElementById('mobileDiaryReminderTimeContainer');
            if (mobileTimeContainer) {
                mobileTimeContainer.style.display = mobileDiaryToggle.checked ? 'block' : 'none';
            }
            
            // Set mobile time input value
            const mobileTimeInput = document.getElementById('mobileDiaryReminderTimeInput');
            if (mobileTimeInput && settings.diary_reminder_time) {
                mobileTimeInput.value = settings.diary_reminder_time;
            }
        }
            
            // Show/hide time input based on toggle state
            const timeContainer = document.getElementById('diaryReminderTimeContainer');
            if (timeContainer) {
                timeContainer.style.display = newValue ? 'block' : 'none';
            }
            
            // Set time input value
            const timeInput = document.getElementById('diaryReminderTimeInput');
            if (timeInput && settings.diary_reminder_time) {
                timeInput.value = settings.diary_reminder_time;
            }
            
            // Show timezone
            const timezoneSpan = document.getElementById('diaryReminderTimezone');
            if (timezoneSpan && settings.diary_reminder_timezone) {
                // Temporary display until loadUserTimezone updates it with city name
                timezoneSpan.textContent = settings.diary_reminder_timezone;
            }
            
            // Always load the proper timezone from user's city (this will update the display)
            console.log('[NOTIFICATION DEBUG] Calling loadUserTimezone() to set city-based timezone...');
            loadUserTimezone();
        } else {
            console.error('[NOTIFICATION DEBUG] ERROR: dailyDiaryReminderToggle element NOT FOUND!');
        }
        
        console.log('[NOTIFICATION DEBUG] Notification settings load COMPLETE');
        console.log('[NOTIFICATION DEBUG] ========================================');
    } catch (error) {
        console.error('[NOTIFICATION DEBUG] ERROR loading notification settings:', error);
        console.error('[NOTIFICATION DEBUG] Error stack:', error.stack);
    }
}

// Update a notification setting
async function updateNotificationSetting(settingName, value) {
    console.log('[NOTIFICATION DEBUG] ========================================');
    console.log('[NOTIFICATION DEBUG] updateNotificationSetting CALLED');
    console.log('[NOTIFICATION DEBUG] settingName:', settingName);
    console.log('[NOTIFICATION DEBUG] value:', value, 'type:', typeof value);
    console.log('[NOTIFICATION DEBUG] Current time:', new Date().toISOString());
    
    try {
        console.log('[NOTIFICATION DEBUG] Sending PUT to /api/notification-settings...');
        const response = await fetch('/api/notification-settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                [settingName]: value
            })
        });
        
        console.log('[NOTIFICATION DEBUG] PUT Response status:', response.status);
        console.log('[NOTIFICATION DEBUG] PUT Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error('Failed to update setting - status: ' + response.status);
        }
        
        const result = await response.json();
        console.log('[NOTIFICATION DEBUG] PUT Result:', JSON.stringify(result, null, 2));
        
        // Show success feedback
        const lang = localStorage.getItem('selectedLanguage') || 'en';
        
        // Check if emails were sent (when enabling email_on_alert)
        if (settingName === 'email_on_alert' && value && result.emails_sent > 0) {
            const emailsSentMessages = {
                'en': `Setting enabled! ${result.emails_sent} existing alerts sent to your email.`,
                'he': `◊î◊î◊í◊ì◊®◊î ◊î◊ï◊§◊¢◊ú◊î! ${result.emails_sent} ◊î◊™◊®◊ê◊ï◊™ ◊ß◊ô◊ô◊û◊ï◊™ ◊†◊©◊ú◊ó◊ï ◊ú◊û◊ô◊ô◊ú ◊©◊ú◊ö.`,
                'ar': `ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØ! ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ${result.emails_sent} ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸÖŸàÿ¨ŸàÿØÿ© ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä.`,
                'ru': `–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞! ${result.emails_sent} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É.`
            };
            showNotification(emailsSentMessages[lang] || emailsSentMessages['en'], 'success');
        } else if (settingName === 'email_on_alert' && value) {
            const enabledMessages = {
                'en': 'Email alerts enabled. You will receive emails for all future alerts.',
                'he': '◊î◊™◊®◊ê◊ï◊™ ◊ê◊ô◊û◊ô◊ô◊ú ◊î◊ï◊§◊¢◊ú◊ï. ◊™◊ß◊ë◊ú ◊ê◊ô◊û◊ô◊ô◊ú ◊¢◊ú ◊õ◊ú ◊î◊™◊®◊ê◊î ◊¢◊™◊ô◊ì◊ô◊™.',
                'ar': 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä. ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸäÿ©.',
                'ru': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ email –≤–∫–ª—é—á–µ–Ω—ã. –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–∏—Å—å–º–∞ –æ –≤—Å–µ—Ö –±—É–¥—É—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.'
            };
            showNotification(enabledMessages[lang] || enabledMessages['en'], 'success');
        } else {
            const messages = {
                'en': 'Setting updated',
                'he': '◊î◊î◊í◊ì◊®◊î ◊¢◊ï◊ì◊õ◊†◊î',
                'ar': 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπÿØÿßÿØ',
                'ru': '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'
            };
            // Show brief notification for other changes
            showNotification(messages[lang] || messages['en'], 'success');
        }
        
        console.log('[NOTIFICATION DEBUG] Update SUCCESSFUL');
        console.log('[NOTIFICATION DEBUG] ========================================');
        
        // Show/hide time container when diary reminder toggle changes
        if (settingName === 'email_daily_diary_reminder') {
            const timeContainer = document.getElementById('diaryReminderTimeContainer');
            if (timeContainer) {
                timeContainer.style.display = value ? 'block' : 'none';
                
                // Load timezone for user's city if enabling
                if (value) {
                    loadUserTimezone();
                }
            }
        }
        
    } catch (error) {
        console.error('[NOTIFICATION DEBUG] ERROR updating notification setting:', error);
        console.error('[NOTIFICATION DEBUG] Error stack:', error.stack);
        
        // Revert the toggle on error
        const toggle = document.getElementById(settingName === 'email_on_alert' ? 'emailOnAlertToggle' : 'dailyDiaryReminderToggle');
        if (toggle) {
            console.log('[NOTIFICATION DEBUG] Reverting toggle from', toggle.checked, 'to', !value);
            toggle.checked = !value;
        }
        
        showNotification('Failed to update setting', 'error');
    }
}

// Format time input to help users enter 24-hour time correctly
function formatTimeInput(input) {
    let value = input.value.replace(/[^0-9:]/g, '');
    
    // Auto-add colon after 2 digits
    if (value.length === 2 && !value.includes(':')) {
        value = value + ':';
    }
    
    // Limit to 5 characters (HH:MM)
    if (value.length > 5) {
        value = value.substring(0, 5);
    }
    
    input.value = value;
}

// Update diary reminder time
async function updateDiaryReminderTime(timeValue) {
    console.log('[DIARY REMINDER] Updating reminder time to:', timeValue);
    
    // Validate 24-hour format (HH:MM)
    const timeRegex = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
    if (!timeRegex.test(timeValue)) {
        const lang = localStorage.getItem('selectedLanguage') || 'en';
        const errorMessages = {
            'en': 'Please enter time in 24-hour format (HH:MM), e.g., 09:00 or 21:30',
            'he': '◊†◊ê ◊ú◊î◊ñ◊ô◊ü ◊©◊¢◊î ◊ë◊§◊ï◊®◊û◊ò 24 ◊©◊¢◊ï◊™ (HH:MM), ◊ú◊û◊©◊ú 09:00 ◊ê◊ï 21:30',
            'ar': 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàŸÇÿ™ ÿ®ÿ™ŸÜÿ≥ŸäŸÇ 24 ÿ≥ÿßÿπÿ© (HH:MM)ÿå ŸÖÿ´ŸÑ 09:00 ÿ£Ÿà 21:30',
            'ru': '–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ 24-—á–∞—Å–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (HH:MM), –Ω–∞–ø—Ä–∏–º–µ—Ä 09:00 –∏–ª–∏ 21:30'
        };
        showNotification(errorMessages[lang] || errorMessages['en'], 'error');
        return;
    }
    
    // Normalize to HH:MM format (add leading zero if needed)
    const [hours, minutes] = timeValue.split(':');
    const normalizedTime = hours.padStart(2, '0') + ':' + minutes;
    
    try {
        // First get the user's timezone from their city
        console.log('[DIARY REMINDER] Fetching timezone for user city...');
        let timezone = 'UTC';
        try {
            const tzResponse = await fetch('/api/city-timezone', { credentials: 'include' });
            if (tzResponse.ok) {
                const tzData = await tzResponse.json();
                timezone = tzData.timezone || 'UTC';
                console.log('[DIARY REMINDER] Got timezone from city:', timezone);
            }
        } catch (tzError) {
            console.warn('[DIARY REMINDER] Could not get timezone, using UTC:', tzError);
        }
        
        // Update both time and timezone together
        const response = await fetch('/api/notification-settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                diary_reminder_time: normalizedTime,
                diary_reminder_timezone: timezone
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update reminder time');
        }
        
        // Update input with normalized value
        document.getElementById('diaryReminderTimeInput').value = normalizedTime;
        
        // Update timezone display
        await loadUserTimezone();
        
        const lang = localStorage.getItem('selectedLanguage') || 'en';
        const messages = {
            'en': `Reminder time set to ${normalizedTime}`,
            'he': `◊ñ◊û◊ü ◊î◊™◊ñ◊õ◊ï◊®◊™ ◊†◊ß◊ë◊¢ ◊ú-${normalizedTime}`,
            'ar': `ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ∞ŸÉŸäÿ± ÿ•ŸÑŸâ ${normalizedTime}`,
            'ru': `–í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${normalizedTime}`
        };
        showNotification(messages[lang] || messages['en'], 'success');
        
    } catch (error) {
        console.error('[DIARY REMINDER] Error updating reminder time:', error);
        showNotification('Failed to update reminder time', 'error');
    }
}

// Load user's timezone based on their selected city
async function loadUserTimezone() {
    console.log('[DIARY TIMEZONE] ========================================');
    console.log('[DIARY TIMEZONE] loadUserTimezone() called');
    
    try {
        console.log('[DIARY TIMEZONE] Fetching /api/city-timezone...');
        const response = await fetch('/api/city-timezone', {
            credentials: 'include'
        });
        
        console.log('[DIARY TIMEZONE] Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('[DIARY TIMEZONE] Response data:', JSON.stringify(data));
            
            const timezoneSpan = document.getElementById('diaryReminderTimezone');
            console.log('[DIARY TIMEZONE] timezoneSpan element found:', !!timezoneSpan);
            
            if (timezoneSpan && data.city) {
                // Get current language
                const lang = localStorage.getItem('selectedLanguage') || 'en';
                console.log('[DIARY TIMEZONE] Current language:', lang);
                
                // Convert city name to i18n key: "Jerusalem, Israel" -> "city.jerusalem_israel"
                const cityKey = 'city.' + data.city.toLowerCase().replace(/, /g, '_').replace(/ /g, '_');
                console.log('[DIARY TIMEZONE] City i18n key:', cityKey);
                
                // Get translated city name using i18n system
                let translatedCityName = data.city; // Default to English
                if (window.i18n && window.i18n.translate) {
                    const translated = window.i18n.translate(cityKey);
                    // Only use translation if it's not the key itself (meaning translation exists)
                    if (translated && translated !== cityKey) {
                        translatedCityName = translated;
                    }
                }
                console.log('[DIARY TIMEZONE] Translated city name:', translatedCityName);
                
                // Create localized timezone display with translated city name
                const timezoneLabels = {
                    'en': `${translatedCityName} time`,
                    'he': `◊©◊¢◊ï◊ü ${translatedCityName}`,
                    'ar': `ÿ™ŸàŸÇŸäÿ™ ${translatedCityName}`,
                    'ru': `–≤—Ä–µ–º—è ${translatedCityName}`
                };
                const displayText = timezoneLabels[lang] || timezoneLabels['en'];
                
                console.log('[DIARY TIMEZONE] Setting display text to:', displayText);
                timezoneSpan.textContent = displayText;
                timezoneSpan.setAttribute('data-city', data.city);
                timezoneSpan.setAttribute('data-timezone', data.timezone);
            } else if (timezoneSpan && !data.city) {
                console.log('[DIARY TIMEZONE] No city set, showing select city prompt');
                const lang = localStorage.getItem('selectedLanguage') || 'en';
                const noCityLabels = {
                    'en': 'Select a city',
                    'he': '◊ë◊ó◊® ◊¢◊ô◊®',
                    'ar': 'ÿßÿÆÿ™ÿ± ŸÖÿØŸäŸÜÿ©',
                    'ru': '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'
                };
                timezoneSpan.textContent = noCityLabels[lang] || 'Select a city';
            }
            
            // Also update the backend with the timezone
            if (data.timezone) {
                console.log('[DIARY TIMEZONE] Updating backend with timezone:', data.timezone);
                const updateResponse = await fetch('/api/notification-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        diary_reminder_timezone: data.timezone
                    })
                });
                console.log('[DIARY TIMEZONE] Backend update response status:', updateResponse.status);
                
                if (updateResponse.ok) {
                    console.log('[DIARY TIMEZONE] Backend timezone update successful');
                } else {
                    console.error('[DIARY TIMEZONE] Backend timezone update failed');
                }
            }
        } else {
            console.error('[DIARY TIMEZONE] Failed to fetch city timezone, status:', response.status);
        }
    } catch (error) {
        console.error('[DIARY TIMEZONE] Error loading timezone:', error);
        console.error('[DIARY TIMEZONE] Error stack:', error.stack);
    }
    
    console.log('[DIARY TIMEZONE] ========================================');
}

// Make functions globally available
window.loadNotificationSettings = loadNotificationSettings;
window.updateNotificationSetting = updateNotificationSetting;
window.updateDiaryReminderTime = updateDiaryReminderTime;
window.loadUserTimezone = loadUserTimezone;

// Update timezone display when language changes
window.addEventListener('languageChanged', () => {
    console.log('[DIARY TIMEZONE] Language changed, refreshing timezone display...');
    loadUserTimezone();
});






       async function loadProfile() {
            viewingUserId = null; // Reset when viewing own profile
            console.log('[DEBUG] loadProfile called - loading current user profile');
            
            // PJ708: Remove action buttons from viewing another user
            if (typeof clearViewActionButtons === 'function') {
                clearViewActionButtons('profileView');
            }
            
            try {
                const response = await apiCall('/profile');
                if (!response) return;

                console.log('[DEBUG] Profile response:', response);

                // FIXED: Update profile header with username
                const profileHeader = document.querySelector('#profileView h2');
                if (profileHeader) {
                    if (response.username) {
                        profileHeader.textContent = `${response.username}'s Profile`;
                        console.log('[DEBUG] Set profile header to:', response.username);
                    } else {
                        profileHeader.textContent = 'My Profile';
                        console.log('[DEBUG] Set profile header to: My Profile (no username)');
                    }
                }

                // FIXED: Update profile avatar and username display elements
                const profileAvatar = document.getElementById('profileAvatar');
                const profileUsername = document.getElementById('profileUsername');
                if (response.username) {
                    if (profileAvatar) {
                        profileAvatar.textContent = response.username.charAt(0).toUpperCase();
                        console.log('[DEBUG] Set profile avatar to:', response.username.charAt(0));
                    }
                    if (profileUsername) {
                        profileUsername.textContent = response.username;
                        console.log('[DEBUG] Set profile username to:', response.username);
                    }
                }

                document.getElementById('profileBio').value = response.bio || '';
                document.getElementById('profileInterests').value = response.interests || '';
                document.getElementById('profileOccupation').value = response.occupation || '';
                document.getElementById('profileGoals').value = response.goals || '';
                document.getElementById('profileFavoriteHobbies').value = response.favorite_hobbies || '';
                
                // PJ6001: Load birth year
                const birthYearInput = document.getElementById('profileBirthYear');
                if (birthYearInput) {
                    birthYearInput.value = response.birth_year || 1985;
                    birthYearInput.disabled = false;
                    birthYearInput.style.backgroundColor = '';
                    birthYearInput.style.cursor = '';
                }
                
                // PJ6014: Show birth year Update button for own profile
                const birthYearUpdateBtn = document.getElementById('birthYearUpdateBtn');
                if (birthYearUpdateBtn) {
                    birthYearUpdateBtn.style.display = '';
                }

                // Show Change Password and Delete Account sections when viewing own profile
                const changePasswordSection = document.getElementById('changePasswordSection');
                const accountDeletionSection = document.getElementById('accountDeletionSection');
                if (changePasswordSection) {
                    changePasswordSection.style.display = '';
                }
                if (accountDeletionSection) {
                    accountDeletionSection.style.display = '';
                }

                // Re-enable profile fields for own profile
                const bioElement = document.getElementById('profileBio');
                const interestsElement = document.getElementById('profileInterests');
                const occupationElement = document.getElementById('profileOccupation');
                const goalsElement = document.getElementById('profileGoals');
                const hobbiesElement = document.getElementById('profileFavoriteHobbies');
                const saveButton = document.getElementById('updateProfileBtn');

                [bioElement, interestsElement, occupationElement, goalsElement, hobbiesElement].forEach(el => {
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });

                // Show save button
                if (saveButton) {
                    saveButton.style.display = '';
                }

                // Remove back to following button if present
                const backBtn = document.querySelector('#profileView .back-to-following-btn');
                if (backBtn) backBtn.remove();
                
                // PJ602: Remove action buttons if present (Block, Follow, etc.) - these should only show for other users
                const actionButtons = document.querySelector('#profileView .profile-action-buttons');
                if (actionButtons) actionButtons.remove();

            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const profileData = {
                bio: document.getElementById('profileBio').value,
                interests: document.getElementById('profileInterests').value,
                occupation: document.getElementById('profileOccupation').value,
                goals: document.getElementById('profileGoals').value,
                favorite_hobbies: document.getElementById('profileFavoriteHobbies').value
            };

            try {
                await apiCall('/profile', 'PUT', profileData);
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ' successfully!');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });

        // PJ6001: Update birth year function
        async function updateBirthYear() {
            const birthYearInput = document.getElementById('profileBirthYear');
            const birthYear = parseInt(birthYearInput.value);
            
            if (isNaN(birthYear) || birthYear < 1900 || birthYear > 2025) {
                alert(t('profile.birth_year_error') || 'Please enter a valid birth year (1900-2025)');
                return;
            }
            
            try {
                await apiCall('/profile', 'PUT', { birth_year: birthYear });
                alert(t('profile.birth_year_updated') || 'Birth year updated successfully!');
            } catch (error) {
                alert(t('msg.error') || 'Error' + ': ' + error.message);
            }
        }
        // Make updateBirthYear globally available
        window.updateBirthYear = updateBirthYear;

        // Circles Functions
 // FIXED: Move loadCirclesPrivacy and updateCirclesPrivacy OUTSIDE of loadCircles()
// These need to be at global scope to properly access viewingUserId

// Load circles privacy setting
async function loadCirclesPrivacy() {
    try {
        // Determine which user's privacy to load
        const targetUserId = viewingUserId || currentUserId;
        const isViewingOwnCircles = !viewingUserId || viewingUserId === currentUserId;

        // Build URL with user_id parameter if viewing another user
        const url = isViewingOwnCircles
            ? '/api/circles/privacy'
            : `/api/circles/privacy?user_id=${targetUserId}`;

        console.log('[Privacy] Loading privacy for user:', targetUserId, 'isOwn:', isViewingOwnCircles);

        const response = await fetch(url, {
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            console.log('[Privacy] Received privacy data:', data);

            const privacySelect = document.getElementById('circleVisibility');
            if (privacySelect) {
                // Set the privacy value (use circles_privacy or privacy)
                const privacyValue = data.circles_privacy || data.privacy || 'class_a';
                privacySelect.value = privacyValue;

                if (isViewingOwnCircles) {
                    // Viewing own circles - enable editing
                    privacySelect.disabled = false;
                    privacySelect.style.cursor = 'pointer';
                    privacySelect.style.opacity = '1';
                    privacySelect.title = '';
                    console.log('[Privacy] Own circles - editable, value:', privacyValue);
                } else {
                    // Viewing another user's circles - show their setting but disable editing
                    privacySelect.disabled = true;
                    privacySelect.style.cursor = 'not-allowed';
                    privacySelect.style.opacity = '0.6';
                    privacySelect.title = "You cannot change another user's privacy settings";
                    console.log('[Privacy] Other user circles - read-only, value:', privacyValue);
                }
            }
        }
    } catch (error) {
        console.error('Failed to load circles privacy:', error);
    }
}

// Update circles privacy setting
async function updateCirclesPrivacy(passedValue) {
    try {
        // Accept parameter OR get from element
        let privacyLevel = passedValue;

        if (!privacyLevel) {
            const privacySelect = document.getElementById('circleVisibility');
            if (!privacySelect) {
                console.error('Privacy select element not found');
                return;
            }
            privacyLevel = privacySelect.value;
        }

        console.log('Updating privacy to:', privacyLevel);

        if (!privacyLevel) {
            console.error('No privacy level selected');
            showNotification('Please select a privacy level', 'error');
            return;
        }

        const response = await fetch('/api/circles/privacy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                privacy_level: privacyLevel,
                privacy: privacyLevel,
                circles_privacy: privacyLevel
            })
        });

        if (response.ok) {
            showNotification('Privacy settings updated successfully', 'success');
        } else {
            const errorData = await response.json();
            console.error('Privacy update failed:', errorData);
            showNotification('Failed to update privacy settings', 'error');
        }
    } catch (error) {
        console.error('Failed to update circles privacy:', error);
        showNotification('Failed to update privacy settings', 'error');
    }
}


// PJ708: Helper function to clear action buttons from a view when returning to own content
function clearViewActionButtons(viewId) {
    const view = document.getElementById(viewId);
    if (!view) return;
    
    // Remove profile action buttons (Unfollow, Add to Circle, Block, etc.)
    const actionButtons = view.querySelector('.profile-action-buttons');
    if (actionButtons) {
        console.log(`[PJ708] Removing action buttons from ${viewId}`);
        actionButtons.remove();
    }
    
    // Remove back to following button
    const backBtn = view.querySelector('.back-to-following-btn');
    if (backBtn) {
        console.log(`[PJ708] Removing back button from ${viewId}`);
        backBtn.remove();
    }
    
    // PJ709: Remove viewer access level indicator (blue "Your access level" section)
    const accessIndicators = view.querySelectorAll('.viewer-access-indicator');
    accessIndicators.forEach(indicator => {
        console.log(`[PJ709] Removing access level indicator from ${viewId}`);
        indicator.remove();
    });
    
    // PJ801: Remove circle restriction message (yellow "Restricted Access" box)
    const restrictionMessages = view.querySelectorAll('.circle-restriction-message');
    restrictionMessages.forEach(message => {
        console.log(`[PJ801] Removing circle restriction message from ${viewId}`);
        message.remove();
    });
}

async function loadCircles() {
    try {
        console.log('[DEBUG] loadCircles called - loading own circles');

        // CRITICAL FIX: Ensure language is set BEFORE displaying circles
        if (!window.i18n || !window.i18n.currentLanguage) {
            console.log('[loadCircles] ‚ö†Ô∏è i18n.currentLanguage not set! Initializing from localStorage...');
            const storedLang = localStorage.getItem('selectedLanguage') || 'en';
            if (window.i18n && window.i18n.setLanguage) {
                await window.i18n.setLanguage(storedLang);
                console.log('[loadCircles] ‚úÖ Language initialized to:', storedLang);
            } else {
                console.error('[loadCircles] ‚ùå i18n.setLanguage not available!');
            }
        } else {
            console.log('[loadCircles] ‚úÖ Current language already set:', window.i18n.currentLanguage);
        }

        // CRITICAL: Reset viewingUserId when loading own circles
        viewingUserId = null;
        window.viewingUserId = null;

        // PJ708: Remove action buttons from viewing another user
        clearViewActionButtons('circlesView');

        // PJ801: Restore circle cards visibility (they may have been hidden when viewing another user's private circles)
        const circlesContainer = document.querySelector('#circlesView .circles-container');
        if (circlesContainer) {
            const circleCards = circlesContainer.querySelectorAll('.circle-card');
            circleCards.forEach(card => {
                card.style.display = '';  // Reset to default display
            });
        }

        // Ensure we're loading current user's circles
        const header = document.querySelector('#circlesView h2');
        if (header) {
            header.textContent = window.i18n && window.i18n.translate ? window.i18n.translate('circles.title') : 'Circles';
        }

        // Remove any existing back buttons (we're in our own circles view now) - handled by clearViewActionButtons
        const existingBackBtn = document.querySelector('#circlesView .back-to-following-btn');
        if (existingBackBtn) {
            existingBackBtn.remove();
        }

        // Show the user search bar (can add people to own circles)
        const userSearch = document.querySelector('#circlesView .user-search');
        if (userSearch) {
            userSearch.style.display = '';
        }

        // Load own circles from /api/circles (NOT /api/users/{id}/circles)
        const response = await apiCall('/circles');
        if (!response) {
            console.error('[DEBUG] No response from /circles');
            return;
        }

        console.log('[DEBUG] Circles response:', response);

        // Load and show privacy settings for own circles
        await loadCirclesPrivacy();
        const visibilityContainer = document.getElementById('circleVisibilityContainer');
        if (visibilityContainer) {
            visibilityContainer.style.display = 'block';
        }

        // PJ801: Show circle recommendations section when loading own circles
        const recsSection = document.getElementById('circleRecommendationsSection');
        if (recsSection) {
            recsSection.style.display = '';  // Reset to default display
        }

        // Show add/remove functionality for own circles
        const searchBox = document.getElementById('userSearchInput');
        if (searchBox) {
            searchBox.style.display = '';
            if (searchBox.parentElement) {
                searchBox.parentElement.style.display = '';
            }
        }

        // Show all remove buttons
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.style.display = '';
        });

        // Handle response data structure
        let generalMembers = response.general || response.public || [];
        let closeFriendsMembers = response.close_friends || response.class_b || [];
        let familyMembers = response.family || response.class_a || [];

        // If circles object exists, use it (new structure)
        if (response.circles) {
            generalMembers = response.circles.general || response.circles.public || [];
            closeFriendsMembers = response.circles.close_friends || response.circles.class_b || [];
            familyMembers = response.circles.family || response.circles.class_a || [];
        }

        console.log('[DEBUG] Members - Public:', generalMembers.length, 'Class B:', closeFriendsMembers.length, 'Class A:', familyMembers.length);

        // Update displays - language should now be properly set
        console.log('[loadCircles] About to update circle displays with language:', window.i18n?.currentLanguage);
        updateCircleDisplay('general', generalMembers);
        updateCircleDisplay('close_friends', closeFriendsMembers);
        updateCircleDisplay('family', familyMembers);

        console.log('[loadCircles] Circle displays updated');
        
        // Load circle recommendations (only for own circles, not when viewing others)
        if (!viewingUserId || viewingUserId === currentUserId) {
            loadCircleRecommendations();
        }
    } catch (error) {
        console.error('Failed to load circles:', error);
        showNotification(window.i18n && window.i18n.translate ? window.i18n.translate('circles.load_failed') : 'Failed to load circles', 'error');
    }
}


// Load recommended users to add to circles
async function loadCircleRecommendations() {
    console.log('[CircleRecs] Starting loadCircleRecommendations...');
    try {
        const recommendationsContainer = document.getElementById("circleRecommendationsList");
        if (!recommendationsContainer) {
            console.log('[CircleRecs] Container not found');
            return;
        }

        // Show loading state
        recommendationsContainer.innerHTML = `<p style="color: var(--gray); text-align: center;">Loading recommendations...</p>`;

        const response = await fetch("/api/circles/recommendations", {
            credentials: 'include'
        });
        
        console.log('[CircleRecs] Response status:', response.status);
        
        if (!response.ok) {
            console.error("[CircleRecs] Failed to load circle recommendations, status:", response.status);
            recommendationsContainer.innerHTML = `<p style="color: var(--gray); text-align: center;" data-i18n="circles.no_recommendations">No recommendations available</p>`;
            return;
        }

        const data = await response.json();
        console.log('[CircleRecs] Got data:', data);

        if (!data.recommendations || data.recommendations.length === 0) {
            console.log('[CircleRecs] No recommendations found');
            recommendationsContainer.innerHTML = `<p style="color: var(--gray); text-align: center;" data-i18n="circles.no_recommendations">No recommendations available</p>`;
            // PJ4007: Use safe wrapper to protect language selector
            safeApplyLanguage(window.i18n?.getCurrentLanguage?.() || "en");
            return;
        }

        console.log('[CircleRecs] Building HTML for', data.recommendations.length, 'recommendations');
        let html = "";
        data.recommendations.forEach(user => {
            const reasonKey = user.reason_key || "circles.reason_default";
            // Escape username for onclick to prevent XSS and quote issues
            const escapedUsername = (user.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += `
                <div class="recommendation-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 10px; transition: background 0.2s; margin-bottom: 8px; background: white;">
                    <div class="user-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${(user.username || "U")[0].toUpperCase()}
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600; color: var(--dark);">${user.username}</div>
                        <div style="font-size: 12px; color: var(--gray);" data-i18n="${reasonKey}">${user.reason}</div>
                        ${user.selected_city ? `<div style="font-size: 11px; color: var(--gray);">üìç ${user.selected_city}</div>` : ""}
                    </div>
                    <button onclick="showCircleAddMenu(${user.id}, '${escapedUsername}')" 
                        style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s;"
                        onmouseover="this.style.transform='scale(1.05)'" 
                        onmouseout="this.style.transform='scale(1)'">
                        <span data-i18n="circles.add_to_circle">Add to Circle</span>
                    </button>
                </div>
            `;
        });

        recommendationsContainer.innerHTML = html;

        // PJ4007: Use safe wrapper to protect language selector
        safeApplyLanguage(window.i18n?.getCurrentLanguage?.() || "en");
        
        console.log('[CircleRecs] Successfully displayed', data.recommendations.length, 'recommendations');

    } catch (error) {
        console.error("[CircleRecs] Error loading circle recommendations:", error);
        const recommendationsContainer = document.getElementById("circleRecommendationsList");
        if (recommendationsContainer) {
            recommendationsContainer.innerHTML = `<p style="color: var(--gray); text-align: center;" data-i18n="circles.no_recommendations">No recommendations available</p>`;
        }
    }
}

// Show menu to select which circle to add user to
function showCircleAddMenu(userId, username) {
    const currentLang = window.i18n && window.i18n.getCurrentLanguage ? window.i18n.getCurrentLanguage() : "en";
    
    const labels = {
        "en": { public: "Public", close_friends: "Close Friends", family: "Family", title: "Add to which circle?" },
        "he": { public: "◊¶◊ô◊ë◊ï◊®◊ô", close_friends: "◊ó◊ë◊®◊ô◊ù ◊ß◊®◊ï◊ë◊ô◊ù", family: "◊û◊©◊§◊ó◊î", title: "◊ú◊î◊ï◊°◊ô◊£ ◊ú◊ê◊ô◊ñ◊î ◊û◊¢◊í◊ú?" },
        "ar": { public: "ÿπÿßŸÖ", close_friends: "ÿ£ÿµÿØŸÇÿßÿ° ŸÖŸÇÿ±ÿ®ŸàŸÜ", family: "ÿπÿßÿ¶ŸÑÿ©", title: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿ£Ÿä ÿØÿßÿ¶ÿ±ÿ©?" },
        "ru": { public: "–ü—É–±–ª–∏—á–Ω—ã–π", close_friends: "–ë–ª–∏–∑–∫–∏–µ –¥—Ä—É–∑—å—è", family: "–°–µ–º—å—è", title: "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∫–æ–π –∫—Ä—É–≥?" }
    };
    
    const t = labels[currentLang] || labels["en"];
    
    const choice = prompt(
        `${t.title}\n\n` +
        `1. ${t.public}\n` +
        `2. ${t.close_friends}\n` +
        `3. ${t.family}\n\n` +
        `Enter 1, 2, or 3:`
    );
    
    if (!choice) return;
    
    const circleMap = {
        "1": "general",
        "2": "close_friends",
        "3": "family"
    };
    
    const circleType = circleMap[choice.trim()];
    if (!circleType) {
        showNotification("Invalid choice", "error");
        return;
    }
    
    addToCircle(userId, circleType, username);
}


// Now loadCircles() - with the nested functions removed
async function loadUserCircles(userId) {
    try {
        // CRITICAL FIX: Ensure language is set BEFORE displaying circles
        if (!window.i18n || !window.i18n.currentLanguage) {
            console.log('[loadUserCircles] ‚ö†Ô∏è i18n.currentLanguage not set! Initializing from localStorage...');
            const storedLang = localStorage.getItem('selectedLanguage') || 'en';
            if (window.i18n && window.i18n.setLanguage) {
                await window.i18n.setLanguage(storedLang);
                console.log('[loadUserCircles] ‚úÖ Language initialized to:', storedLang);
            } else {
                console.error('[loadUserCircles] ‚ùå i18n.setLanguage not available!');
            }
        } else {
            console.log('[loadUserCircles] ‚úÖ Current language already set:', window.i18n.currentLanguage);
        }

        const response = await fetch(`/api/users/${userId}/circles`, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their circles', 'error');
                // PJ601: Reset viewingUserId to prevent navigation loop bug
                viewingUserId = null;
                window.viewingUserId = null;
                showView('following');
                return;
            }
            throw new Error('Failed to load circles');
        }

        const data = await response.json();

        // Get username for header
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        let username = 'User';
        if (profileResponse.ok) {
            const user = await profileResponse.json();
            username = user.username;
            const circlesHeader = document.querySelector('#circlesView h2');
            if (circlesHeader) circlesHeader.textContent = `${username}'s Circles`;
        }

        // Hide the user search bar completely (can't add people to their circles)
        const userSearch = document.querySelector('#circlesView .user-search');
        if (userSearch) userSearch.style.display = 'none';

        // CHECK IF CIRCLES ARE PRIVATE AND USER DOESN'T HAVE ACCESS
        if (data.private === true || (data.message && data.message.includes('private'))) {
            // Show privacy restriction message with proper context
            const circlesContainer = document.querySelector('#circlesView .circles-container');
            if (circlesContainer) {
                // PJ801: Hide circle cards instead of clearing innerHTML (which destroys the structure)
                const circleCards = circlesContainer.querySelectorAll('.circle-card');
                circleCards.forEach(card => {
                    card.style.display = 'none';
                });

                // Remove any existing restriction messages first
                const existingRestriction = circlesContainer.querySelector('.circle-restriction-message');
                if (existingRestriction) {
                    existingRestriction.remove();
                }

                // Create a centered message explaining the restriction
                const restrictionMessage = document.createElement('div');
                restrictionMessage.className = 'circle-restriction-message';  // PJ801: Add class for removal when navigating away
                restrictionMessage.style.cssText = 'max-width: 600px; margin: 2rem auto; padding: 2rem; background: #fff3cd; border-radius: 15px; text-align: center; border: 2px solid #ffc107;';

                const t = (key, fallback) => {
                    return window.i18n && window.i18n.translate ? window.i18n.translate(key) : fallback;
                };

                let userPrivacyText = '';
                let userPrivacyIcon = '';
                let viewerAccessText = '';
                let viewerAccessIcon = '';

                // Get user's privacy setting
                if (data.user_privacy === 'private') {
                    userPrivacyText = t('circles.visibility_private', 'Private');
                    userPrivacyIcon = 'üîí';
                } else if (data.user_privacy === 'class_a') {
                    userPrivacyText = t('circles.title_class_a', 'Family');
                    userPrivacyIcon = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
                } else if (data.user_privacy === 'class_b') {
                    userPrivacyText = t('circles.title_class_b', 'Close Friends');
                    userPrivacyIcon = 'üë•';
                } else {
                    userPrivacyText = t('circles.visibility_public', 'Public');
                    userPrivacyIcon = 'üåç';
                }

                // Get viewer's access level
                if (data.viewer_circle_type === 'class_a') {
                    viewerAccessText = t('circles.title_class_a', 'Family');
                    viewerAccessIcon = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
                } else if (data.viewer_circle_type === 'class_b') {
                    viewerAccessText = t('circles.title_class_b', 'Close Friends');
                    viewerAccessIcon = 'üë•';
                } else {
                    viewerAccessText = t('circles.title_public', 'Public');
                    viewerAccessIcon = 'üåç';
                }

                restrictionMessage.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                    <h3 style="color: #856404; margin-bottom: 1rem;">${t('circles.restricted_access', 'Restricted Access')}</h3>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #333;">
                        ${username}'s ${t('circles.circles_visibility', 'circles visibility')} ${t('common.is_set_to', 'is set to')}:
                        <strong style="color: #667eea;">${userPrivacyIcon} ${userPrivacyText}</strong>
                    </p>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #333;">
                        ${t('circles.your_access_level', 'Your access level')}:
                        <strong style="color: #667eea;">${viewerAccessIcon} ${viewerAccessText}</strong>
                    </p>
                    <p style="color: #856404;">
                        ${t('circles.insufficient_access', 'You do not have permission to view these circles. The user would need to add you to a higher access level.')}
                    </p>
                `;

                circlesContainer.appendChild(restrictionMessage);
            }

            // Hide privacy dropdown container
            const visibilityContainer = document.getElementById('circleVisibilityContainer');
            if (visibilityContainer) {
                visibilityContainer.style.display = 'none';
            }

            // PJ801: Hide circle recommendations section when viewing restricted circles
            const recsSection = document.getElementById('circleRecommendationsSection');
            if (recsSection) {
                recsSection.style.display = 'none';
            }

            // Add back button
            addBackToFollowingButton('circlesView');
            
            // PJN451: Add action buttons to circles view even when private
            const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
            if (profileResponse.ok) {
                const userData = await profileResponse.json();
                addUserActionButtonsToView('circlesView', userId, userData.username);
            }

            return; // Exit early - don't try to display circles
        }

        // NORMAL FLOW - User has access to circles
        // Load and display the other user's privacy setting (read-only)
        if (data.user_privacy) {
            const privacySelect = document.getElementById('circleVisibility');
            if (privacySelect) {
                privacySelect.value = data.user_privacy;
                privacySelect.disabled = true;
                privacySelect.style.cursor = 'not-allowed';
                privacySelect.style.opacity = '0.6';
                const privacyLabels = {
                    'private': 'Private üîí',
                    'class_a': 'Family üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                    'class_b': 'Close Friends üë•',
                    'public': 'Public üåç'
                };
                privacySelect.title = `This user's circles are ${privacyLabels[data.user_privacy] || data.user_privacy}`;
            }
        }

        // Ensure privacy dropdown container is visible
        const visibilityContainer = document.getElementById('circleVisibilityContainer');
        if (visibilityContainer) {
            visibilityContainer.style.display = 'block';
        }

        // Show viewer's access level in a read-only display
        const circlesContainer = document.querySelector('#circlesView .circles-container') ||
                                 document.querySelector('#circlesView');
        if (circlesContainer && data.viewer_circle_type) {
            // REMOVE ANY EXISTING INDICATORS TO PREVENT DUPLICATES
            const existingIndicators = document.querySelectorAll('.viewer-access-indicator');
            existingIndicators.forEach(indicator => indicator.remove());

            // Create read-only visibility indicator
            const visibilityIndicator = document.createElement('div');
            visibilityIndicator.className = 'viewer-access-indicator';
            visibilityIndicator.style.cssText = 'max-width: 600px; margin: 0 auto 30px; padding: 15px 20px; background: #f0f8ff; border-radius: 10px; text-align: center; border: 2px solid #667eea;';

            const t = (key, fallback) => {
                return window.i18n && window.i18n.translate ? window.i18n.translate(key) : fallback;
            };

            let accessLevelText = '';
            let accessIcon = '';

            if (data.viewer_circle_type === 'class_a') {
                accessLevelText = t('circles.title_class_a', 'Family');
                accessIcon = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            } else if (data.viewer_circle_type === 'class_b') {
                accessLevelText = t('circles.title_class_b', 'Close Friends');
                accessIcon = 'üë•';
            } else {
                accessLevelText = t('circles.title_public', 'Public');
                accessIcon = 'üåç';
            }

            visibilityIndicator.innerHTML = `
                <strong style="color: #667eea;">${t('circles.your_access_level', 'Your Access Level')}:</strong>
                <span style="font-size: 1.2em;">${accessIcon} ${accessLevelText}</span>
            `;

            // Insert at the top of circles view, after the header
            const header = circlesContainer.querySelector('h1, h2') || circlesContainer.firstChild;
            if (header && header.nextSibling) {
                circlesContainer.insertBefore(visibilityIndicator, header.nextSibling);
            } else if (header) {
                header.parentNode.insertBefore(visibilityIndicator, header.nextSibling);
            }
        }

        // Add back button
        addBackToFollowingButton('circlesView');
        
        // PJN451: Add action buttons to circles view when viewing another user
        // Note: profileResponse already declared earlier in this function, so use different name
        const profileResponse3 = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (profileResponse3.ok) {
            const userData3 = await profileResponse3.json();
            addUserActionButtonsToView('circlesView', userId, userData3.username);
        }

        // Hide all edit buttons (add, remove, etc) - but keep action buttons visible
        document.querySelectorAll('#circlesView button').forEach(btn => {
            if (!btn.classList.contains('back-to-following-btn') && !btn.closest('.profile-action-buttons')) {
                btn.style.display = 'none';
            }
        });

        // Display circles that user CAN see
        const generalMembers = data.public || [];
        const closeFriendsMembers = data.class_b || [];
        const familyMembers = data.class_a || [];

        updateCircleDisplay('general', generalMembers);
        updateCircleDisplay('close_friends', closeFriendsMembers);
        updateCircleDisplay('family', familyMembers);

    } catch (error) {
        console.error('Error loading user circles:', error);
        showNotification('Failed to load user circles', 'error');
    }
}

 function hideCircleEditControls() {
    // Hide search box and add buttons
    const searchBox = document.getElementById('userSearchInput');
    const searchResults = document.getElementById('searchResults');
    const visibilityContainer = document.getElementById('circleVisibilityContainer');

    if (searchBox) {
        searchBox.style.display = 'none';
        searchBox.parentElement.style.display = 'none';
    }
    if (searchResults) {
        searchResults.style.display = 'none';
    }
    if (visibilityContainer) {
        visibilityContainer.style.display = 'none';
    }

    // Hide all remove buttons
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.style.display = 'none';
    });
}

function showCircleEditControls() {
    // Show search box and add buttons
    const searchBox = document.getElementById('userSearchInput');

    if (searchBox) {
        searchBox.style.display = '';
        searchBox.parentElement.style.display = '';
    }

    // Show all remove buttons
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.style.display = '';
    });
}


function updateCircleDisplay(type, members) {
    let containerId, countId, displayLabel;

    // Map internal types to display labels and container IDs
    if (type === 'general') {
        containerId = 'generalMembers';
        countId = 'generalCount';
        displayLabel = 'Public';
    } else if (type === 'close_friends') {
        containerId = 'closeFriendsMembers';
        countId = 'closeFriendsCount';
        displayLabel = 'Close Friends';
    } else {
        containerId = 'familyMembers';
        countId = 'familyCount';
        displayLabel = 'Family';
    }

    const container = document.getElementById(containerId);
    const count = document.getElementById(countId);

    if (!container || !count) {
        console.error('Container or count element not found for type:', type);
        return;
    }

    count.textContent = members.length;

    // Update the circle header to show the correct label using translations
    const circleSection = container.closest('.circle-card');
    if (circleSection) {
        const headerElement = circleSection.querySelector('.circle-title');
        if (headerElement) {
            // Get translation function - try both t() and translate() methods
            const t = (window.i18n && window.i18n.t) ? window.i18n.t.bind(window.i18n) :
                      (window.i18n && window.i18n.translate) ? window.i18n.translate.bind(window.i18n) :
                      (key) => key;

            const emoji = type === 'general' ? '' :
                        type === 'close_friends' ? '' : '';

            let translationKey;
            if (type === 'general') {
                translationKey = 'circles.title_public';
            } else if (type === 'close_friends') {
                translationKey = 'circles.title_class_b';
            } else {
                translationKey = 'circles.title_class_a';
            }

            const translatedText = t(translationKey);
            headerElement.textContent = `${emoji} ${translatedText}`;

            // Debug logging to track what's being set
            console.log(`[Circle Title Update] ${type}: "${emoji} ${translatedText}" (current lang: ${window.i18n?.currentLanguage || 'unknown'})`);
        }
    }

    // Update member list or show empty state
    if (members.length === 0) {
        // Get translation function for empty state
        const t = (window.i18n && window.i18n.t) ? window.i18n.t.bind(window.i18n) :
                  (window.i18n && window.i18n.translate) ? window.i18n.translate.bind(window.i18n) :
                  (key) => key;

        container.innerHTML = `<p style="text-align: center; color: var(--gray);" data-i18n="circles.no_members">${t('circles.no_members')}</p>`;
    } else {
        // Check if viewing another user's circles (read-only mode)
        const isReadOnly = viewingUserId !== null && viewingUserId !== currentUserId;

        // Get translation function for Remove button
        const t = (window.i18n && window.i18n.t) ? window.i18n.t.bind(window.i18n) :
                  (window.i18n && window.i18n.translate) ? window.i18n.translate.bind(window.i18n) :
                  (key) => key;

        container.innerHTML = members.map(member => `
            <div class="member-item">
                <div class="member-avatar">${escapeHtml(member.username[0].toUpperCase())}</div>
                <span class="member-name">${escapeHtml(member.username)}</span>
                ${!isReadOnly ? `<button class="remove-btn" onclick="removeFromCircle(${member.id}, '${type}')" data-i18n="circles.remove">${t('circles.remove')}</button>` : ''}
            </div>
        `).join('');
    }
}

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value;

            if (query.length < 1) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('searchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    // PJ6014: Updated to show mutual/city info like circle recommendations
                    container.innerHTML = response.users.map(user => {
                        // Build reason string like circle recommendations
                        let reason = '';
                        if (user.is_mutual && user.is_same_city) {
                            reason = 'Mutual connection & same city';
                        } else if (user.is_mutual) {
                            reason = 'Mutual connection';
                        } else if (user.is_same_city) {
                            reason = 'Same city';
                        }
                        
                        return `
                        <div class="search-result-item" style="display: block; padding: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;" onclick="viewUserProfile(${user.id}); document.getElementById('searchResults').classList.remove('active'); document.getElementById('userSearchInput').value = '';">
                                <div class="member-avatar" style="margin-right: 10px;">${escapeHtml(user.username[0].toUpperCase())}</div>
                                <div style="flex: 1;">
                                    <strong>${escapeHtml(user.username)}</strong>
                                    ${reason ? `<br><small style="color: var(--gray);">${reason}</small>` : ''}
                                    ${user.selected_city ? `<br><small style="color: var(--gray);">üìç ${escapeHtml(user.selected_city)}</small>` : ''}
                                </div>
                            </div>
                           <select onclick="event.stopPropagation();" onchange="addToCircle(${user.id}, this.value, '${escapeHtml(user.username).replace(/'/g, "\\'")}')" style="width: 100%;">
    <option value="">${(window.i18n && window.i18n.t ? window.i18n.t('circles.add_to') : 'Add to circle...')}</option>
   <option value="general" data-i18n="privacy.public">Public</option>
    <option value="close_friends" data-i18n="privacy.class_b">Close Friends</option>
    <option value="family" data-i18n="privacy.class_a">Family</option>
</select>
                        </div>
                    `}).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function addToCircle(userId, circleType, username) {
            if (!circleType) return;

            try {
                await apiCall('/circles', 'POST', {
                    user_id: userId,
                    circle_type: circleType
                });

                const circleLabels = {
    'general': 'Public',
    'close_friends': 'Close Friends',
    'family': 'Family'
};
alert(`${username} added to ${circleLabels[circleType]} circle!`);
                loadCircles();
                document.getElementById('userSearchInput').value = '';
                document.getElementById('searchResults').classList.remove('active');
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        async function removeFromCircle(userId, circleType) {
            if (!confirm((window.i18n && window.i18n.t ? window.i18n.t('circles.remove') : 'Remove') + '?')) return;

            try {
                await apiCall('/circles/remove', 'DELETE', {
                    user_id: userId,
                    circle_type: circleType
                });

                loadCircles();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        }

        // Messages Functions
        async function searchUsersForMessage() {
            const query = document.getElementById('messageUserSearch').value;

            if (query.length < 1) {
                document.getElementById('messageSearchResults').classList.remove('active');
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                if (!response) return;

                const container = document.getElementById('messageSearchResults');

                if (response.users.length === 0) {
                    container.innerHTML = `<div class="search-result-item">${(window.i18n && window.i18n.t ? window.i18n.t('circles.no_users') : 'No users found')}</div>`;
                } else {
                    container.innerHTML = response.users.map(user => `
                        <div class="search-result-item" onclick="startConversation(${user.id}, '${user.username}')">
                            <strong>${user.username}</strong>
                        </div>
                    `).join('');
                }

                container.classList.add('active');
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        async function startConversation(userId, username) {
            currentRecipient = { id: userId, username: username };
            document.getElementById('messageUserSearch').value = '';
            document.getElementById('messageSearchResults').classList.remove('active');
            loadMessages(userId, username);

            const convList = document.getElementById('conversationsList');
            const existingConv = Array.from(convList.children).find(
                child => child.dataset.userId == userId
            );

            if (!existingConv) {
                loadConversations();
            }
        }

   async function loadConversations() {
    try {
        const response = await apiCall('/messages/conversations');
        console.log('Conversations response:', response);
        if (!response) return;

        const container = document.getElementById('conversationsList');

        // Cache translation strings
       const noConversationsText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_conversations') : 'No conversations yet';
const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

        // FIX: response is already parsed JSON from apiCall, don't parse again
        const data = response;

        if (!data.conversations || data.conversations.length === 0) {
            container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--gray);" data-i18n="messages.no_conversations">${noConversationsText}</div>`;
          } else {
            container.innerHTML = data.conversations.map(conv => {
                // Safely access nested properties with fallbacks
                const userId = conv.user && conv.user.id ? conv.user.id : 0;
                const username = conv.user && conv.user.username ? conv.user.username : 'Unknown User';
                const lastMessageCreatedAt = conv.last_message && conv.last_message.created_at ? conv.last_message.created_at : null;
              const lastMessageTime = lastMessageCreatedAt ? formatMessageTime(lastMessageCreatedAt) : '';
                const lastMessageContent = conv.last_message && conv.last_message.content ? conv.last_message.content : noMessagesText;
                const isOwn = conv.last_message && conv.last_message.is_own === true;
                const unreadCount = conv.unread_count || 0;

                // Prevent errors if userId or username is invalid
                if (!userId || !username) {
                    console.warn('Invalid conversation data:', conv);
                    return '';
                }

                // Escape HTML in username to prevent XSS
                const safeUsername = escapeHtml(username);

                return `
                    <div class="conversation-item" data-user-id="${userId}" onclick="loadMessages(${userId}, '${safeUsername}')">
                        <div class="conversation-header">
                            <span class="conversation-username">${safeUsername}</span>
                            <span class="conversation-time">${lastMessageTime}</span>
                        </div>
                        <div class="conversation-preview">
                            ${isOwn ? (youText + ': ') : ''}${escapeHtml(lastMessageContent.substring(0, 50))}${lastMessageContent.length > 50 ? '...' : ''}
                        </div>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                `;
            }).filter(html => html !== '').join('');

            if (currentRecipient && currentRecipient.id) {
                const activeItem = container.querySelector(`[data-user-id="${currentRecipient.id}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }
    } catch (error) {
        console.error('Failed to load conversations:', error);
        const container = document.getElementById('conversationsList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading conversations';
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--danger);">${errorText}</div>`;
    }
}

      async function loadMessages(userId, username) {
    // Validate inputs
  // Validate inputs
    if (!userId || !username) {
        console.error('Invalid userId or username:', { userId, username });
        // Don't show error alert for unauthenticated users
        if (authToken) {
            alert(window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error: Invalid user data');
        }
        return;
    }

    currentRecipient = { id: userId, username: username };

    document.getElementById('chatHeader').textContent = username;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendMessageBtn').disabled = false;

    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.userId == userId) {
            item.classList.add('active');
        }
    });

    try {
        const response = await apiCall(`/messages?recipient_id=${userId}`);
        console.log('Messages response:', response);
        if (!response) return;

        const container = document.getElementById('messagesList');
       const noMessagesText = window.i18n && window.i18n.t ? window.i18n.t('messages.no_messages') : 'No messages yet. Start the conversation!';
const youText = window.i18n && window.i18n.t ? window.i18n.t('messages.you') : 'You';

     if (response.messages && response.messages.length > 0) {
            container.innerHTML = response.messages.map(msg => {
                // Safely check if sender exists and get ID
                const senderId = msg.sender && msg.sender.id ? msg.sender.id : null;
                currentUserId = currentUser?.id || null; // Remove 'const' - just assign to existing variable
                const isOwn = senderId === currentUserId;
                const content = msg.content || '';
                const senderPrefix = isOwn ? youText : (msg.sender && msg.sender.username ? msg.sender.username : 'Unknown');

                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        <div class="message-bubble">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; opacity: 0.8;">${escapeHtml(senderPrefix)}</div>
                            <div>${escapeHtml(content)}</div>
                            <div class="message-time">${formatMessageTime(msg.created_at)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--gray);" data-i18n="messages.no_messages">${noMessagesText}</div>`;
        }

        container.scrollTop = container.scrollHeight;

        await apiCall(`/messages/read/${userId}`, 'POST');
        loadConversations();
    } catch (error) {
        console.error('Failed to load messages:', error);
        const container = document.getElementById('messagesList');
        const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error loading messages';
        container.innerHTML = `<div style="text-align: center; padding: 50px; color: var(--danger);">${errorText}</div>`;
    }
}

    // PJ812: Improved flag system to prevent double message submission
    let isMessageSending = false;
    let lastMessageSentTime = 0;
    const MESSAGE_DEBOUNCE_MS = 1000; // Minimum 1 second between messages
    
    async function sendMessageHandler() {
        // PJ812: Multiple layers of duplicate prevention
        const now = Date.now();
        
        // Layer 1: Flag check
        if (isMessageSending) {
            console.log('[PJ812] Message already sending, ignoring duplicate');
            return;
        }
        
        // Layer 2: Time-based debounce
        if (now - lastMessageSentTime < MESSAGE_DEBOUNCE_MS) {
            console.log('[PJ812] Message sent too recently, ignoring duplicate');
            return;
        }
        
        // Check if recipient is selected
        if (!currentRecipient || !currentRecipient.id) {
            const errorText = window.i18n && window.i18n.t ? window.i18n.t('messages.select_conversation') : 'Please select a conversation first';
            alert(errorText);
            return;
        }

        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        if (!content) return;

        // PJ812: Set all prevention mechanisms immediately
        isMessageSending = true;
        lastMessageSentTime = now;
        document.getElementById('sendMessageBtn').disabled = true;
        
        // PJ812: Clear input immediately to prevent re-sending same message
        const messageToSend = content;
        messageInput.value = '';
        
        try {
            const response = await apiCall('/messages', 'POST', {
                recipient_id: currentRecipient.id,
                content: messageToSend
            });

            // Validate response before proceeding
            if (response && response.success) {
                await loadMessages(currentRecipient.id, currentRecipient.username);
                await loadConversations();
            } else {
                // Restore message if send failed
                messageInput.value = messageToSend;
                throw new Error(response && response.error ? response.error : 'Failed to send message');
            }
        } catch (error) {
            console.error('Send message error:', error);
            // Restore message on error
            if (!messageInput.value) {
                messageInput.value = messageToSend;
            }
            const errorText = window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error';
            alert(errorText + ': ' + (error.message || 'Failed to send message'));
        } finally {
            // PJ812: Reset flag after completion, but keep debounce time active
            isMessageSending = false;
            document.getElementById('sendMessageBtn').disabled = false;
        }
    }
    
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessageHandler);

        // PJ812: Use keydown instead of keypress for more reliable Enter detection
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                e.stopPropagation();
                // PJ812: Call handler directly instead of simulating click
                sendMessageHandler();
            }
        });

        // Parameters/Tracking Functions
        // Parameters/Tracking Functions
function initCalendar() {
    // Call the calendar initialization from parameters-social.js
    if (typeof initializeCalendar === 'function') {
        initializeCalendar();
    }

    // Also initialize the 1-4 parameter options
    if (typeof createParameterOptions === 'function') {
        // Small delay to ensure DOM is ready
        setTimeout(function() {
            createParameterOptions('moodInput', 'mood');
            createParameterOptions('sleepInput', 'sleep');
            createParameterOptions('exerciseInput', 'exercise');
            createParameterOptions('stressInput', 'stress');
            createParameterOptions('socialInput', 'social');
        }, 100);
    }
}




// Initialize calendar with saved dates
async function initializeCalendar() {
    try {
        // Load saved dates first
        if (typeof loadSavedDates === 'function') {
            await loadSavedDates();
        }
        // Then render the calendar
        renderCalendar();
        updateSelectedDateDisplay();
    } catch (error) {
        console.error('Error initializing calendar:', error);
    }
}



// Remove or comment out your local loadSavedDates function
// The one in parameters-social.js will be used instead
function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    // FIX: Use numeric month index directly
    const translatedMonth = window.i18n && window.i18n.translate ?
        window.i18n.translate('calendar.' + month) :
        ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month];

    document.getElementById('currentMonth').textContent = `${translatedMonth} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    // FIX: Get day headers using individual day keys
    const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    dayNames.forEach(dayKey => {
        const header = document.createElement('div');
        header.style.fontWeight = '600';
        header.style.textAlign = 'center';
        header.style.padding = '8px';
        header.textContent = window.i18n && window.i18n.translate ?
            window.i18n.translate('day.' + dayKey) :
            dayKey.charAt(0).toUpperCase() + dayKey.slice(1);
        grid.appendChild(header);
    });

    for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        dayCell.textContent = day;

        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // Check if this date has saved data
        if (savedDates && savedDates.includes(dateStr)) {
            dayCell.classList.add('has-data');
            // Add green dot indicator
            const dot = document.createElement('div');
            dot.className = 'parameter-dot';
            dot.style.cssText = 'width: 6px; height: 6px; background: #10B981; border-radius: 50%; position: absolute; bottom: 2px; right: 2px;';
            dayCell.style.position = 'relative';
            dayCell.appendChild(dot);
        }

        if (selectedDate.getDate() === day &&
            selectedDate.getMonth() === month &&
            selectedDate.getFullYear() === year) {
            dayCell.classList.add('selected');
        }

        dayCell.onclick = () => selectDate(year, month, day);
        grid.appendChild(dayCell);
    }

    // Ensure saved dates are loaded
    if (typeof loadSavedDates === 'function') {
        loadSavedDates();
    }
}

  function selectDate(year, month, day) {
    selectedDate = new Date(year, month, day);
    renderCalendar();
    updateSelectedDateDisplay();

    const dateStr = selectedDate.toISOString().split('T')[0];

    // Check if viewing another user's parameters
    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        loadUserParametersForDate(viewingUserId, dateStr);
    } else {
        loadParametersForDate(dateStr);
    }
}




// Load a specific user's parameters for a date (read-only)
async function loadUserParametersForDate(userId, dateStr) {
    try {
        const response = await fetch(`/api/user/${userId}/parameters/${dateStr}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their parameters', 'error');
                return;
            }
            throw new Error('Failed to load parameters for date');
        }

        const data = await response.json();

        if (data.success && data.data) {
            const params = data.data.parameters;

            // Display parameters as read-only
            displayParameterReadOnly('moodInput', params.mood, 'Mood');
            displayParameterReadOnly('sleepInput', params.sleep_quality, 'Sleep');
            displayParameterReadOnly('exerciseInput', params.physical_activity, 'Exercise');
            displayParameterReadOnly('anxietyInput', params.anxiety, 'Anxiety');
            displayParameterReadOnly('energyInput', params.energy, 'Energy');

            // Display notes if present
            const notesElement = document.getElementById('parameterNotes');
            if (notesElement) {
                notesElement.value = data.data.notes || 'No notes for this date';
                notesElement.disabled = true;
                notesElement.style.backgroundColor = '#f3f4f6';
                notesElement.style.cursor = 'default';
            }
        } else {
            // No data for this date
            clearParameterDisplays();
        }

        // Hide all save buttons
        document.querySelectorAll('#trackingView button, #parametersView button').forEach(btn => {
            if (btn.textContent.includes('Save') || btn.textContent.includes('Submit') || btn.type === 'submit') {
                btn.style.display = 'none';
            }
        });
    } catch (error) {
        console.error('Error loading user parameters for date:', error);
        clearParameterDisplays();
    }
}

// Helper function to display a single parameter as read-only
function displayParameterReadOnly(elementId, value, label) {
    const element = document.getElementById(elementId);
    if (!element) return;

    if (value !== null && value !== undefined && value !== '') {
        // Create a read-only display
        element.innerHTML = `
            <div style="padding: 10px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: 600;">
                ${label}: ${value}/4
            </div>
        `;
    } else {
        element.innerHTML = `
            <div style="padding: 10px; background: var(--light); color: var(--gray); border-radius: 8px; text-align: center;">
                No data
            </div>
        `;
    }
}

// Helper function to clear all parameter displays
function clearParameterDisplays() {
    displayParameterReadOnly('moodInput', null, 'Mood');
    displayParameterReadOnly('sleepInput', null, 'Sleep');
    displayParameterReadOnly('exerciseInput', null, 'Exercise');
    displayParameterReadOnly('anxietyInput', null, 'Anxiety');

    const notesElement = document.getElementById('parameterNotes');
    if (notesElement) {
        notesElement.value = 'No data for this date';
        notesElement.disabled = true;
        notesElement.style.backgroundColor = '#f3f4f6';
        notesElement.style.cursor = 'default';
    }
}




        function updateSelectedDateDisplay() {
            const date = selectedDate;
            const monthIndex = date.getMonth();
            const dayIndex = date.getDay();
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();

            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const translatedDay = window.i18n && window.i18n.translate ?
                window.i18n.translate('day.' + dayNames[dayIndex]) : dayNames[dayIndex];
            const translatedMonth = window.i18n && window.i18n.translate ?
                window.i18n.translate('calendar.' + monthIndex) :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIndex];

            document.getElementById('selectedDateDisplay').textContent =
                `${translatedDay}, ${translatedMonth} ${dayOfMonth}, ${year}`;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        document.getElementById('sleepInput').addEventListener('input', (e) => {
            const hours = e.target.value || 0;
            const hoursText = window.i18n && window.i18n.t ? window.i18n.t('parameters.sleep_hours') : 'Hours';
            document.getElementById('sleepDisplay').innerHTML = `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;
        });

    async function saveParameters() {
    const dateStr = selectedDate.toISOString().split('T')[0];

    // Helper to get selected radio button value
    function getSelectedRadioValue(name) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : '';
    }

    const parameters = {
        date: dateStr,
        mood: getSelectedRadioValue('mood'),
        sleep_hours: getSelectedRadioValue('sleep'),
        exercise: getSelectedRadioValue('exercise'),
        stress: getSelectedRadioValue('stress'),
        social: getSelectedRadioValue('social'),
        notes: document.getElementById('notesInput') ?
               document.getElementById('notesInput').value : ''
    };

    try {
        await apiCall('/parameters/save', 'POST', parameters);
        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.saved') : 'Saved') + ` for ${dateStr}`);

        // Reload calendar to show saved dates
        if (typeof loadSavedDates === 'function') {
            loadSavedDates();
        }
        if (typeof renderCalendar === 'function') {
            renderCalendar();
        }
    } catch (error) {
        alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
    }
}

     async function loadParameters() {
    const dateStr = selectedDate.toISOString().split('T')[0];

    // Helper to set radio button selection
    function setRadioValue(name, value) {
        if (value) {
            const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
            }
        }
    }

    try {
        const response = await apiCall(`/parameters/load/${dateStr}`);

        if (response && response.success) {
            const data = response.data;

            // Set radio button selections
            setRadioValue('mood', data.mood);
            setRadioValue('sleep', data.sleep_hours);
            setRadioValue('exercise', data.exercise);
            setRadioValue('stress', data.stress || data.anxiety); // Handle old 'anxiety' field
            setRadioValue('social', data.social || data.energy); // Handle old 'energy' field

            // Set notes if textarea exists
            if (document.getElementById('notesInput') && data.notes) {
                document.getElementById('notesInput').value = data.notes;
            }

            // Update sleep display if it exists
            if (document.getElementById('sleepDisplay') && data.sleep_hours) {
                const hours = data.sleep_hours || 0;
                const hoursText = window.i18n && window.i18n.t ?
                    window.i18n.t('parameters.sleep_hours') : 'Hours';
                document.getElementById('sleepDisplay').innerHTML =
                    `<span>${hours}</span> <span data-i18n="parameters.sleep_hours">${hoursText}</span>`;
            }

            console.log('Parameters loaded from', dateStr);
        } else {
            alert((window.i18n && window.i18n.t ?
                window.i18n.t('parameters.no_data') : 'No data') + ' for this date');
        }
    } catch (error) {
        alert((window.i18n && window.i18n.t ?
            window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
    }
}


// Fix parameter persistence when switching dates
async function loadParametersForDate(dateStr) {
    // Clear all previous selections first
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
    });

    // Clear notes
    const notesInput = document.getElementById('notesInput');
    if (notesInput) {
        notesInput.value = '';
    }

    try {
        const response = await apiCall(`/parameters/load/${dateStr}`);

        if (response && response.success && response.data) {
            const data = response.data;

            // Set radio button selections using proper value matching
            if (data.mood) {
                const moodRadio = document.querySelector(`input[name="mood"][value="${data.mood}"]`);
                if (moodRadio) moodRadio.checked = true;
            }

            if (data.sleep_hours) {
                const sleepRadio = document.querySelector(`input[name="sleep"][value="${data.sleep_hours}"]`);
                if (sleepRadio) sleepRadio.checked = true;
            }

            if (data.exercise) {
                const exerciseRadio = document.querySelector(`input[name="exercise"][value="${data.exercise}"]`);
                if (exerciseRadio) exerciseRadio.checked = true;
            }

            if (data.stress || data.anxiety) {
                const stressRadio = document.querySelector(`input[name="stress"][value="${data.stress || data.anxiety}"]`);
                if (stressRadio) stressRadio.checked = true;
            }

            if (data.social || data.energy) {
                const socialRadio = document.querySelector(`input[name="social"][value="${data.social || data.energy}"]`);
                if (socialRadio) socialRadio.checked = true;
            }

            // Set notes
            if (notesInput && data.notes) {
                notesInput.value = data.notes;
            }
        }
    } catch (error) {
        console.error('Error loading parameters:', error);
    }
}


// CRITICAL: Reset to own account when loading Following view
viewingUserId = null;
window.viewingUserId = null;

// Following/Followers Functions
  // Following/Followers Functions
async function loadFollowing() {
    try {
        // PJ708: Remove action buttons from viewing another user
        if (typeof clearViewActionButtons === 'function') {
            clearViewActionButtons('followingView');
        }
        
        // Ensure we're loading current user's following (not viewing another user)
        const header = document.querySelector('#followingView h2');
        if (header) {
            header.textContent = 'Following';
        }

        // Remove any existing back buttons (we're in our own following view now)
       // CRITICAL: Ensure we're back to viewing own account
        viewingUserId = null;
        window.viewingUserId = null;
        console.log('[DEBUG] loadFollowing - reset viewingUserId to null');

        // Remove any existing back buttons (we're in our own following view now)
        const existingBackBtn = document.querySelector('#followingView .back-to-following-btn');
        if (existingBackBtn) {
            existingBackBtn.remove();
        }

        // Load people user is following
        const followingResponse = await fetch('/api/following', {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!followingResponse.ok) throw new Error('Failed to load following');
        const followingData = await followingResponse.json();

        // Load recommended users
        const recommendedResponse = await fetch('/api/recommendations', {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!recommendedResponse.ok) throw new Error('Failed to load recommended');
        const recommendedData = await recommendedResponse.json();

        // Display following - PJN452: People You Follow - NO block button, only Unfollow + Following Back label
        const followingContainer = document.querySelector('#followingList');
        if (followingContainer) {
            if (followingData.following && followingData.following.length > 0) {
                followingContainer.innerHTML = followingData.following.map(user => `
                    <div class="user-card" data-user-id="${user.id}">
                        <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}; cursor: pointer;">
                            ${escapeHtml(user.username.charAt(0).toUpperCase())}
                        </div>
                        <div class="user-info" style="cursor: pointer;">
                            <div class="user-name">${escapeHtml(user.username)}</div>
                            <div class="user-location">${escapeHtml(user.selected_city || user.city || 'Unknown')}</div>
                        </div>
                        <div class="follow-actions-container" style="display: flex; gap: 0.5rem; align-items: center; flex-direction: column;">
                            <button class="btn-secondary unfollow-btn" data-user-id="${user.id}" data-i18n="following.unfollow">
                                ${pt('following.unfollow') || 'Unfollow'}
                            </button>
                            ${user.is_following_back ? `<span style="color: var(--success); font-size: 0.75rem; padding: 2px 6px; background: #d1fae5; border-radius: 4px;" data-i18n="following.following_back">${pt('following.following_back') || 'Following back'}</span>` : ''}
                        </div>
                    </div>
                `).join('');

                // PJN452: Add click handlers to view profiles - click on avatar or info
                followingContainer.querySelectorAll('.user-card').forEach(card => {
                    const avatar = card.querySelector('.user-avatar');
                    const info = card.querySelector('.user-info');
                    
                    const clickHandler = (e) => {
                        e.stopPropagation();
                        const userId = parseInt(card.dataset.userId);
                        console.log('[DEBUG] User card clicked, setting viewingUserId to:', userId);
                        viewUserProfile(userId);
                    };
                    
                    if (avatar) avatar.addEventListener('click', clickHandler);
                    if (info) info.addEventListener('click', clickHandler);
                });

                // Add unfollow handlers
                followingContainer.querySelectorAll('.unfollow-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const userId = btn.dataset.userId;
                        await unfollowUser(parseInt(userId));
                        loadFollowing();
                    });
                });
            } else {
                followingContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">You are not following anyone yet. Check out recommended users below!</p>';
            }
        }

        // Display recommended - PJN452: Block button next to Follow button (Block on left)
        // PJ501: Fixed block button translation
        // PJ601: Fixed block/unblock toggle for recommended users
        const recommendedContainer = document.querySelector('#followingRecommendationsList');
        if (recommendedContainer) {
            const recommendations = recommendedData.recommendations || [];
            
            // PJ601: Fetch blocked users list for toggle functionality
            let blockedUserIds = new Set();
            try {
                const blockedResponse = await fetch('/api/blocked-users', { credentials: 'include' });
                if (blockedResponse.ok) {
                    const blockedData = await blockedResponse.json();
                    if (blockedData.blocked_users) {
                        blockedUserIds = new Set(blockedData.blocked_users.map(u => u.id));
                    }
                }
            } catch (e) {
                console.error('Error fetching blocked users:', e);
            }
            
            // PJ501: Get translated texts
            const lang = localStorage.getItem('selectedLanguage') || 'en';

            if (recommendations && recommendations.length > 0) {
                recommendedContainer.innerHTML = recommendations.map(user => {
                    // PJ601: Check if user is blocked and set button accordingly
                    const isBlocked = blockedUserIds.has(user.id);
                    const buttonText = isBlocked ? (pt('block.unblock_user') || 'Unblock') : (pt('block.block_user') || 'Block');
                    const buttonStyle = isBlocked 
                        ? 'background: #6c757d; color: white;'  // Gray for unblock
                        : 'background: #ef4444; color: white;'; // Red for block
                    const dataI18n = isBlocked ? 'block.unblock_user' : 'block.block_user';
                    
                    return `
                    <div class="user-card" data-user-id="${user.id}">
                        <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}; cursor: pointer;" onclick="viewRecommendedUserProfile(${user.id})">
                            ${escapeHtml(user.username.charAt(0).toUpperCase())}
                        </div>
                        <div class="user-info" style="cursor: pointer;" onclick="viewRecommendedUserProfile(${user.id})">
                            <div class="user-name">${escapeHtml(user.username)}</div>
                            ${user.reason ? `<div class="user-reason" style="font-size: 0.75rem; color: var(--gray);">${escapeHtml(user.reason)}</div>` : ''}
                            <div class="user-location" style="font-size: 0.75rem;">üìç ${escapeHtml(user.selected_city || user.city || 'Unknown')}</div>
                        </div>
                        <div class="follow-actions-container" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                            <button class="btn-primary follow-btn" data-user-id="${user.id}" style="font-size: 0.8rem; padding: 6px 12px; width: auto;" data-i18n="following.follow">
                                ${pt('following.follow') || 'Follow'}
                            </button>
                            <button class="btn-secondary follow-note-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}" style="font-size: 0.75rem; padding: 4px 8px; white-space: nowrap;" data-i18n="following.with_note">
                                ${window.i18n && window.i18n.t ? window.i18n.t('following.with_note') : '+ Note'}
                            </button>
                            <button class="block-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}" 
                                data-is-blocked="${isBlocked}"
                                style="padding: 6px 10px; ${buttonStyle} border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"
                                data-i18n="${dataI18n}">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `}).join('');

                // Add follow handlers
                recommendedContainer.querySelectorAll('.follow-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const userId = btn.dataset.userId;
                        await followUser(parseInt(userId));
                        loadFollowing();
                    });
                });

                // Add follow with note handlers
                recommendedContainer.querySelectorAll('.follow-note-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const userId = btn.dataset.userId;
                        const username = btn.dataset.username;
                        await followUserWithNote(parseInt(userId), username);
                    });
                });
                
                // PJ601: Add block/unblock toggle handlers for recommended users
                recommendedContainer.querySelectorAll('.block-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const userId = parseInt(btn.dataset.userId);
                        const username = btn.dataset.username;
                        const isBlocked = btn.dataset.isBlocked === 'true';
                        
                        if (isBlocked) {
                            // Unblock user
                            const success = await unblockUser(userId);
                            if (success) {
                                loadFollowing();
                            }
                        } else {
                            // Block user
                            await blockUser(userId, username);
                            loadFollowing();
                        }
                    });
                });
            } else {
                recommendedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No recommendations available. Try updating your city in your profile!</p>';
            }
        }



    } catch (error) {
        console.error('Error loading following:', error);
        showNotification('Failed to load following', 'error');
    }
}



async function loadUserFollowing(userId) {
    try {
        // Get the user's profile first for the username
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (!profileResponse.ok) {
            throw new Error('Failed to load user profile');
        }
        const userProfile = await profileResponse.json();

        // Update header
        const followingHeader = document.querySelector('#followingView h2');
        if (followingHeader) {
            followingHeader.textContent = `${userProfile.username}'s Following`;
        }

        // For now, show a message that this feature requires backend support
        const container = document.getElementById('followingList') || document.querySelector('#followingView .following-list');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <p style="margin-bottom: 1rem;">Following list for other users is currently view-only.</p>
                    <p style="font-size: 0.875rem;">This user's following list is private.</p>
                </div>
            `;
        }

        // Add back button
        addBackToFollowingButton('followingView');

    } catch (error) {
        console.error('Error loading user following:', error);
        showNotification('Failed to load user following', 'error');
    }
}

// CRITICAL: Reset to own account when loading Following view
viewingUserId = null;
window.viewingUserId = null;


 async function loadFollowers() {
    try {
        // PJ708: Remove action buttons from viewing another user
        if (typeof clearViewActionButtons === 'function') {
            clearViewActionButtons('followersView');
        }
        
        // Ensure we're loading current user's followers (not viewing another user)
        const header = document.querySelector('#followersView h2');
        if (header) {
            header.textContent = pt('followers.title') || 'Followers';
        }

        // Remove any existing back buttons (we're in our own followers view now)
        const existingBackBtn = document.querySelector('#followersView .back-to-following-btn');
        if (existingBackBtn) {
            existingBackBtn.remove();
        }

        // Fetch followers and blocked users in parallel
        const [followersResponse, blockedResponse] = await Promise.all([
            fetch('/api/followers', {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            }),
            fetch('/api/blocked-users', {
                credentials: 'include'
            })
        ]);

        if (!followersResponse.ok) throw new Error('Failed to load followers');
        const data = await followersResponse.json();
        
        // Get list of blocked user IDs
        let blockedUserIds = new Set();
        if (blockedResponse.ok) {
            const blockedData = await blockedResponse.json();
            if (blockedData.blocked_users) {
                blockedUserIds = new Set(blockedData.blocked_users.map(u => u.id));
            }
        }

        const followersContainer = document.querySelector('#followersList');
        if (followersContainer) {
            if (data.followers && data.followers.length > 0) {
                followersContainer.innerHTML = data.followers.map(user => {
                    const isBlocked = blockedUserIds.has(user.id);
                    const buttonText = isBlocked ? (pt('block.unblock_user') || 'Unblock') : (pt('block.block_user') || 'Block');
                    const buttonAction = isBlocked ? 'unblockUserAndRefresh' : 'blockUser';
                    const buttonStyle = isBlocked 
                        ? 'background: #6c757d; color: white;'  // Gray for unblock
                        : 'background: #dc3545; color: white;'; // Red for block
                    const dataI18n = isBlocked ? 'block.unblock_user' : 'block.block_user';
                    
                    return `
                    <div class="user-card" data-user-id="${user.id}" style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="viewUserProfileFromFollowers(${user.id})">
                            <div class="user-avatar" style="background: ${user.avatar_color || '#6B46C1'}">
                                ${escapeHtml(user.username.charAt(0).toUpperCase())}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${escapeHtml(user.username)}</div>
                                <div class="user-location">${escapeHtml(user.selected_city || user.city || 'Unknown')}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${user.is_following_back ? `<span style="color: var(--success); font-size: 0.875rem;" data-i18n="following.following_back">${pt('following.following_back') || 'Following back'}</span>` : ''}
                            <button onclick="${buttonAction}(${user.id}, '${escapeHtml(user.username).replace(/'/g, "\\'")}')" 
                                    class="block-btn" 
                                    style="${buttonStyle} border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;"
                                    data-i18n="${dataI18n}">${buttonText}</button>
                        </div>
                    </div>
                `}).join('');

            } else {
                followersContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;" data-i18n="followers.no_followers">No one is following you yet.</p>';
            }
        }
    } catch (error) {
        console.error('Error loading followers:', error);
        showNotification('Failed to load followers', 'error');
    }
}



async function loadUserFollowers(userId) {
    try {
        // Get the user's profile first for the username
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (!profileResponse.ok) {
            throw new Error('Failed to load user profile');
        }
        const userProfile = await profileResponse.json();

        // Update header
        const followersHeader = document.querySelector('#followersView h2');
        if (followersHeader) {
            followersHeader.textContent = `${userProfile.username}'s Followers`;
        }

        // For now, show a message that this feature requires backend support
        const container = document.getElementById('followersList') || document.querySelector('#followersView .followers-list');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <p style="margin-bottom: 1rem;">Followers list for other users is currently view-only.</p>
                    <p style="font-size: 0.875rem;">This user's followers list is private.</p>
                </div>
            `;
        }

        // Add back button
        addBackToFollowingButton('followersView');

    } catch (error) {
        console.error('Error loading user followers:', error);
        showNotification('Failed to load user followers', 'error');
    }
}






async function followUser(userId, note = '', trigger = false) {
    try {
        // Always send a JSON body
        const body = {};
        if (note) body.note = note;
        if (trigger) body.trigger = trigger;

        const response = await fetch(`/api/follow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body),  // Always send JSON body
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to follow user');
        showNotification('Successfully followed user', 'success');

        // Refresh following list if visible
        if (typeof loadFollowing === 'function') {
            await loadFollowing();
        }

        return true;
    } catch (error) {
        console.error('Error following user:', error);
        showNotification('Failed to follow user', 'error');
        return false;
    }
}


// ========== BLOCK USER FUNCTIONS - START ==========

async function blockUser(userId, username) {
    const lang = localStorage.getItem('preferredLanguage') || 'en';
    const confirmMessages = {
        'en': `Are you sure you want to block ${username}? They will no longer be able to see your profile.`,
        'he': `◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊ó◊°◊ï◊ù ◊ê◊™ ${username}? ◊î◊ù ◊ú◊ê ◊ô◊ï◊õ◊ú◊ï ◊ô◊ï◊™◊® ◊ú◊®◊ê◊ï◊™ ◊ê◊™ ◊î◊§◊®◊ï◊§◊ô◊ú ◊©◊ú◊ö.`,
        'ar': `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∏ÿ± ${username}ÿü ŸÑŸÜ Ÿäÿ™ŸÖŸÉŸÜŸàÿß ŸÖŸÜ ÿ±ÿ§Ÿäÿ© ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä ÿ®ÿπÿØ ÿßŸÑÿ¢ŸÜ.`,
        'ru': `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${username}? –û–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å.`
    };
    
    if (!confirm(confirmMessages[lang] || confirmMessages['en'])) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${userId}/block`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to block user');
        }
        
        const successMessages = {
            'en': 'User blocked successfully',
            'he': '◊î◊û◊©◊™◊û◊© ◊†◊ó◊°◊ù ◊ë◊î◊¶◊ú◊ó◊î',
            'ar': 'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠',
            'ru': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
        };
        showNotification(successMessages[lang] || successMessages['en'], 'success');
        
        // Refresh followers list
        if (typeof loadFollowers === 'function') {
            await loadFollowers();
        }
    } catch (error) {
        console.error('Error blocking user:', error);
        showNotification(error.message || 'Failed to block user', 'error');
    }
}

async function unblockUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/unblock`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to unblock user');
        }
        
        const lang = localStorage.getItem('preferredLanguage') || 'en';
        const successMessages = {
            'en': 'User unblocked successfully',
            'he': '◊î◊ó◊°◊ô◊û◊î ◊î◊ï◊°◊®◊î ◊ë◊î◊¶◊ú◊ó◊î',
            'ar': 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠',
            'ru': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
        };
        showNotification(successMessages[lang] || successMessages['en'], 'success');
        
        return true;
    } catch (error) {
        console.error('Error unblocking user:', error);
        showNotification(error.message || 'Failed to unblock user', 'error');
        return false;
    }
}

// Unblock user and refresh followers list (for use in followers list buttons)
async function unblockUserAndRefresh(userId, username) {
    const success = await unblockUser(userId);
    if (success && typeof loadFollowers === 'function') {
        await loadFollowers();
    }
}

// Make unblockUserAndRefresh globally available
window.unblockUserAndRefresh = unblockUserAndRefresh;

async function checkIfBlockedByUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/check-blocked`, {
            credentials: 'include'
        });
        
        if (!response.ok) return { blocked: false, blockedBy: false };
        
        return await response.json();
    } catch (error) {
        console.error('Error checking block status:', error);
        return { blocked: false, blockedBy: false };
    }
}

function showBlockedMessage() {
    const lang = localStorage.getItem('preferredLanguage') || localStorage.getItem('selectedLanguage') || 'en';
    // PJ501: Changed message to "Account Not Available"
    const messages = {
        'en': { title: 'Account Not Available', button: 'Back to Following' },
        'he': { title: '◊ó◊©◊ë◊ï◊ü ◊ú◊ê ◊ñ◊û◊ô◊ü', button: '◊ó◊ñ◊®◊î ◊ú◊û◊¢◊ß◊ë' },
        'ar': { title: 'ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠', button: 'ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©' },
        'ru': { title: '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', button: '–ù–∞–∑–∞–¥ –∫ –ø–æ–¥–ø–∏—Å–∫–∞–º' }
    };
    const msg = messages[lang] || messages['en'];
    
    // Create modal overlay - PJ501: White background for blocked message
    const overlay = document.createElement('div');
    overlay.id = 'blockedMessageOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    overlay.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        ">
            <h2 style="color: #333; margin-bottom: 20px; font-size: 24px;">${msg.title}</h2>
            <button onclick="closeBlockedMessage()" style="
                background: #6B46C1;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
            ">${msg.button}</button>
        </div>
    `;
    
    document.body.appendChild(overlay);
}

function closeBlockedMessage() {
    const overlay = document.getElementById('blockedMessageOverlay');
    if (overlay) {
        overlay.remove();
    }
    // Navigate back to following tab
    showSection('social');
    setTimeout(() => {
        const followingTab = document.querySelector('[onclick*="showSocialTab"][onclick*="following"]') || 
                            document.querySelector('.social-tab[data-tab="following"]');
        if (followingTab) followingTab.click();
    }, 100);
}

// ========== BLOCK USER FUNCTIONS - END ==========


// ========== TRIGGER FUNCTIONS - START ==========
// Place these AFTER followUser function, BEFORE searchUsersToFollow function

async function loadTriggers() {
    try {
        const response = await fetch('/api/triggers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load triggers');

        const data = await response.json();
        const container = document.getElementById('triggersList');

        if (!container) return; // Safety check

        if (!data.triggers || data.triggers.length === 0) {
            container.innerHTML = '<p style="color: var(--gray);">No triggers set yet</p>';
            return;
        }

        container.innerHTML = data.triggers.map(trigger => `
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${trigger.target_username}</strong>
                        <span style="color: var(--gray); margin-left: 10px;">
                            ${trigger.parameter}: ${trigger.operator} ${trigger.threshold}
                        </span>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTrigger(${trigger.id})"
                            style="padding: 5px 10px; font-size: 12px;">
                        Remove
                    </button>
                </div>
                ${trigger.days ? `<small style="color: var(--gray);">For ${trigger.days} days</small>` : ''}
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading triggers:', error);
    }
}

async function deleteTrigger(triggerId) {
    if (!confirm('Remove this trigger?')) return;

    try {
        const response = await fetch(`/api/triggers/${triggerId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to delete trigger');

        showNotification('Trigger removed', 'success');
        loadTriggers();
    } catch (error) {
        console.error('Error deleting trigger:', error);
        showNotification('Failed to remove trigger', 'error');
    }
}

function showAddTriggerModal() {
    // Create modal - ensuring it doesn't conflict with other modals
    const existingModal = document.getElementById('addTriggerModal');
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = 'addTriggerModal';
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3>Add Wellness Trigger</h3>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">User to monitor:</label>
                <select id="triggerUserId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Parameter:</label>
                <select id="triggerParameter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="mood">Mood</option>
                    <option value="sleep_quality">Sleep Quality</option>
                    <option value="physical_activity">Physical Activity</option>
                    <option value="anxiety">Anxiety</option>
                    <option value="energy">Energy</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Alert when:</label>
                <select id="triggerOperator" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="less_than">Less than</option>
                    <option value="greater_than">Greater than</option>
                    <option value="equals">Equals</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Value (1-4):</label>
                <input type="number" id="triggerThreshold" min="1" max="4" value="2"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">For how many days (optional):</label>
                <input type="number" id="triggerDays" min="1" max="30"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       placeholder="Leave blank for single occurrence">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="document.getElementById('addTriggerModal').remove()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createTrigger()">
                    Create Trigger
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Load following list for the select
    loadFollowingForTriggers();
}

async function loadFollowingForTriggers() {
    try {
        const response = await fetch('/api/following', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load following');

        const data = await response.json();
        const select = document.getElementById('triggerUserId');

        if (!select) return;

        if (data.following && data.following.length > 0) {
            select.innerHTML = '<option value="">Select a user...</option>' +
                data.following.map(user =>
                    `<option value="${user.id}">${user.username}</option>`
                ).join('');
        } else {
            select.innerHTML = '<option value="">No users followed</option>';
        }
    } catch (error) {
        console.error('Error loading following for triggers:', error);
    }
}

async function createTrigger() {
    const targetId = document.getElementById('triggerUserId').value;
    const parameter = document.getElementById('triggerParameter').value;
    const operator = document.getElementById('triggerOperator').value;
    const threshold = document.getElementById('triggerThreshold').value;
    const days = document.getElementById('triggerDays').value;

    if (!targetId) {
        alert('Please select a user');
        return;
    }

    try {
        const body = {
            target_id: parseInt(targetId),
            parameter: parameter,
            operator: operator,
            threshold: parseInt(threshold)
        };

        if (days) {
            body.days = parseInt(days);
        }

        const response = await fetch('/api/triggers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body),
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to create trigger');

        showNotification('Trigger created successfully', 'success');
        document.getElementById('addTriggerModal').remove();
        loadTriggers();
    } catch (error) {
        console.error('Error creating trigger:', error);
        showNotification('Failed to create trigger', 'error');
    }
}


// Function to show trigger modal for a specific user
async function showAddTriggerModalForUser(targetUserId, targetUsername) {
    // Create modal for this specific user
    const existingModal = document.getElementById('addTriggerModal');
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = 'addTriggerModal';
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
    `;

    modal.innerHTML = `
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3>Add Trigger for ${targetUsername}</h3>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Parameter:</label>
                <select id="triggerParameter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="mood">Mood</option>
                    <option value="sleep_quality">Sleep Quality</option>
                    <option value="physical_activity">Physical Activity</option>
                    <option value="anxiety">Anxiety</option>
                    <option value="energy">Energy</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Alert when:</label>
                <select id="triggerOperator" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="less_than">Less than</option>
                    <option value="greater_than">Greater than</option>
                    <option value="equals">Equals</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">Value (1-4):</label>
                <input type="number" id="triggerThreshold" min="1" max="4" value="2"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px;">For how many days (optional):</label>
                <input type="number" id="triggerDays" min="1" max="30"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       placeholder="Leave blank for single occurrence">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="document.getElementById('addTriggerModal').remove()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createTriggerForUser(${targetUserId}, '${targetUsername}')">
                    Create Trigger
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

async function createTriggerForUser(targetId, targetUsername) {
    const parameter = document.getElementById('triggerParameter').value;
    const operator = document.getElementById('triggerOperator').value;
    const threshold = document.getElementById('triggerThreshold').value;
    const days = document.getElementById('triggerDays').value;

    try {
        const body = {
            watched_id: parseInt(targetId),  // Changed from target_id
            parameter_name: parameter,       // Changed from parameter
            condition: operator,              // Changed from operator
            value: parseInt(threshold),      // Changed from threshold
            consecutive_days: days ? parseInt(days) : 1  // Changed from days, default to 1
        };

        const response = await fetch('/api/triggers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body),
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to create trigger');

        showNotification('Trigger created successfully', 'success');
        document.getElementById('addTriggerModal').remove();
        // Reload triggers in the modal with username
        loadTriggersForUser(targetId, targetUsername);
    } catch (error) {
        console.error('Error creating trigger:', error);
        showNotification('Failed to create trigger', 'error');
    }
}

async function loadTriggersForUser(userId, username) {
    try {
        // Get all triggers where current user is watching
        const response = await fetch('/api/triggers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load triggers');

        const data = await response.json();
        const container = document.getElementById('modalTriggersList');

        if (!container) return;

        // Filter triggers for this specific user by username
        const userTriggers = data.triggers ? data.triggers.filter(t => {
            return t.watched_user === username;
        }) : [];

        if (userTriggers.length === 0) {
            const noTriggersText = window.i18n ? window.i18n.t('trigger_no_triggers') : 'No triggers set for this user';
            container.innerHTML = `<p style="color: #666; font-size: 0.9rem;">${noTriggersText}</p>`;
            return;
        }

        // Helper function to translate trigger text
        function translateTrigger(trigger) {
            // Translate parameter name
            const paramKey = `trigger_parameter_${trigger.parameter || trigger.parameter_name}`;
            const paramText = window.i18n ? window.i18n.t(paramKey) : (trigger.parameter || trigger.parameter_name);

            // Translate condition
            const conditionKey = `trigger_condition_${trigger.condition}`;
            const conditionText = window.i18n ? window.i18n.t(conditionKey) : trigger.condition;

            // Translate days
            const daysKey = 'trigger_days_format';
            const daysText = trigger.consecutive_days ?
                (window.i18n ? window.i18n.t(daysKey).replace('{count}', trigger.consecutive_days) : `${trigger.consecutive_days} days`)
                : '';

            return `${paramText}: ${conditionText} ${trigger.value}${daysText ? ` (${daysText})` : ''}`;
        }

        const removeText = window.i18n ? window.i18n.t('trigger_remove') : 'Remove';

        container.innerHTML = userTriggers.map(trigger => `
            <div style="padding: 10px; background: white; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span>
                    ${translateTrigger(trigger)}
                </span>
                <button class="btn btn-danger" onclick="deleteTrigger(${trigger.id}); setTimeout(() => loadTriggersForUser(${userId}, '${username}'), 500);"
                        style="padding: 4px 8px; font-size: 0.8rem;">
                    ${removeText}
                </button>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading triggers:', error);
    }
}

// ========== TRIGGER FUNCTIONS - END ==========





async function followUserWithNote(userId, username) {
    // Ensure username is safe
    username = username || 'User';

    // Create modal for follow options
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.style.cssText = `
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    `;

    modalContent.innerHTML = `
        <h3 style="margin-top: 0;">Follow ${username}</h3>
        <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">Add a note (optional):</label>
            <textarea id="followNote" style="
                width: 100%;
                min-height: 80px;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 4px;
                resize: vertical;
            " placeholder="Say something nice..."></textarea>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button class="btn-secondary" id="cancelFollowBtn">Cancel</button>
            <button class="btn-primary" id="confirmFollowBtn">Follow</button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Add event listeners using addEventListener instead of onclick
    document.getElementById('cancelFollowBtn').addEventListener('click', () => {
        modal.remove();
    });

    document.getElementById('confirmFollowBtn').addEventListener('click', async () => {
        const note = document.getElementById('followNote')?.value || '';
        const success = await followUser(userId, note, false);
        if (success) {
            modal.remove();
        }
    });

    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

async function confirmFollowUser(userId, username) {
    const note = document.getElementById('followNote')?.value || '';
    const modal = document.querySelector('.modal-overlay');

    const success = await followUser(userId, note, false);
    if (success && modal) {
        modal.remove();
    }
}





async function searchUsersToFollow() {
    const searchInput = document.getElementById('followSearchInput');
    const resultsContainer = document.getElementById('followSearchResults');
    const query = searchInput.value.trim();

    if (!query || query.length < 1) {
        resultsContainer.style.display = 'none';
        return;
    }

    try {
        const response = await fetch('/api/users/search?q=' + encodeURIComponent(query), {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Search failed');
        }

        const data = await response.json();
        const users = data.users || [];

        if (users.length === 0) {
            resultsContainer.innerHTML = `
                <p style="text-align: center; color: #999; padding: 1rem;">
                    No users found matching "${query}"
                </p>
            `;
            resultsContainer.style.display = 'block';
            return;
        }

        // Display search results
        resultsContainer.innerHTML = users.map(user => `
            <div class="user-search-result" style="
                display: flex;
                align-items: center;
                padding: 0.75rem;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: background 0.2s;
            " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                <div style="
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: ${user.avatar_url || '#6B46C1'};
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-right: 1rem;
                ">
                    ${user.username.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 500;">${user.username}</div>
                    ${user.bio ? `<div style="font-size: 0.875rem; color: #666;">${user.bio.slice(0, 50)}...</div>` : ''}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-secondary btn-sm" onclick="event.stopPropagation(); followUser(${user.id}); this.disabled=true; this.textContent='Following'">
                        Follow
                    </button>
                   <button class="btn-primary btn-sm" onclick="event.stopPropagation(); followUserWithNote(${user.id}, '${user.username}')" data-i18n="following.with_note">
                                ${window.i18n && window.i18n.translate ? window.i18n.translate('following.with_note') : '+ Note'}
                    </button>
                </div>
            </div>
        `).join('');

        resultsContainer.style.display = 'block';

    } catch (error) {
        console.error('Search error:', error);
        resultsContainer.innerHTML = `
            <p style="text-align: center; color: #e74c3c; padding: 1rem;">
                Search failed. Please try again.
            </p>
        `;
        resultsContainer.style.display = 'block';
    }
}

// Clear search results when clicking outside
document.addEventListener('click', (e) => {
    const searchContainer = document.getElementById('followSearchResults');
    const searchInput = document.getElementById('followSearchInput');
    if (searchContainer && !searchContainer.contains(e.target) && e.target !== searchInput) {
        searchContainer.style.display = 'none';
    }
});



async function unfollowUser(userId) {
    try {
        const response = await fetch(`/api/unfollow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to unfollow user');
        showNotification('Successfully unfollowed user', 'success');
    } catch (error) {
        console.error('Error unfollowing user:', error);
        showNotification('Failed to unfollow user', 'error');
    }
}

async function viewUserProfile(userId, allowPreview = false) {
    try {
        // Check if blocked by this user first
        const blockStatus = await checkIfBlockedByUser(userId);
        if (blockStatus.blockedBy || blockStatus.is_blocked) {
            showBlockedMessage();
            return;
        }
        
        viewingUserId = userId;
        window.viewingUserId = userId;
        
        // PJ501: Store if this is a preview (for recommended users)
        window.isProfilePreview = allowPreview;

        // Get current user ID from session or local storage
      const sessionResponse = await fetch('/api/profile', {credentials: 'include'});
        if (sessionResponse.ok) {
            const sessionData = await sessionResponse.json();
            console.log('[DEBUG] viewUserProfile - currentUserId:', currentUserId, 'session user:', sessionData.id);
            // DON'T overwrite currentUserId - it's already set at page load
            // currentUserId = sessionData.id || sessionData.user_id;
        }

        // Show profile view first
       // Show profile view first
showView('profile');

// Hide messages tab when viewing another user
updateMessagesNavVisibility();

    } catch (error) {
        console.error('Error viewing user profile:', error);
        showNotification('Failed to load user profile', 'error');
    }
}

// PJ501: New function to view recommended user profiles (non-followed users)
async function viewRecommendedUserProfile(userId) {
    try {
        // Check if blocked by this user first
        const blockStatus = await checkIfBlockedByUser(userId);
        if (blockStatus.blockedBy || blockStatus.is_blocked) {
            showBlockedMessage();
            return;
        }
        
        // Set the preview flag and call viewUserProfile with preview mode
        viewUserProfile(userId, true);
    } catch (error) {
        console.error('Error viewing recommended user profile:', error);
        showNotification('Failed to load user profile', 'error');
    }
}

// Make viewRecommendedUserProfile globally available
window.viewRecommendedUserProfile = viewRecommendedUserProfile;

// PJ703: New function to view user profiles from Followers tab (works exactly like Following tab)
async function viewUserProfileFromFollowers(userId) {
    try {
        // Check if blocked by this user first
        const blockStatus = await checkIfBlockedByUser(userId);
        if (blockStatus.blockedBy || blockStatus.is_blocked) {
            showBlockedMessage();
            return;
        }
        
        // Use preview mode to allow viewing profiles of users you don't follow
        viewUserProfile(userId, true);
    } catch (error) {
        console.error('Error viewing user profile from followers:', error);
        showNotification('Failed to load user profile', 'error');
    }
}

// Make viewUserProfileFromFollowers globally available
window.viewUserProfileFromFollowers = viewUserProfileFromFollowers;

// Function to view another user's parameters
async function viewUserParameters(userId, username) {
    console.log('[DEBUG] viewUserParameters called with userId:', userId, 'username:', username);

    // Prevent duplicate calls - stop double modal issue
    if (window._loadingParametersFor === userId) {
        console.log('[DEBUG] Already loading parameters for user', userId, '- ignoring duplicate call');
        return;
    }
    window._loadingParametersFor = userId;

    console.log('[DEBUG] Showing loading modal');
    // Show loading modal immediately
    showLoadingModal();

    try {
        console.log(`[DEBUG] Loading parameters for user ${userId} (${username})`);

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);

        const start = startDate.toISOString().split('T')[0];
        const end = endDate.toISOString().split('T')[0];

        console.log('[DEBUG] Fetching parameters from API:', start, 'to', end);
        const response = await fetch(`/api/users/${userId}/parameters?start_date=${start}&end_date=${end}`);
        console.log('[DEBUG] API response status:', response.status);

        if (response.status === 401) {
            console.log('[DEBUG] Unauthorized - redirecting to login');
            closeLoadingModal();
            window.location.href = '/';
            return;
        }

        if (response.status === 403) {
            console.log('[DEBUG] Forbidden - must follow user');
            closeLoadingModal();
            showNotification('You must follow this user to view their parameters', 'error');
            return;
        }

        if (!response.ok) {
            console.log('[DEBUG] Response not OK:', response.status);
            closeLoadingModal();
            throw new Error(`Failed to load parameters: ${response.status}`);
        }

        const parameters = await response.json();
        console.log('[DEBUG] Parameters received:', parameters.length, 'entries');
        console.log('[DEBUG] Parameters data:', parameters);

        // Close loading modal before showing parameters
        console.log('[DEBUG] Closing loading modal');
        closeLoadingModal();

        // Show parameters modal
        console.log('[DEBUG] Calling showUserParametersModal');
        showUserParametersModal(userId, username, parameters, start, end);
        console.log('[DEBUG] showUserParametersModal completed');

    } catch (error) {
        console.error('[DEBUG] Error loading user parameters:', error);
        closeLoadingModal();
        showNotification('Failed to load user parameters', 'error');
    } finally {
        // Always clear the flag when done (even if error occurred)
        console.log('[DEBUG] Clearing loading flag');
        window._loadingParametersFor = null;
    }
}

function showUserParametersModal(userId, username, parameters, startDate, endDate) {
    console.log('[DEBUG] showUserParametersModal called');
    console.log('[DEBUG] Parameters:', parameters.length, 'entries');

    // Remove any existing modal first
    const existing = document.getElementById('userParametersModal');
    if (existing) {
        console.log('[DEBUG] Removing existing modal');
        existing.remove();
    }

   // Format the date range display
  // Format the date range display with current language
    const formatDate = (dateStr) => {
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        // Use current language from i18n if available
        const locale = window.i18n && window.i18n.currentLanguage ?
                      (window.i18n.currentLanguage === 'he' ? 'he-IL' :
                       window.i18n.currentLanguage === 'ar' ? 'ar-SA' :
                       window.i18n.currentLanguage === 'ru' ? 'ru-RU' : 'en-US') : 'en-US';
        return date.toLocaleDateString(locale, { month: 'short', day: 'numeric', year: 'numeric' });
    };

    // Build the parameters display for ALL entries
    let parametersHtml = '';

    if (!parameters || parameters.length === 0) {
        parametersHtml = '<p style="text-align: center; color: #666;">No data available for this period</p>';
    } else {
        // Group parameters by date and display each one
        parametersHtml = '<div class="parameters-timeline">';

        parameters.forEach(param => {
            // Parse date string as local date to avoid timezone issues
            const [year, month, day] = param.date.split('-').map(Number);
            const date = new Date(year, month - 1, day);
         // Use current language from i18n if available
            const locale = window.i18n && window.i18n.currentLanguage ?
                          (window.i18n.currentLanguage === 'he' ? 'he-IL' :
                           window.i18n.currentLanguage === 'ar' ? 'ar-SA' :
                           window.i18n.currentLanguage === 'ru' ? 'ru-RU' : 'en-US') : 'en-US';
            const dateStr = date.toLocaleDateString(locale, {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            parametersHtml += `
                <div class="parameter-day" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: #333;">${dateStr}</h4>
                    <div class="parameter-values" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            `;

            // Display each parameter with privacy handling
            const paramLabels = {
                    mood: `üòä ${window.i18n ? window.i18n.translate('parameters.mood') : 'Mood'}`,
                energy: `‚ö° ${window.i18n ? window.i18n.translate('parameters.energy') : 'Energy'}`,
                sleep_quality: `üò¥ ${window.i18n ? window.i18n.translate('parameters.sleep_quality') : 'Sleep Quality'}`,
                physical_activity: `üèÉ ${window.i18n ? window.i18n.translate('parameters.physical_activity') : 'Physical Activity'}`,
                anxiety: `üò∞ ${window.i18n ? window.i18n.translate('parameters.anxiety') : 'Anxiety'}`
            };

            for (const [key, label] of Object.entries(paramLabels)) {
                if (param[key] !== null && param[key] !== undefined) {
                    parametersHtml += `
                        <div class="param-item" style="padding: 8px; background: white; border-radius: 5px;">
                            <span style="font-size: 0.9em; color: #666;">${label}:</span>
                            <strong style="margin-left: 5px; color: #333;">${param[key]}/4</strong>
                        </div>
                    `;
                } else {
                    parametersHtml += `
                        <div class="param-item" style="padding: 8px; background: white; border-radius: 5px; opacity: 0.5;">
                            <span style="font-size: 0.9em; color: #999;">${label}:</span>
                            <span style="margin-left: 5px; color: #999;">Private</span>
                        </div>
                    `;
                }
            }

            // Add notes if available
            if (param.notes) {
                parametersHtml += `
                    <div style="grid-column: 1 / -1; margin-top: 10px; padding: 8px; background: white; border-radius: 5px;">
                        <span style="font-size: 0.9em; color: #666;">üìù Notes:</span>
                        <div style="margin-top: 5px; color: #333;">${escapeHtml(param.notes)}</div>
                    </div>
                `;
            }

            parametersHtml += '</div></div>';
        });

        parametersHtml += '</div>';
    }

 // Get translations
    const parametersText = window.i18n ? window.i18n.translate('parameters.title') : 'Parameters';
    const showingDataText = window.i18n ? window.i18n.translate('parameters.showing_data') : 'Showing data from';
    const toText = window.i18n ? window.i18n.translate('parameters.to') : 'to';
    const entriesText = window.i18n ? window.i18n.translate('parameters.entries') : 'entries';
    const entryText = window.i18n ? window.i18n.translate('parameters.entry') : 'entry';

    const modalHtml = `
        <div id="userParametersModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>${escapeHtml(username)}'s ${parametersText}</h2>
                    <span class="close" onclick="closeUserParametersModal()">&times;</span>
                </div>
                <div class="modal-body">

                    <!-- Triggers Section (only shown if following this user) -->
                    ${userId && userId !== currentUserId ? `
            <div id="triggersSection" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1.1rem;">
                            ${window.i18n ? window.i18n.t('trigger_set_alert') : 'Set Alert Triggers'}
                        </h3>
                        <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 15px;">
                            ${window.i18n ? window.i18n.t('trigger_get_notified').replace('{username}', escapeHtml(username)) : `Get notified when ${escapeHtml(username)}'s wellness parameters are concerning`}
                        </p>
                        <div id="modalTriggersList" style="margin-bottom: 10px;">
                            <p style="color: #666;">Loading triggers...</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddTriggerModalForUser(${userId}, '${escapeHtml(username)}')" style="padding: 8px 16px; font-size: 0.9rem;">
                            ${window.i18n ? window.i18n.t('trigger_add') : 'Add Trigger'}
                        </button>
                    </div>
                    ` : ''}

                    <p style="color: #666; margin-bottom: 20px;">
                        ${showingDataText} ${formatDate(startDate)} ${toText} ${formatDate(endDate)}
                        <br><small>(${parameters.length} ${parameters.length === 1 ? entryText : entriesText})</small>
                    </p>
                    ${parametersHtml}
                </div>
            </div>
        </div>
    `;

    console.log('[DEBUG] Inserting modal HTML');
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Load triggers if viewing another user
    if (userId && userId !== currentUserId) {
        setTimeout(() => loadTriggersForUser(userId, username), 100);
    }


    const modal = document.getElementById('userParametersModal');
    console.log('[DEBUG] Modal element:', modal ? 'found' : 'NOT FOUND');

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeUserParametersModal();
        });
        console.log('[DEBUG] Modal event listener added');
    }
}

function closeUserParametersModal() {
    const modal = document.getElementById('userParametersModal');
    if (modal) modal.remove();
}


function showLoadingModal() {
    // Remove any existing loading modal
    const existing = document.getElementById('loadingParametersModal');
    if (existing) existing.remove();

    const loadingHtml = `
        <div id="loadingParametersModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div class="modal-body" style="padding: 2rem;">
                    <div class="loading-spinner" style="
                        width: 50px;
                        height: 50px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #667eea;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 1rem;
                    "></div>
                    <p style="color: #666; font-size: 16px;">Loading parameters...</p>
                </div>
            </div>
        </div>
        <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
    `;

    document.body.insertAdjacentHTML('beforeend', loadingHtml);
}

function closeLoadingModal() {
    const modal = document.getElementById('loadingParametersModal');
    if (modal) modal.remove();
}




function formatDateDisplay(dateString) {
    // Handle date string as local date, not UTC
    // If dateString is "2025-10-11", treat it as October 11 in local time
    const [year, month, day] = dateString.split('-').map(Number);
    const date = new Date(year, month - 1, day); // month is 0-indexed
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}







async function loadUserProfileView(userId) {
    // Set the viewing user ID so feed knows we're viewing another user
    viewingUserId = userId;
    
    // PJ501: Check if this is a preview request (for recommended users)
    const isPreview = window.isProfilePreview === true;

    try {
        // PJ501: Add allow_preview parameter for recommended users
        const url = isPreview 
            ? `/api/users/${userId}/profile?allow_preview=true`
            : `/api/users/${userId}/profile`;
            
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                const errorData = await response.json().catch(() => ({}));
                // PJ501: Check if blocked
                if (errorData.blocked || errorData.error === 'account_not_available') {
                    showBlockedMessage();
                    return;
                }
                showNotification('You must follow this user to view their profile', 'error');
                showView('following');
                return;
            }
            throw new Error('Failed to load profile');
        }

        const userData = await response.json();

        // Update header
        const profileHeader = document.querySelector('#profileView h2');
        if (profileHeader) {
            profileHeader.textContent = `${userData.username}'s Profile`;
        }

        // Update profile avatar and username
        const profileAvatar = document.getElementById('profileAvatar');
        const profileUsername = document.getElementById('profileUsername');
        if (profileAvatar) {
            profileAvatar.textContent = userData.username.charAt(0).toUpperCase();
        }
        if (profileUsername) {
            profileUsername.textContent = userData.username;
        }

        // Populate all profile fields with user data
        const bioElement = document.getElementById('profileBio');
        const interestsElement = document.getElementById('profileInterests');
        const occupationElement = document.getElementById('profileOccupation');
        const goalsElement = document.getElementById('profileGoals');
        const hobbiesElement = document.getElementById('profileFavoriteHobbies');

        if (bioElement) {
            bioElement.value = userData.bio || '';
            bioElement.disabled = true;
            bioElement.style.backgroundColor = '#f3f4f6';
            bioElement.style.cursor = 'default';
        }

        if (interestsElement) {
            interestsElement.value = userData.interests || '';
            interestsElement.disabled = true;
            interestsElement.style.backgroundColor = '#f3f4f6';
            interestsElement.style.cursor = 'default';
        }

        if (occupationElement) {
            occupationElement.value = userData.occupation || '';
            occupationElement.disabled = true;
            occupationElement.style.backgroundColor = '#f3f4f6';
            occupationElement.style.cursor = 'default';
        }

        if (goalsElement) {
            goalsElement.value = userData.goals || '';
            goalsElement.disabled = true;
            goalsElement.style.backgroundColor = '#f3f4f6';
            goalsElement.style.cursor = 'default';
        }

        if (hobbiesElement) {
            hobbiesElement.value = userData.favorite_hobbies || '';
            hobbiesElement.disabled = true;
            hobbiesElement.style.backgroundColor = '#f3f4f6';
            hobbiesElement.style.cursor = 'default';
        }
        
        // PJ6014: Hide birth year Update button and disable input when viewing another user
        const birthYearInput = document.getElementById('profileBirthYear');
        const birthYearUpdateBtn = document.getElementById('birthYearUpdateBtn');
        if (birthYearInput) {
            birthYearInput.value = userData.birth_year || '';
            birthYearInput.disabled = true;
            birthYearInput.style.backgroundColor = '#f3f4f6';
            birthYearInput.style.cursor = 'default';
        }
        if (birthYearUpdateBtn) {
            birthYearUpdateBtn.style.display = 'none';
        }

        // Hide the Save Profile button and any edit buttons
        const saveButton = document.getElementById('updateProfileBtn');
        if (saveButton) {
            saveButton.style.display = 'none';
        }

        document.querySelectorAll('#profileView .btn-primary, #profileView .btn-secondary').forEach(btn => {
            if (btn.textContent.includes('Edit') || btn.textContent.includes('Save') || btn.textContent.includes('Add')) {
                btn.style.display = 'none';
            }
        });

        // Add back button
        addBackToFollowingButton('profileView');
        
        // PJ401: Add action buttons (Follow, Follow with Note, Add to Circle, Block)
        // PJ501: Pass isPreview flag to show Follow buttons instead of Unfollow for recommended users
        addUserProfileActionButtons(userId, userData.username, isPreview || userData.is_preview);
        
        // PJ501: Reset the preview flag after use
        window.isProfilePreview = false;

        // Hide Change Password and Delete Account sections when viewing another user
        const changePasswordSection = document.getElementById('changePasswordSection');
        const accountDeletionSection = document.getElementById('accountDeletionSection');
        if (changePasswordSection) {
            changePasswordSection.style.display = 'none';
        }
        if (accountDeletionSection) {
            accountDeletionSection.style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading user profile:', error);
        showNotification('Failed to load user profile', 'error');
        window.isProfilePreview = false; // Reset on error too
    }
}

// PJ401: Add action buttons (Follow, Follow with Note, Add to Circle, Block) to user profile view
// PJ501: Added forceShowFollow parameter for recommended users
// PJ601: Added block/unblock toggle functionality and fixed Follow button width
async function addUserProfileActionButtons(userId, username, forceShowFollow = false) {
    addUserActionButtonsToView('profileView', userId, username, forceShowFollow);
}

// PJN451: General function to add action buttons to any view
// PJ501: Added forceShowFollow parameter for recommended users (shows Follow buttons even if following status is indeterminate)
// PJ601: Added block/unblock toggle and fixed Follow button width
// PJ703: Always check actual following status - forceShowFollow only used for backend API preview permission
async function addUserActionButtonsToView(viewId, userId, username, forceShowFollow = false) {
    const view = document.getElementById(viewId);
    if (!view) return;
    
    // Remove existing action buttons container if any
    const existingButtons = view.querySelector('.profile-action-buttons');
    if (existingButtons) existingButtons.remove();
    
    // PJ703: Always check if currently following this user (don't skip based on forceShowFollow)
    // This ensures proper Follow/Unfollow button display regardless of how we navigated to the profile
    let isFollowing = false;
    try {
        const followingResponse = await fetch('/api/following', { credentials: 'include' });
        if (followingResponse.ok) {
            const followingData = await followingResponse.json();
            isFollowing = followingData.following.some(u => u.id === userId);
        }
    } catch (e) {
        console.error('Error checking following status:', e);
    }
    
    // PJ601: Check if user is blocked for toggle functionality
    let isBlocked = false;
    try {
        const blockedResponse = await fetch('/api/blocked-users', { credentials: 'include' });
        if (blockedResponse.ok) {
            const blockedData = await blockedResponse.json();
            if (blockedData.blocked_users) {
                isBlocked = blockedData.blocked_users.some(u => u.id === userId);
            }
        }
    } catch (e) {
        console.error('Error checking blocked status:', e);
    }
    
    // Translation labels
    const lang = localStorage.getItem('preferredLanguage') || localStorage.getItem('selectedLanguage') || 'en';
    const labels = {
        'en': { 
            follow: 'Follow', 
            unfollow: 'Unfollow',
            followWithNote: 'Follow with Note', 
            addToCircle: 'Add to Circle',
            block: 'Block',
            unblock: 'Unblock'
        },
        'he': { 
            follow: '◊¢◊ß◊ï◊ë', 
            unfollow: '◊î◊§◊°◊ß ◊ú◊¢◊ß◊ï◊ë',
            followWithNote: '◊¢◊ß◊ï◊ë ◊¢◊ù ◊î◊¢◊®◊î', 
            addToCircle: '◊î◊ï◊°◊£ ◊ú◊û◊¢◊í◊ú',
            block: '◊ó◊°◊ï◊ù',
            unblock: '◊ë◊ò◊ú ◊ó◊°◊ô◊û◊î'
        },
        'ar': { 
            follow: 'ŸÖÿ™ÿßÿ®ÿπÿ©', 
            unfollow: 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©',
            followWithNote: 'ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿπ ŸÖŸÑÿßÿ≠ÿ∏ÿ©', 
            addToCircle: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿØÿßÿ¶ÿ±ÿ©',
            block: 'ÿ≠ÿ∏ÿ±',
            unblock: 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ±'
        },
        'ru': { 
            follow: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è', 
            unfollow: '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è',
            followWithNote: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è —Å –∑–∞–º–µ—Ç–∫–æ–π', 
            addToCircle: '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫—Ä—É–≥',
            block: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
            unblock: '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'
        }
    };
    const t = labels[lang] || labels['en'];
    
    // Create container for buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'profile-action-buttons';
    buttonContainer.style.cssText = `
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
    `;
    
    if (isFollowing) {
        // Unfollow button (grey/secondary)
        const unfollowBtn = document.createElement('button');
        unfollowBtn.className = 'btn-secondary';
        unfollowBtn.textContent = t.unfollow;
        unfollowBtn.style.cssText = 'padding: 0.5rem 1rem;';
        unfollowBtn.onclick = async () => {
            if (confirm(lang === 'he' ? `◊î◊ê◊ù ◊ú◊î◊§◊°◊ô◊ß ◊ú◊¢◊ß◊ï◊ë ◊ê◊ó◊®◊ô ${username}?` : 
                       lang === 'ar' ? `ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÑÿ∫ÿßÿ° ŸÖÿ™ÿßÿ®ÿπÿ© ${username}ÿü` :
                       lang === 'ru' ? `–û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç ${username}?` :
                       `Unfollow ${username}?`)) {
                try {
                    const response = await fetch(`/api/unfollow/${userId}`, { 
                        method: 'DELETE', 
                        credentials: 'include' 
                    });
                    if (response.ok) {
                        showNotification(lang === 'he' ? '◊î◊§◊°◊ß◊™ ◊ú◊¢◊ß◊ï◊ë' : 
                                        lang === 'ar' ? 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©' :
                                        lang === 'ru' ? '–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å' :
                                        'Unfollowed', 'success');
                        addUserActionButtonsToView(viewId, userId, username); // Refresh buttons
                    }
                } catch (e) {
                    console.error('Error unfollowing:', e);
                }
            }
        };
        buttonContainer.appendChild(unfollowBtn);
    } else {
        // PJ601: Block/Unblock button with toggle (placed FIRST before follow button)
        const blockBtn = document.createElement('button');
        blockBtn.textContent = isBlocked ? t.unblock : t.block;
        blockBtn.style.cssText = isBlocked 
            ? 'padding: 0.5rem 1rem; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;'
            : 'padding: 0.5rem 1rem; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;';
        blockBtn.onmouseover = () => { blockBtn.style.backgroundColor = isBlocked ? '#5a6268' : '#dc2626'; };
        blockBtn.onmouseout = () => { blockBtn.style.backgroundColor = isBlocked ? '#6c757d' : '#ef4444'; };
        blockBtn.onclick = async () => {
            if (isBlocked) {
                // Unblock user
                const success = await unblockUser(userId);
                if (success) {
                    addUserActionButtonsToView(viewId, userId, username, forceShowFollow); // Refresh buttons
                }
            } else {
                // Block user
                await blockUser(userId, username);
                addUserActionButtonsToView(viewId, userId, username, forceShowFollow); // Refresh buttons
            }
        };
        buttonContainer.appendChild(blockBtn);
        
        // PJ601: Follow button (blue/primary) - with min-width to match Follow with Note
        // PJ602: Added width:auto to override CSS width:100%
        const followBtn = document.createElement('button');
        followBtn.className = 'btn-primary';
        followBtn.textContent = t.follow;
        followBtn.style.cssText = 'padding: 0.5rem 1rem; background-color: #3b82f6; color: white; width: auto;';
        followBtn.onclick = async () => {
            const success = await followUser(userId);
            if (success) {
                addUserActionButtonsToView(viewId, userId, username); // Refresh buttons
            }
        };
        buttonContainer.appendChild(followBtn);
        
        // Follow with Note button (grey/secondary)
        const followNoteBtn = document.createElement('button');
        followNoteBtn.className = 'btn-secondary';
        followNoteBtn.textContent = t.followWithNote;
        followNoteBtn.style.cssText = 'padding: 0.5rem 1rem;';
        followNoteBtn.onclick = () => {
            followUserWithNote(userId, username);
        };
        buttonContainer.appendChild(followNoteBtn);
    }
    
    // PJ702: Check if user is already in any of my circles before showing Add to Circle button
    let isInCircles = false;
    try {
        const circlesResponse = await fetch('/api/circles', { credentials: 'include' });
        if (circlesResponse.ok) {
            const circlesData = await circlesResponse.json();
            console.log('[PJ702] My circles data for Add to Circle check:', circlesData);
            
            const publicCircle = circlesData.general || circlesData.public || [];
            const classBCircle = circlesData.close_friends || circlesData.class_b || [];
            const classACircle = circlesData.family || circlesData.class_a || [];
            
            const allCircleMembers = [...publicCircle, ...classBCircle, ...classACircle];
            isInCircles = allCircleMembers.some(m => Number(m.id) === Number(userId));
            console.log('[PJ702] User', userId, 'isInCircles:', isInCircles);
        }
    } catch (e) {
        console.error('[PJ702] Error checking circle membership:', e);
    }
    
    // PJ702: Add to Circle button (green) - only show if user is not already in any circle
    if (!isInCircles) {
        const addCircleBtn = document.createElement('button');
        addCircleBtn.textContent = t.addToCircle;
        addCircleBtn.style.cssText = 'padding: 0.5rem 1rem; background-color: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer;';
        addCircleBtn.onmouseover = () => { addCircleBtn.style.backgroundColor = '#16a34a'; };
        addCircleBtn.onmouseout = () => { addCircleBtn.style.backgroundColor = '#22c55e'; };
        addCircleBtn.onclick = () => {
            showCircleAddMenu(userId, username);
        };
        buttonContainer.appendChild(addCircleBtn);
    }
    
    // PJN451: Block button only appears when NOT following (already added at start in the else block above)
    // No block button when following - removed per requirement #3
    
    // Insert after back button
    const backButton = view.querySelector('.back-to-following-btn');
    if (backButton) {
        backButton.after(buttonContainer);
    } else {
        view.insertBefore(buttonContainer, view.firstChild);
    }
}



// Hide or show messages nav based on viewing context
function updateMessagesNavVisibility() {
    const mobileMessagesNav = document.getElementById('mobileMessagesNav');
    const desktopMessagesNav = document.getElementById('desktopMessagesNav');

    if (viewingUserId !== null && viewingUserId !== currentUserId) {
        // Viewing another user - hide messages
        if (mobileMessagesNav) mobileMessagesNav.style.display = 'none';
        if (desktopMessagesNav) desktopMessagesNav.style.display = 'none';
    } else {
        // Viewing own profile - show messages
        if (mobileMessagesNav) mobileMessagesNav.style.display = '';
        if (desktopMessagesNav) desktopMessagesNav.style.display = '';
    }
}




async function loadUserFeed(userId) {
    try {
        // Get current user ID to check if viewing own feed
        const sessionResponse = await fetch('/api/auth/session', {
            credentials: 'include'
        });
        const sessionData = await sessionResponse.json();
        const isOwnFeed = sessionData.user_id === userId;

        // Load the calendar for this user
        // Don't set window.viewingUserId here - use the global viewingUserId variable instead
        // window.viewingUserId = userId;
        // Keep viewingUserId set to the user we're viewing
       console.log('[DEBUG] loadUserFeed - maintaining viewingUserId:', userId);
        console.log('[DEBUG] loadUserFeed - currentUserId should already be set to:', currentUserId);
        console.log('[DEBUG] loadUserFeed - session user_id is:', sessionData.user_id);

        // DON'T overwrite currentUserId here - it should already be set from page load
        // window.currentUserId = sessionData.user_id;
        // currentUserId = sessionData.user_id;

        initFeedCalendar(isOwnFeed ? null : userId);

        const response = await fetch(`/api/users/${userId}/posts`, {
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            if (response.status === 403) {
                showNotification('You must follow this user to view their feed', 'error');
                // PJ601: Reset viewingUserId to prevent navigation loop bug
                viewingUserId = null;
                window.viewingUserId = null;
                showView('following');
                return;
            }
            throw new Error('Failed to load feed');
        }

        const data = await response.json();

        // Get username for header
        const profileResponse = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
        if (profileResponse.ok) {
            const user = await profileResponse.json();
            const feedHeader = document.querySelector('#feedView h2');
            if (feedHeader) feedHeader.textContent = `${user.username}'s Feed`;
        }

        // Hide post creation form when viewing others' feeds
     // Hide/modify elements when viewing others' feeds
        if (!isOwnFeed) {
            // Hide textarea
            const postInput = document.getElementById('postInput');
            if (postInput) {
                postInput.style.display = 'none';
            }

            // Hide visibility selector
            const visibilitySelect = document.getElementById('visibilitySelect');
            if (visibilitySelect) {
                visibilitySelect.style.display = 'none';
            }

            // Hide ONLY the Save Update button, keep Load Update visible
            const saveBtn = document.getElementById('postBtn');
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        }

        // Display posts
        const feedContainer = document.querySelector('#feedView .feed-posts, #feedView .posts-container, #feedView .feed-content');
        if (!feedContainer) {
            console.error('Feed container not found');
            return;
        }

        const circleNames = {
            1: 'Public',
            2: 'Close Friends',
            3: 'Family',
            'general': 'Public',
            'close_friends': 'Close Friends',
            'family': 'Family',
            'private': 'Private'
        };

        if (data.posts && data.posts.length > 0) {
            feedContainer.innerHTML = data.posts.map(post => `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${post.category || 'General'}</span>
                        <span class="post-date">${new Date(post.created_at).toLocaleDateString()}</span>
                        ${post.circle_id ? `<span class="post-visibility" style="margin-left: 0.5rem; font-size: 0.85rem; color: var(--gray);">(${circleNames[post.circle_id] || circleNames[post.circle] || 'Public'})</span>` : ''}
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.mood ? `<div class="post-mood" style="margin-top: 0.5rem; color: var(--gray);">Mood: ${post.mood}</div>` : ''}
                    <div class="post-footer" style="margin-top: 1rem; display: flex; justify-content: space-between;">
                        <div class="post-stats">
                            <button class="like-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem;">
                                <span class="like-icon">${post.user_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span class="like-count">${post.likes_count || 0}</span>
                            </button>
                            <button class="comment-btn" data-post-id="${post.id}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem 0.5rem; margin-left: 1rem;">
                                üí¨ <span class="comment-count">${post.comments_count || 0}</span>
                            </button>
                        </div>
                        <div class="comments-section" id="comments-${post.id}" style="display: none; margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <div class="comments-list" id="comments-list-${post.id}"></div>
                            <div style="margin-top: 1rem;">
                                <input type="text" id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="submitComment(${post.id})" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Post Comment</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            feedContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No posts yet.</p>';
        }

        // Add back button
        // Add back button if not already present
        const existingBackBtn = document.querySelector('#feedView .back-to-following-btn');
        if (!existingBackBtn) {
            addBackToFollowingButton('feedView');
        } else {
            // Ensure it's visible
            existingBackBtn.style.display = 'block';
            existingBackBtn.style.visibility = 'visible';
        }
        
        // PJN451: Add action buttons to feed view when viewing another user
        if (!isOwnFeed) {
            const profileResponse2 = await fetch(`/api/users/${userId}/profile`, {credentials: 'include'});
            if (profileResponse2.ok) {
                const userData = await profileResponse2.json();
                addUserActionButtonsToView('feedView', userId, userData.username);
            }
        }

    } catch (error) {
        console.error('Error loading user feed:', error);
        showNotification('Failed to load user feed', 'error');
    }
}



// Old loadUserParameters function removed - now using viewUserParameters with modal display

function addBackToFollowingButton(viewId) {
    const view = document.getElementById(viewId);
    if (!view) return;

    // Check if back button already exists
    if (view.querySelector('.back-to-following-btn')) return;

    const backButton = document.createElement('button');
    backButton.className = 'btn-secondary back-to-following-btn';
    backButton.textContent = pt('common.back_to_following') || '‚Üê Back to Following';
    backButton.setAttribute('data-i18n', 'common.back_to_following');
    backButton.style.marginBottom = '1rem';
  backButton.onclick = () => {
        console.log('[DEBUG] Back to Following clicked, resetting viewingUserId');
        // CRITICAL: Reset viewingUserId BEFORE calling showView
        viewingUserId = null;
        window.viewingUserId = null;

        // Re-enable profile fields if in profile view
        if (viewId === 'profileView') {
            const bioElement = document.getElementById('profileBio');
            const interestsElement = document.getElementById('profileInterests');
            const occupationElement = document.getElementById('profileOccupation');
            const goalsElement = document.getElementById('profileGoals');
            const hobbiesElement = document.getElementById('profileFavoriteHobbies');
            const saveButton = document.getElementById('updateProfileBtn');

            // Re-enable all fields
            [bioElement, interestsElement, occupationElement, goalsElement, hobbiesElement].forEach(el => {
                if (el) {
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                }
            });

            // Show save button
            if (saveButton) {
                saveButton.style.display = '';
            }

            // Show Change Password and Delete Account sections
            const changePasswordSection = document.getElementById('changePasswordSection');
            const accountDeletionSection = document.getElementById('accountDeletionSection');
            if (changePasswordSection) {
                changePasswordSection.style.display = '';
            }
            if (accountDeletionSection) {
                accountDeletionSection.style.display = '';
            }
        }

        // Show all edit buttons again
        document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => {
            btn.style.display = '';
        });
        // Show post forms again
        document.querySelectorAll('form, .post-form, .post-creation, .parameter-inputs').forEach(form => {
            form.style.display = '';
        });

        // Reset headers to default (will be updated by load functions)
        const profileHeader = document.querySelector('#profileView h2');
        if (profileHeader) profileHeader.textContent = 'Profile';
        const feedHeader = document.querySelector('#feedView h2');
        if (feedHeader) feedHeader.textContent = 'Feed';
        const circlesHeader = document.querySelector('#circlesView h2');
        if (circlesHeader) circlesHeader.textContent = 'Circles';
        const parametersHeader = document.querySelector('#parametersView h2, #trackingView h2');
        if (parametersHeader) parametersHeader.textContent = 'Wellness Parameters';
        const followingHeader = document.querySelector('#followingView h2');
        if (followingHeader) followingHeader.textContent = 'Following';
        const followersHeader = document.querySelector('#followersView h2');
        if (followersHeader) followersHeader.textContent = 'Followers';

        // Remove all back to following buttons from all views
        document.querySelectorAll('.back-to-following-btn').forEach(btn => btn.remove());

        // Show messages nav visibility (restore own account view)
        updateMessagesNavVisibility();

        // Navigate to following view and load current user's following list
        showView('following');

        // Force reload of current user's following data
        loadFollowing();
    };

    view.insertBefore(backButton, view.firstChild);
}




// ========== UPDATED loadAlerts() WITH CLICK-TO-DISMISS ==========
// Replace your existing loadAlerts() function with this version

async function loadAlerts() {
    try {
        console.log('üîÑ loadAlerts called');
       if (!currentUser || !currentUser.id) {
    console.log('üîÑ No user logged in, skipping alerts load');
    return;
}
        const response = await apiCall('/alerts');
        if (!response) {
            console.error('‚ùå No response from /api/alerts');
            return;
        }

        const alertsContainer = document.getElementById('alertsList');
        const notificationsContainer = document.getElementById('notificationsList');
        const mobileAlertsContainer = document.getElementById('mobileAlertsList');
        const mobileNotificationsContainer = document.getElementById('mobileNotificationsList');
        
        if (!alertsContainer) {
            console.error('‚ùå alertsList container not found');
            return;
        }

        console.log(`üì¨ Received ${response.alerts?.length || 0} items from API`);

        // PJ6003: Separate alerts (wellness/trigger) from notifications (messages, follows, invites)
        const wellnessAlerts = [];
        const notifications = [];
        
        if (response.alerts && response.alerts.length > 0) {
            response.alerts.forEach(alert => {
                // Wellness alerts have alert_category='trigger' or type='trigger'
                if (alert.alert_category === 'trigger' || alert.type === 'trigger') {
                    wellnessAlerts.push(alert);
                } else {
                    // Everything else is a notification (messages, follows, invites)
                    notifications.push(alert);
                }
            });
        }
        
        console.log(`üìä Separated: ${wellnessAlerts.length} wellness alerts, ${notifications.length} notifications`);

        // Helper function to translate and render an alert/notification item
        function renderItem(alert) {
            try {
                let title = alert.title || '';
                let content = alert.message || alert.content || '';

                // ===== HANDLE WELLNESS ALERT TITLES =====
                // PJ6003: Translate "Wellness Alert for username" pattern
                if (title.startsWith('Wellness Alert for ')) {
                    const username = title.replace('Wellness Alert for ', '');
                    const template = translateKey('alerts.wellness_alert_for') || 'Wellness Alert for {username}';
                    title = template.replace('{username}', username);
                }
                
                // ===== HANDLE WELLNESS ALERT CONTENT =====
                // PJ6003: Translate wellness alert content patterns
                // Pattern: "username's param has been at concerning levels for N consecutive days (date range)"
                const wellnessMatch = content.match(/^(.+?)'s (\w+) has been at concerning levels for (\d+) consecutive days \((.+)\)$/);
                if (wellnessMatch) {
                    const [, alertUsername, param, days, dateRange] = wellnessMatch;
                    // Translate parameter name
                    const translatedParam = translateKey(`params.${param}`) || param;
                    const template = translateKey('alerts.wellness_content') || "{username}'s {param} has been at concerning levels for {days} consecutive days ({dateRange})";
                    content = template
                        .replace('{username}', alertUsername)
                        .replace('{param}', translatedParam)
                        .replace('{days}', days)
                        .replace('{dateRange}', dateRange);
                }

                // ===== HANDLE OTHER TITLE PATTERNS =====
                try {
                    const titleData = JSON.parse(title);
                    if (titleData.key && titleData.params) {
                        const translatedBase = translateKey(titleData.key) || titleData.key;
                        // PJ6004: Replace {username} placeholder instead of concatenating
                        if (titleData.params.username) {
                            title = translatedBase.replace('{username}', titleData.params.username);
                        } else {
                            title = translatedBase;
                        }
                    }
                } catch (e) {
                    // Not JSON, handle as plain string
                    if (title.startsWith('alerts.') || title.startsWith('invite.')) {
                        const translated = translateKey(title);
                        if (!translated || translated === title) {
                            if (title === 'invite.alert_title') {
                                title = translateKey('invite.alert_title') || 'New Invitation';
                            } else {
                                title = title.replace('alerts.', '').replace('invite.', '').replace(/_/g, ' ');
                            }
                        } else {
                            title = translated;
                        }
                    }
                    else if (title.startsWith('New message from ')) {
                        const username = title.replace('New message from ', '');
                        const template = translateKey('alerts.new_message_from') || 'New message from {username}';
                        title = template.replace('{username}', username);
                    }
                    else if (title.includes('started following you')) {
                        const username = title.split(' started following you')[0];
                        const template = translateKey('alerts.started_following') || '{username} started following you';
                        title = template.replace('{username}', username);
                    }
                    else if (title.includes('accepted your follow request')) {
                        const username = title.split(' accepted your follow request')[0];
                        const template = translateKey('alerts.accepted_request') || '{username} accepted your follow request';
                        title = template.replace('{username}', username);
                    }
                    else if (title.includes('wants to follow you')) {
                        const username = title.split(' wants to follow you')[0];
                        const template = translateKey('alerts.follow_request') || '{username} wants to follow you';
                        title = template.replace('{username}', username);
                    }
                    else if (title === 'New Follow Request') {
                        title = translateKey('invite.alert_title') || 'New Invitation';
                    }
                }

                // ===== HANDLE CONTENT =====
                if (content.startsWith('alerts.')) {
                    const translated = translateKey(content);
                    if (!translated || translated === content) {
                        content = content.replace('alerts.', '').replace(/_/g, ' ');
                    } else {
                        content = translated;
                    }
                }
                else if (content === 'You have a new follower!' || content === 'You have a new follower') {
                    content = translateKey('alerts.new_follower') || 'You have a new follower!';
                }
                else if (content && typeof content === 'string' && content.includes('|')) {
                    const parts = content.split('|');
                    if (parts.length === 2) {
                        const [username, i18nKey] = parts;
                        const template = translateKey(i18nKey) || '{username} has invited you to follow them';
                        content = template.replace('{username}', username);
                    }
                }
                else if (content === 'Someone wants to follow your journey') {
                    content = translateKey('invite.legacy_alert_content') || 'Someone has invited you to follow them';
                }

                if (!title || title.trim() === '') {
                    title = translateKey('notifications.notification') || 'Notification';
                }
                if (!content || content.trim() === '') {
                    content = translateKey('notifications.new_notification') || 'You have a new notification';
                }

                return `
                    <div class="alert-item ${alert.type || 'info'}"
                         data-alert-id="${alert.id}"
                         onclick="dismissAlert(${alert.id}, this)">
                        <strong>${escapeHtml(title)}</strong><br>
                        <small>${escapeHtml(content)}</small>
                        <span class="alert-dismiss" style="position: absolute; top: 8px; right: 8px; opacity: 0.3; font-size: 1.2rem; transition: opacity 0.2s;">√ó</span>
                    </div>
                `;
            } catch (alertError) {
                console.error(`‚ùå Error rendering item:`, alertError, alert);
                return `
                    <div class="alert-item info">
                        <strong>Notification</strong><br>
                        <small>You have a new notification (display error)</small>
                    </div>
                `;
            }
        }

        // Render wellness alerts
        const noAlertsText = translateKey('alerts.no_alerts') || 'No alerts';
        const noNotificationsText = translateKey('notifications.no_notifications') || 'No notifications';
        
        if (wellnessAlerts.length === 0) {
            alertsContainer.innerHTML = `<p style="color: var(--gray);" data-i18n="alerts.no_alerts">${noAlertsText}</p>`;
            if (mobileAlertsContainer) {
                mobileAlertsContainer.innerHTML = `<p style="color: var(--gray);" data-i18n="alerts.no_alerts">${noAlertsText}</p>`;
            }
        } else {
            const alertsHTML = wellnessAlerts.map(renderItem).join('');
            alertsContainer.innerHTML = alertsHTML;
            if (mobileAlertsContainer) {
                mobileAlertsContainer.innerHTML = alertsHTML;
            }
        }
        
        // Render notifications
        if (notificationsContainer) {
            if (notifications.length === 0) {
                notificationsContainer.innerHTML = `<p style="color: var(--gray);" data-i18n="notifications.no_notifications">${noNotificationsText}</p>`;
            } else {
                const notificationsHTML = notifications.map(renderItem).join('');
                notificationsContainer.innerHTML = notificationsHTML;
            }
        }
        
        if (mobileNotificationsContainer) {
            if (notifications.length === 0) {
                mobileNotificationsContainer.innerHTML = `<p style="color: var(--gray);" data-i18n="notifications.no_notifications">${noNotificationsText}</p>`;
            } else {
                const notificationsHTML = notifications.map(renderItem).join('');
                mobileNotificationsContainer.innerHTML = notificationsHTML;
            }
        }
        
        console.log(`‚úÖ Rendered ${wellnessAlerts.length} wellness alerts and ${notifications.length} notifications`);
        
        // Update mobile alerts badge (on main nav and in More menu)
        const mobileAlertsBadge = document.getElementById('mobileAlertsBadge');
        const mobileMoreAlertsBadge = document.getElementById('mobileMoreAlertsBadge');
        const totalCount = wellnessAlerts.length + notifications.length;
        const badgeText = totalCount > 99 ? '99+' : totalCount.toString();
        
        if (mobileAlertsBadge) {
            if (totalCount > 0) {
                mobileAlertsBadge.textContent = badgeText;
                mobileAlertsBadge.style.display = 'block';
            } else {
                mobileAlertsBadge.style.display = 'none';
            }
        }
        
        // PJ5002: Also update badge in More menu
        if (mobileMoreAlertsBadge) {
            if (totalCount > 0) {
                mobileMoreAlertsBadge.textContent = badgeText;
                mobileMoreAlertsBadge.style.display = 'inline-block';
            } else {
                mobileMoreAlertsBadge.style.display = 'none';
            }
        }
        
        // Show/hide no alerts message on mobile
        const mobileNoAlertsMsg = document.getElementById('mobileNoAlertsMessage');
        if (mobileNoAlertsMsg) {
            mobileNoAlertsMsg.style.display = wellnessAlerts.length === 0 ? 'block' : 'none';
        }
        
        const mobileNoNotificationsMsg = document.getElementById('mobileNoNotificationsMessage');
        if (mobileNoNotificationsMsg) {
            mobileNoNotificationsMsg.style.display = notifications.length === 0 ? 'block' : 'none';
        }

    } catch (error) {
        console.error('‚ùå Failed to load alerts:', error);
        console.error('Error stack:', error.stack);

        const container = document.getElementById('alertsList');
        if (container) {
            container.innerHTML = '<p style="color: red;">Error loading alerts. Please refresh the page.</p>';
        }
    }
}

// ‚úÖ NEW FUNCTION: Add this right after loadAlerts()
async function dismissAlert(alertId, element) {
    try {
        // Fade out animation
        element.style.opacity = '0.5';

        // Mark as read in backend
        const response = await fetch(`/api/alerts/${alertId}/read`, {
            method: 'PUT',
            credentials: 'include'
        });

        if (response.ok) {
            // Remove from DOM with animation
            element.style.opacity = '0';
            setTimeout(() => {
                element.remove();
                
                // PJ5001: Also remove from the other list (mobile or desktop)
                const otherListSelectors = ['#alertsList', '#mobileAlertsList'];
                otherListSelectors.forEach(selector => {
                    const otherList = document.querySelector(selector);
                    if (otherList) {
                        const otherElement = otherList.querySelector(`[data-alert-id="${alertId}"]`);
                        if (otherElement && otherElement !== element) {
                            otherElement.remove();
                        }
                    }
                });

                // If no alerts left, show "no alerts" message
                const desktopContainer = document.getElementById('alertsList');
                const mobileContainer = document.getElementById('mobileAlertsList');
                const noAlertsText = translateKey('alerts.no_alerts') || 'No alerts';
                
                if (desktopContainer && desktopContainer.children.length === 0) {
                    desktopContainer.innerHTML = `<p style="color: var(--gray);">${noAlertsText}</p>`;
                }
                if (mobileContainer && mobileContainer.children.length === 0) {
                    mobileContainer.innerHTML = `<p style="color: var(--gray);">${noAlertsText}</p>`;
                    const mobileNoAlertsMsg = document.getElementById('mobileNoAlertsMessage');
                    if (mobileNoAlertsMsg) mobileNoAlertsMsg.style.display = 'block';
                }
                
                // Update mobile badges (main nav and More menu)
                const mobileAlertsBadge = document.getElementById('mobileAlertsBadge');
                const mobileMoreAlertsBadge = document.getElementById('mobileMoreAlertsBadge');
                const remainingAlerts = mobileContainer ? mobileContainer.querySelectorAll('.alert-item').length : 0;
                
                if (mobileAlertsBadge) {
                    if (remainingAlerts > 0) {
                        mobileAlertsBadge.textContent = remainingAlerts > 99 ? '99+' : remainingAlerts;
                        mobileAlertsBadge.style.display = 'block';
                    } else {
                        mobileAlertsBadge.style.display = 'none';
                    }
                }
                
                // PJ5002: Also update More menu badge
                if (mobileMoreAlertsBadge) {
                    if (remainingAlerts > 0) {
                        mobileMoreAlertsBadge.textContent = remainingAlerts > 99 ? '99+' : remainingAlerts;
                        mobileMoreAlertsBadge.style.display = 'inline-block';
                    } else {
                        mobileMoreAlertsBadge.style.display = 'none';
                    }
                }
            }, 300);
        } else {
            // Restore if failed
            element.style.opacity = '1';
            console.error('Failed to dismiss alert');
        }
    } catch (error) {
        console.error('Error dismissing alert:', error);
        element.style.opacity = '1';
    }
}

// ========== AUTO-REFRESH ALERTS (KEEP THIS - NO CHANGES) ==========
// Poll for new alerts every 30 seconds when page is visible
let alertPollInterval = setInterval(async () => {
    if (document.visibilityState === 'visible' && typeof loadAlerts === 'function') {
        try {
            await loadAlerts();
        } catch (error) {
            console.error('Alert polling error:', error);
        }
    }
}, 30000);

// PJ5001: Sync mobile notification settings with desktop toggles
function syncMobileNotificationSettings() {
    // Sync email on alert toggle
    const desktopEmailToggle = document.getElementById('emailOnAlertToggle');
    const mobileEmailToggle = document.getElementById('mobileEmailOnAlertToggle');
    if (desktopEmailToggle && mobileEmailToggle) {
        mobileEmailToggle.checked = desktopEmailToggle.checked;
    }
    
    // Sync daily diary reminder toggle
    const desktopDiaryToggle = document.getElementById('dailyDiaryReminderToggle');
    const mobileDiaryToggle = document.getElementById('mobileDailyDiaryReminderToggle');
    if (desktopDiaryToggle && mobileDiaryToggle) {
        mobileDiaryToggle.checked = desktopDiaryToggle.checked;
    }
    
    // Sync time input
    const desktopTimeInput = document.getElementById('diaryReminderTimeInput');
    const mobileTimeInput = document.getElementById('mobileDiaryReminderTimeInput');
    if (desktopTimeInput && mobileTimeInput) {
        mobileTimeInput.value = desktopTimeInput.value;
    }
    
    // Sync time container visibility
    const desktopTimeContainer = document.getElementById('diaryReminderTimeContainer');
    const mobileTimeContainer = document.getElementById('mobileDiaryReminderTimeContainer');
    if (desktopTimeContainer && mobileTimeContainer) {
        mobileTimeContainer.style.display = desktopTimeContainer.style.display;
    }
    
    console.log('[PJ5001] Synced mobile notification settings');
}

// Refresh alerts when user returns to the page
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && typeof loadAlerts === 'function') {
        try {
            console.log('üëÅÔ∏è Page visible - refreshing alerts');
            await loadAlerts();
        } catch (error) {
            console.error('Alert refresh error:', error);
        }
    }
});

console.log('‚úÖ Alert auto-refresh enabled (30s polling + visibility change)');
// ========== END AUTO-REFRESH ALERTS ==========

// Call this when user logs in or navigates to main page
async function checkAndLoadTriggerAlerts() {
    try {
        // First check for any trigger alerts
        const response = await fetch('/api/parameters/check-triggers', {
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            console.log(`Checked triggers: ${data.count} alerts found`);
        }

        // Then load all alerts (including newly created trigger alerts)
        if (typeof loadAlerts === 'function') {
            await loadAlerts();
        }
    } catch (error) {
        console.error('Error checking trigger alerts:', error);
    }
}



        // Helper function for translations - place this RIGHT AFTER loadAlerts()
        function translateKey(key) {
            if (window.i18n && window.i18n.translate) {
                const result = window.i18n.translate(key);
                // Debug: log when translation returns the key itself (meaning not found)
                if (result === key) {
                    console.warn('[i18n] Translation not found for key:', key);
                }
                return result;
            }
            console.warn('[i18n] window.i18n not available, returning raw key:', key);
            return key;
        }

        // Support Form
        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const subject = document.getElementById('supportSubject').value;
            const message = document.getElementById('supportMessage').value;

            try {
                await apiCall('/support/contact', 'POST', {
                    subject: subject,
                    message: message
                });

                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.sent') : 'Message sent') + ' successfully!');
                document.getElementById('supportForm').reset();
            } catch (error) {
                alert((window.i18n && window.i18n.t ? window.i18n.t('msg.error') : 'Error') + ': ' + error.message);
            }
        });




// Home View Functions
        function initializeHomeView() {
            // Initialize city selector
            const citySelector = document.getElementById('homeCitySelector');
            if (citySelector && currentUser) {
                citySelector.value = currentUser.selected_city || 'Jerusalem, Israel';
                citySelector.addEventListener('change', updateUserCity);
                updateHomeCityTime();
                setInterval(updateHomeCityTime, 1000);
            }
        }

        async function updateUserCity() {
            const citySelector = document.getElementById('homeCitySelector');
            const selectedCity = citySelector.value;
            console.log('[CITY UPDATE] Updating city to:', selectedCity);

            try {
                const response = await apiCall('/user/update-city', 'POST', {
                    selected_city: selectedCity
                });

                if (response.success) {
                    currentUser.selected_city = selectedCity;
                    updateHomeCityTime();
                    
                    // Update diary reminder timezone when city changes
                    console.log('[CITY UPDATE] City updated, refreshing diary reminder timezone...');
                    if (typeof loadUserTimezone === 'function') {
                        loadUserTimezone();
                    }
                }
            } catch (error) {
                console.error('Error updating city:', error);
            }
        }

        function updateHomeCityTime() {
            const citySelector = document.getElementById('homeCitySelector');
            const timeDisplay = document.getElementById('homeCurrentTime');
            const dateDisplay = document.getElementById('homeCurrentDate');

            if (!citySelector || !timeDisplay || !dateDisplay) return;

            const selectedCity = citySelector.value;
            const timezoneMap = {
                'Jerusalem, Israel': 'Asia/Jerusalem',
                'Tel Aviv, Israel': 'Asia/Jerusalem',
                'Haifa, Israel': 'Asia/Jerusalem',
                'New York, USA': 'America/New_York',
                'London, UK': 'Europe/London',
                'Paris, France': 'Europe/Paris',
                'Berlin, Germany': 'Europe/Berlin',
                'Moscow, Russia': 'Europe/Moscow',
                'Dubai, UAE': 'Asia/Dubai',
                'Tokyo, Japan': 'Asia/Tokyo',
                'Sydney, Australia': 'Australia/Sydney'
            };

            const timezone = timezoneMap[selectedCity] || 'UTC';
            const now = new Date();

            const timeOptions = {
                timeZone: timezone,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };

            const dateOptions = {
                timeZone: timezone,
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };

            timeDisplay.textContent = now.toLocaleTimeString('en-US', timeOptions);
            dateDisplay.textContent = now.toLocaleDateString('en-US', dateOptions);
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert(window.i18n ? window.i18n.translate('home.fill_all_fields') : 'Please fill in all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert(window.i18n ? window.i18n.translate('home.passwords_no_match') : 'New passwords do not match');
                return;
            }

            if (newPassword.length < 12) {
                alert(window.i18n ? window.i18n.translate('home.password_too_short') : 'Password must be at least 12 characters long');
                return;
            }

            // Check password complexity
            const hasUpper = /[A-Z]/.test(newPassword);
            const hasLower = /[a-z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);

            if (!hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                alert(window.i18n ? window.i18n.translate('home.password_complexity') : 'Password must contain uppercase, lowercase, number, and special character');
                return;
            }

            try {
                const response = await apiCall('/user/change-password', 'POST', {
                    current_password: currentPassword,
                    new_password: newPassword
                });

                if (response.success) {
                    alert(window.i18n ? window.i18n.translate('home.password_updated') : 'Password updated successfully');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    alert(window.i18n ? window.i18n.translate('home.password_update_failed') : response.message || 'Failed to update password');
                }
            } catch (error) {
                console.error('Error updating password:', error);
                alert(window.i18n ? window.i18n.translate('home.error_occurred') : 'An error occurred');
            }
        }

        async function requestAccountDeletion() {
            const confirmMsg = window.i18n ? window.i18n.translate('home.confirm_deletion') : 'Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently deleted.';

            if (!confirm(confirmMsg)) {
                return;
            }

            const doubleConfirm = window.i18n ? window.i18n.translate('home.double_confirm') : 'This is your final warning. Type DELETE to confirm account deletion.';
            const userInput = prompt(doubleConfirm);

            if (userInput !== 'DELETE') {
                alert(window.i18n ? window.i18n.translate('home.deletion_cancelled') : 'Account deletion cancelled');
                return;
            }

            try {
                const response = await apiCall('/user/delete-account', 'POST', {});

                if (response.success) {
                    alert(window.i18n ? window.i18n.translate('home.account_deleted') : 'Your account has been deleted');
                    // Logout
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('dashboard').classList.add('hidden');
                } else {
                    alert(window.i18n ? window.i18n.translate('home.deletion_failed') : response.message || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert(window.i18n ? window.i18n.translate('home.error_occurred') : 'An error occurred');
            }
        }




        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }



        // Check authentication on load
    // Check authentication on load
// Check authentication on load
window.addEventListener('DOMContentLoaded', async () => {


// Handle password reset token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('reset_token');

    if (resetToken) {
        showResetPassword(resetToken);
        // Remove token from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return; // Don't proceed with normal login check
    }

    // Check for magic link token
    checkMagicToken();

    // Wait for i18n to be ready (max 1 second)
    let i18nReady = false;
    let attempts = 0;
    while (!i18nReady && attempts < 20) {
        if (window.i18n && window.i18n.translate) {
            i18nReady = true;
        } else {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
        }
    }

    if (!i18nReady) {
        console.warn('i18n not loaded in time, using fallback');
    }


    try {
        const response = await fetch(`${API_URL}/auth/session`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data && data.authenticated) {
                currentUser = data.user;
                currentUserId = data.user.id;
                showDashboard();
                
                // FIX: Sync language selector immediately after showing dashboard
                setTimeout(() => {
                    if (typeof syncLanguageSelector === 'function') {
                        syncLanguageSelector();
                    }
                }, 100);
                
                // Load alerts AFTER dashboard is shown and i18n is ready
                await checkAndLoadTriggerAlerts();
                // Load notification settings
                console.log('[AUTH DEBUG] About to call loadNotificationSettings()');
                loadNotificationSettings();
                
                // Verification: Check toggle states after a delay to detect if something resets them
                setTimeout(() => {
                    console.log('[VERIFICATION] ========================================');
                    console.log('[VERIFICATION] Checking toggle states 500ms AFTER loadNotificationSettings');
                    const emailToggle = document.getElementById('emailOnAlertToggle');
                    const diaryToggle = document.getElementById('dailyDiaryReminderToggle');
                    console.log('[VERIFICATION] emailOnAlertToggle exists:', !!emailToggle);
                    console.log('[VERIFICATION] emailOnAlertToggle.checked:', emailToggle ? emailToggle.checked : 'N/A');
                    console.log('[VERIFICATION] dailyDiaryReminderToggle exists:', !!diaryToggle);
                    console.log('[VERIFICATION] dailyDiaryReminderToggle.checked:', diaryToggle ? diaryToggle.checked : 'N/A');
                    console.log('[VERIFICATION] ========================================');
                }, 500);
                
                // Another check after 2 seconds
                setTimeout(() => {
                    console.log('[VERIFICATION 2s] ========================================');
                    console.log('[VERIFICATION 2s] Checking toggle states 2000ms AFTER loadNotificationSettings');
                    const emailToggle = document.getElementById('emailOnAlertToggle');
                    const diaryToggle = document.getElementById('dailyDiaryReminderToggle');
                    console.log('[VERIFICATION 2s] emailOnAlertToggle.checked:', emailToggle ? emailToggle.checked : 'N/A');
                    console.log('[VERIFICATION 2s] dailyDiaryReminderToggle.checked:', diaryToggle ? diaryToggle.checked : 'N/A');
                    console.log('[VERIFICATION 2s] ========================================');
                }, 2000);
            } else {
                showAuthContainer();
            }
        } else if (response.status === 401) {
            showAuthContainer();
        } else {
            console.error('Session check failed:', response.status);
            showAuthContainer();
        }
    } catch (error) {
        console.error('Session check error:', error);
        showAuthContainer();
    }
});

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchResults = document.getElementById('searchResults');
            const messageSearchResults = document.getElementById('messageSearchResults');

            if (searchResults && !searchResults.contains(e.target) && e.target.id !== 'userSearchInput') {
                searchResults.classList.remove('active');
            }

            if (messageSearchResults && !messageSearchResults.contains(e.target) && e.target.id !== 'messageUserSearch') {
                messageSearchResults.classList.remove('active');
            }
        });

        // Auto-refresh alerts
        setInterval(() => {
            if (currentUser) {
                loadAlerts().catch(() => {});
            }
        }, 15000);

        // Listen for language changes to reload dynamic content
        window.addEventListener('languageChanged', () => {
            // Reload alerts and other dynamic content if user is logged in
            if (currentUser) {
                loadAlerts().catch(() => {});
            }
        });
 </script>

<script>
// Handle active_view from Flask backend
{% if active_view %}
document.addEventListener('DOMContentLoaded', function() {
    // Wait for all scripts to load
    setTimeout(function() {
        // Call showView with the tracking view
        if (typeof showView === 'function') {
            showView('{{ active_view }}');
        }

        // Ensure calendar and options are initialized for parameters
        if ('{{ active_view }}' === 'tracking') {
            // Initialize the calendar
            if (typeof initializeCalendar === 'function') {
                initializeCalendar();
            }

            // Create parameter options
            if (typeof createParameterOptions === 'function') {
                createParameterOptions('moodInput', 'mood');
                createParameterOptions('sleepInput', 'sleep');
                createParameterOptions('exerciseInput', 'exercise');
                createParameterOptions('stressInput', 'stress');
                createParameterOptions('socialInput', 'social');
            }
        }
    }, 500); // Increased delay from 200 to 500
});
{% endif %}
</script>

<script>
// Handle URL parameters for navigation
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const viewParam = urlParams.get('view');

    if (viewParam) {
        // Wait for page to fully load
        window.addEventListener('load', function() {
            // Remove the parameter from URL without reload
            window.history.replaceState({}, document.title, window.location.pathname);

            // Navigate to the specified view
            if (typeof showView === 'function') {
                showView(viewParam);
            }
        });
    }
})();
</script>

<script>
// ===== FIX #6: INSTANT SEARCH FUNCTION FOR FOLLOWING PAGE =====
// Now works like the Circles search - uses same API endpoint
let searchDebounceTimer = null;

async function searchUsersToFollowInstant(query) {
    const resultsContainer = document.getElementById('followSearchResults');
    
    // Clear previous timer
    if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
    }
    
    // If empty query, hide results
    if (!query || query.trim().length < 1) {
        if (resultsContainer) {
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
        }
        return;
    }
    
    // Debounce: wait 200ms before searching (same as circles)
    searchDebounceTimer = setTimeout(async () => {
        try {
            // FIX #6: Use apiCall which handles auth properly, same as circles search
            const response = await apiCall(`/users/search?q=${encodeURIComponent(query.trim())}`);
            
            if (!response) {
                throw new Error('Search failed');
            }
            
            // FIX #6: Handle response format - check for users array or direct array
            const users = response.users || (Array.isArray(response) ? response : []);
            
            if (resultsContainer) {
                if (users.length === 0) {
                    // FIX #6: Translated "No users found" message
                    const noUsersText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('following.no_users') : 'No users found';
                    resultsContainer.innerHTML = `<p style="text-align: center; color: #6B7280; padding: 15px;">${noUsersText}</p>`;
                } else {
                    // PJ702: Fetch blocked users list for Block/Unblock toggle functionality
                    let blockedUserIds = new Set();
                    try {
                        const blockedResponse = await fetch('/api/blocked-users', { credentials: 'include' });
                        if (blockedResponse.ok) {
                            const blockedData = await blockedResponse.json();
                            if (blockedData.blocked_users) {
                                blockedUserIds = new Set(blockedData.blocked_users.map(u => u.id));
                            }
                        }
                    } catch (e) {
                        console.error('[PJ702] Error fetching blocked users:', e);
                    }
                    
                    // FIX #6: Show results with Follow and +Note buttons like circles
                    const followText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('following.follow') : 'Follow';
                    const unfollowText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('following.unfollow') : 'Unfollow';
                    const withNoteText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('following.with_note') : '+ Note';
                    const blockText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('block.block_user') : 'Block';
                    const unblockText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('block.unblock_user') : 'Unblock';
                    
                    // PJ706: Render with Follow/Unfollow toggle based on following status
                    // PJ6014: Updated to show mutual/city info like circle recommendations
                    resultsContainer.innerHTML = users.map(user => {
                        const isBlocked = blockedUserIds.has(user.id);
                        const buttonLabel = isBlocked ? unblockText : blockText;
                        const buttonStyle = isBlocked 
                            ? 'background-color: #6c757d;'  // Gray for unblock
                            : 'background-color: #ef4444;'; // Red for block
                        const buttonAction = isBlocked 
                            ? `unblockUserFromSearchToggle(${user.id})`
                            : `blockUserFromSearchToggle(${user.id}, '${user.username.replace(/'/g, "\\'")}')`;
                        
                        // PJ706: Check if already following this user
                        const isFollowing = user.is_following === true;
                        const followButtonText = isFollowing ? unfollowText : followText;
                        const followButtonAction = isFollowing 
                            ? `unfollowUserFromSearch(${user.id})`
                            : `followUserFromSearch(${user.id})`;
                        const followButtonStyle = isFollowing
                            ? 'background-color: #6c757d;'  // Gray for unfollow
                            : '';  // Default primary style
                        
                        // PJ6014: Build reason string like circle recommendations
                        let reason = '';
                        if (user.is_mutual && user.is_same_city) {
                            reason = 'Mutual connection & same city';
                        } else if (user.is_mutual) {
                            reason = 'Mutual connection';
                        } else if (user.is_same_city) {
                            reason = 'Same city';
                        }
                        
                        return `
                        <div class="search-result-item" data-user-id="${user.id}" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #E5E7EB;">
                            <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="viewUserProfileFromSearch(${user.id})">
                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;">
                                    ${user.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <strong style="display: block;">${user.username}</strong>
                                    ${reason ? `<small style="color: var(--gray);">${reason}</small><br>` : ''}
                                    ${user.selected_city ? `<small style="color: #6B7280;">üìç ${user.selected_city}</small>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); ${buttonAction}" style="padding: 6px 10px; ${buttonStyle} color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ${buttonLabel}
                                </button>
                                <button onclick="event.stopPropagation(); ${followButtonAction}" class="btn ${isFollowing ? '' : 'btn-primary'}" style="padding: 8px 16px; font-size: 14px; width: auto; ${followButtonStyle} ${isFollowing ? 'color: white; border: none; border-radius: 6px; cursor: pointer;' : ''}">
                                    ${followButtonText}
                                </button>
                                ${!isFollowing ? `<button onclick="event.stopPropagation(); followUserWithNoteFromSearch(${user.id}, '${user.username.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; width: auto;">
                                    ${withNoteText}
                                </button>` : ''}
                            </div>
                        </div>
                    `}).join('');
                }
                resultsContainer.style.display = 'block';
            }
        } catch (error) {
            console.error('Search error:', error);
            if (resultsContainer) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #EF4444; padding: 15px;">Search failed. Please try again.</p>';
                resultsContainer.style.display = 'block';
            }
        }
    }, 200);
}

// FIX #6: Helper function to follow user from search results
async function followUserFromSearch(userId) {
    try {
        await apiCall(`/follow/${userId}`, 'POST', {});
        showNotification('Successfully followed user', 'success');
        
        // Clear search and reload following
        document.getElementById('followSearchInput').value = '';
        document.getElementById('followSearchResults').style.display = 'none';
        
        if (typeof loadFollowing === 'function') {
            await loadFollowing();
        }
    } catch (error) {
        showNotification('Failed to follow user', 'error');
    }
}

// FIX #6: Helper function to follow user with note from search results  
async function followUserWithNoteFromSearch(userId, username) {
    const note = prompt(`Add a note for ${username} (optional):`);
    if (note !== null) {
        try {
            await apiCall(`/follow/${userId}`, 'POST', { note: note });
            showNotification('Successfully followed user with note', 'success');
            
            // Clear search and reload following
            document.getElementById('followSearchInput').value = '';
            document.getElementById('followSearchResults').style.display = 'none';
            
            if (typeof loadFollowing === 'function') {
                await loadFollowing();
            }
        } catch (error) {
            showNotification('Failed to follow user', 'error');
        }
    }
}

// PJ706: Helper function to unfollow user from search results
async function unfollowUserFromSearch(userId) {
    try {
        await apiCall(`/unfollow/${userId}`, 'POST', {});
        showNotification('Successfully unfollowed user', 'success');
        
        // Clear search and reload following
        document.getElementById('followSearchInput').value = '';
        document.getElementById('followSearchResults').style.display = 'none';
        
        if (typeof loadFollowing === 'function') {
            await loadFollowing();
        }
    } catch (error) {
        showNotification('Failed to unfollow user', 'error');
    }
}

// Make functions globally available
window.searchUsersToFollowInstant = searchUsersToFollowInstant;
window.followUserFromSearch = followUserFromSearch;
window.followUserWithNoteFromSearch = followUserWithNoteFromSearch;
window.unfollowUserFromSearch = unfollowUserFromSearch;

// PJN451: View user profile from search results
async function viewUserProfileFromSearch(userId) {
    // Clear search and hide results
    document.getElementById('followSearchInput').value = '';
    document.getElementById('followSearchResults').style.display = 'none';
    
    // Navigate to user profile
    viewUserProfile(userId);
}

// PJN451: Block user from search results
async function blockUserFromSearch(userId, username) {
    await blockUser(userId, username);
    
    // Clear search and reload following
    document.getElementById('followSearchInput').value = '';
    document.getElementById('followSearchResults').style.display = 'none';
    
    if (typeof loadFollowing === 'function') {
        await loadFollowing();
    }
}

window.viewUserProfileFromSearch = viewUserProfileFromSearch;
window.blockUserFromSearch = blockUserFromSearch;

// PJ702: Block user from search with toggle functionality - updates button in place
async function blockUserFromSearchToggle(userId, username) {
    const confirmed = confirm(`Block ${username}?`);
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/users/${userId}/block`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.ok) {
            showNotification('User blocked', 'success');
            
            // Update the button in place to show Unblock
            const searchItem = document.querySelector(`.search-result-item[data-user-id="${userId}"]`);
            if (searchItem) {
                const blockBtn = searchItem.querySelector('button');
                if (blockBtn) {
                    const unblockText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('block.unblock_user') : 'Unblock';
                    blockBtn.textContent = unblockText;
                    blockBtn.style.backgroundColor = '#6c757d';
                    blockBtn.onclick = (e) => { e.stopPropagation(); unblockUserFromSearchToggle(userId); };
                }
            }
            
            // Reload following list
            if (typeof loadFollowing === 'function') {
                await loadFollowing();
            }
        }
    } catch (error) {
        console.error('Error blocking user:', error);
        showNotification('Failed to block user', 'error');
    }
}

// PJ702: Unblock user from search with toggle functionality - updates button in place
async function unblockUserFromSearchToggle(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/unblock`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.ok) {
            showNotification('User unblocked', 'success');
            
            // Update the button in place to show Block
            const searchItem = document.querySelector(`.search-result-item[data-user-id="${userId}"]`);
            if (searchItem) {
                const blockBtn = searchItem.querySelector('button');
                if (blockBtn) {
                    const blockText = window.i18n && window.i18n.translate ? 
                        window.i18n.translate('block.block_user') : 'Block';
                    blockBtn.textContent = blockText;
                    blockBtn.style.backgroundColor = '#ef4444';
                    // Get username from the search item
                    const usernameEl = searchItem.querySelector('strong');
                    const username = usernameEl ? usernameEl.textContent : '';
                    blockBtn.onclick = (e) => { e.stopPropagation(); blockUserFromSearchToggle(userId, username); };
                }
            }
            
            // Reload following list
            if (typeof loadFollowing === 'function') {
                await loadFollowing();
            }
        }
    } catch (error) {
        console.error('Error unblocking user:', error);
        showNotification('Failed to unblock user', 'error');
    }
}

window.blockUserFromSearchToggle = blockUserFromSearchToggle;
window.unblockUserFromSearchToggle = unblockUserFromSearchToggle;

// ===== PROGRESS CHART FUNCTIONS =====
let progressChartInstance = null;

async function updateProgressChart() {
    const days = document.getElementById('progressTimeRange')?.value || 7;
    const token = localStorage.getItem('token');
    // PJ6004: Pass current language to get translated insights
    const currentLang = localStorage.getItem('selectedLanguage') || 'en';
    
    try {
        const response = await fetch(`/api/parameters/progress?days=${days}&lang=${currentLang}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to fetch progress data');
        
        const data = await response.json();
        renderProgressChart(data);
        updateInsights(data);
        updateCheckinSummary(data);
    } catch (error) {
        console.error('Progress chart error:', error);
        // Show placeholder if no data
        const insightsEl = document.getElementById('insightsContent');
        if (insightsEl) {
            insightsEl.textContent = 'Start tracking your wellness to see insights here!';
        }
    }
}

function renderProgressChart(data) {
    const canvas = document.getElementById('progressChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart
    if (progressChartInstance) {
        progressChartInstance.destroy();
    }
    
    // FIX #2: Get translated labels based on current language
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    const chartLabels = {
        'en': { mood: 'Mood', energy: 'Energy', sleep: 'Sleep', activity: 'Activity', anxiety: 'Anxiety' },
        'he': { mood: '◊û◊¶◊ë ◊®◊ï◊ó', energy: '◊ê◊†◊®◊í◊ô◊î', sleep: '◊©◊ô◊†◊î', activity: '◊§◊¢◊ô◊ú◊ï◊™', anxiety: '◊ó◊®◊ì◊î' },
        'ar': { mood: 'ÿßŸÑŸÖÿ≤ÿßÿ¨', energy: 'ÿßŸÑÿ∑ÿßŸÇÿ©', sleep: 'ÿßŸÑŸÜŸàŸÖ', activity: 'ÿßŸÑŸÜÿ¥ÿßÿ∑', anxiety: 'ÿßŸÑŸÇŸÑŸÇ' },
        'ru': { mood: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', energy: '–≠–Ω–µ—Ä–≥–∏—è', sleep: '–°–æ–Ω', activity: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', anxiety: '–¢—Ä–µ–≤–æ–≥–∞' }
    };
    const labels_t = chartLabels[lang] || chartLabels['en'];
    
    // Prepare data - FIX #2: Include Anxiety as 5th parameter
    const labels = data.dates || [];
    const datasets = [
        {
            label: labels_t.mood,
            data: data.mood || [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.3,
            fill: false
        },
        {
            label: labels_t.energy,
            data: data.energy || [],
            borderColor: '#48BB78',
            backgroundColor: 'rgba(72, 187, 120, 0.1)',
            tension: 0.3,
            fill: false
        },
        {
            label: labels_t.sleep,
            data: data.sleep || [],
            borderColor: '#9F7AEA',
            backgroundColor: 'rgba(159, 122, 234, 0.1)',
            tension: 0.3,
            fill: false
        },
        {
            label: labels_t.activity,
            data: data.activity || [],
            borderColor: '#F6AD55',
            backgroundColor: 'rgba(246, 173, 85, 0.1)',
            tension: 0.3,
            fill: false
        },
        // FIX #2: Added Anxiety as 5th parameter
        {
            label: labels_t.anxiety,
            data: data.anxiety || [],
            borderColor: '#FC8181',
            backgroundColor: 'rgba(252, 129, 129, 0.1)',
            tension: 0.3,
            fill: false
        }
    ];
    
    progressChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    // FIX #2: Scale from 1 to 5 (not 0 to 10)
                    min: 1,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function updateInsights(data) {
    const insightsEl = document.getElementById('insightsContent');
    if (!insightsEl) return;
    
    // FIX #2: Translated "Start tracking" message
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    const startTrackingTexts = {
        'en': 'Start tracking your wellness to see insights here!',
        'he': '◊î◊™◊ó◊ú ◊ú◊¢◊ß◊ï◊ë ◊ê◊ó◊® ◊î◊ë◊®◊ô◊ê◊ï◊™ ◊©◊ú◊ö ◊õ◊ì◊ô ◊ú◊®◊ê◊ï◊™ ◊™◊ï◊ë◊†◊ï◊™ ◊õ◊ê◊ü!',
        'ar': 'ÿßÿ®ÿØÿ£ ÿ®ÿ™ÿ™ÿ®ÿπ ÿµÿ≠ÿ™ŸÉ ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ±ÿ§Ÿâ ŸáŸÜÿß!',
        'ru': '–ù–∞—á–Ω–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–¥–µ—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!'
    };
    
    if (data.insights) {
        insightsEl.textContent = data.insights;
    } else {
        insightsEl.textContent = startTrackingTexts[lang] || startTrackingTexts['en'];
    }
}

function updateCheckinSummary(data) {
    const totalEl = document.getElementById('totalCheckins');
    const moodEl = document.getElementById('avgMood');
    const energyEl = document.getElementById('avgEnergy');
    const sleepEl = document.getElementById('avgSleep');
    const activityEl = document.getElementById('avgActivity');
    
    if (totalEl) totalEl.textContent = data.totalCheckins || 0;
    if (moodEl) moodEl.textContent = data.avgMood ? data.avgMood.toFixed(1) : '-';
    if (energyEl) energyEl.textContent = data.avgEnergy ? data.avgEnergy.toFixed(1) : '-';
    if (sleepEl) sleepEl.textContent = data.avgSleep ? data.avgSleep.toFixed(1) : '-';
    if (activityEl) activityEl.textContent = data.avgActivity ? data.avgActivity.toFixed(1) : '-';
}

// ===== FIX #5: AUTO-REDIRECT TO DIARY ON LOGIN - FIXED TO RUN ONLY ONCE =====
async function checkAndRedirectToDiary() {
    // Don't redirect if already on parameters page
    if (window.location.pathname === '/parameters') {
        console.log('[DiaryCheck] Already on parameters page, skipping redirect check');
        return false;
    }
    
    // Check if we've already done the redirect check this session
    // This prevents repeated redirects when navigating within the app
    if (sessionStorage.getItem('diary_redirect_checked') === 'true') {
        console.log('[DiaryCheck] Redirect already checked this session, skipping');
        return false;
    }
    
    try {
        // FIX: Send client's local date to handle timezone differences
        // This ensures we check against the user's actual local date, not server time
        const today = new Date();
        const clientDate = today.getFullYear() + '-' + 
            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
            String(today.getDate()).padStart(2, '0');
        
        console.log('[DiaryCheck] Client local date:', clientDate);
        
        // Use the new endpoint that tracks session-based redirect
        const response = await fetch(`/api/parameters/should-redirect-to-diary?client_date=${clientDate}`, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            console.log('[DiaryCheck] API returned non-OK status:', response.status);
            return false;
        }
        
        const data = await response.json();
        console.log('[DiaryCheck] Server response:', data);
        
        // Mark that we've checked (so we don't check again on navigation)
        sessionStorage.setItem('diary_redirect_checked', 'true');
        
        // FIX #5: Only redirect if server says we should AND diary is incomplete
        if (data.should_redirect) {
            console.log('[DiaryCheck] Redirecting to diary page. Reason:', data.reason);
            console.log('[DiaryCheck] Missing fields:', data.missing_fields);
            window.location.href = '/parameters';
            return true;
        } else {
            console.log('[DiaryCheck] No redirect needed. Reason:', data.reason);
            if (data.values) {
                console.log('[DiaryCheck] Current values:', data.values);
            }
        }
    } catch (error) {
        console.error('[DiaryCheck] Error:', error);
        // On error, mark as checked so we don't keep retrying
        sessionStorage.setItem('diary_redirect_checked', 'true');
    }
    
    return false;
}

// Function to clear the redirect check flag (call this when user logs out)
function clearDiaryRedirectCheck() {
    sessionStorage.removeItem('diary_redirect_checked');
    console.log('[DiaryCheck] Redirect check flag cleared');
}

// Initialize progress chart on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load progress chart when home view is active
    setTimeout(() => {
        if (document.getElementById('progressChart')) {
            updateProgressChart();
        }
    }, 1000);
    
    // Check if user needs to fill diary - runs ONCE per session after login
    // The server-side flag ensures this only triggers once per login session
    setTimeout(() => {
        checkAndRedirectToDiary();
    }, 500);
});

// Make functions globally available
window.updateProgressChart = updateProgressChart;
window.checkAndRedirectToDiary = checkAndRedirectToDiary;
window.clearDiaryRedirectCheck = clearDiaryRedirectCheck;

// ===== REPORT GENERATION FUNCTIONS =====

function generateExcelReport() {
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    const downloadUrl = `/api/reports/excel?lang=${lang}`;
    
    // Show download started notification
    const downloadMessages = {
        'en': 'Download started!',
        'he': '◊î◊î◊ï◊®◊ì◊î ◊î◊ó◊ú◊î!',
        'ar': 'ÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ!',
        'ru': '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å!'
    };
    showNotification(downloadMessages[lang] || downloadMessages['en'], 'success');
    
    // Create a hidden link and click it to trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `weekly_report_${lang}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function generatePdfReport() {
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    const downloadUrl = `/api/reports/pdf?lang=${lang}`;
    
    // Show download started notification
    const downloadMessages = {
        'en': 'Download started!',
        'he': '◊î◊î◊ï◊®◊ì◊î ◊î◊ó◊ú◊î!',
        'ar': 'ÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ!',
        'ru': '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å!'
    };
    showNotification(downloadMessages[lang] || downloadMessages['en'], 'success');
    
    // Create a hidden link and click it to trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `weekly_report_${lang}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function prepareEmailReport() {
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    
    // Prompt for email address
    const promptTexts = {
        'en': 'Enter email address to send report to:',
        'he': '◊î◊ñ◊ü ◊õ◊™◊ï◊ë◊™ ◊ê◊ô◊û◊ô◊ô◊ú ◊ú◊©◊ú◊ô◊ó◊™ ◊î◊ì◊ï◊ó:',
        'ar': 'ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±:',
        'ru': '–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞:'
    };
    
    const email = prompt(promptTexts[lang] || promptTexts['en']);
    if (!email) return;
    
    // Validate email
    if (!email.includes('@')) {
        showNotification(window.i18n ? window.i18n.translate('auth.invalid_email') : 'Invalid email address', 'error');
        return;
    }
    
    showNotification(window.i18n ? window.i18n.translate('reports.sending') : 'Sending report...', 'info');
    
    try {
        const response = await fetch('/api/reports/email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, lang })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const successTexts = {
                'en': 'Report sent successfully!',
                'he': '◊î◊ì◊ï◊ó ◊†◊©◊ú◊ó ◊ë◊î◊¶◊ú◊ó◊î!',
                'ar': 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!',
                'ru': '–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'
            };
            showNotification(successTexts[lang] || successTexts['en'], 'success');
        } else {
            showNotification(data.error || 'Failed to send report', 'error');
        }
    } catch (error) {
        console.error('Email report error:', error);
        showNotification('Failed to send report', 'error');
    }
}

// Make report functions globally available
window.generateExcelReport = generateExcelReport;
window.generatePdfReport = generatePdfReport;
window.prepareEmailReport = prepareEmailReport;
</script>

</body>

</html>