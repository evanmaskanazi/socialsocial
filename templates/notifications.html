<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Settings - TheraSocial</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <h1>TheraSocial</h1>
                </div>
                <div class="nav-menu">
                    <a href="/" class="nav-link">Dashboard</a>
                    <a href="/parameters" class="nav-link">Parameters</a>
                    <a href="/profile" class="nav-link">Profile</a>
                    <a href="/messages" class="nav-link">Messages</a>
                    <a href="/notifications" class="nav-link active">Notifications</a>
                    <a href="/logout" class="nav-link">Logout</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1>Notification Settings</h1>
                <p class="page-subtitle">Manage how and when you receive notifications</p>
            </div>

            <div class="settings-container">
                <!-- Email Notifications Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">üìß</span>
                        <h2>Email Notifications</h2>
                    </div>

                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="notify-follow-requests">
                                    <strong>Follow Requests</strong>
                                    <p>Get notified when someone wants to follow your journey</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <label class="switch">
                                    <input type="checkbox" id="notify-follow-requests" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="notify-triggers">
                                    <strong>Parameter Trigger Alerts</strong>
                                    <p>Receive alerts when trigger conditions are met</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <label class="switch">
                                    <input type="checkbox" id="notify-triggers" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="notify-messages">
                                    <strong>New Messages</strong>
                                    <p>Get notified when you receive private messages</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <label class="switch">
                                    <input type="checkbox" id="notify-messages" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="notify-daily-reminder">
                                    <strong>Daily Check-in Reminder</strong>
                                    <p>Remind me to log my daily parameters</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <label class="switch">
                                    <input type="checkbox" id="notify-daily-reminder">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-extra" id="daily-time-setting" style="display: none;">
                                <label>Reminder time:</label>
                                <input type="time" id="daily-reminder-time" value="20:00">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="notify-weekly-summary">
                                    <strong>Weekly Progress Summary</strong>
                                    <p>Receive a weekly summary of your wellness journey</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <label class="switch">
                                    <input type="checkbox" id="notify-weekly-summary">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Push Notifications Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">üîî</span>
                        <h2>Push Notifications</h2>
                    </div>

                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="enable-push">
                                    <strong>Enable Browser Notifications</strong>
                                    <p>Receive real-time notifications in your browser</p>
                                </label>
                            </div>
                            <div class="setting-control">
                                <button id="enable-push-btn" class="btn-secondary" onclick="enablePushNotifications()">
                                    Enable
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trigger Management Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">‚ö°</span>
                        <h2>Care Triggers</h2>
                    </div>

                    <div id="triggers-container">
                        <!-- Triggers will be loaded here by triggers.js -->
                    </div>
                </div>

                <!-- Follow Requests Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">üë•</span>
                        <h2>Pending Follow Requests</h2>
                        <span id="follow-requests-badge" class="badge" style="display: none;">0</span>
                    </div>

                    <div id="follow-requests-container">
                        <!-- Follow requests will be loaded here by follow-requests.js -->
                    </div>
                </div>

                <!-- Save Button -->
                <div class="settings-actions">
                    <button onclick="saveNotificationSettings()" class="btn-primary">
                        üíæ Save Settings
                    </button>
                    <button onclick="window.location.href='/'" class="btn-secondary">
                        ‚Üê Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="/static/js/utilities.js"></script>
    <script src="/static/js/triggers.js"></script>
    <script src="/static/js/follow-requests.js"></script>

    <script>
        // Initialize components
        document.addEventListener('DOMContentLoaded', () => {
            // Load trigger manager
            if (typeof triggerManager !== 'undefined') {
                triggerManager.init();
            }

            // Load follow requests
            if (typeof followRequestsManager !== 'undefined') {
                followRequestsManager.init();
            }

            // Load current settings
            loadNotificationSettings();

            // Setup event listeners
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Daily reminder toggle
            const dailyReminder = document.getElementById('notify-daily-reminder');
            if (dailyReminder) {
                dailyReminder.addEventListener('change', (e) => {
                    const timeSettings = document.getElementById('daily-time-setting');
                    if (timeSettings) {
                        timeSettings.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            }
        }

        // Load current notification settings
        async function loadNotificationSettings() {
            try {
                const response = await fetch('/api/users/notification-settings', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const settings = await response.json();

                    // Apply settings to checkboxes
                    if (settings.follow_requests !== undefined) {
                        document.getElementById('notify-follow-requests').checked = settings.follow_requests;
                    }
                    if (settings.parameter_triggers !== undefined) {
                        document.getElementById('notify-triggers').checked = settings.parameter_triggers;
                    }
                    if (settings.new_messages !== undefined) {
                        document.getElementById('notify-messages').checked = settings.new_messages;
                    }
                    if (settings.daily_reminder !== undefined) {
                        document.getElementById('notify-daily-reminder').checked = settings.daily_reminder;
                        if (settings.daily_reminder) {
                            document.getElementById('daily-time-setting').style.display = 'block';
                        }
                    }
                    if (settings.weekly_summary !== undefined) {
                        document.getElementById('notify-weekly-summary').checked = settings.weekly_summary;
                    }
                    if (settings.daily_reminder_time) {
                        document.getElementById('daily-reminder-time').value = settings.daily_reminder_time;
                    }
                }
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }

        // Save notification settings
        async function saveNotificationSettings() {
            const settings = {
                follow_requests: document.getElementById('notify-follow-requests').checked,
                parameter_triggers: document.getElementById('notify-triggers').checked,
                new_messages: document.getElementById('notify-messages').checked,
                daily_reminder: document.getElementById('notify-daily-reminder').checked,
                weekly_summary: document.getElementById('notify-weekly-summary').checked,
                daily_reminder_time: document.getElementById('daily-reminder-time').value
            };

            try {
                const response = await fetch('/api/users/notification-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showSuccess('Settings saved successfully!');
                } else {
                    showError('Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showError('Failed to save settings');
            }
        }

        // Enable push notifications
        async function enablePushNotifications() {
            if (!('Notification' in window)) {
                showError('Your browser does not support push notifications');
                return;
            }

            if (Notification.permission === 'granted') {
                showSuccess('Push notifications are already enabled!');
                document.getElementById('enable-push-btn').textContent = 'Enabled ‚úì';
                document.getElementById('enable-push-btn').disabled = true;
            } else if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showSuccess('Push notifications enabled successfully!');
                    document.getElementById('enable-push-btn').textContent = 'Enabled ‚úì';
                    document.getElementById('enable-push-btn').disabled = true;

                    // Test notification
                    new Notification('TheraSocial', {
                        body: 'Push notifications are now enabled!',
                        icon: '/static/img/icon.png'
                    });
                } else {
                    showError('Push notifications were denied');
                }
            } else {
                showError('Push notifications have been blocked. Please enable them in your browser settings.');
            }
        }

        // Check push notification status on load
        document.addEventListener('DOMContentLoaded', () => {
            if ('Notification' in window && Notification.permission === 'granted') {
                const btn = document.getElementById('enable-push-btn');
                if (btn) {
                    btn.textContent = 'Enabled ‚úì';
                    btn.disabled = true;
                }
            }
        });
    </script>
</body>
</html>