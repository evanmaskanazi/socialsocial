<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parameters - TheraSocial</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #loadingMessage {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: white;
        }

        #errorMessage {
            display: none;
            background: #fee;
            border: 1px solid #fcc;
            padding: 20px;
            margin: 20px;
            border-radius: 5px;
            color: #c00;
        }

        #parametersContainer {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* RTL Support */
        [dir="rtl"] {
            direction: rtl;
        }

        [dir="rtl"] .parameters-page {
            text-align: right;
        }

        [dir="rtl"] .date-controls {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .rating-buttons {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .action-buttons {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .parameter-header {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .parameter-emoji {
            margin-right: 0;
            margin-left: 15px;
        }
    </style>
</head>
<body>
    <div id="loadingMessage">Loading parameters...</div>
    <div id="errorMessage"></div>
    <div id="parametersContainer"></div>

    <!-- Load scripts in correct order -->
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/parameters-social.js"></script>

    <script>
        console.log('Parameters page initializing...');

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing parameters...');

            // Hide loading message
            const loadingDiv = document.getElementById('loadingMessage');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            // Small delay to ensure scripts are fully loaded
            setTimeout(() => {
                // Check if initialization function exists
                if (typeof initializeParameters !== 'function') {
                    console.error('initializeParameters function not found');
                    const errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = 'Error: Parameters system not loaded properly. Please refresh the page.';
                    }
                    return;
                }

                try {
                    // Initialize parameters
                    initializeParameters();
                    console.log('Parameters initialized successfully');

                    // Apply initial translations
                    if (window.i18n && window.i18n.applyLanguage) {
                        window.i18n.applyLanguage();
                    }

                    // Set RTL direction for Arabic and Hebrew
                    const currentLang = window.i18n?.currentLanguage || localStorage.getItem('userLanguage') || 'en';
                    const rtlLanguages = ['ar', 'he'];
                    if (rtlLanguages.includes(currentLang)) {
                        document.body.setAttribute('dir', 'rtl');
                    } else {
                        document.body.setAttribute('dir', 'ltr');
                    }

                    // Verify initialization
                    setTimeout(() => {
                        const buttons = document.querySelectorAll('.rating-button');
                        const categories = document.querySelectorAll('.parameter-item');
                        const languageSelector = document.getElementById('languageSelector');
                        
                        console.log(`Verification: ${buttons.length} rating buttons found (expected: 20)`);
                        console.log(`Verification: ${categories.length} parameter categories found (expected: 5)`);
                        console.log(`Language selector present: ${languageSelector ? 'YES' : 'NO'}`);
                        
                        if (buttons.length !== 20) {
                            console.warn(`Unexpected number of rating buttons: ${buttons.length}`);
                        }
                        if (categories.length !== 5) {
                            console.warn(`Unexpected number of categories: ${categories.length}`);
                        }
                        if (!languageSelector) {
                            console.warn('Language selector not found!');
                        }
                    }, 500);

                } catch (error) {
                    console.error('Error during initialization:', error);
                    const errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = 'Initialization error: ' + error.message;
                    }
                }
            }, 100);
        });

        // Handle language changes
        window.addEventListener('languageChanged', () => {
            console.log('Language changed, updating parameters UI...');
            
            try {
                // Update translations
                if (typeof updateTranslations === 'function') {
                    updateTranslations();
                }

                // Update RTL direction
                const currentLang = window.i18n?.currentLanguage || localStorage.getItem('userLanguage') || 'en';
                const rtlLanguages = ['ar', 'he'];
                if (rtlLanguages.includes(currentLang)) {
                    document.body.setAttribute('dir', 'rtl');
                } else {
                    document.body.setAttribute('dir', 'ltr');
                }

                console.log('Language update completed');
            } catch (error) {
                console.error('Error updating language:', error);
            }
        });

        // Debug helper
        window.debugParameters = function() {
            console.log('=== Parameters Debug Info ===');
            console.log('Categories:', document.querySelectorAll('.parameter-item').length);
            console.log('Rating buttons:', document.querySelectorAll('.rating-button').length);
            console.log('Language selector:', document.getElementById('languageSelector'));
            console.log('Current language:', window.i18n?.getCurrentLanguage?.() || localStorage.getItem('userLanguage'));
            console.log('Selected ratings:', window.selectedRatings || {});
            console.log('Categories present:', Array.from(document.querySelectorAll('.parameter-name')).map(el => el.textContent));
            console.log('===========================');
        };
    </script>
</body>
</html>
