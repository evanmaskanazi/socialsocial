<!DOCTYPE html>
<!-- TheraSocial Messages Version P305 -->
<!-- P305: Visual design overhaul - new calming color palette -->
<!-- P305: Dark mode support for evening/nighttime use -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - TheraSocial</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #6B8BA4 0%, #B6A9C9 100%);
            min-height: 100vh;
        }

        /* P305: Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2D3748 0%, #1F2937 100%);
            }
        }

        .dark-mode body, body.dark-mode {
            background: linear-gradient(135deg, #2D3748 0%, #1F2937 100%);
        }

        /* MS-5: Mobile responsive containment */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        #messagesContainer {
            max-width: 100%;
            overflow-x: hidden;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            #messagesContainer {
                padding: 0;
            }
            .message-card, .messages-container, .chat-container {
                max-width: 100% !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
            }
            .message-input, textarea, input {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
        }

        /* MS-5: Orientation change viewport recalculation */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding: 5px;
            }
            #messagesContainer {
                max-height: calc(100vh - 10px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- G-5: Apply dark mode from localStorage -->
    <script>if(localStorage.getItem('therasocial_dark_mode')==='true')document.body.classList.add('dark-mode');</script>
    <div id="messagesContainer">Loading...</div>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/circles-messages.js?v=9.0"></script>
    <script>
        // Wait for i18n to be fully loaded
        function waitForI18n() {
            return new Promise((resolve) => {
                if (window.i18n && window.i18n.t) {
                    resolve();
                } else {
                    setTimeout(() => waitForI18n().then(resolve), 50);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for i18n to load
                await waitForI18n();

                // Check authentication first
                const sessionResponse = await fetch('/api/auth/session', {
                    credentials: 'include'
                });

                if (!sessionResponse.ok) {
                    window.location.href = '/';
                    return;
                }

                // Load content
                document.getElementById('messagesContainer').innerHTML = messagesHTML;

                // Apply translations
                window.i18n.applyLanguage();

                // Load user data and messages
                await getCurrentUser();
                await loadMessages();

                // Re-apply translations when language changes
                window.addEventListener('languageChanged', () => {
                    window.i18n.applyLanguage();
                });
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('messagesContainer').innerHTML =
                    '<p style="color: white; text-align: center;">Error loading messages. Please try again.</p>';
            }
        });
    </script>
</body>
</html>
