<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circles - TheraSocial</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* RTL Support */
        [dir="rtl"] {
            direction: rtl;
        }

        [dir="rtl"] .circles-container {
            text-align: right;
        }

        [dir="rtl"] .circle-selector {
            flex-direction: row-reverse;
        }
    </style>
</head>
<body>
    <div id="loadingMessage" style="text-align: center; padding: 20px; font-size: 18px; color: white;">Loading circles...</div>
    <div id="circlesContainer" style="opacity: 0; transition: opacity 0.2s;"></div>

    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/circles-messages.js?v=2.0"></script>
    <script src="/static/js/feed-updates.js?v=2.2"></script>

    <script>
        // SINGLE initialization flag to prevent race conditions
        let pageInitialized = false;

        // Verify authentication before loading
        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth/session');
                if (response.status === 401) {
                    window.location.href = '/';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error checking authentication:', error);
                return false;
            }
        }

        // Monitor DOM for when circles are actually populated
        function waitForCirclesPopulated(maxWaitMs = 3000) {
            return new Promise((resolve) => {
                const startTime = Date.now();

                const checkPopulated = () => {
                    const publicMembers = document.getElementById('publicMembers');
                    const classBMembers = document.getElementById('class_bMembers');
                    const classAMembers = document.getElementById('class_aMembers');

                    const hasRealContent =
                        (publicMembers && (
                            publicMembers.querySelector('.member-item') ||
                            publicMembers.textContent.includes('private')
                        )) ||
                        (classBMembers && (
                            classBMembers.querySelector('.member-item') ||
                            classBMembers.textContent.includes('private')
                        )) ||
                        (classAMembers && (
                            classAMembers.querySelector('.member-item') ||
                            classAMembers.textContent.includes('private')
                        ));

                    if (hasRealContent) {
                        console.log('Circles populated with real data');
                        resolve(true);
                        return;
                    }

                    if (Date.now() - startTime > maxWaitMs) {
                        console.warn('Timeout waiting for circles to populate');
                        resolve(false);
                        return;
                    }

                    setTimeout(checkPopulated, 50);
                };

                checkPopulated();
            });
        }

        // MAIN INITIALIZATION - runs exactly once
        async function initializeCirclesPage() {
            if (pageInitialized) {
                console.log('Page already initialized, skipping...');
                return;
            }
            pageInitialized = true;

            console.log('Circles page initializing...');

            // 1. Check authentication first
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) return;

            // 2. Wait for i18n to load
            let waitCount = 0;
            while ((!window.i18n || !window.i18n.translations) && waitCount < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                waitCount++;
            }

            // 3. Add circle translations if available
            if (typeof addCircleTranslations === 'function') {
                addCircleTranslations();
            }

            // 4. Load HTML structure (invisible)
            if (typeof circlesHTML !== 'undefined') {
                document.getElementById('circlesContainer').innerHTML = circlesHTML;
                console.log('Circles HTML loaded');
            } else {
                console.error('circlesHTML not found');
                return;
            }

            // 5. Fetch and apply user's language preference
            try {
                const response = await fetch('/api/user/profile');
                if (response.ok) {
                    const profile = await response.json();
                    if (profile.preferred_language && window.i18n && window.i18n.setLanguage) {
                        await window.i18n.setLanguage(profile.preferred_language);
                    }
                }
            } catch (error) {
                console.log('Could not fetch user language preference');
            }

            // 6. Apply initial translations
            if (window.i18n && window.i18n.applyLanguage) {
                const currentLang = window.i18n.getCurrentLanguage ? window.i18n.getCurrentLanguage() : 'en';
                window.i18n.applyLanguage(currentLang);

                // Set RTL direction
                const rtlLanguages = ['ar', 'he'];
                document.body.setAttribute('dir', rtlLanguages.includes(currentLang) ? 'rtl' : 'ltr');
            }

            // 7. Initialize circles data
            if (typeof initializeCircles === 'function') {
                console.log('Calling initializeCircles');
                initializeCircles();
            } else if (typeof loadCircles === 'function') {
                console.log('Calling loadCircles');
                loadCircles();
            } else {
                console.error('No circle initialization function found');
                return;
            }

            // 8. Wait for circles to populate
            console.log('Waiting for circles to populate...');
            await waitForCirclesPopulated(3000);

            // 9. Apply translations ONE FINAL TIME (after data loaded)
            if (window.i18n && window.i18n.applyLanguage) {
                const currentLang = window.i18n.getCurrentLanguage ? window.i18n.getCurrentLanguage() : 'en';
                window.i18n.applyLanguage(currentLang);
            }

            // 10. Update circle displays (emojis + translations)
            if (typeof updateCircleDisplay === 'function') {
                updateCircleDisplay();
            }
            if (typeof updateCircleDisplays === 'function') {
                updateCircleDisplays();
            }
            if (typeof updatePrivacyDropdownTranslations === 'function') {
                updatePrivacyDropdownTranslations();
            }

            // 11. Make visible
            const container = document.getElementById('circlesContainer');
            const loadingDiv = document.getElementById('loadingMessage');
            container.style.opacity = '1';
            if (loadingDiv) loadingDiv.style.display = 'none';

            console.log('Circles page fully initialized and visible');
        }

        // Language change handler - SIMPLIFIED
        window.addEventListener('languageChanged', (event) => {
            if (!pageInitialized) return; // Don't handle until page is ready

            console.log('Language changed to:', event.detail?.language || window.i18n?.currentLanguage);

            // Update RTL direction
            const rtlLanguages = ['ar', 'he'];
            const newLang = event.detail?.language || window.i18n?.currentLanguage || 'en';
            document.body.setAttribute('dir', rtlLanguages.includes(newLang) ? 'rtl' : 'ltr');

            // Re-apply translations (WITHOUT reloading data)
            if (window.i18n && window.i18n.applyLanguage) {
                window.i18n.applyLanguage(newLang);
            }

            // Update displays
            if (typeof updateCircleDisplays === 'function') {
                updateCircleDisplays();
            }
            if (typeof updatePrivacyDropdownTranslations === 'function') {
                updatePrivacyDropdownTranslations();
            }
        });

        // Start initialization when DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCirclesPage);
        } else {
            // DOM already loaded
            initializeCirclesPage();
        }
    </script>
</body>
</html>